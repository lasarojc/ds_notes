
<!doctype html>
<html lang="pt" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Fundamentos - Notas em Sistemas Distribuídos</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-PJX835H7DP","lasarojc.github.org/dsnotes"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fundamentos" class="md-skip">
          Ir para o conteúdo
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-header__button md-logo" aria-label="Notas em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Notas em Sistemas Distribuídos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Fundamentos
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Buscar" placeholder="Buscar" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Notas em Sistemas Distribuídos
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../preface/" class="md-nav__link">
        Prefácio
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Fundamentos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Fundamentos
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modelos-computacionais" class="md-nav__link">
    Modelos computacionais
  </a>
  
    <nav class="md-nav" aria-label="Modelos computacionais">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comunicacao" class="md-nav__link">
    Comunicação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sincronismo" class="md-nav__link">
    Sincronismo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas" class="md-nav__link">
    Falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelo-assumido" class="md-nav__link">
    Modelo Assumido
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sd-sao-como-cebolas" class="md-nav__link">
    SD são como cebolas!
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comunicacao_1" class="md-nav__link">
    Comunicação
  </a>
  
    <nav class="md-nav" aria-label="Comunicação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canais-e-protocolos" class="md-nav__link">
    Canais e Protocolos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-internet" class="md-nav__link">
    A Internet
  </a>
  
    <nav class="md-nav" aria-label="A Internet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sockets" class="md-nav__link">
    Sockets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcp" class="md-nav__link">
    TCP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#udp" class="md-nav__link">
    UDP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ip-multicast" class="md-nav__link">
    IP-Multicast
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concorrencia" class="md-nav__link">
    Concorrência
  </a>
  
    <nav class="md-nav" aria-label="Concorrência">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cliente" class="md-nav__link">
    Cliente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servidor" class="md-nav__link">
    Servidor
  </a>
  
    <nav class="md-nav" aria-label="Servidor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-threaded" class="md-nav__link">
    Single-threaded
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-per-request" class="md-nav__link">
    Thread per request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-pool" class="md-nav__link">
    Thread pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estagios" class="md-nav__link">
    Estágios
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#desafios" class="md-nav__link">
    Desafios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estado" class="md-nav__link">
    Estado
  </a>
  
    <nav class="md-nav" aria-label="Estado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sessao" class="md-nav__link">
    Sessão
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas_1" class="md-nav__link">
    Falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stateless-x-stateful" class="md-nav__link">
    Stateless x Stateful
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multithread-na-pratica" class="md-nav__link">
    Multithread na prática
  </a>
  
    <nav class="md-nav" aria-label="Multithread na prática">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#posix" class="md-nav__link">
    POSIX
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    Python
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java" class="md-nav__link">
    Java
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coordenacao" class="md-nav__link">
    Coordenação
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../arch/" class="md-nav__link">
        Arquiteturas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../comm/" class="md-nav__link">
        Comunicação
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../coord/" class="md-nav__link">
        Coordenação
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../time/" class="md-nav__link">
        Tempo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../fault/" class="md-nav__link">
        Tolerância a Falhas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../disdb/" class="md-nav__link">
        Bancos de Dados
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../disfs/" class="md-nav__link">
        Sistemas de Arquivos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tech/" class="md-nav__link">
        Tecnologias
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../projeto/" class="md-nav__link">
        Projeto
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modelos-computacionais" class="md-nav__link">
    Modelos computacionais
  </a>
  
    <nav class="md-nav" aria-label="Modelos computacionais">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comunicacao" class="md-nav__link">
    Comunicação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sincronismo" class="md-nav__link">
    Sincronismo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas" class="md-nav__link">
    Falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelo-assumido" class="md-nav__link">
    Modelo Assumido
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sd-sao-como-cebolas" class="md-nav__link">
    SD são como cebolas!
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comunicacao_1" class="md-nav__link">
    Comunicação
  </a>
  
    <nav class="md-nav" aria-label="Comunicação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canais-e-protocolos" class="md-nav__link">
    Canais e Protocolos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-internet" class="md-nav__link">
    A Internet
  </a>
  
    <nav class="md-nav" aria-label="A Internet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sockets" class="md-nav__link">
    Sockets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcp" class="md-nav__link">
    TCP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#udp" class="md-nav__link">
    UDP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ip-multicast" class="md-nav__link">
    IP-Multicast
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concorrencia" class="md-nav__link">
    Concorrência
  </a>
  
    <nav class="md-nav" aria-label="Concorrência">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cliente" class="md-nav__link">
    Cliente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servidor" class="md-nav__link">
    Servidor
  </a>
  
    <nav class="md-nav" aria-label="Servidor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-threaded" class="md-nav__link">
    Single-threaded
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-per-request" class="md-nav__link">
    Thread per request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-pool" class="md-nav__link">
    Thread pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estagios" class="md-nav__link">
    Estágios
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#desafios" class="md-nav__link">
    Desafios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estado" class="md-nav__link">
    Estado
  </a>
  
    <nav class="md-nav" aria-label="Estado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sessao" class="md-nav__link">
    Sessão
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas_1" class="md-nav__link">
    Falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stateless-x-stateful" class="md-nav__link">
    Stateless x Stateful
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multithread-na-pratica" class="md-nav__link">
    Multithread na prática
  </a>
  
    <nav class="md-nav" aria-label="Multithread na prática">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#posix" class="md-nav__link">
    POSIX
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    Python
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java" class="md-nav__link">
    Java
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coordenacao" class="md-nav__link">
    Coordenação
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              

<!-- Edit button -->


  <!--
       Hack: check whether the content contains a h1 headline. If it
       doesn't, the page title (or respectively site name) is used
       as the main headline.
    -->


  <!-- Content -->
  <h1 id="fundamentos">Fundamentos</h1>
<p>Uma vez que estejam convencidos de que não temos alternativas à distribuição se queremos sistemas escaláveis e tolerantes a falhas, o próximo passo é entender como podemos implementá-los e quais desafios encontraremos. 
O primeiro desafio é entender o ambiente no qual estão inseridos, suas limitações e fragilidades. Isto é, precisamos definir um <strong>modelo computacional</strong>, sabendo que alguns problemas tem soluções triviais ou inexistentes, dependendo do modelo.</p>
<h2 id="modelos-computacionais">Modelos computacionais</h2>
<p>Antes de distribuir nosso sistema, isto é, dividir a computação/armazenamento em diversas máquinas, e coordenar suas ações para que sejam consistentes com a especificação, de forma a minimizar o tempo que o serviço fica fora do ar, entregando o serviço de acordo com expectativas especificadas, precisamos responder a algumas perguntas:</p>
<ul>
<li>Qual a probabilidade de um nó parar de funcionar?</li>
<li>Como os nós se comunicam? Eles compartilham um espaço de endereçamento ou enviam mensagens uns para os outros?</li>
<li>A quais atrasos a comunicação está sujeita? Pode haver atrasos infinitos?</li>
<li>A comunicação pode ser corrompida?</li>
<li>Os relógios dos hospedeiros marcam o mesmo valor no mesmo instante, ou melhor, são sincronizados?</li>
<li>Há agentes que possam querer perturbar o sistema, por exemplo para ganhar acesso a mais recursos do que seria justo?</li>
</ul>
<details class="info inline end"><summary>Modelos</summary><ul>
<li>Comunicação</li>
<li>Sincronismo</li>
<li>Falhas</li>
</ul>
</details>
<p>Estas perguntas são normalmente divididas em três eixos, <strong>Comunicação</strong>, <strong>Sincronismo</strong> e <strong>Falhas</strong>, e a combinação das respostas define o modelo computacional adotado.</p>
<h3 id="comunicacao">Comunicação</h3>
<p>De uma forma ou de outra, sistemas distribuídos tem à sua disposição múltiplos processadores e permitem o desenvolvimento de aplicações paralelas, isto é, onde múltiplas tarefas são executadas ao mesmo tempo ou <strong>paralelamente</strong>.
Contudo, por um lado, quando falamos em sistemas multiprocessados, normalmente estamos falando de sistemas em que os processadores estão <strong>próximos</strong> e compartilham um mesmo espaço de endereçamento, sejam computadores com múltiplos processadores ou sejam clusters de computadores conectados por um barramento de comunicação de altíssima largura de banda, como <a href="https://en.wikipedia.org/wiki/InfiniBand">Infiniband</a> que abstraiam múltiplos segmentos de memória como um único espaço de endereçamento.
Seja como for, estes sistemas com <strong>memória compartilhada</strong> são normalmente usados para aplicações de computação intensiva e em cujo os componentes são mais <strong>fortemente acoplados</strong> e melhor estudados em um curso de computação paralela.</p>
<p><img alt="Memória Compartilhada" src="../drawings/shared_memory.drawio-0.svg" /></p>
<details class="info inline end"><summary>Comunicação</summary><ul>
<li>memória compartilhada</li>
<li>troca de mensagens</li>
</ul>
</details>
<p>Por outro lado, estamos mais interessados aqui em sistemas de maior escala geográfica, o que se adequa melhor ao modelo de troca de mensagens, isto é, onde cada nó mantem controle total do seu espaço de endereçamento e só expõe seu estado via mensagens enviadas para os outros nós.
Este modelo é mais adequado ao desenvolvimento de aplicações com componentes <strong>fracamente acoplados</strong>, em que atrasos de comunicação e ocorrência de falhas independentes são intrínsecas.</p>
<p><img alt="Passagem de Mensagens" src="../drawings/shared_memory.drawio-2.svg" /></p>
<p>Memória Compartilhada Distribuída (DSM, do inglês, <em>Distributed Shared Memory</em>) é uma abordagem híbrida que tenta integrar a facilidade de se programar usando um único espaço de endereçamento mas com o nível de distribuição necessária a aplicações de larga escala, inclusive geográfica.</p>
<p><img alt="Memória Compartilhada" src="../drawings/memory.drawio-0.svg" /></p>
<p>Considere uma possível implementação em software da DSM, apresentada na próxima figura. 
Nesta abordagem, cada <em>host</em> contribui uma porção de sua memória para um <em>pool</em> global. Processos acessam o <em>pool</em> via <strong>gerentes de memória</strong>, que traduzem os endereços de um espaço de endereçamento virtual para um host e um endereço local a tal host, e usam <em>message passing</em>  para implementar o acesso. 
Esta abordagem resulta em uma arquitetura NUMA, isto é, <em>Non-Uniform Memory Access</em>, já que os acessos a endereços locais são mais rápidos que aos remotos.</p>
<p><img alt="Memória Compartilhada Distribuída em Software" src="../drawings/shared_memory.drawio-1.svg" /></p>
<h3 id="sincronismo">Sincronismo</h3>
<details class="info inline end"><summary>Sincronismo</summary><ul>
<li>operações</li>
<li>comunicação</li>
<li>relógio</li>
<li>sincronização</li>
</ul>
</details>
<p>Quanto ao sincronismo, considera-se os processos tem a capacidade de medir a passagem de tempo, isto é, tem a acesso a relógios, o quão acurazes este são e o quão sincronizados são estes relógios uns com os outros.
Além disso, considera-se a existência de limites de tempo para execução de operações, por exemplo, o tempo um processador leva para executar uma operação de soma de dois inteiros, ou o tempo necessário para a entrega de uma mensagem ou acesso a uma região de memória.</p>
<h3 id="falhas">Falhas</h3>
<p>Quanto às falhas, primeiro é preciso aceitar o fato de que componentes independentes podem falhar independentemente e que quanto mais <em>hosts</em>, maior é a probabilidade de que pelo menos um deles tenha uma CPU, disco, fonte, ou que quer que seja, falhando; e estejam certos, estas falhas acontecem o tempo todo.<sup id="fnref:falham"><a class="footnote-ref" href="#fn:falham">1</a></sup> 
Isto é importante pois se em sistemas monolíticos uma falha pode facilmente fazer com que o sistema todo pare e, portanto, não tente progredir na ausência de um componente, em um sistema distribuído queremos exatamente o contrário, isto é, que apesar da falha de um componente, os outros continuem prestando o serviço, mesmo de forma deteriorada e sem comprometer a corretude do sistema.</p>
<details class="info inline end"><summary>Falhas</summary><ul>
<li>detectável</li>
<li>temporização</li>
<li>quebras</li>
<li>maliciosas</li>
<li>perda e corrupção de mensagens</li>
</ul>
</details>
<p>Para lidar com falhas, precisamos entender quais são suas possíveis formas, isto é, se o levam componentes falhos a parar de funcionar totalmente e de forma identificável por outros ou não, se há falhas "maliciosas", se os limites de tempo estabelecidos acima podem ser violados, se mensagens podem ser perdidas ou corrompidas.</p>
<h3 id="modelo-assumido">Modelo Assumido</h3>
<details class="info inline end"><summary>Outros</summary><ul>
<li>carga de trabalho</li>
</ul>
</details>
<p>Embora modelos clássicos sejam normalmente definidos em termos dos fatores acima, outras questões são também importantes, como o padrão da carga de trabalho do sistema (maior carga à noite? Na hora do almoço? <em>Black friday</em>?). Além de ignorarmos estes outros fatores, por enquanto assumiremos um modelo computacional não amigável, com comunicação por troca de mensagens, relógios e limites de tempo para operações, mesmo que desconhecidos. Também assumiremos ausência de falhas, a não ser quando quisermos provocar a análise de situações mais interessantes. Este modelo será ajustado na medida em que avançarmos, para tornar nossas análises mais realistas.</p>
<h3 id="sd-sao-como-cebolas">SD são como cebolas!</h3>
<p>Uma vez definido o <strong>modelo computacional</strong> e identificado os <strong>algoritmos adequados</strong> aos problemas que queremos resolver, passamos à implementação.
Distribuir é <strong>dividir</strong> a computação/armazenamento em diversos componentes, <strong>possivelmente geograficamente distantes</strong>, e <strong>coordenar</strong> suas ações para que resolvam a tarefa em questão de forma correta.
Com a distribuição objetiva-se <strong>usar recursos</strong> disponíveis nos hosts onde os componentes são executados<sup id="fnref:recursos"><a class="footnote-ref" href="#fn:recursos">2</a></sup> e usar de <strong>redundância</strong> para garantir que o serviço sofra <strong>degradação graciosa</strong> em caso de falhas, ou seja, fazer com que o serviço continue funcionando, mesmo que com <strong>vazão reduzida</strong>, <strong>latência aumentada</strong>, menor capacidade de tratamento de requisições concorrentes, ou com <strong>funcionalidades desabilitadas</strong>.</p>
<details class="info inline end"><summary>Abstrações</summary><ul>
<li>Comunicação<ul>
<li>Ordenação</li>
<li>Confiabilidade</li>
<li>Invocação de procedimentos remotos</li>
</ul>
</li>
<li>Heterogeneidade<ul>
<li>Linguagens</li>
<li>Arquiteturas</li>
<li>Sistemas Operacionais</li>
<li>Times</li>
</ul>
</li>
</ul>
</details>
<p>Para colaborar, as diversas partes do sistema distribuído devem se comunicar, o que pode pode ser feito de diversas formas e em diversos níveis de abstração. Por exemplo, no caso troca de mensagens, estas podem ser desde pacotes de bytes entregues pelo IP/UDP como por <strong>troca de mensagens</strong> ordenadas, <strong>fluxos de dados</strong>, ou <strong>invocação remota de procedimentos</strong>.
Implementar estas abstrações em si já é uma tarefa complicada, pois é preciso levar em consideração que os componentes de um sistema distribuído <strong>falham independentemente</strong>, executam em <em>hosts</em>  com <strong>relógios dessincronizados</strong>, são desenvolvidos usando-se <strong>linguagens diversas</strong>, <strong>sistemas operacionais distintos</strong>, com <strong>arquiteturas diferentes</strong> e por <strong>times independentes</strong>.</p>
<p>Apesar de tantas variáveis, as abstrações precisam permitir que as aplicações que as usem possam se coordenar nos mínimos detalhes. 
Dado que a complexidade de se implementar estas abstrações já é grande por si só, se formos reinventar a roda a cada novo sistema, não faremos muitos avanços.
Mas, como vocês bem sabem, camadas de abstração são a chave para se lidar com complexidade.
Assim, sistemas distribuídos são como cebolas, cheias de camadas e que nos fazem chorar quando precisamos descascá-las.<sup id="fnref:ogros"><a class="footnote-ref" href="#fn:ogros">3</a></sup>
Felizmente, para cada problema que tenha que resolver, há uma boa probabilidade de que alguém já o tenha atacado e disponibilizado uma solução, de forma comercial ou não.</p>
<h2 id="comunicacao_1">Comunicação</h2>
<p>As camadas de abstração mais básicas estão <strong>na rede de computadores</strong> que serve de substrato a todo e qualquer sistema distribuído, afinal, a pedra fundamental da construção de sistemas distribuídos é a capacidade de comunicação entre seus componentes.
Também importantes, de um ponto de vista prático do desenvolvimento, são os conceitos de concorrência e paralelismo, pois componentes pode necessitar manter várias "conversas" em paralelo com múltiplos outros componentes.</p>
<h3 id="canais-e-protocolos">Canais e Protocolos</h3>
<p>Para que os componentes de um sistema distribuído se comuniquem, é necessário que seus <em>hosts</em> possuam <strong>interfaces de rede</strong> e que estas interfaces estejam ligadas a uma rede com capacidade de roteamento de dados, estabelecendo um <strong>canal de comunicação</strong> entre os componentes.
Além do canal, é também necessário que se estabeleça um <strong>protocolo de comunicação</strong>, que define as regras para que a comunicação aconteça, por exemplo, a gramática para formação de mensagens.
Por exemplo, quando você fala com uma pessoa, cara-a-cara, o meio de comunicação é o ar e o protocolo utilizado é a linguagem conhecida pelas duas partes, o Português por exemplo.
Na prática, canais de comunicação podem ter diversas topologias e características, por exemplo:</p>
<table>
<thead>
<tr>
<th>Ponto-a-ponto</th>
<th>Barramento Compartilhado</th>
<th>Token Ring</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sem colisões</td>
<td>Com colisões</td>
<td>Sem colisões</td>
</tr>
<tr>
<td>Roteamento trivial</td>
<td>Roteamento complexo</td>
<td>Roteamento simples</td>
</tr>
<tr>
<td>Caro (exponencial)</td>
<td>Barato (linear)</td>
<td>Barato (linear)</td>
</tr>
</tbody>
</table>
<p>Nas redes atuais, pode se dizer que o meio mais utilizado é provido pela arquitetura <strong>Ethernet</strong>, que trata da comunicação entre nós usando um <strong>barramento compartilhado</strong>, mesmo que este esteja por vezes escondido.
Sobre este meio, são usados protocolos para, por exemplo,</p>
<ul>
<li>Controle de acesso ao meio </li>
<li>Transmissão de mensagens</li>
<li>Evitar e tratar colisões</li>
</ul>
<p>As redes Ethernet, contudo, cobrem pequenas áreas e para se ter conversas mais "abrangentes", é necessário que se conecte diversas destas redes.
A conversa então é feita por meio de intermediários, <strong><em>gateways</em></strong> que conectam duas ou mais redes, permitindo que mensagens de um interlocutor sejam <strong>roteadas</strong> para o outro, via tais intermediários.</p>
<p>Um exemplo interessante das questões ligadas à manutenção da conversa entre dois pontos é a decisão sobre o uso de <strong>comutação de pacotes</strong> (<em>packet switching</em>) ou de <strong>circuitos</strong> (<em>circuit switching</em>).</p>
<table>
<thead>
<tr>
<th>Comutação de pacotes</th>
<th>Comutação de circuito</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cada pacote viaja independentemente</td>
<td>Todo pacote viaja por caminho predefinido</td>
</tr>
<tr>
<td>Latência variável</td>
<td>Latência mais constante</td>
</tr>
<tr>
<td>Banda não reservada</td>
<td>Banda reservada</td>
</tr>
<tr>
<td>Banda não desperdiçada</td>
<td>Banda desperdiçada</td>
</tr>
</tbody>
</table>
<p>Outro fator importante é a <strong>unidade máxima de transmissão</strong> (<em>maximum transmission unit</em>, MTU), o tamanho máximo de um pacote em determinada rede. É necessário entender que qualquer quantidade de dados maior que o MTU precisará ser dividida em múltiplos pacotes. Também é importante perceber que redes são heterogêneas, e que o vários segmentos no caminho entre origem e destino podem ter MTU diferentes, levando à fragmentação de pacotes em trânsito e, possivelmente, entrega desordenada dos mesmos.</p>
<p>Finalmente, há uma questão importante relativa à confiabilidade na transmissão dos elementos da conversa, isto é, se a rede deve garantir ou não que algo "dito" por um interlocutor deve garantidamente ser "ouvido" pelo outro, ou se a <strong>mensagem pode ser perdida</strong> no meio.</p>
<p>Felizmente boa parte da <strong>complexidade da resolução destas questões é abstraída do desenvolvedor dos sistemas distribuídos</strong>, isto é, você, lhe cabendo apenas a decisão de qual protocolo utilizar.
Nas redes atuais, a conversa em componentes será feita, em algum nível, por meio dos protocolos da arquitetura <strong>Internet</strong>.</p>
<h3 id="a-internet">A Internet</h3>
<p>A Internet tem este nome por usar o protocolo de interconexão de redes independentes, o <em>internetworking protocol</em>, ou IP.
Para a aplicação usando o IP, todas as redes se comportam como uma única e coerente rede, exceto por alguns detalhes.
Os elementos que conectam as diversas redes são denominados <strong>roteadores</strong> e fazem um <strong>melhor esforço</strong> para encaminhar os pacotes de dados do remetente ao destinatário.</p>
<p><img alt="A Internet" src="../images/internet.png" /><sup id="fnref:internet"><a class="footnote-ref" href="#fn:internet">4</a></sup></p>
<p>Se você se lembrar da pilha de protocolos de comunicação de referência OSI, lembrará que há uma organização em camadas em que cada camada é responsável pela comunicação em um nível e serve de fundação para a funcionalidade da camada de cima, isto é, cada camada é responsável pela comunicação em um nível de abstração que serve de base para o nível imediatamente superior:
O protocolo de cada camada inclui <strong>cabeçalhos</strong> (<em>header</em>) e <strong>carga</strong> (<em>payload</em>) e o conjunto de cabeçalho + carga de uma camada é considerado carga da camada inferior.
Assim, embora tenha-se a impressão de que cada camada conversa com a equivalente do outro lado da comunicação, na prática, a comunicação desce e sobe a pilha. </p>
<p><img alt="Pilhas de Comunicação" src="../drawings/pilha.drawio-0.svg" /></p>
<p>São sete as camadas:</p>
<ol>
<li>Física: Bits</li>
<li>Enlace: Frames/quadros; controle de fluxo; acesso ao meio.</li>
<li>Rede: Datagramas/pacotes; roteamento</li>
<li>Transporte: Controle de fluxo; fim a fim; confiabilidade; tcp e udp</li>
<li>Sessão: Streams/fluxos; conexões lógicas; restart; checkpoint; http, ssl</li>
<li>Apresentação: Objetos; json, xml; criptografia</li>
<li>Aplicação: Aplicações; http, pop, ftp</li>
</ol>
<p><img alt="Pilhas de Comunicação" src="../drawings/pilha.drawio-1.svg" /></p>
<p>Embora o IP se refira estritamente ao protocolo da camada 3 da pilha, nos referimos à pilha que usa este protocolo como a pilha IP.
Comparada à pilha OSI, a IP é mais simples, como se vê na figura, 
pois as camadas 5 e 6 não estão presentes na pilha IP e as funcionalidades correspondentes são implementadas na camada 7, de aplicaçao.</p>
<p><a href="http://computing.dcu.ie/~humphrys/Notes/Networks/intro.2.html"><img alt="OSI x IP" src="../drawings/pilha.drawio-2.svg" /></a></p>
<p>Contudo, não tema! Estas funcionalidades podem se normalmente implementadas por meio de <em>frameworks</em> ou do <em>middleware</em> em uso.
Alguns exemplos de tais funcionalidades são</p>
<ul>
<li>(De)Serialização - conversão de estruturas complexas, e.g., objetos e estruturas, em sequência de bytes.</li>
<li>Nomeamento - identificação de <em>hosts</em></li>
<li>Criptografia - ocultação dos dados trafegados</li>
<li>Replicação - comunicação com múltiplos interlocutores</li>
<li>Invocação remota de procedimentos - abstração de protocolos de comunicação</li>
</ul>
<p>A grande vantagem desta abordagem é que se pode implementar exatamente e somente as funcionalidades desejadas.
Este característica é conhecida como o <a href="http://web.mit.edu/Saltzer/www/publications/endtoend/endtoend.pdf">argumento fim-a-fim no projeto de sistemas</a>; uma análise recente deste argumento foi feita <a href="https://blog.acolyer.org/2014/11/14/end-to-end-arguments-in-system-design/">aqui</a>.</p>
<p>Como usuários da pilha IP, temos que entender como a camada 3 funciona, mas dificilmente interagiremos com algo além da camada 4, a camada de <strong>transporte</strong>.</p>
<h4 id="sockets">Sockets</h4>
<p>Na prática, para implementarmos a comunicação entre processos, usamos <strong>sockets</strong>.
Para se definir um socket a partir de um <strong><em>host</em></strong> é necessário identificar o outro fim da comunicação, isto é, o outro <em>host</em>, ou melhor, uma de suas interfaces de rede.
Os sockets são então a abstração dos canais de comunicação, mas como dito antes, é necessário definir também os protocolos usados por estes sockets.
O primeiro protocolo é o de endereçamento, que define qual pilha de protocolos usar, na camada 3.
No caso da pilha IP, usa-se o protocolo AF_INET ou PF_INET.
Escolhido o protocolo, </p>
<ul>
<li>cada interface tem um endereço MAC, na camada 2, que a identifica entre as interfaces na mesma rede local, e </li>
<li>cada interface tem um endereço IPv4/IPv6 de 32/128 bits, que o indentifica entre todos os hosts na Internet.<sup id="fnref:ippub"><a class="footnote-ref" href="#fn:ippub">5</a></sup></li>
</ul>
<p>Mas dentro de um <em>host</em>, podem haver diversas aplicações sendo executadas. Como identificar exatamente com qual se quer conversar?
Isto é feito pela definição uma porta:</p>
<ul>
<li>Porta: inteiro de 16 bits</li>
<li>Associadas a serviços pela <a href="http://www.iana.org">Internet Assigned Numbers Authority</a>, IANA.<ul>
<li>Portas "Bem conhecidas": 0-1023</li>
<li>Portas Proprietárias: 49151</li>
<li>Portas Dinâmicas: 65535</li>
</ul>
</li>
</ul>
<p>Também é necessário definir o protocolo de transporte dos dados, na camada 4.
Novamente, no caso da pilha IP, pode-se usar TCP (<strong>SOCK_STREAM</strong>) ou UDP (<strong>SOCK_DGRAM</strong>).</p>
<p>A API usada para estabelecer a conversa via socket tem várias chamadas, que devem ser executadas na ordem certa no processo iniciando a conversa e naquele que aceita participar da mesma. Comecemos estudando o TCP.</p>
<h4 id="tcp">TCP</h4>
<p>O fluxograma da criação de um socket TCP é apresentado na seguinte figura:
<div class="mermaid">stateDiagram-v2
   Servidor --&gt; Entrada/Saída
   Cliente --&gt; Entrada/Saída
   Entrada/Saída --&gt; Encerramento

   state Servidor {
     ss: Cria socket
     sb: Associa porta
     sl: Escuta conexões
     sa: Aceita conexões
     ss --&gt; sb 
     sb --&gt; sl
     sl --&gt; sa
   }

   state Entrada/Saída {
     leitura --&gt; escrita
     escrita --&gt; leitura
   }

   state Cliente {   
     cs: Cria socket
     cc: Inicia conexão
     cs --&gt; cc
   }

   state Encerramento {
       sc: Fecha conexão
   }</div></p>
<!--![image](images/04-15.png)-->

<p>Estabelecido o socket, o mesmo pode ser usado como um <strong>arquivo</strong>, isto é, lendo-se e escrevendo-se bytes.
O que exatamente deve ser escrito e como o que é lido deve ser interpretado é o protocolo da camada 7, <strong>sua responsabilidade</strong>.</p>
<p>Vejamos um exemplo do uso de sockets, em Python, descrito no arquivo <code>server.py</code>.<sup id="fnref:pyname"><a class="footnote-ref" href="#fn:pyname">6</a></sup></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">#server.py</span>
<span class="c1">#!/usr/bin/python                           # This is server.py file</span>

<span class="kn">import</span> <span class="nn">socket</span>                               <span class="c1"># Import socket module</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>                         <span class="c1"># Create a socket object</span>
<span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>                 <span class="c1"># Get local machine name</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">12345</span>                                <span class="c1"># Reserve a port for your service.</span>
<span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>                        <span class="c1"># Bind to the port</span>

<span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>                                 <span class="c1"># Now wait for client connections.</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
   <span class="n">c</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>                     <span class="c1"># Establish connection with client.</span>
   <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Got connection from&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
   <span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;Thank you for connecting&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
   <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                                <span class="c1"># Close the connection</span>
</code></pre></div>
</td></tr></table>
<p>Para executá-lo, execute o seguinte comando em um terminal. </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>python server.py
</code></pre></div>
</td></tr></table>
<p>Em outro terminal, execute <strong>um dos</strong> dois comandos a seguir. <sup id="fnref:telnet"><a class="footnote-ref" href="#fn:telnet">7</a></sup></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>telnet localhost <span class="m">12345</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>netcat localhost <span class="m">12345</span>
</code></pre></div>
</td></tr></table>
<p>No segundo terminal a mensagem 
<code>Thank you for connecting</code>
será impressa, enquanto no primeiro veremos algo como 
 <code>('Got connection from', ('127.0.0.1', 57801))</code> </p>
<p>O que está acontecendo aqui é um processo criou um socket e ficou aguardando uma conexão, usando o código em Python.
Tanto o telnet quando o netcat são programas genéricos para se conversar com outro processo usando TCP/IP.
Aqui, estes programas simplesmente se conectaram e imprimiram o que quer que o primeiro processo lhes tenha enviado, assumindo que correspondia a uma string, o que neste caso é correto.
Simples, não é mesmo?</p>
<p>Duas observações importantes a serem feitas aqui. 
A primeira é que, em geral, denominamos o processo que fica aguardando a conexão de <strong>servidor</strong> e o processo que se conecta de <strong>cliente</strong>. Isto por quê, em geral, o servidor executa alguma tarefa, serve, o cliente, embora isto não seja necessariamente verdade.</p>
<p>Por completude, vamos também escrever o código do cliente, agora que você já sabe que o servidor funciona.
Do lado cliente, estabelece-se uma conexão apontando-se para onde está o servidor.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">#client.py</span>

<span class="c1">#!/usr/bin/python                      # This is client.py file</span>

<span class="kn">import</span> <span class="nn">socket</span>                          <span class="c1"># Import socket module</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>                    <span class="c1"># Create a socket object</span>
<span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>            <span class="c1"># Get local machine name</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">12345</span>                           <span class="c1"># Reserve a port for your service.</span>

<span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                              <span class="c1"># Close the socket when done</span>
</code></pre></div>
</td></tr></table></p>
<p>E para se executar o cliente, faça:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>python client.py
</code></pre></div>
</td></tr></table></p>
<p>Observe que o <code>socket.close()</code> encerra a conexão do lado de quem invoca. Na contraparte, invocações a <code>socket.recv()</code> retornam com 0 bytes lidos.</p>
<p>A título de comparação, em Java, a criação do socket do lado do servidor seria muito mais simples, consistindo apenas em: 
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Socket</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
</code></pre></div>
</td></tr></table></p>
<p>O cliente em Java também é simplificado.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Socket</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="n">port</span><span class="p">);</span>
</code></pre></div>
</td></tr></table></p>
<div class="admonition question">
<p class="admonition-title">Exercício: Múltiplos Pacotes</p>
<p>Façamos agora uma modificação no código do servidor para que envie não uma, mas duas mensagens para o cliente. Isto é, modifique seu servidor assim</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="o">...</span>
<span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;Thank you for connecting&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;Come back often&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="o">...</span>
</code></pre></div>
</td></tr></table>
<p>Agora execute novamente o cliente e veja o que acontece.  Consegue explicar o fenômeno?</p>
<p>Modifiquemos o cliente agora, para que tenha dois <code>recv</code>, assim.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="o">...</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<span class="o">...</span>
</code></pre></div>
</td></tr></table></p>
<p>E agora, o que acontece? A saída é como esperava? Como explica este fenômeno e como poderia corrigí-lo?</p>
</div>
<div class="admonition question">
<p class="admonition-title">Exercício: Ping-Pong</p>
<p>Modifique cliente e servidor tal que o cliente envie uma mensagem passada na linha de comando ao servidor e fique esperando uma resposta, e tal que o servidor fique esperando uma mensagem e então solicite ao operador que digite uma resposta e a envie para o cliente. O loop continua até que o usuário digite SAIR, e a conexão seja encerrada.</p>
<table>
<thead>
<tr>
<th>Terminal 1</th>
<th>Terminal 2</th>
</tr>
</thead>
<tbody>
<tr>
<td>python server.py</td>
<td>python client.py</td>
</tr>
<tr>
<td>Esperando conexão.</td>
<td>conectando-se ao servidor</td>
</tr>
<tr>
<td>Conectado</td>
<td>Conectado</td>
</tr>
<tr>
<td>Esperando mensagem</td>
<td>Digite mensagem: lalala</td>
</tr>
<tr>
<td></td>
<td>Mensagem enviada</td>
</tr>
<tr>
<td>Mensagem recebida: lalala</td>
<td>Esperando resposta</td>
</tr>
<tr>
<td>Digite resposta: lelele</td>
<td></td>
</tr>
<tr>
<td>Resposta enviada.</td>
<td>Resposta recebida: lelele</td>
</tr>
<tr>
<td></td>
<td>Digite mensagem: SAIR</td>
</tr>
<tr>
<td></td>
<td>Desconectando.</td>
</tr>
<tr>
<td>Conexão encerrada.</td>
<td></td>
</tr>
<tr>
<td>Esperando conexão.</td>
<td></td>
</tr>
</tbody>
</table>
<p>Observe que para ler do teclado em Python 2 você deve usar <code class="highlight"><span class="n">x</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">()</span></code>, enquanto que em Python 3 seria <code class="highlight"><span class="n">x</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span></code>. Além disso, em Python 2, você deve remover as invocações para <code>encode</code> e <code>decode</code>.</p>
</div>
<h4 id="udp">UDP</h4>
<p>No exemplo anterior, usamos o protocolo TCP (o padrão da API). Caso quiséssemos usar UDP, precisaríamos nos atentar a alguns detalhes.</p>
<p>A criação do socket é feita explicitando-se o uso de <strong>datagramas</strong>: <code class="highlight"><span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span></code></p>
<p>Um servidor UDP não executa <code>listen</code> ou <code>accept</code> e, em Python, simplesmente executa <code class="highlight"><span class="n">data</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span></code> para receber o datagrama, onde <code>data</code> é o conteúdo recebido e  <code>addr</code> o endereço de quem enviou o datagrama.</p>
<p>Neste caso, um mesmo socket é usado para manter comunicação com múltiplos interlocutores. Para enviar uma resposta a um interlocutor em específico, <code>addr</code> é usado: <code class="highlight"><span class="n">sent</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span></code>, onde <code>sent</code> é a quantidade de bytes enviados.</p>
<p>Além deste detalhe, é importante manter em mente outras características do UDP:</p>
<ul>
<li>falta de ordem</li>
<li>falta de confiabilidade</li>
<li>menos dados lidos que enviados.</li>
<li>mais dados lidos que enviados (pode acontecer também no TCP)</li>
</ul>
<p>Com tantas dificuldades para se usar o UDP, fica a questão: <strong>para que serve UDP?</strong></p>
<div class="admonition question">
<p class="admonition-title">Exercício: Ping-Pong UDP</p>
<p>Modifique o código do exercício Ping-Pong para usar UDP em vez de TCP na comunicação entre nós.
Execute múltiplos clientes ao mesmo tempo. Como o seu servidor lida com isso? Modifique-o para mandar um "eco" da mensagem recebida de volta ao remetente. </p>
</div>
<h4 id="ip-multicast">IP-Multicast</h4>
<p>Imagine que você tenha que enviar um <em>stream</em> de vídeo para um amigo mostrando como você está jogando o mais novo jogo da velha no mercado.
Qual protocolo de transporte você usaria? TCP, provavelmente, já que garante a entrega ordenada dos pacotes do vídeo.
Como você já sabe, o TCP envia confirmações de pacotes recebidos e usa uma janela deslizante para determinar quais pacotes reenviar, o que pode causar interrupções na execução do vídeo.
Além do mais, as pessoas provavelmente preferirão perder alguns quadros que perder a sincronia com sua excitante partida.
Parece que uma opção melhor seria então usar UDP, correto?</p>
<p>Imagine agora que os mesmos dados devam ser enviados para múltiplos destinatários (você está ficando famoso!)
Com múltiplos destinatários, múltiplos controles precisariam ser mantidos no TCP, o que pode se tornar custoso; mais uma razão para usar UDP!</p>
<p><img alt="Multicast" src="../drawings/group_com.drawio-0.svg" /></p>
<p>Para terminar, lhe darei uma razão final: IP-Multicast!
Multicast, em oposição ao Unicast, é a capacidade de enviar mensagens para um grupo de destinatários, em vez de apenas um. </p>
<p><img alt="Multicast" src="../drawings/group_com.drawio-1.svg" /></p>
<p>IP-Multicast é uma implementação desta ideia, usando umaa configuração específica do UDP, associada a recursos dos comutadores de rede, para otimizar o envio dos mesmos dados a múltiplos destinatários.
Grupos são identificados por endereços IP especiais, conhecidos como Classe D (224.0.0.0-239.255.255.255), e propagados pela rede.
A seguinte tabela descreve os usos das sub-faixas de endereços.<sup id="fnref:multicast_use"><a class="footnote-ref" href="#fn:multicast_use">8</a></sup></p>
<table>
<thead>
<tr>
<th>Endereço</th>
<th>Uso</th>
</tr>
</thead>
<tbody>
<tr>
<td>224.0.0.0-224.0.0.255</td>
<td>Multicast local - Usado por protocolos L2, como EIGRP e OSPF</td>
</tr>
<tr>
<td>224.0.1.0-224.0.1.255</td>
<td>Multicast roteaddo - Usado por protocolos L3</td>
</tr>
<tr>
<td>232.0.0.0-232.255.255.255</td>
<td><em>Source Specific Multicast</em> - Receptores definem fontes confiáveis</td>
</tr>
<tr>
<td>233.0.0.0-233.255.255.255</td>
<td>Reservado para detentores <em>Autonomous Systems</em></td>
</tr>
<tr>
<td>239.0.0.0-239.255.255.255</td>
<td>Reservado para IANA</td>
</tr>
<tr>
<td>Resto</td>
<td>Uso geral</td>
</tr>
</tbody>
</table>
<p>Quando um pacote é enviado para o endereço do grupo, <strong>todos</strong> os membros do grupo recebem tal mensagem.
Melhor dizendo, todos os membros podem receber a mensagem, mas como estamos falando de UDP, <strong>é possível que alguns não recebam</strong>.
Além disso, <strong>não há garantia qualquer sobre a ordem de recepção das mensagens</strong>.</p>
<p>Apenas reforçando, IP-Multicast só funciona com UDP, pois lidar com retransmissões em um grupo grande levaria a um estado imenso sendo mantido na origem dos dados.
Outro ponto importante é que pelo podencial desestabilizador do IP-Multicast, ele é normalemente limitado à pequenas seções das redes.</p>
<p>Mas experimentemos com esta tecnologia na prática.
Criemos um programa que <strong>criar Socket UDP</strong>, <strong>associa-o a um grupo</strong>, e <strong>recebe pacotes</strong> destinados ao grupo.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// MReceiver.java</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.*</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MReceiver</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">inBuf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">256</span><span class="o">]</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="n">MulticastSocket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MulticastSocket</span><span class="p">(</span><span class="mi">8888</span><span class="p">);</span>
      <span class="n">InetAddress</span> <span class="n">address</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="p">.</span><span class="na">getByName</span><span class="p">(</span><span class="s">&quot;224.2.2.3&quot;</span><span class="p">);</span>
      <span class="n">socket</span><span class="p">.</span><span class="na">joinGroup</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DatagramPacket</span> <span class="n">inPacket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DatagramPacket</span><span class="p">(</span><span class="n">inBuf</span><span class="p">,</span> <span class="n">inBuf</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
        <span class="n">socket</span><span class="p">.</span><span class="na">receive</span><span class="p">(</span><span class="n">inPacket</span><span class="p">);</span>
        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="n">inBuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inPacket</span><span class="p">.</span><span class="na">getLength</span><span class="p">());</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;From &quot;</span> <span class="o">+</span> <span class="n">inPacket</span><span class="p">.</span><span class="na">getAddress</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; Msg : &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ioe</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Instancie múltiplos processos deste, na mesma máquina e em máquinas distintas.
Agora criemos um programa que envia pacotes para o dito grupo.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">// MSender.java</span>
<span class="kn">import</span> <span class="nn">java.io.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.*</span><span class="p">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MSender</span> <span class="p">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">byte</span><span class="o">[]</span> <span class="n">outBuf</span><span class="p">;</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">PORT</span> <span class="o">=</span> <span class="mi">8888</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
   <span class="n">DatagramSocket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DatagramSocket</span><span class="p">();</span>
   <span class="kt">long</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">InetAddress</span> <span class="n">address</span> <span class="o">=</span> <span class="n">InetAddress</span><span class="p">.</span><span class="na">getByName</span><span class="p">(</span><span class="s">&quot;224.2.2.3&quot;</span><span class="p">);</span>
   <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
    <span class="n">outBuf</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Multicast numero &quot;</span> <span class="o">+</span> <span class="n">counter</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">address</span><span class="p">).</span><span class="na">getBytes</span><span class="p">();</span>
    <span class="n">DatagramPacket</span> <span class="n">outPacket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DatagramPacket</span><span class="p">(</span><span class="n">outBuf</span><span class="p">,</span> <span class="n">outBuf</span><span class="p">.</span><span class="na">length</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">PORT</span><span class="p">);</span>
    <span class="n">socket</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">outPacket</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span> <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span> <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{}</span>
   <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">ioe</span><span class="p">)</span> <span class="p">{</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ioe</span><span class="p">);</span> <span class="p">}</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Observe como a mesma mensagem é recebida pelos vários membros e que como diferentes fontes tem seus pacotes recebidos.</p>
<p>A título de curiosidade, IP-Multicast também está presente em IPv6, mas com algumas pequenas diferenças </p>
<div class="admonition tip">
<p class="admonition-title">IP-Multicast em IPv6<sup id="fnref:ipv6multi"><a class="footnote-ref" href="#fn:ipv6multi">9</a></sup></p>
<p>In IPv6, the left-most bits of an address are used to determine its type. For a multicast address, the first 8 bits are all ones, i.e. FF00::/8. Further, bit 113-116 represent the scope of the address, which can be either one of the following 4: Global, Site-local, Link-local, Node-local.</p>
<p>In addition to unicast and multicast, IPv6 also supports anycast, in which a packet can be sent to any member of the group, but need not be sent to all members.''</p>
</div>
<div class="admonition question">
<p class="admonition-title">Exercício: IP-Multicast</p>
<p>Implemente e teste o seguinte <strong>receiver</strong>, colocando várias instâncias para executar em múltiplos terminais, ao mesmo tempo.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="n">MCAST_GRP</span> <span class="o">=</span> <span class="s1">&#39;224.1.1.1&#39;</span>
<span class="n">MCAST_PORT</span> <span class="o">=</span> <span class="mi">5007</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_UDP</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">MCAST_PORT</span><span class="p">))</span>
<span class="n">mreq</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;=4sl&quot;</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">MCAST_GRP</span><span class="p">),</span> <span class="n">socket</span><span class="o">.</span><span class="n">INADDR_ANY</span><span class="p">)</span>
<span class="c1">#4 bytes (4s) seguidos de um long (l), usando ordem nativa (=)</span>

<span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IP_ADD_MEMBERSHIP</span><span class="p">,</span> <span class="n">mreq</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">10240</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</code></pre></div>
</td></tr></table>
<p>Implemente e teste o seguinte <strong>sender</strong>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">MCAST_GRP</span> <span class="o">=</span> <span class="s1">&#39;224.1.1.1&#39;</span>
<span class="n">MCAST_PORT</span> <span class="o">=</span> <span class="mi">5007</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_UDP</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IP_MULTICAST_TTL</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="p">(</span><span class="n">MCAST_GRP</span><span class="p">,</span> <span class="n">MCAST_PORT</span><span class="p">))</span>
</code></pre></div>
</td></tr></table>
</div>
<h2 id="concorrencia">Concorrência</h2>
<p>É impossível pensar em sistemas distribuídos sem pensar em concorrência na forma de múltiplos processos executando (normalmente) em hosts distintos e em termos de múltiplos <em>threads</em> nos processos.
Os exemplos apresentados até agora, consistem todos em um processo cliente requisitando ações de algum processo servidor.
Apesar disso, a interação entre tais processos aconteceu sempre de forma sincronizada, <em>lock-step</em>, em que o cliente requisitava o serviço e ficava bloqueado esperando a resposta do servidor para então prosseguir em seu processamento, e o servidor fica bloqueado esperando requisições que atende e então volta a dormir.
Este cenário, apresentado na figura a seguir, mostra que apesar do uso de processadores distintos e da concorrência na execução dos processos, temos um baixo grau de efetivo paralelismo; a requisição (2) só é processada depois que a resposta (1) é enviada.</p>
<div class="mermaid">sequenceDiagram
    activate Cliente
    note left of Cliente: Ativo gerando requisição
    note right of Servidor: Inativo esperando requisição
    activate Cliente2
    note right of Cliente2: Ativo gerando requisição
    Cliente-&gt;&gt;+Servidor: Request (1)
    deactivate Cliente 
    note left of Cliente: Inativo esperando resposta
  Cliente2--&gt;&gt;Servidor: Request (2)
    deactivate Cliente2
    note right of Cliente2: Inativo esperando resposta
    note right of Servidor: Ativo processando requisição (1)
    Servidor-&gt;&gt;-Cliente: Response (1)
      activate Cliente
    activate Servidor
    note left of Cliente: Ativo processando resposta (1)
    note right of Servidor: Ativo processando requisição (2)
  Servidor--&gt;&gt;Cliente2: Response (2)
    deactivate Servidor
    activate Cliente2
    note right of Servidor: Inativo esperando requisição
    note right of Cliente2: Ativo processando resposta (2)
    deactivate Cliente
  deactivate Cliente2</div>
<p>Este modelo de sincronização entre as partes comunicantes é um exemplo de <strong>E/S bloqueante</strong>. 
O principal ponto positivo desta estratégia é a <strong>simplicidade do código</strong> e o principal ponto negativo é a <strong>limitação do paralelismo</strong> no uso de recursos, uma das razões de ser da computação distribuída.</p>
<p>Para usarmos melhor os recursos disponíveis, tanto do lado dos clientes quanto servidores, temos então que pensar em termos de eventos sendo disparados entre os componentes, que devem ser tratados assim que recebidos ou tão logo haja recursos para fazê-lo. 
Estes eventos correspondem tanto a requisições quanto a respostas (efetivamente tornando difícil a distinção).</p>
<p>No modelo bloqueante, quando um evento é disparado (no exemplo, a requisição), o sistema fica bloqueado até que um evento específico seja observado (no exemplo, a chegada da resposta).
Sempre que possível, um componente não deve ficar esperando por eventos em específico, aproveitando a chance executar outras tarefas; quando eventos são recebidos, são então atendidos. Esta é a forma de fazer <strong>E/S assíncrona</strong>.</p>
<p>Dada que processos interagem com a rede usando sockets, cuja interface mais simples para operações de leitura é bloqueante, neste curso não falaremos especificamene sobre E/S assíncrono<sup id="fnref:asyncio"><a class="footnote-ref" href="#fn:asyncio">10</a></sup> e por isso, para vermos como aumentar a concorrência no sistema, é necessário falar de <em>multithreading</em> e as várias formas em que aparecem nos sistemas.</p>
<p>Há duas razões claras para estudarmos <em>multithreading</em>. 
A primeira, de ordem prática, é a discutida acima: permitir o desenvolvimento de componentes que utilizem "melhormente" os recursos em um host.
A segunda, didática, é o fato que muitos dos problemas que aparecem em programação <em>multithread</em>, aparecem em programação multi-processo (como nos sistemas distribuídos), apenas em um grau de complexidade maior.
Para relembrar, há várias diferenças entre <em>threads</em> e processos, mas a abstração é essencialmente a mesma:</p>
<table>
<thead>
<tr>
<th></th>
<th>Processo</th>
<th>Thread</th>
</tr>
</thead>
<tbody>
<tr>
<td>Definição</td>
<td>Instância de um programa</td>
<td>"Processo leve"</td>
</tr>
<tr>
<td>Função de entrada</td>
<td><code>main</code></td>
<td>função "qualquer"</td>
</tr>
<tr>
<td>Compartilhamento de código e dados</td>
<td>Privado ao processo</td>
<td>Compartilhado pelos threads</td>
</tr>
<tr>
<td>Estado</td>
<td>Código, Stack, Heap, descritores (e.g, file descriptors), controle de acesso</td>
<td>Stack, variáveis locais</td>
</tr>
<tr>
<td>Comunicação</td>
<td>IPC (<em>Inter Process Communication</em>): sockets, FIFO, memória compartilhada, etc</td>
<td>IPC, mutex, variáveis de condição, semáforos, etc</td>
</tr>
<tr>
<td>Nível da implementação</td>
<td>Sistema operacional</td>
<td>Diferentes implementações</td>
</tr>
<tr>
<td>API</td>
<td></td>
<td>Posix, C++, Java, ...</td>
</tr>
<tr>
<td>Bloqueio</td>
<td>Mudança de contexto para outro thread mesmo sem terminar quantum</td>
<td>Mudança de contexto para outro thread do mesmo processo</td>
</tr>
<tr>
<td>Tempo de criação, terminação e mudança de contexto</td>
<td>Demora mais</td>
<td>Demora menos</td>
</tr>
</tbody>
</table>
<p>Vejamos como o uso de múltiplos threads podem melhorar o desenvolvimento de sistemas distribuídos na prática.
Considere os exemplos de clientes e servidores vistos <a href="#tcp">anteriormente</a>.
Imagine que em vez do serviço simples feito no exemplo, o servidor retorne uma página Web.
Detalhes do protocolo seguido por navegadores e servidores serão vistos mais tarde. Por agora, considere apenas que uma requisição <code>GET arquivo.html</code> será enviada para o servidor que lerá o arquivo especificado do sistema de arquivos; como você sabe, ler um arquivo é uma operação lenta e que não requer CPU.</p>
<h3 id="cliente">Cliente</h3>
<p>Do ponto de vista do cliente, a vantagem do uso de múltiplos threads são claras: permite lidar com <strong>várias tarefas concorrentemente</strong>, por exemplo solicitar CSS, HTML e imagens concorrentemente, <strong>escondendo latência</strong> das várias operações, e permite <strong>organizar código</strong> em blocos/módulos.
Se você usar o console de desenvolvimento do navegador, verá como múltiplos arquivos são baixados em paralelo quando acessa um sítio. 
A figura a seguir mostra a carga do sítio da <a href="https://www.facom.ufu.br">Facom</a>.
O primeiro arquivo, <code>index.html</code> é baixado individualmente, mas uma vez que isso acontece e são determinados quais os demais arquivos necessários, requisições concorrentes são disparadas, minimizando o tempo total da operação.</p>
<p><img alt="Facom loading times" src="../images/facom.png" /></p>
<p>Como outros exemplos, considere um formulário <em>online</em> em que a validação de um campo é executada enquanto o campo seguinte está sendo preenchido, ou um serviço de email em que arquivos são carregados enquanto a mensagem é confeccionada.</p>
<h3 id="servidor">Servidor</h3>
<p>Do lado dos servidores há diversas possibilidades de uso de threads para aumentar o paralelismo no processamento de requisições, melhor utilizando recursos disponíveis e melhorando a experiência do usuário.</p>
<h4 id="single-threaded">Single-threaded</h4>
<p>A estratégia mais simples de se implementar é a de usar apenas um thread, como temos feito até agora.
Considere um servidor Web com esta esta característica; o fluxo no tratamento de uma requisição é exemplificado na pela figura a seguir:</p>
<p><img alt="Single Threaded" src="../images/singlethreadedserver.gif" /></p>
<ol>
<li>O servidor é iniciado, criando o socket e invocando accept</li>
<li>o cliente envia a requisição para o servidor</li>
<li>o servidor aceita a conexão em seu único thread</li>
<li>uma tarefa é gerada para ler o arquivo</li>
<li>o arquivo é lido, de forma bloqueante, e uma resposta para o cliente é preparada</li>
<li>a resposta é enviada para o cliente, de forma bloqueante</li>
<li>a requisição é descartada</li>
<li>o thread do servidor volta a esperar uma nova requisição</li>
</ol>
<p>Se novas requisições forem recebidas enquanto o servidor está executando os passos de 2 a 6, sejam requisições paralelas do mesmo cliente ou de um outro cliente, estas ficarão bloqueadas. 
A espera será maior quanto mais o servidor demorar para atender à primeira requisição, por exemplo, se precisar consultar um banco de dados ou carregar o arquivo requisitado do disco.
Para evitar que isto ocorra, o servidor pode usar mais threads.</p>
<h4 id="thread-per-request">Thread per request</h4>
<p>O servidor pode criar um novo thread para cada nova requisição, permitindo que múltiplas requisições sejam tratadas concorrentemente.
Isto é, mesmo que um thread do servidor seja bloqueado por muito tempo, somente um cliente terá sua resposta atrasada (excluindo-se necessidades de coordenação entre múltiplos threads) e outros clientes podem continuar sendo atendidos normalmente, como mostrado na figura a seguir.</p>
<p><img alt="Multi Threaded" src="../images/multithreadedserver.gif" /></p>
<p>Lembre-se, entretanto, que o número de threads que se pode criar em um SO é limitado, pois cada thread usa recursos do SO. 
Além disso, a criação e destruição de threads é cara pois é feita por meio de uma chamada de sistema, pelo kernel, e portanto implica em alternar entre modo usuário e modo protegido.
Se possível, devemos evitar a criação de novos threads em aplicações com requisitos de desempenho, e recliclá-los pode ser uma boa estratégia.</p>
<h4 id="thread-pool">Thread pool</h4>
<p>Para reciclarmos threads, podemos criar <em>pools</em>, um balde de threads que são usados quando necessário e devolvidos para o balde quando não mais.
No cerne desta abordagem, junto com o <em>pool</em> de threads, fica uma fila bloquenante na qual tarefas são inseridas e de onde os threads tentam retirá-las.</p>
<p>Como a fila é bloqueante, se estiver vazia, o thread é bloqueado e para de consumir recursos. Tão logo nova tarefa seja inserida, a fila acorda os threads para que a processem. Para garantir a corretude no processamento, a fila deve ser <strong>thread-safe</strong>, isto é, que se mantem correta mesmo quando múltiplos threads operam nela tanto para inserir quanto remover tarefas.</p>
<p>Na figura, um thread principal é encarregado de receber as requisições e colocar na fila bloqueante; se a fila fica cheia, o thread principal fica bloqueado esperando por espaço, fazendo com que novas conexões tenham que esperar.</p>
<p><a href="https://www3.nd.edu/~dthain/courses/cse30341/spring2009/project4/project4.html"><img alt="Pool Threaded" src="../images/poolthreadedserver.gif" /></a></p>
<p>Os threads do pool removem uma tarefa da fila, a tratam e, ao final do atendimento,  pegam nova requisição na fila, em um loop infinito; requisições que demandam menor processamento liberam o thread mais rapidamente para que pegue nova tarefa.
Se todas as tarefas são pequenas, os threds ficarão bloqueados por muito tempo. Se todas são grandes, as tarefas se acumularão na fila.
Por isso é importante dimensionar bem o tamanho to <em>pool</em>, ou mesmo torná-lo dinâmico para que use menos recursos (threads) quando não necessário e não deixe tarefas pendentes por muito tempo. </p>
<p>Se considerarmos que cada tarefa na verdade tem várias partes, 
é possível refinar mais este modelo, quebrando o processamento em vários pools.</p>
<h4 id="estagios">Estágios</h4>
<p>Na arquitetura baseada em estágios, e.g.,  <strong>Staged Event-Driven Architecture</strong>, SEDA, cada <strong>estágio</strong>, cada estágio é responsável por processar uma parte da tarefa, passada adiante até que seja completada.<sup id="fnref:seda"><a class="footnote-ref" href="#fn:seda">11</a></sup></p>
<p><a href="http://images.cnitblog.com/blog/13665/201306/15180500-a54c8eb3d73246469f1b74ee74f2119b.png"><img alt="Seda" src="../images/seda1.png" /></a></p>
<p>Uma característica importante deste modelo é que cada estágio pode ser escalado individualmente de acordo com a demanda uma vez que cada estágio tem seu próprio <em>pool</em>. Por exemplo, se um estágio faz algum cálculo leve, então poucos <em>threads</em> são necessários ao mesmo. Já um estágio que precise efetuar E/S talvez precise mais <em>threads</em>, uma vez que estes ficam bloqueandos enquanto a operação é executada. <sup id="fnref:ioasync"><a class="footnote-ref" href="#fn:ioasync">12</a></sup></p>
<p><a href="http://images.cnitblog.com/blog/13665/201306/15180500-a54c8eb3d73246469f1b74ee74f2119b.png"><img alt="Seda" src="../images/seda2.png" /></a></p>
<h3 id="desafios">Desafios</h3>
<p>Embora a ideia de usar múltiplos threads seja melhorar desempenho e experiência do usuário, fazê-lo efetivamente é não trivial.
Vejamos por exemplo o problema do falso compartilhamento; considere o seguinte pseudo-código:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">...</span>
<span class="n">int32</span> <span class="n">X</span><span class="p">;</span>
<span class="n">int32</span> <span class="n">Y</span><span class="p">;</span>

<span class="n">thread1</span> <span class="o">=</span> <span class="n">tread_new</span><span class="p">(</span><span class="n">threadfunction</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">);</span>
<span class="n">thread2</span> <span class="o">=</span> <span class="n">tread_new</span><span class="p">(</span><span class="n">threadfunction</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Y</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">threadfunction</span><span class="p">(</span><span class="n">int32</span> <span class="o">*</span> <span class="n">exclusivo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">int32</span> <span class="n">local</span> <span class="o">=</span> <span class="o">*</span><span class="n">exclusivo</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">local</span> <span class="o">=</span> <span class="n">processa</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
        <span class="o">*</span><span class="n">exclusivo</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">...</span>
</code></pre></div>
</td></tr></table>
<p>Cada um dos threads criados acessa exclusivamente uma das variáveis. Logo, não há interferência entre as threads e se cada uma for colocada em um processador diferente, executarão no máximo de seu potencial, correto?
Não exatamente, pois mesmo este código simplíssimo podemos sofrer de <a href="https://dzone.com/articles/false-sharing">falso compartilhamento</a>.
Isto acontece, por exemplo, se cada linha da cache do sistema onde este programa executa tiver 8 ou mais bytes de comprimento. Como tanto <code>X</code> quanto <code>Y</code> no programa tem 4 bytes, as duas variáveis poderão ficar na mesma linha da cache e toda vez que uma thread modificar uma variável a cache da outra será invalidada para leitura.</p>
<p><img alt="Multithreaded" src="../images/cache-line.png" /></p>
<p>Para que isto não ocorra, é preciso se certificar que as variáveis fiquem em linhas diferentes da cache; no exemplo, poderia-se definir X e Y como vetores do tamanho da linha da cache e usar efetivamente apenas a primeira posição de cada vetor.</p>
<p>Se o compartilhamento for real, por exemplo se ambos os threads usarem a variável X, então o problema não será tão facilmente resolvível.
Neste caso, poder-se-ia definir afinidade entre threads, isto é, notar quais threads compartilham estado de forma que threads afins sejam colocados nos mesmos processadores e compartilhem as mesmas memórias. 
Isto torna muito mais fácil e eficiente o controle de concorrência, do ponto de vista do SO e hardware.</p>
<p><img alt="Multithreaded" src="../images/multithread2.png" /></p>
<details class="- info inline end"><summary>Multiprogramação</summary><p><img alt="Multithreaded" src="../images/multithreaded.jpg" /></p>
</details>
<p>Fazer esta divisão pode ser complicado pois a relação de compartilhamento entre threads pode ser complexa em função da tarefa sendo resolvida, por exemplo, se diferentes threads compartilharem diferentes variáveis uns com os. Ainda que que uma configuração ótima em termos de afinidade exista, encontrá-la pode ser custo.
Ainda assim, precisamos lidar com estado compartilhado e enfrentar condições de corrida de forma a não levar a <strong>inconsistências</strong> na executação de tarefas, nos referindo a inconsistência aqui como qualquer desvio no comportamento do programa daquilo que foi especificado pelo desenvolvedor.
Para isso, usamos as primitivas de controle de concorrência que estudaram em SO, que também tem seus problemas em potencial, como <strong>deadlocks</strong> e <strong>inanição</strong>.
Veja o seguinte vídeo para uma análise de diversos pontos importantes no uso de multithreads.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/JRaDkV0itbM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<h3 id="estado">Estado</h3>
<p>A questão das regiões críticas está intimamente relacionada à questão da manutenção de estado nos servidores.
Quanto a este respeito, podemos classificar servidores como <strong>stateful</strong> e <strong>stateless</strong>, dois termos que ouvirão frequentemente enquanto trabalhando com SD.</p>
<details class="- info inline end"><summary>To state or not to state?</summary><ul>
<li>Complexidade e desempenho</li>
<li>Falhas</li>
<li>Balanceamento</li>
</ul>
</details>
<p>O "state" nos dois nomes se refere ao estado mantido por um serviço para atender a requisições.
Caso mantenha estado, por exemplo informando em quais arquivos o cliente está interessado, fica mais fácil para o servidor continuar o trabalho feito em requisições anteriores.
Imagine por exemplo que um cliente esteja acessando linhas em um banco de dados, de forma paginada: a cada requisição, o cliente recebe <span class="arithmatex">\(n\)</span> novas linhas para processar e, quando estiver pronto, requisite <span class="arithmatex">\(n\)</span> novas linhas.
Imagine quão infeficiente seria se o servidor seguisse o seguinte fluxo:</p>
<ol>
<li>receba requisição informando a última linha lida</li>
<li>recalcule todas as respostas para consulta</li>
<li>salte até a linha informada pelo cliente</li>
<li>retorne as próximas <span class="arithmatex">\(n\)</span> linhas para o cliente</li>
<li>feche o resultado da consulta.</li>
</ol>
<p>Se em vez disso o servidor mantiver um mapa com consultas recentes, em que a chave seja algum identificador do cliente e o valor uma <em>visão</em>  dos resultados; a cada nova requisição, basta o servidor resgatar a visão usando o identificador do cliente e selecionar as seguintes <span class="arithmatex">\(n\)</span> entradas da visão. Manter o mapa como estado acelera o processamento e melhora a experiência do usuário, neste caso.
Por outro lado, considere que múltiplos clientes fazem consultas concorrentemente: quanto recurso seria necessário para que o servidor mantenha a visão de todos os clientes?</p>
<p>Também a complexidade do servidor aumenta. Considere as algumas de muitas perguntas possíveis neste cenário:</p>
<ul>
<li>Como o servidor mantém as respostas a novas requisições consistentes com as respostas anteriores? E se linhas são removidas ou inseridas no banco de dados?</li>
<li>Se múltiplos servidores existem, como compartilhar os estado entre os mesmos?</li>
<li>Se o cliente resolva não fazer mais requisições, por exemplo por ter encontrado o que procurava, por quanto tempo o servidor deve manter a visão aberta?</li>
</ul>
<p>Você já deve ter adivinhado que no primeiro exemplo temos um servidor <em>stateless</em> e no segundo um <em>stateful</em>, e percebido que cada um tem suas vantagens e desvantagens.
Vejamos mais algumas.</p>
<h4 id="sessao">Sessão</h4>
<p>Essencialmente, o servidor <em>stateless</em> não mantem informação sobre a sessão do cliente e requer que a cada nova requisição, quaisquer informações necessárias para realizar a tarefa requisitada sejam novamente fornecidas ao servidor.
No caso <em>stateful</em>, o servidor pode se lembrar, como no exemplo anterior, até onde o trabalho já foi executado, quais arquivos o cliente manipulou (e mantê-los abertos), qual o endereço o cliente e enviar-lhe notificações importantes (e.g., "Novo dado inserido!").</p>
<h4 id="falhas_1">Falhas</h4>
<p>Enquanto servidores <em>stateful</em> obviamente levam a melhor desempenho no <em>happy path</em> (contanto que recursos suficientes sejam providos), no caso de falhas, serviços <em>stateless</em> tendem a voltar ao ar mais rapidamente, uma vez que não há estado que precise ser recuperado.
Pela mesma razão, clientes que percebem que um servidor falhou podem rapidamente se dirigir a outros servidores e continuar suas requisições de onde estavam, uma vez que são detentores de toda a informação necessária para o próximo passo do processamento.</p>
<p>Lidar com falhas também introduz outro requisito aos servidores: memória estável.
Para que possa o recuperar o estado anterior à falha, o servidor precisa colocar o estado em algum lugar que independa do processo para se manter, por exemplo,
<a href="https://en.wikipedia.org/wiki/Non-volatile_random-access_memory">nvRAM</a>, <a href="https://en.wikipedia.org/wiki/Solid-state_drive">SSD</a> ou <a href="https://en.wikipedia.org/wiki/Hard_disk_drive#Spindle">spindles</a>.
A perda deste estado implicaria na incapacidade de prover o serviço corretamente.
Um projeto <em>stateless</em> não depende deste estado e por isso pode ser mais rapidamente recuperado, replicado ou substituído.</p>
<h4 id="stateless-x-stateful">Stateless x Stateful</h4>
<p>Não surpreendentemente, a resposta para "qual abordagem é melhor, <em>stateful</em> ou <em>stateless</em>?" é <strong>depende</strong>.
Ambos as opções tem suas vantagens e desvantagens e para algums serviços apenas uma opção será viável.
Se seu serviço precisa manter estado (um SGBD, por exemplo), ele terá que manter estado, mesmo que não sobre clientes.
Veja um pequeno comparativo das características das duas abordagens.</p>
<table>
<thead>
<tr>
<th>Stateless</th>
<th>Stateful</th>
</tr>
</thead>
<tbody>
<tr>
<td>Resultado depende da entrada</td>
<td>Depende do histórico de entradas</td>
</tr>
<tr>
<td>Qualquer servidor pode atender</td>
<td>Mesmo servidor deve atender</td>
</tr>
<tr>
<td>Não promete notificar o cliente</td>
<td>Assina contrato com o cliente</td>
</tr>
<tr>
<td>Repete operações</td>
<td>Aproveita resultados anteriores</td>
</tr>
<tr>
<td>Não fica inconsistente com relação ao cliente</td>
<td>Pode ficar inconsistente se perder estado ou conexão feita com outro servidor</td>
</tr>
<tr>
<td>re-autenticação (mesmo que simplficada) a cada requisição</td>
<td>Autentica no começo da sessão</td>
</tr>
</tbody>
</table>
<h3 id="multithread-na-pratica">Multithread na prática</h3>
<h4 id="posix">POSIX</h4>
<p><a href="https://en.wikipedia.org/wiki/POSIX_Threads">POSIX Threads</a> ou PThreads, são uma definição <strong>aberta</strong> de como <em>threads</em> devem funcionar em sistemas operacionais.
Várias implementações desta especificação estão disponíveis tanto para sistemas Unix, que se esforçam para ser compatíveis com especifições POSIX, mas também para Windows, via subsistemas que compatibilizam diferentes API.
Além disso, mesmo implementações não POSIX tem funcionalidade equivalentes e, por este motivo, entender POSIX servirá de base para entender quaisquer API para programação <em>multi-threaded</em>.</p>
<p>Para se definir um <em>thread</em>, é necessário definir uma função de entrada, que será para o <em>thread</em> como a função <code>main</code> é para o processo em si.
No exemplo a seguir a função foi definida com retorno <code>void *</code> e com único parâmetro, também <code>void *</code>; esta é uma obrigatoriedade para funções de entrata PThread.
Observe contudo que <code>void *</code> pode ser tratado como um blob para mascarar outros tipos de dados, por exemplo um vetor, um ponteiro para uma enumeração ou uma <code>struct</code>.
Também observe que a função tem uma variável local <code>my_id</code> que só está definida no contexto da thread (linha 8); se múltiplas <em>threads</em> forem instanciadas, cada uma terá a sua versão da variável. 
Há também uma variável global <code>thread_count</code>, compartilhada por todas as instâncias (linha 5).</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">thread_count</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">hello</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="n">my_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello from thread %ld of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">my_id</span><span class="p">,</span> <span class="n">thread_count</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Um <em>thread</em>  é criado pela função <code>pthread_create</code> (linha 14), que coloca em um <code>pthread_t</code> um <em>handle</em> para o <em>thread</em>.
O <em>handle</em> do <em>thread</em> deve ser alocado previamente à função de criação do <em>thread</em> (linha 11).
A função recebe como parâmetros opções para configuração, a função de entrada, e o parâmetro do tipo <code>void *</code>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="kr">thread</span><span class="p">;</span>
    <span class="n">pthread_t</span><span class="o">*</span> <span class="n">thread_handles</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: %s &lt;number of threads&gt;&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> 
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">thread_count</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">thread_handles</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">thread_count</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pthread_t</span><span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">thread</span> <span class="o">&lt;</span> <span class="n">thread_count</span><span class="p">;</span> <span class="kr">thread</span><span class="o">++</span><span class="p">)</span>
        <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_handles</span><span class="p">[</span><span class="kr">thread</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hello</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="kr">thread</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello from the main thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>É possível esperar pelo fim da execução do <em>thread</em> usando o <code>pthread_join</code>, que recebe como parâmetro o <em>handle</em> do <em>thread</em> e um ponteiro para onde o resultado da função de entrada deve ser colocado, do tipo <code>void **</code> (linha 2). No exemplo, nenhum retorno é esperado, então um endereço nulo é passado como parâmetro.
Ao final da execução, o <em>handle</em> deve ser liberado (linha 4).</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="k">for</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">thread</span> <span class="o">&lt;</span> <span class="n">thread_count</span><span class="p">;</span> <span class="kr">thread</span><span class="o">++</span><span class="p">)</span>
        <span class="n">pthread_join</span><span class="p">(</span><span class="n">thread_handles</span><span class="p">[</span><span class="kr">thread</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">free</span><span class="p">(</span><span class="n">thread_handles</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>Para executar um programa PThread, compile com
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>gcc -pthread teste.c -o teste
</code></pre></div>
</td></tr></table>
e execute com
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./teste <span class="m">5</span>
</code></pre></div>
</td></tr></table>
e observe que a saída das threads é <em>ordenada</em>. </p>
<p>Agora experimente
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./teste <span class="m">200</span>
</code></pre></div>
</td></tr></table>
Observe que a saída é desordenada (pode ser necessário executar múltiplas vezes ou aumentar de 200 para, digamos, 1000 para observar a desordem.
Isto acontece porquê a execução das threads independe da ordem de criação.
De fato, usando PThreads, temos pouco controle sobre os threads que criamos. 
Mas isto não quer dizer que estamos "órfãos" de API; várias outras operações podem ser executadas, e podem ser encontradas a partir do <a href="http://man7.org/linux/man-pages/man3/pthread_create.3.html">manual de <code>pthread_create</code></a>. Alguns exemplos interessantes:</p>
<ul>
<li><code>pthread_tryjoin</code> - espera thread terminar</li>
<li>
<p><code>pthread_exit</code> - termina a thread e retorna resultado </p>
<blockquote>
<p>An implicit call to <code>pthread_exit()</code> is made when a thread other than the thread in which <code>main()</code> was first invoked returns from the start routine that was used to create it. The function's return value serves as the thread's exit status. <a href="http://man7.org/linux/man-pages/man3/pthread_exit.3.html">Manual de <code>pthread_exit</code></a>.</p>
</blockquote>
</li>
<li>
<p><code>pthread_attr_setaffinity_np</code> - ajusta afinidade dos threads.</p>
</li>
</ul>
<h4 id="python">Python</h4>
<p>Em Python, como seria de se esperar, há várias formas de se trabalhar com <em>threads</em>. 
O exemplo a seguir usa o pacote <code>thread</code> e é essencialmente um envólucro POSIX.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">thread</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Define a function for the thread</span>
<span class="k">def</span> <span class="nf">print_time</span><span class="p">(</span> <span class="n">threadName</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
   <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
      <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">threadName</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="p">)</span>

<span class="c1"># Create two threads as follows</span>
<span class="k">try</span><span class="p">:</span>
   <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span> <span class="n">print_time</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Thread-1&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
   <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span> <span class="n">print_time</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Thread-2&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
   <span class="nb">print</span> <span class="s2">&quot;Error: unable to start thread&quot;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
   <span class="k">pass</span>
</code></pre></div>
</td></tr></table>
<p>Já o próximo exemplo usa o pacote <code>threading</code> e uma abordagem orientada a objetos. Observe que há momentos distintos no ciclo de vida do thread em que acontece a criação e o início da execução.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">exitFlag</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">myThread</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threadID</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>
      <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">threadID</span> <span class="o">=</span> <span class="n">threadID</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span>
   <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="nb">print</span> <span class="s2">&quot;Starting &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
      <span class="n">print_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
      <span class="nb">print</span> <span class="s2">&quot;Exiting &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

   <span class="k">def</span> <span class="nf">print_time</span><span class="p">(</span><span class="n">threadName</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
      <span class="k">while</span> <span class="n">counter</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">exitFlag</span><span class="p">:</span>
            <span class="n">threadName</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
         <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
         <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threadName</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
         <span class="n">counter</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="c1"># Create new threads</span>
<span class="n">thread1</span> <span class="o">=</span> <span class="n">myThread</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Thread-1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">thread2</span> <span class="o">=</span> <span class="n">myThread</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Thread-2&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Start new Threads</span>
<span class="n">thread1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">thread2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="nb">print</span> <span class="s2">&quot;Exiting Main Thread&quot;</span>
</code></pre></div>
</td></tr></table>
<p>Uma consequência desta divisão é que um mesmo objeto do tipo <code>Thread</code> pode ser reciclado e executado várias vezes.</p>
<h4 id="java">Java</h4>
<p>Outro exemplo importante de API para multithreading é a do Java, pois nesta linguagem há, essencialmente, duas formas de se conseguir concorrência. 
A primeira é via instâncias explícitas da classe <code>Thread</code> e, a segunda, via abstrações de mais alto nível, os <code>Executors</code>.
Aqui nos focaremos em aspectos básicos de concorrência na linguagem, mas esteja ciente de que a mesma é muito rica neste tópico, por exemplo provendo diversas estruturas para comunicação e coordenação de <em>threads</em> no pacote <code>java.util.concurrent</code>.
Uma ótima documentação sobre o uso de <em>threads</em> e estruturas é dispobinilizada pela <a href="https://docs.oracle.com/javase/tutorial/essential/concurrency/">Oracle</a>.</p>
<p>Há duas formas básicas de definir um novo <em>thread</em> em Java, ou via extensão da classe <code>Thread</code> ou via implementação da interface <code>Runnable</code>; observe o quão pouco muda no código dos exemplos a seguir.
Note também que, nos dois exemplos, um método <code>run()</code> é implementado com o código a ser executado pelo <em>thread</em> mas que em nenhum momento tal método é invocado diretamente.
Em vez disto, o método <code>start()</code> é que é invocado, porquê antes de executar as instruções definidas pelo pelo programador no método <code>run()</code>,
a máquina virtual precisa executar alguma "mágica" por baixo dos panos como, por exemplo, solicitar ao sistema operacional a criação de um <em>thread</em> do SO, que servirá de hospedeiro para o <em>thread</em> Java. 
Isto acontece dentro do <code>start()</code>, que em algum ponto de sua execução levará à invocação do método <code>run()</code>.</p>
<div class="tabbed-set" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">Thread</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello from a thread!&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hello</span><span class="p">();</span>
        <span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">Runnable</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello from a thread!&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Hello</span><span class="p">());</span>
        <span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Além de servider base para outras classes, a classe <code>Thread</code> também provê uma série de métodos que permitem gerenciar a vida dos <em>threads</em> criados.
Por exemplo, o método de classe <code>Thread.sleep()</code> permite bloquear o thread no qual a invocação aconteceu por um determinado período.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">){</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello at instant &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;awoken&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Hello</span><span class="p">());</span>
        <span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Observe que a chamada a <code>sleep()</code> deve estar dentro de um bloco <code>try/catch</code>, pois é permitido à JVM acordar o <em>thread</em> em qualquer instante, antes ou após o tempo especificado. 
Assim, embora normalmente o tempo "dormido" seja próximo ao especificado, se há requisitos de precisão, é sugerido que a <em>thread</em> durma em pequenas frações até chegar ao valor total e que, ao acordar, verifique se já não dormiu o suficiente.
No exemplo seguinte, o <em>thread</em> dorme por pelo menos 1000 milissegundos a cada iteração.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">){</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello at instant &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
            <span class="kt">long</span> <span class="n">before</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
            <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span><span class="n">before</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()){</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">before</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">)));</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;awoken&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Hello</span><span class="p">());</span>
        <span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Quando um <em>thread</em> está sendo executado, outros podem ter que esperar até que complete. Por exemplo, no caso de um navegador
Web, o <em>thread</em> que faz a renderização da página não pode começar a trabalhar enquanto o <em>thread</em>  que solicitou o HTML
do servidor não receber sua resposta. Um <em>thread</em> indica a intenção de esperar por outro usando o método <code>join()</code>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">){</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello at instant &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
            <span class="kt">long</span> <span class="n">before</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
            <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">901</span> <span class="o">+</span> <span class="n">rand</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
            <span class="k">while</span><span class="p">(</span><span class="n">before</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()){</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">before</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">)));</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;awoken&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Hello</span><span class="p">());</span>
        <span class="c1">//t.setDaemon(true);</span>
        <span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">t</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
            <span class="c1">//t.join(10000);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Waiting was interrupted&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">isAlive</span><span class="p">())</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Got tired of waiting&quot;</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Wait is over&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Invocar <code>t.join()</code> fará com que o <em>thread</em> corrente, neste caso o principal, espere indefinidamente até que <code>t</code> termine de executar.
Caso seja necessário limitar o tempo de espera, um limite pode ser especificado como na linha comentada.
Caso a espera termine por causa de um <em>timeout</em>, é possível testar o estado atual do thread com <code>Thread.isAlive()</code>.</p>
<p>Outro método interessante, <code>Thread.setDaemon()</code>, especifica que o <em>thread</em> pode ser terminado quando a <em>thread</em> principal terminar. Descomente a invocação e teste o efeito.</p>
<div class="admonition question">
<p class="admonition-title">Exercício: contador</p>
<p>Façamos um exercício simples do uso de <em>threads</em>. Considere a classe e siga as instruções abaixo.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">Counter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">++</span><span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">decrement</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">--</span><span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">value</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Instancie um programa que gere 10 <em>threads</em>. </li>
<li>Todos os <em>threads</em> devem compartilhar <strong>uma mesma instância</strong> de <code>Counter</code></li>
<li>Cada <em>thread</em> deve executar um <em>loop</em> em que incrementa o valor do contador 20 vezes </li>
<li>a cada vez, imprime o resultado precedido do identificador do <em>thread</em> (use <code>Thread.getName()</code> ou <code>Thread.currentThread().getName()</code>)</li>
<li>A <em>thread</em>  principal deve esperar todas as outras terminarem antes de terminar (use <code>Thread.join()</code>).</li>
<li>Analise a saída do programa observando a ordem de execução dos <em>threads</em>.</li>
</ul>
<details class="note"><summary>Análise</summary><p>É fácil observar que a saída do programa é aleatória nos identificadores e tende a ser incremental nos contadores, mas nem sempre isso é verdade. Isso acontece porquê a execução dos <em>threads</em> é não determinística; uma vez que estejam prontos para executar, cabe ao escalonador do sistema operacional a decisão sobre qual processo e em qual processador deverá executar.</p>
</details>
</div>
<p>Além de extensão de <code>Thread</code> e implementação de <code>Runnable</code>, Java disponibiliza também <code>ExecutorService</code> como abstração de mais alto nível para execução de tarefas concorrentes.
Os <code>ExecutorService</code>, de forma genérica, provê o acesso a <em>pools</em> de <em>thread</em> e a API para submeter tarefas para este pool.
Para iniciar tal processo, você pode criar um executor service usando uma das muitas fábricas providas pela classe <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Executors.html"><code>Executors</code></a> ou pela instanciação de <em>thread</em> <em>pools</em>  diretamente.
O mais simples é o de tamanho fixo em que há um número inicial de <em>threads</em> criados e que, no caso de algum ser terminado, por exemplo por causa de uma exceção não tratada, cria substitutos para manter o número constante.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">ExecutorService</span> <span class="n">es1</span> <span class="o">=</span> <span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">ExecutorService</span> <span class="n">es2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="n">L</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">,</span> <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">());</span>
</code></pre></div>
</td></tr></table>
<p>Uma vez criado o executor, você atribui tarefas para serem executadas, que devem implementar <code>Runnable</code> ou <code>Callable</code>.
No caso de <code>Runnable</code>, você pode usar o método <code>execute</code> para executá-las em algum momento, sem a possibilidade de retorno de resultados.</p>
<div class="tabbed-set" data-tabs="2:3"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">Implements</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">MyRunnable</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;R0&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyRunnable</span><span class="p">();</span>

<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es2</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><label for="__tabbed_2_2">Anônimo</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;R1&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es2</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><label for="__tabbed_2_3">Lambda</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;R2&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es2</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Já usando <code>Callable</code>, é possível retornar resultados na forma de <code>Future&lt;T&gt;</code>. No exemplo a seguir, a <code>c</code> retorna um <code>Integer</code>, e portanto <code>submit</code> retorna <code>Future&lt;Integer&gt;</code>; para acessar o resultado, use <code>Future&lt;&gt;.get()</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Callable</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;C1&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">es1</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

<span class="cm">/* Outras tarefas... */</span>

<span class="kt">int</span> <span class="n">resultado</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>Outros métodos interessantes dos <code>ExecutorService</code> são <code>invokeAny()</code> e <code>invokeAll()</code>, que permitem passar uma lista de tarefas e retornam o resultado de qualquer tarefa ou implica na execução de todas, respectivamente.</p>
<p>Alguns executores são interessantes por razões diferentes. Primeiro, o <code>ForkJoinPool</code> é um executor interessante por funcionar da seguinte forma: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>if (my portion of the work is small enough)
  do the work directly
else
  split my work into two pieces
  invoke the two pieces and wait for the results
</code></pre></div>
</td></tr></table>
<p>Segundo, os <code>ScheduledExecutorService</code> permitem a execução agendada ou periódica de tarefas, por exemplo:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">ScheduledExecutorService</span> <span class="n">es3</span> <span class="o">=</span> <span class="n">Executors</span><span class="p">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="p">();</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">executorService</span><span class="p">.</span><span class="na">schedule</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span>
<span class="c1">//Executa a cada 5 segundos, depois de esperar por 1 segundo para começar. </span>
<span class="n">executorService</span><span class="p">.</span><span class="na">scheduleAtFixedDelay</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span>
<span class="c1">//Como a anterior, mas pode atrasar a próxima invocação para permiter à anterior que termine.</span>
<span class="n">executorService</span><span class="p">.</span><span class="na">scheduleAtFixedRate</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<h4 id="coordenacao">Coordenação</h4>
<p>Como visto no exercício anterior, a execução de <em>threads</em> é não determinística. Contudo, estas execuções frequentemente precisam ser coordenadas para que não pisem uns nos calcanhares dos outros, por exemplo, decidindo quem deve ser o próximo a entrar em uma região crítica ou será o responsável por uma determinada tarefa. </p>
<p>Há várias astrações que podem ser usadas para coordenar as operações de <em>threads</em>, como deve se lembrar no estudo de Sistemas Operacionais. Alguns exemplos são <em>locks</em>, variáveis de condição e semáforos.</p>
<p>Especificamente em Java, provavelmente a abstração mais simples são os blocos <code>synchronized</code>.</p>
<h6><code>synchronized</code></h6>
<p>Ao definir métodos como <code>synchronized</code>, garante-se que os mesmos nunca serão executados concorrentemente. 
Observe a classe a seguir, que modifica o contador do exercício anterior.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SynchronizedCounter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">++</span><span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">decrement</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">--</span><span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">value</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Caso dois <em>threads</em> invoquem os métodos <code>increment</code> e <code>decrement</code> ao mesmo tempo, por exemplo, a JVM fará com que um dos <em>threads</em> pare sua execução até que o outro tenha completado a invocação.
Isto não quer dizer que executar o exercício anterior com esta versão do contador levará a saídas com incrementos completamente sequenciais, pois um <em>thread</em>  poderia parar de ser executado logo após incrementar o contador, depois de terminado o método <code>increment</code>, e só voltar a executar depois que outro tenha incrementado e impresso na tela o valor obtido. 
O que quer dizer é que, mesmo que saídas estranhas existam, cada método foi executada integralmente antes da operação seguinte.</p>
<div class="admonition question">
<p class="admonition-title">Exercício: synchronized</p>
<p>Modifique o código do exercício anterior para usar a versão <code>synchronized</code> do contador. Depois de executá-lo, adicione um <code>println("Dentro: " + c)</code> <strong>dentro</strong> do método de incremento para verificar que estas saídas acontecem ordenadamente.</p>
</div>
<p><code>synchronized</code> funciona porquê limita a concorrência, mas é problemático exatamente pela mesma razão. 
Por isso, é essencial que o <code>synchronized</code> seja o mais limitado possível em termos de escopo, o que nos leva ao uso de <code>synchronized</code> em blocos de código menores que métodos. Por exemplo:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Namer</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">lastName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nameCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">lastName</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
        <span class="kd">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">nameCount</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">nameList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Neste caso, blocos sincronizados <strong>no mesmo objeto</strong>, não são executados concorrentemente, mas outros blocos sim.</p>
<div class="admonition question">
<p class="admonition-title">Exercício: bloco synchronized</p>
<p>Neste exercício, use dois objetos para travar o acesso a dois contadores. Instancie um programa com dois <em>threads</em>  tal que:</p>
<ul>
<li>executem um loop 1000 vezes em que</li>
<li>o primeiro <em>thread</em> primeiro invoca <code>inc1</code> e depois <code>inc2</code></li>
<li>o segundo <em>thread</em> primeiro invoca <code>inc2</code> e depois <code>inc1</code></li>
<li>ambos os threads imprimem o valor de <code>c1</code> e <code>c2</code></li>
</ul>
<details class="tip"><summary>Análise</summary><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MsLunch</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">c1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">c2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Object</span> <span class="n">lock1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span>
    <span class="kd">private</span> <span class="n">Object</span> <span class="n">lock2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inc1</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">synchronized</span><span class="p">(</span><span class="n">lock1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">c1</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inc2</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">synchronized</span><span class="p">(</span><span class="n">lock2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">c2</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</details>
</div>
<h6>Sinalização</h6>
<p>Usados corretamente, o bloco <code>synchronized</code> é executado de forma atômica, isto é, indivisível.
Algumas operações muito simples são naturalmente atômicas, e não precisam ser "protegidas" pelo <code>synchronized</code>.
Por exemplo, leituras e escritas de tipos básicos como <code>int</code>, <code>char</code> e <code>byte</code>, mas não <code>long</code> ou <code>double</code>, pois usam mais de uma palavra em algumas arquiteturas, ou variáveis declaradas <code>volatile</code>.
Usando estas variáveis, é possível coordenar <em>threads</em>, como no exemplo a seguir.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">boolean</span> <span class="n">condicao</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="p">...</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">espereCondicao</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">condicao</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;condicao alcancada.&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">satisfacaCondicao</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">condicao</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Embora correta, esta abordagem, conhecida como <strong>espera ocupada</strong>, não é eficiente pois desperdiça computação.
Felizmente, em Java, todos os objetos implementam os métodos <code>wait</code> e <code>notify/notifyAll</code>, que podem ser usados para sincronizar eficientemente <em>threads</em>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sync</span><span class="p">{</span>
   <span class="n">Object</span> <span class="n">synch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span>
   <span class="kt">boolean</span> <span class="n">condicao</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">espereCondicao</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">condicao</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">try</span> <span class="p">{</span>
             <span class="kd">synchronized</span><span class="p">(</span><span class="n">synch</span><span class="p">){</span>
                 <span class="n">synch</span><span class="p">.</span><span class="na">wait</span><span class="p">();</span>
             <span class="p">}</span>
         <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
      <span class="p">}</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Condicao alcancada&quot;</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">...</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">satisfacaCondicao</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">condicao</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="kd">synchronized</span><span class="p">(</span><span class="n">synch</span><span class="p">){</span>
          <span class="n">synch</span><span class="p">.</span><span class="na">notifyAll</span><span class="p">();</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Neste exemplo a execução da função <code>espereCondicao</code> é "pausada" por <code class="highlight"><span class="n">synch</span><span class="p">.</span><span class="na">wait</span><span class="p">()</span></code> até que uma notificação seja enviada via <code class="highlight"><span class="n">sync</span><span class="p">.</span><span class="na">notifiyAll</span><span class="p">()</span></code>, na função <code class="highlight"><span class="n">satisfacaCondicao</span><span class="p">()</span></code>.
Observe que estas operações só podem ocorrer dentro de blocos sincronizados na variável usada na sinalização.</p>
<h6><em>Locks</em></h6>
<p>Outras abstrações para coordenação de <em>threads</em> estão disponíveis no pacote <code>java.util.concurrent</code>. 
As mais simples delas são <code>java.util.concurrent.locks.Lock</code> e <code>java.util.concurrent.locks.ReentrantLock</code>. 
Veja um exemplo de uso, notando o idioma de uso dentro de block <code>try/catch/finally</code>, que garante que o <em>lock</em> será liberado a despeito de exceções no bloco.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Lock</span> <span class="n">l</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="p">();</span>
  <span class="n">l</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span>
  <span class="k">try</span> <span class="p">{</span>
     <span class="c1">// access the resource protected by this lock</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
     <span class="n">l</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Como bem sabido, o uso dos "locks" em ordens diferentes pode levar a um <em>deadlock</em> pois um ciclo de dependências pode ser formado entre locks, detentores de locks e interessados em locks. O grafo de dependência seguinte exemplifica o cenário, em que o <em>thread</em> T1 obteve o lock2 e tenta obter o lock1, e o <em>thread</em> T2 obteve o lock1 e tenta obter o lock2.</p>
<div class="mermaid">graph LR
      T1 --&gt; lock1 --&gt; T2 --&gt; lock2 --&gt; T1</div>
<h6>Estruturas <em>thread-safe</em></h6>
<p>Finalmente, Java também disponibiliza estruturas de dados que podem ser acessadas concorrentemente por múltiplos <em>threads</em> sem risco de corrupção, denominadas <em>thread-safe</em>.</p>
<ul>
<li><code>BlockingQueue</code> - bloqueia <em>threads</em>  se não houver elementos na fila.</li>
<li><code>ConcurrentMap/ConcurrentHashMap</code> - operações atômicas;</li>
<li><code>if (!m.containsKey(k)) m.put(k,v);</code></li>
<li><code>vOld = m.putIfAbsent(k,v);</code></li>
</ul>
<h6>Tipos Atômicos</h6>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AtomicCounter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">decrement</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="na">decrementAndGet</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">value</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h6>ThreadLocal</h6>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">private</span> <span class="kd">static</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">myId</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
   <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">initialValue</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">Random</span><span class="p">().</span><span class="na">nexInt</span><span class="p">();</span>
   <span class="p">}</span> 
<span class="p">};</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">Integer</span> <span class="nf">getMyId</span><span class="p">()</span> <span class="p">{</span> 
    <span class="k">return</span> <span class="n">myId</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<div class="admonition question">
<p class="admonition-title">Exercício - Anel Multithread</p>
<ul>
<li>Usando uma linguagem de alto-nível como C/C++/Java, escrever um programa que crie 30 threads e faça com que uma mensagem circule entre os mesmos. </li>
<li>A mensagem é uma string aleatória de pelo menos 80 caracteres. </li>
<li>A cada vez que um thread recebe a mensagem ele a imprime, modifica o primeiro caractere minúsculo para maiúsculo, caso exista, dorme por 1 segundo, e repassa a mensagem. </li>
<li>Quando todos os caracteres forem maiúsculos, o processo repassa a mensagem e então termina. </li>
<li>Antes de terminar, o processo deve imprimir a mensagem resultante.</li>
</ul>
</div>
<h2 id="referencias">Referências</h2>
<ul>
<li>
<p>Sockets</p>
<ul>
<li><a href="http://pymotw.com/2/socket/udp.html">UDP em Python</a></li>
<li><a href="http://www.tutorialspoint.com/python/python_networking.htm">UDP em Python</a></li>
<li><a href="lycog.com/programming/multicast-programming-java/">Multicast em Java</a></li>
<li><a href="https://pymotw.com/2/socket/multicast.html">Multicast em Python</a></li>
<li><a href="https://beej.us/guide/bgnet/">Beej's Guide to Network Programming - Using Internet Sockets</a></li>
</ul>
</li>
<li>
<p>Concorrência em Java</p>
<ul>
<li><a href="http://jcip.net/">Java Concurrency in Practice</a></li>
<li><a href="https://www.manning.com/books/the-well-grounded-java-developer">The Well-Grounded Java Developer</a></li>
<li><a href="http://docs.oracle.com/javase/tutorial/essential/concurrency/simple.html">Concorrência em Java</a></li>
<li><a href="http://winterbe.com/posts/2015/04/07/java8-concurrency-tutorial-thread-executor-examples/">Futures e Promises</a></li>
<li><a href="http://winterbe.com/posts/2015/04/30/java8-concurrency-tutorial-synchronized-locks-examples/">Locks</a></li>
<li><a href="http://winterbe.com/posts/2015/05/22/java8-concurrency-tutorial-atomic-concurrent-map-examples/">Tipos Atômicos</a></li>
</ul>
</li>
<li>
<p>Concorrência em Python</p>
<ul>
<li><a href="https://www.tutorialspoint.com/python/python_multithreading.htm">Threads em Python</a></li>
</ul>
</li>
<li>
<p>Estado</p>
<ul>
<li>Uma visão interessante sobre estado é apresentada em <a href="https://leonmergen.com/on-stateless-software-design-what-is-state-72b45b023ba2">On stateless software design</a>. Observe que não necessariamente eu concordo com tudo o que está escrito aqui, principalmente a questão sobre <em>stateful</em> ser sempre mais complexo. A discrepância de visão está no fato de parte da complexidade ser levada para o cliente, no caso dos servidores <em>stateless</em>, mas não necessariamente ser eliminada.</li>
<li><a href="https://www.developer.com/java/data/understanding-asynchronous-socket-channels-in-java.html">Sobre IO não bloqueante em Java.</a></li>
</ul>
</li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:falham">
<p><a href="https://www.statista.com/statistics/430769/annual-failure-rates-of-servers/">Annual failure rates - servers</a>&#160;<a class="footnote-backref" href="#fnref:falham" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:recursos">
<p>Os recursos compartilhados vão desde alguns óbvios, como <strong>capacidade de armazenamento</strong> e de <strong>processamento</strong>, a própria <strong>localização</strong> de um nó, que pode ser geograficamente mais próxima e de menor latência até  um ponto de interesse, ou até mesmo a disponibilidade de uma conexão física com um recurso especial, como uma impressora.&#160;<a class="footnote-backref" href="#fnref:recursos" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:ogros">
<p>Lembrem-se que também <img alt="ogros são como cebolas" src="https://media.giphy.com/media/4RsEUfHym7tuw/200.gif" /> e você não quer que seu sistema seja como ogros, temperamentais e mal-cheirosos. Logo, planeje bem suas camadas de abstração.&#160;<a class="footnote-backref" href="#fnref:ogros" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:internet">
<p>By User:Ludovic.ferre - Internet Connectivity Distribution&amp;Core.svg, CC BY-SA 3.0, (<a href="https://commons.wikimedia.org/w/index.php?curid=10030716">https://commons.wikimedia.org/w/index.php?curid=10030716</a>)&#160;<a class="footnote-backref" href="#fnref:internet" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:ippub">
<p>Endereços IP não públicos não servem como identificadores únicos na Internet.&#160;<a class="footnote-backref" href="#fnref:ippub" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:pyname">
<p>Você pode usar outro nome, desde que não seja <code>socket.py</code>, e que adapte o comando para sua execução.&#160;<a class="footnote-backref" href="#fnref:pyname" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:telnet">
<p>O programa <code>telnet</code> é normalmente instalado por padrão tanto no Windows, OSX quanto no Linux. Já o <code>netcat</code> normalmente precisa ser instalado por você. Em alguns sistemas, em vez de <code>netcat</code> o comando é o <code>nc</code>.&#160;<a class="footnote-backref" href="#fnref:telnet" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:multicast_use">
<p><a href="http://www.dasblinkenlichten.com/understanding-ip-multicast/">Understanding IP Multicast</a>&#160;<a class="footnote-backref" href="#fnref:multicast_use" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
<li id="fn:ipv6multi">
<p><a href="http://www.baeldung.com/java-broadcast-multicast">IP-Multicast em IPv6</a>&#160;<a class="footnote-backref" href="#fnref:ipv6multi" title="Jump back to footnote 9 in the text">&#8617;</a></p>
</li>
<li id="fn:asyncio">
<p>Um bom ponto de partida para o tópico é a sua entrada na <a href="https://en.wikipedia.org/wiki/Asynchronous_I/O">wikipedia</a>.&#160;<a class="footnote-backref" href="#fnref:asyncio" title="Jump back to footnote 10 in the text">&#8617;</a></p>
</li>
<li id="fn:seda">
<p>O artigo <a href="http://www.sosp.org/2001/papers/welsh.pdf">SEDA: An Architecture for Well-Conditioned, Scalable Internet Services</a> descreve em detalhes a arquitetura SEDA.&#160;<a class="footnote-backref" href="#fnref:seda" title="Jump back to footnote 11 in the text">&#8617;</a></p>
</li>
<li id="fn:ioasync">
<p>Pode-se argumentar que E/S assíncrona resolveria o problema aqui, mas isso não vem ao caso.&#160;<a class="footnote-backref" href="#fnref:ioasync" title="Jump back to footnote 12 in the text">&#8617;</a></p>
</li>
</ol>
</div>

  <!-- Last update of source file -->


              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../intro/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              Introdução
            </div>
          </div>
        </a>
      
      
        <a href="../arch/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Próximo
              </span>
              Arquiteturas
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copiar para \u00e1rea de transfer\u00eancia", "clipboard.copied": "Copiado para \u00e1rea de transfer\u00eancia", "search.config.lang": "pt", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Buscar", "search.result.placeholder": "Digite para iniciar a busca", "search.result.none": "Nenhum resultado encontrado", "search.result.one": "1 resultado encontrado", "search.result.other": "# resultados encontrados", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../javascripts/mathjaxhelper.js"></script>
      
    
  </body>
</html>