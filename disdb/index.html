
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.6">
    
    
      
        <title>Bancos de Dados - Notas em Sistemas Distribuídos</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6910b76c.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.196e0c26.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-PJX835H7DP","lasarojc.github.org/dsnotes"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bancos-de-dados-distribuidos" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-header-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Notas em Sistemas Distribuídos
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Bancos de Dados
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Notas em Sistemas Distribuídos
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Prólogo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../intro/" class="md-nav__link">
      Introdução
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../basics/" class="md-nav__link">
      Fundamentos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../comm/" class="md-nav__link">
      Comunicação
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../arch/" class="md-nav__link">
      Arquiteturas
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../coord/" class="md-nav__link">
      Coordenação
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../time/" class="md-nav__link">
      Tempo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../fault/" class="md-nav__link">
      Tolerância a Falhas
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Bancos de Dados
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Bancos de Dados
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nosql" class="md-nav__link">
    NoSQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estruturas-de-dados-para-sd" class="md-nav__link">
    Estruturas de Dados para SD
  </a>
  
    <nav class="md-nav" aria-label="Estruturas de Dados para SD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-structured-merge-tree" class="md-nav__link">
    Log Structured Merge Tree
  </a>
  
    <nav class="md-nav" aria-label="Log Structured Merge Tree">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compactacoes" class="md-nav__link">
    Compactações
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtros-de-bloom" class="md-nav__link">
    Filtros de Bloom
  </a>
  
    <nav class="md-nav" aria-label="Filtros de Bloom">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelos-de-consistencia" class="md-nav__link">
    Modelos de Consistência
  </a>
  
    <nav class="md-nav" aria-label="Modelos de Consistência">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#motivacao" class="md-nav__link">
    Motivação
  </a>
  
    <nav class="md-nav" aria-label="Motivação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#content-delivery-network" class="md-nav__link">
    Content Delivery Network
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#raft" class="md-nav__link">
    RAFT
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicacao-solucao-ou-problema" class="md-nav__link">
    Replicação: solução ou problema?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conflitos" class="md-nav__link">
    Conflitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tipos-de-consistencia" class="md-nav__link">
    Tipos de consistência
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definicao" class="md-nav__link">
    Definição
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelos" class="md-nav__link">
    Modelos
  </a>
  
    <nav class="md-nav" aria-label="Modelos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modelo-centrado-nos-dados" class="md-nav__link">
    Modelo Centrado nos Dados
  </a>
  
    <nav class="md-nav" aria-label="Modelo Centrado nos Dados">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-store" class="md-nav__link">
    Data store
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-estrita" class="md-nav__link">
    Consistência Estrita
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-sequencial" class="md-nav__link">
    Consistência Sequencial
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-causal" class="md-nav__link">
    Consistência Causal
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-fifo" class="md-nav__link">
    Consistência FIFO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operacoes-simples" class="md-nav__link">
    Operações Simples
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grupos-de-operacoes" class="md-nav__link">
    Grupos de Operações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variaveis-de-sincronizacao" class="md-nav__link">
    Variáveis de sincronização
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-de-entrada" class="md-nav__link">
    Consistência de Entrada
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transacoes" class="md-nav__link">
    Transações
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelos-centrados-nos-clientes" class="md-nav__link">
    Modelos Centrados nos Clientes
  </a>
  
    <nav class="md-nav" aria-label="Modelos Centrados nos Clientes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modelo-de-sistema" class="md-nav__link">
    Modelo de Sistema
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leituras-monotonicas" class="md-nav__link">
    Leituras Monotônicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escritas-monotonicas" class="md-nav__link">
    Escritas Monotônicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leia-suas-escritas" class="md-nav__link">
    Leia suas Escritas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escritas-seguem-leituras" class="md-nav__link">
    Escritas seguem Leituras
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mais-informacoes" class="md-nav__link">
    Mais informações:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#posicionamento-de-replicas" class="md-nav__link">
    Posicionamento de Réplicas
  </a>
  
    <nav class="md-nav" aria-label="Posicionamento de Réplicas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sob-demanda-do-servidor" class="md-nav__link">
    Sob demanda do Servidor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propagacao-de-atualizacoes" class="md-nav__link">
    Propagação de Atualizações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propagacao-de-atualizacoes_1" class="md-nav__link">
    Propagação de Atualizações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proativopush-ou-reativopull" class="md-nav__link">
    Proativo/Push ou Reativo/Pull
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hibrido-lease" class="md-nav__link">
    Híbrido: Lease
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recuperacao-checkpoint" class="md-nav__link">
    Recuperação &amp; Checkpoint
  </a>
  
    <nav class="md-nav" aria-label="Recuperação &amp; Checkpoint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recuperacao" class="md-nav__link">
    Recuperação
  </a>
  
    <nav class="md-nav" aria-label="Recuperação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snapshots" class="md-nav__link">
    Snapshots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pontos-de-recuperacao" class="md-nav__link">
    Pontos de Recuperação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estado-global-consistente" class="md-nav__link">
    Estado Global Consistente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rollback-em-cascata" class="md-nav__link">
    Rollback em Cascata
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#armazenamento-em-disco" class="md-nav__link">
    Armazenamento em Disco
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpoint" class="md-nav__link">
    Checkpoint
  </a>
  
    <nav class="md-nav" aria-label="Checkpoint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpointing-independente" class="md-nav__link">
    Checkpointing independente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restricao" class="md-nav__link">
    Restrição
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caso-patologico" class="md-nav__link">
    Caso patológico
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpointing-coordenado" class="md-nav__link">
    Checkpointing coordenado
  </a>
  
    <nav class="md-nav" aria-label="Checkpointing coordenado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bloqueio-em-duas-fases" class="md-nav__link">
    Bloqueio em duas fases
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chandy-lamport" class="md-nav__link">
    Chandy-Lamport
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-logging" class="md-nav__link">
    Message Logging
  </a>
  
    <nav class="md-nav" aria-label="Message Logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notacao" class="md-nav__link">
    Notação
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orfaos" class="md-nav__link">
    Órfãos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocolo-pessimista" class="md-nav__link">
    Protocolo Pessimista
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bancos-de-dados" class="md-nav__link">
    Bancos de Dados
  </a>
  
    <nav class="md-nav" aria-label="Bancos de Dados">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operacoes-atomicas" class="md-nav__link">
    Operações Atômicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conjuntos-de-operacoes" class="md-nav__link">
    Conjuntos de Operações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memoria-estavel" class="md-nav__link">
    Memória Estável
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#o-banco" class="md-nav__link">
    O Banco
  </a>
  
    <nav class="md-nav" aria-label="O Banco">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transacao" class="md-nav__link">
    Transação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transacao_1" class="md-nav__link">
    Transação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execucao-concorrente" class="md-nav__link">
    Execução Concorrente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execucao-concorrente_1" class="md-nav__link">
    Execução Concorrente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solucao" class="md-nav__link">
    Solução?!
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#equivalencia-serial" class="md-nav__link">
    Equivalência Serial
  </a>
  
    <nav class="md-nav" aria-label="Equivalência Serial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#concorrencia" class="md-nav__link">
    Concorrência
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equivalencia-serial_1" class="md-nav__link">
    Equivalência Serial
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lost-update" class="md-nav__link">
    Lost Update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dirty-read" class="md-nav__link">
    Dirty Read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aborto-em-cascata" class="md-nav__link">
    Aborto em Cascata
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dirty-read_1" class="md-nav__link">
    Dirty Read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transacoes_1" class="md-nav__link">
    Transações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escrita-prematura" class="md-nav__link">
    Escrita Prematura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strict-execution" class="md-nav__link">
    Strict Execution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controle-de-concorrencia" class="md-nav__link">
    Controle de Concorrência
  </a>
  
    <nav class="md-nav" aria-label="Controle de Concorrência">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#como" class="md-nav__link">
    Como
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locks" class="md-nav__link">
    Locks
  </a>
  
    <nav class="md-nav" aria-label="Locks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strict-two-phase-locking" class="md-nav__link">
    Strict Two Phase Locking
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-write-locks" class="md-nav__link">
    Read-Write Locks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lock-por-que-evitar" class="md-nav__link">
    Lock -- por que evitar?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abordagem-mais-otimista" class="md-nav__link">
    Abordagem mais otimista?
  </a>
  
    <nav class="md-nav" aria-label="Abordagem mais otimista?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abordagem-otimista" class="md-nav__link">
    Abordagem otimista
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validacao" class="md-nav__link">
    Validação
  </a>
  
    <nav class="md-nav" aria-label="Validação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backward-validation" class="md-nav__link">
    Backward validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-validation" class="md-nav__link">
    Forward validation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timestamping" class="md-nav__link">
    Timestamping
  </a>
  
    <nav class="md-nav" aria-label="Timestamping">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#como-implementar" class="md-nav__link">
    Como implementar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-implementar-escrita" class="md-nav__link">
    Como implementar -- escrita
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-implementar-leitura" class="md-nav__link">
    como implementar -- leitura
  </a>
  
    <nav class="md-nav" aria-label="como implementar -- leitura">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencias_1" class="md-nav__link">
    Referências
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bancos-de-dados-distribuidos_1" class="md-nav__link">
    Bancos de dados distribuídos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bancos-de-dados-transacionais-distribuidos" class="md-nav__link">
    bancos de dados transacionais distribuídos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transacao-distribuida" class="md-nav__link">
    Transação distribuída
  </a>
  
    <nav class="md-nav" aria-label="Transação distribuída">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#papeis" class="md-nav__link">
    Papéis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comprometimento-distribuido" class="md-nav__link">
    Comprometimento distribuído
  </a>
  
    <nav class="md-nav" aria-label="Comprometimento distribuído">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#atomicidade" class="md-nav__link">
    atomicidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc-2-phase-commit" class="md-nav__link">
    2PC - 2 Phase Commit
  </a>
  
    <nav class="md-nav" aria-label="2PC - 2 Phase Commit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#premissas" class="md-nav__link">
    Premissas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1pc" class="md-nav__link">
    1PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc" class="md-nav__link">
    2PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprometimento" class="md-nav__link">
    Comprometimento
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc-o-protocolo" class="md-nav__link">
    2PC -- o protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc_1" class="md-nav__link">
    2PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_1" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-coordenador" class="md-nav__link">
    Falha no Coordenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recuperacao-do-coordenador" class="md-nav__link">
    Recuperação do Coordenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#otimizacoes" class="md-nav__link">
    Otimizações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coleta-de-lixo" class="md-nav__link">
    Coleta de Lixo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-pc" class="md-nav__link">
    3-PC
  </a>
  
    <nav class="md-nav" aria-label="3-PC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#o-protocolo" class="md-nav__link">
    O Protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_2" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3pc-x-2pc" class="md-nav__link">
    3PC x 2PC
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paxos-commit" class="md-nav__link">
    Paxos-Commit
  </a>
  
    <nav class="md-nav" aria-label="Paxos-Commit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#o-protocolo_1" class="md-nav__link">
    O protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_3" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#log-recuperavel" class="md-nav__link">
    Log Recuperável
  </a>
  
    <nav class="md-nav" aria-label="Log Recuperável">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disco-duplicado" class="md-nav__link">
    Disco Duplicado
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../disfs/index.md" class="md-nav__link">
      Sistemas de Arquivos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tech/" class="md-nav__link">
      Tecnologias
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../projeto/" class="md-nav__link">
      Projeto
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nosql" class="md-nav__link">
    NoSQL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estruturas-de-dados-para-sd" class="md-nav__link">
    Estruturas de Dados para SD
  </a>
  
    <nav class="md-nav" aria-label="Estruturas de Dados para SD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-structured-merge-tree" class="md-nav__link">
    Log Structured Merge Tree
  </a>
  
    <nav class="md-nav" aria-label="Log Structured Merge Tree">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compactacoes" class="md-nav__link">
    Compactações
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtros-de-bloom" class="md-nav__link">
    Filtros de Bloom
  </a>
  
    <nav class="md-nav" aria-label="Filtros de Bloom">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelos-de-consistencia" class="md-nav__link">
    Modelos de Consistência
  </a>
  
    <nav class="md-nav" aria-label="Modelos de Consistência">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#motivacao" class="md-nav__link">
    Motivação
  </a>
  
    <nav class="md-nav" aria-label="Motivação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#content-delivery-network" class="md-nav__link">
    Content Delivery Network
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#raft" class="md-nav__link">
    RAFT
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicacao-solucao-ou-problema" class="md-nav__link">
    Replicação: solução ou problema?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conflitos" class="md-nav__link">
    Conflitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tipos-de-consistencia" class="md-nav__link">
    Tipos de consistência
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#definicao" class="md-nav__link">
    Definição
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelos" class="md-nav__link">
    Modelos
  </a>
  
    <nav class="md-nav" aria-label="Modelos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modelo-centrado-nos-dados" class="md-nav__link">
    Modelo Centrado nos Dados
  </a>
  
    <nav class="md-nav" aria-label="Modelo Centrado nos Dados">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-store" class="md-nav__link">
    Data store
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-estrita" class="md-nav__link">
    Consistência Estrita
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-sequencial" class="md-nav__link">
    Consistência Sequencial
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-causal" class="md-nav__link">
    Consistência Causal
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-fifo" class="md-nav__link">
    Consistência FIFO
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operacoes-simples" class="md-nav__link">
    Operações Simples
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#grupos-de-operacoes" class="md-nav__link">
    Grupos de Operações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variaveis-de-sincronizacao" class="md-nav__link">
    Variáveis de sincronização
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consistencia-de-entrada" class="md-nav__link">
    Consistência de Entrada
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transacoes" class="md-nav__link">
    Transações
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelos-centrados-nos-clientes" class="md-nav__link">
    Modelos Centrados nos Clientes
  </a>
  
    <nav class="md-nav" aria-label="Modelos Centrados nos Clientes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#modelo-de-sistema" class="md-nav__link">
    Modelo de Sistema
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leituras-monotonicas" class="md-nav__link">
    Leituras Monotônicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escritas-monotonicas" class="md-nav__link">
    Escritas Monotônicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leia-suas-escritas" class="md-nav__link">
    Leia suas Escritas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escritas-seguem-leituras" class="md-nav__link">
    Escritas seguem Leituras
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mais-informacoes" class="md-nav__link">
    Mais informações:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#posicionamento-de-replicas" class="md-nav__link">
    Posicionamento de Réplicas
  </a>
  
    <nav class="md-nav" aria-label="Posicionamento de Réplicas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sob-demanda-do-servidor" class="md-nav__link">
    Sob demanda do Servidor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propagacao-de-atualizacoes" class="md-nav__link">
    Propagação de Atualizações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#propagacao-de-atualizacoes_1" class="md-nav__link">
    Propagação de Atualizações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proativopush-ou-reativopull" class="md-nav__link">
    Proativo/Push ou Reativo/Pull
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hibrido-lease" class="md-nav__link">
    Híbrido: Lease
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recuperacao-checkpoint" class="md-nav__link">
    Recuperação &amp; Checkpoint
  </a>
  
    <nav class="md-nav" aria-label="Recuperação &amp; Checkpoint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recuperacao" class="md-nav__link">
    Recuperação
  </a>
  
    <nav class="md-nav" aria-label="Recuperação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snapshots" class="md-nav__link">
    Snapshots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pontos-de-recuperacao" class="md-nav__link">
    Pontos de Recuperação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estado-global-consistente" class="md-nav__link">
    Estado Global Consistente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rollback-em-cascata" class="md-nav__link">
    Rollback em Cascata
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#armazenamento-em-disco" class="md-nav__link">
    Armazenamento em Disco
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpoint" class="md-nav__link">
    Checkpoint
  </a>
  
    <nav class="md-nav" aria-label="Checkpoint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpointing-independente" class="md-nav__link">
    Checkpointing independente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restricao" class="md-nav__link">
    Restrição
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caso-patologico" class="md-nav__link">
    Caso patológico
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpointing-coordenado" class="md-nav__link">
    Checkpointing coordenado
  </a>
  
    <nav class="md-nav" aria-label="Checkpointing coordenado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bloqueio-em-duas-fases" class="md-nav__link">
    Bloqueio em duas fases
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chandy-lamport" class="md-nav__link">
    Chandy-Lamport
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-logging" class="md-nav__link">
    Message Logging
  </a>
  
    <nav class="md-nav" aria-label="Message Logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notacao" class="md-nav__link">
    Notação
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orfaos" class="md-nav__link">
    Órfãos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocolo-pessimista" class="md-nav__link">
    Protocolo Pessimista
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bancos-de-dados" class="md-nav__link">
    Bancos de Dados
  </a>
  
    <nav class="md-nav" aria-label="Bancos de Dados">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#operacoes-atomicas" class="md-nav__link">
    Operações Atômicas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conjuntos-de-operacoes" class="md-nav__link">
    Conjuntos de Operações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memoria-estavel" class="md-nav__link">
    Memória Estável
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#o-banco" class="md-nav__link">
    O Banco
  </a>
  
    <nav class="md-nav" aria-label="O Banco">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transacao" class="md-nav__link">
    Transação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transacao_1" class="md-nav__link">
    Transação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execucao-concorrente" class="md-nav__link">
    Execução Concorrente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execucao-concorrente_1" class="md-nav__link">
    Execução Concorrente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solucao" class="md-nav__link">
    Solução?!
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#equivalencia-serial" class="md-nav__link">
    Equivalência Serial
  </a>
  
    <nav class="md-nav" aria-label="Equivalência Serial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#concorrencia" class="md-nav__link">
    Concorrência
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equivalencia-serial_1" class="md-nav__link">
    Equivalência Serial
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lost-update" class="md-nav__link">
    Lost Update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dirty-read" class="md-nav__link">
    Dirty Read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aborto-em-cascata" class="md-nav__link">
    Aborto em Cascata
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dirty-read_1" class="md-nav__link">
    Dirty Read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transacoes_1" class="md-nav__link">
    Transações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escrita-prematura" class="md-nav__link">
    Escrita Prematura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strict-execution" class="md-nav__link">
    Strict Execution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controle-de-concorrencia" class="md-nav__link">
    Controle de Concorrência
  </a>
  
    <nav class="md-nav" aria-label="Controle de Concorrência">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#como" class="md-nav__link">
    Como
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locks" class="md-nav__link">
    Locks
  </a>
  
    <nav class="md-nav" aria-label="Locks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strict-two-phase-locking" class="md-nav__link">
    Strict Two Phase Locking
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-write-locks" class="md-nav__link">
    Read-Write Locks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lock-por-que-evitar" class="md-nav__link">
    Lock -- por que evitar?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abordagem-mais-otimista" class="md-nav__link">
    Abordagem mais otimista?
  </a>
  
    <nav class="md-nav" aria-label="Abordagem mais otimista?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abordagem-otimista" class="md-nav__link">
    Abordagem otimista
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validacao" class="md-nav__link">
    Validação
  </a>
  
    <nav class="md-nav" aria-label="Validação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backward-validation" class="md-nav__link">
    Backward validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-validation" class="md-nav__link">
    Forward validation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timestamping" class="md-nav__link">
    Timestamping
  </a>
  
    <nav class="md-nav" aria-label="Timestamping">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#como-implementar" class="md-nav__link">
    Como implementar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-implementar-escrita" class="md-nav__link">
    Como implementar -- escrita
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-implementar-leitura" class="md-nav__link">
    como implementar -- leitura
  </a>
  
    <nav class="md-nav" aria-label="como implementar -- leitura">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencias_1" class="md-nav__link">
    Referências
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bancos-de-dados-distribuidos_1" class="md-nav__link">
    Bancos de dados distribuídos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bancos-de-dados-transacionais-distribuidos" class="md-nav__link">
    bancos de dados transacionais distribuídos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transacao-distribuida" class="md-nav__link">
    Transação distribuída
  </a>
  
    <nav class="md-nav" aria-label="Transação distribuída">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#papeis" class="md-nav__link">
    Papéis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comprometimento-distribuido" class="md-nav__link">
    Comprometimento distribuído
  </a>
  
    <nav class="md-nav" aria-label="Comprometimento distribuído">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#atomicidade" class="md-nav__link">
    atomicidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc-2-phase-commit" class="md-nav__link">
    2PC - 2 Phase Commit
  </a>
  
    <nav class="md-nav" aria-label="2PC - 2 Phase Commit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#premissas" class="md-nav__link">
    Premissas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1pc" class="md-nav__link">
    1PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc" class="md-nav__link">
    2PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprometimento" class="md-nav__link">
    Comprometimento
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc-o-protocolo" class="md-nav__link">
    2PC -- o protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc_1" class="md-nav__link">
    2PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_1" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-coordenador" class="md-nav__link">
    Falha no Coordenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recuperacao-do-coordenador" class="md-nav__link">
    Recuperação do Coordenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#otimizacoes" class="md-nav__link">
    Otimizações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coleta-de-lixo" class="md-nav__link">
    Coleta de Lixo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-pc" class="md-nav__link">
    3-PC
  </a>
  
    <nav class="md-nav" aria-label="3-PC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#o-protocolo" class="md-nav__link">
    O Protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_2" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3pc-x-2pc" class="md-nav__link">
    3PC x 2PC
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paxos-commit" class="md-nav__link">
    Paxos-Commit
  </a>
  
    <nav class="md-nav" aria-label="Paxos-Commit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#o-protocolo_1" class="md-nav__link">
    O protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_3" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#log-recuperavel" class="md-nav__link">
    Log Recuperável
  </a>
  
    <nav class="md-nav" aria-label="Log Recuperável">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disco-duplicado" class="md-nav__link">
    Disco Duplicado
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="bancos-de-dados-distribuidos">Bancos de Dados Distribuídos</h1>
<h2 id="nosql">NoSQL</h2>
<h2 id="estruturas-de-dados-para-sd">Estruturas de Dados para SD</h2>
<p>Qualquer que seja a escolha de algoritmo para fazer o particionamento dos dados entre servidores, sobra ainda a questão de como manipular os dados dentro do servidor.
Idealmente, toda operação seria executada a partir da memória principal, tendo assim a menor latência possível.
Contudo, para que se tenha também durabilidade das operações executadas, para que os dados manipulados sobrevivam a reinicializações do servidor, intencionais ou não, é preciso armazenar os dados em <strong>memória estável</strong>, da qual a mais comum são os <strong>discos rígidos</strong>.</p>
<p>É notório que escritas em disco são muito mais lentas que em memória principal, mas o que exatamente é lento no acesso ao disco?
Essencialmente, o posicionamento da cabeca de leitura/escrita na trilha correta do disco, pois esta operação é mecânica.
Por esta razão, acessos aleatórios são mais custosos que acessos sequenciais, pois neste o custo de posicionamento é pago apenas uma vez.
Por este motivo, muitos bancos de dados, especialmente DHT pois tem seu uso focado em quantidades muito grandes de dados, gerados e acessados com grande velocidade, tentam acessar o disco sempre de forma sequencial.
Alguns bancos de dados, como o Cassandra, armazenam os dados na forma de uma <em>Log Structured Merge Tree</em>, ou LSMT.</p>
<h3 id="log-structured-merge-tree">Log Structured Merge Tree</h3>
<p>Uma Log Structured Merge Tree é uma forma de se armazenar dados em disco de forma de forma quase sempre sequencial, minimizando assim os o impacto da durabilidade no desempenho do sistema.
Considere um banco armazenando uma pequena quantidade de dados, que cabe em memória principal.
Na LSMT, operações de escrita são adicionadas a um <strong><em>commit log</em></strong>, em disco,  e somente então são executadas em memória principal e confirmadas para o cliente; a estrutura que armazena os dados em memória é denominada <em>memory table</em>, ou simplesmente <strong>memtable</strong>.
Neste cenário o acesso ao disco na escrita é sequencial, o melhor que se pode ter em um disco, e a recuperação dos dados é feita diretamente da memória, rápida.</p>
<p><img alt="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataWritten.html" src="images/lsm2.png" /></p>
<p>No caso de uma reinicialização do processo, a reexecução do <em>commit log</em> restaurará o estado da memtable. Contudo, se o <em>commit log</em> for extenso, reexecutá-lo demandará um tempo significativo.
Uma forma de acelerar o processo é fazer <strong><em>snapshots</em></strong> da memtable de forma sincronizada com a escrita no log.
Isto é, digamos que todas as operações de escrita, até a décima, estão salvas no commit log e refletidas na memtable.
Digamos também que todas as operações são modificações da mesma linha do banco de dados em memória.
Se um <em>snapshot</em>  é tomado, ele será correspondente ao commit log, isto é, conterá o efeito de exatamente as mesmas 10 operações, mas de forma mais compacta que o log, uma vez que o log conterá dez operações e o snapshot somente uma linha de dados.
Após o snapshot ser concluído, o log correspondente pode ser apagado.
Novas operações de escrita devem ser armazenadas em um novo log e, no caso de uma reinicialização, primeiro se deve restaurar o <em>snapshot</em> e então o novo log.
Para lidar com corrupções de arquivo no sistema, pode ser uma boa ideia manter mais do que o último log e <em>snapshot</em>, já que a recuperação do estado exigiria voltar mais atrás na reexecução de operações.</p>
<p>Observe que, além da escrita dos logs, todos os outros acessos ao disco também são sequenciais, seja o <em>flush</em> das memtables, ou a leitura dos snapshots para recuperação e do commit log para reexecução, e já que operações de leitura são todas respondidas da memória, o sistema terá um excelente desempenho.
Contudo, há outro limitante de desempenho importante, relacionado à premissa pouco realista de que os dados cabem todos em memória. Isto é, se os dados não cabem em memória, <em>snapshots</em>  serão importantes não somente para permitir coletar lixo dos logs, isto é, dados obsoletos, mas também, para usar a capacidade de armazenamento dos discos.</p>
<p>Consideremos então um cenário em que a memtable cabe apenas <em>n</em> entradas; quando a operação para adicionar <span><span class="MathJax_Preview">n+1</span><script type="math/tex">n+1</script></span>-ésima entrada à memtable é recebida, um <strong><em>flushs</em></strong> dos dados para um novo <em>snapshot</em> é feito e a memtable é <em>resetada</em>, liberando espaço em memória. Para melhorar o desempenho, estas descargas podem ser feitas proativamente antes da chegada de novas entradas e fora do <em>caminho crítico</em> da operação de escrita, mas isto é apenas uma otimização e portanto não a consideraremos aqui.</p>
<p><img alt="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataWritten.html" src="images/lsm2.png" /></p>
<p>Neste novo fluxo, os arquivos em disco não correspondem mais a <em>snapshots</em> do banco de dados, então nos referiremos a eles como <em>stable storage tables</em>, ou <strong>sstables</strong>, em oposição às <em>memtables</em>, pelo menos por enquanto.</p>
<h5 id="compactacoes">Compactações</h5>
<p>Apesar deste novo fluxo de escrita aumentar a capacidade de armazenamento do nosso banco de dados, ele traz problemas para o fluxo de leitura.
Digamos que a chave <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> teve um valor atribuído e descarregado em uma sstable em diversas ocasiões.
O primeiro problema aqui é que há vários valores antigos associados a <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span>, inutilmente e ocupando espaço, isto é, lixo.
O segundo é que caso o valor associado a <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> seja requisitado, o sistema deverá retornar a última versão, que pode estar em diversos arquivos.
Para lidar com ambos os problemas, podemos <strong>compactar</strong> as sstables juntas, eliminados dados obsoletos e minimizando o número de arquivos a serem pesquisados no caso de leitura.
Caso a sstables estejam ordenadas, o procedimento de compactação pode ser feito como a união de dois segmentos de dados no <em>merge sort</em>, isto é, iterando-se paralelamente nos dois arquivos e escolhendo sempre a menor chave da vez e movendo-a para um novo segmento que conterá a união dos dados.
A figura a seguir mostra um exemplo que várias sstables de nível 0, aquelas geradas por <em>flushs</em>, são unidas gerando sstables de nível 1 e assim sucessivamente.
Observe como as compactações geram uma árvore (na verdade, uma floresta), razão do nome <em>merge tree</em>.</p>
<p><img alt="https://www.hedvig.io/blog/hedvig-internals-log-structured-merge-trees-and-folding-of-bloom-filters" src="images/lsm_compac.png" /></p>
<p>No caso de uma pesquisa, somente as tabelas mais à direita e de nível mais alto precisam ser consultadas e portanto as sstables já usadas como entrada podem ser eliminadas como lixo do sistema.
Ainda assim, no caso de uma leitura, diversas sstables potencialmente contém o dado a ser retornado.
O problema se agrava em sistemas em que partes do dado possam ser gravadas independentemente, como no CassandraDB, em que cada coluna é independente das outras.
Diversas propostas poderiam ser feitas para se identificar mais rapidamente se uma sstable contém uma chave.</p>
<p>Por exemplo, pode-se associar a cada tabela um bitmap indicando a presença ou não de uma certa chave, mas esta abordagem obviamente falha se o espaço de chaves for grande.
Outra possibilidade é lembrar a faixa de chaves contida na tabela. Esta estratégia pode ser útil caso haja localidade no espaço de chaves no momento da escrita, mas falhará miseravelmente se o espaço de chaves for usado uniformemente, resultando em faixas grandes entre a menor e maior chaves de cada tabela.
Como acelerar a identificação das sstables pertinentes? Entram em cena os filtros de <strong>Bloom</strong>.</p>
<h3 id="filtros-de-bloom">Filtros de Bloom</h3>
<p>De acordo com nossa fonte mais que confiável, a <a href="https://en.wikipedia.org/wiki/Bloom_filter">Wikipedia</a></p>
<blockquote>
<p><em>A Bloom filter is a **space-efficient*</em> <strong>probabilistic</strong> data structure, conceived by Burton Howard <em>Bloom</em> in 1970, that is used to test whether an element is a member of a set. False positive matches are possible, but false negatives are not, thus a Bloom filter has a 100% recall rate. In other words, a query returns either <strong>"possibly in set"</strong> or <strong>"definitely not in set"</strong>.*</p>
</blockquote>
<p>Se associarmos a cada sstable um filtro de Bloom, então só será preciso lê-la se o filtro correspondente disser que a chave possivelmente está contida, como no seguinte exemplo.</p>
<p><img alt="LSMT+Bloom Filter" src="images/bf_lsm.jpg" /></p>
<p>Mas como exatamente construímos um filtro de Bloom?
Iniciamos com um vetor de bits inicialmente zerados e um conjunto finito de funções de hash cujo resultado seja uniformemente distribuído no tamanho do vetor de bits.
Para cada elemento colocado no conjunto a ser refletido pelo filtro, aplicamos cada uma das funções hash e colocamos o bit 1 na posição do vetor igual ao resultado da função.
No exemplo a seguir, inserimos os elementos x, y e z e usamos três funções hash.</p>
<p><img alt="By David Eppstein" src="images/bf.png" /></p>
<p>Na <strong>consulta</strong>, cada elemento passa por pelas mesmas funções hash.
Se algum dos índices apontados não estiver com um 1, como no caso do w, no exemplo, o elemento não pertence ao conjunto.
Caso contrário, o filtro responderá que é possível que pertença.</p>
<p>Mas quão bom é um filtro de Bloom na identificação do das sstables? Ou, de outra forma, quais fatores influenciam na taxa de falsos positivos do filtro?
* o número <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> de elementos no conjunto, uma vez que quanto mais elementos, mais bits  1;
* o número <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> de hashes, pois quanto mais hashes, mais bits transformados em 1; e,
* o número <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> de bits no vetor, pois quanto menos bits, mais colisões de bits.</p>
<p>De forma mais precisa,
* a probabilidade de setar um certo bit na inserção de um elemento é <span><span class="MathJax_Preview">1/m</span><script type="math/tex">1/m</script></span>, e
* a probabilidade de não setar tal bit é <span><span class="MathJax_Preview">1 - 1/m</span><script type="math/tex">1 - 1/m</script></span>;
* a probabilidade de <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> hashes não setarem um bit é <span><span class="MathJax_Preview">(1 - 1/m)^k</span><script type="math/tex">(1 - 1/m)^k</script></span>;
* a probabilidade de não setar um bit após <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> inserções é <span><span class="MathJax_Preview">(1 - 1/m)^{kn}</span><script type="math/tex">(1 - 1/m)^{kn}</script></span>;
* a probabilidade de setar um bit após <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> inserções é <span><span class="MathJax_Preview">1 - (1 - 1/m)^{kn}</span><script type="math/tex">1 - (1 - 1/m)^{kn}</script></span></p>
<p>Logo,
* a probabilidade de falso positivo <span><span class="MathJax_Preview">p = (1 - (1 - 1/m)^{kn})^k \approx (1 - e^{-kn/m})^k</span><script type="math/tex">p = (1 - (1 - 1/m)^{kn})^k \approx (1 - e^{-kn/m})^k</script></span>
O que nos permite chegar à relação
* <span><span class="MathJax_Preview">m/n = - 1.44\log_2 p</span><script type="math/tex">m/n = - 1.44\log_2 p</script></span>, em que podemos calcular <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> em função do <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> esperado e do <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> desejado.
E podemos também identificar o <span><span class="MathJax_Preview">k</span><script type="math/tex">k</script></span> ótimo para a situação, pela equação
* <span><span class="MathJax_Preview">k = - \frac{\ln p}{\ln 2} = - \log_2 p</span><script type="math/tex">k = - \frac{\ln p}{\ln 2} = - \log_2 p</script></span></p>
<p>Uma forma "simples" de visualizar este resultado é dada pela figura a seguir, em que o eixo Y dá a taxa de falsos positivos do filtro em função do número de elementos inseridos, indicado no eixo X, para diversas configurações, apresentadas como curvas.
Por exemplo, com um filtro com <span><span class="MathJax_Preview">m = 2^{24}b = 2MB</span><script type="math/tex">m = 2^{24}b = 2MB</script></span>, após 1 milhão de inserções, tem-se probabilidade de falsos positivo <span><span class="MathJax_Preview">p = 0,0001</span><script type="math/tex">p = 0,0001</script></span>.</p>
<h5 id="referencias">Referências</h5>
<p><a href="http://www.slideshare.net/quipo/modern-algorithms-and-data-structures-1-bloom-filters-merkle-trees">Modern Algorithms and Data Structures: Bloom-Filter</a></p>
<div class="admonition todo">
<p class="admonition-title">TODO</p>
<ul>
<li>Mover ED SD de Tecnologias para cá</li>
<li>Combinar<ul>
<li><a href="https://adambcomer.com/blog/simple-database/motivation-design.html">https://adambcomer.com/blog/simple-database/motivation-design.html</a></li>
<li><a href="https://adambcomer.com/blog/simple-database/memtable.html">https://adambcomer.com/blog/simple-database/memtable.html</a></li>
<li><a href="https://adambcomer.com/blog/simple-database/wal.html">https://adambcomer.com/blog/simple-database/wal.html</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="modelos-de-consistencia">Modelos de Consistência</h2>
<h3 id="motivacao">Motivação</h3>
<h4 id="content-delivery-network">Content Delivery Network</h4>
<p><img alt="" src="images/cdn.jpeg" /></p>
<ul>
<li>Conteúdo é colocado próximo aos clientes. </li>
<li>Conteúdo estático ou majoritariamente determinístico. </li>
<li>Um pequeno atraso na replicação é tolerado.</li>
<li>Atualização acontece infrequentemente.</li>
</ul>
<p>Fonte: <a href="https://www.creative-artworks.eu/why-use-a-content-delivery-network-cdn/">https://www.creative-artworks.eu/why-use-a-content-delivery-network-cdn/</a></p>
<h4 id="raft">RAFT</h4>
<p>Considere um sistema replicado usando RAFT. Após cada operação que modifica o estado, todas as réplicas tem o mesmo valor.</p>
<p><img alt="Raft" src="images/raft.png" /> </p>
<p>Fonte: <a href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a></p>
<p>Caso um cliente queira apenas ler o estado, o que deve fazer?</p>
<ul>
<li>Requisitar o valor do líder: o valor lido será <em>o último</em> valor escrito.</li>
<li>Requisitar o valor de alguma réplica: o valor lido será <em>um</em> valor escrito, não necessariamente o último. Mais tempo implica maior a probabilidade de ser o valor escrito.</li>
<li>Se em vez de difusão atômica usássemos IP-Multicast? Alguns valores escritos poderiam nunca ser vistos.</li>
</ul>
<h3 id="replicacao-solucao-ou-problema">Replicação: solução ou problema?</h3>
<p>Replicação aumenta disponibilidade mas tem custo em desempenho e, possivelmente, inconsistências temporárias nos dados.</p>
<h3 id="conflitos">Conflitos</h3>
<p>O problema da replicação está em como lidar com conflitos nas operações dos clientes.</p>
<ul>
<li><strong>Leitura-Leitura</strong>: Não há conflitos. Qualquer quantidade de clientes. <br/> Replicar "... é fácil, extremamente fácil ..."</li>
<li><strong>Leitura-Escrita</strong>: Clientes querem ler dados corretos e, geralmente, a última versão escrita.<br/>
    Como atualizar rapidamente as réplicas?</li>
<li><strong>Escrita-Escrita</strong>: Dados sendo atualizados em múltiplos lugares ao mesmo tempo. Necessidade de ordenação/compatibilização das escritas.</li>
</ul>
<p>Ordenação total das operações pode ser custosa demais.</p>
<p><em>Solução?</em></p>
<p>Enfraquecer os requisitos de consistência dos sistema.</p>
<h3 id="tipos-de-consistencia">Tipos de consistência</h3>
<p>Diferentes formas de propagação e recuperação resultam em diferentes garantias,  diferentes <em>modelos de consistência</em>.</p>
<ul>
<li>Consistência forte: todas a réplicas tem o mesmo valor dentro de um pequena janela de tempo.<br/>
     Alto custo.</li>
<li>Consistência eventual: réplicas um dia terão o mesmo valor.<br/>
    Demora em sincronizar.</li>
<li>Consistência fraca: não há garantia da replicação.<br/>
    Yay!!!</li>
</ul>
<p>Diferentes modelos com nomes parecidos ou até iguais. É preciso conhecer o que cada sistema está entregando para poder utilizá-lo da forma correta.</p>
<h3 id="definicao">Definição</h3>
<p>Contrato entre uma data-store (distribuída) em que se especifica os resultados de operações de leitura e escrita na presença de concorrência.</p>
<h3 id="modelos">Modelos</h3>
<p>Modelos Centrados nos Dados  vs. Modelos Centrados nos Clientes</p>
<ul>
<li>Em um, os dados são mantidos consistentes.</li>
<li>No outro, inconsistências não são vistas pelo cliente.</li>
</ul>
<h4 id="modelo-centrado-nos-dados">Modelo Centrado nos Dados</h4>
<h5 id="data-store">Data store</h5>
<p>Modelo Computacional</p>
<p><img alt="" src="images/07-01.png" /></p>
<ul>
<li><strong>Consistência Forte</strong>: operações são sincronizadas<ul>
<li>Estrita (Strict): segue a linha do tempo.</li>
<li>Sequencial: bancos de dados transacionais (quase).</li>
<li>Causal: operações com dependência causal são ordenadas</li>
<li>FIFO: ordem dos comandos de um mesmo cliente.</li>
</ul>
</li>
<li><strong>Consistência Fraca</strong>: sincronização acontece quando necessário.<ul>
<li>Consistência fraca geral</li>
<li>Consistência de entrada</li>
</ul>
</li>
</ul>
<p>Quanto mais fraco, mais escalável.</p>
<p><strong>Notação</strong>
<img alt="" src="images/07-04.png" /></p>
<ul>
<li>A leitura de x em (a) retorna a</li>
<li>A primeira leitura de x em (b) retorna Nil</li>
<li>A segunda  leitura de x em (b) retorna a</li>
</ul>
<h5 id="consistencia-estrita">Consistência Estrita</h5>
<p>Qualquer leitura de um objeto <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span> retorna o valor gravado em <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span> pela operação de escrita mais recente em <span><span class="MathJax_Preview">X</span><script type="math/tex">X</script></span>.</p>
<ul>
<li>O que quer dizer "mais recente" em um sistema distribuído assíncrono?</li>
<li>Todas as operações de escrita são instantaneamente visíveis a todos os processos  <em>tempo global</em> é respeitado.</li>
<li>Comportamento observado em um sistema sem conflitos ou centralizado</li>
</ul>
<p>Em qual(is) cenário(s) temos consistência estrita?
<img alt="" src="images/07-04.png" /></p>
<h5 id="consistencia-sequencial">Consistência Sequencial</h5>
<p>O resultado de qualquer execução é equivalente a alguma execução sequencial dos processos, e as operações da cada processo aparecem nesta execução sequencial na ordem especificada por seu programa.</p>
<p><img alt="" src="images/07-05a.png" /></p>
<p>P2, P3, P4, P1, P4, P3</p>
<p><img alt="" src="images/07-05b.png" /></p>
<p>P1 ou P2, qual veio primeiro?</p>
<h5 id="consistencia-causal">Consistência Causal</h5>
<p>Escritas com potencial relação causal são vistas por todos os processos na mesma ordem. Escritas concorrentes (não causalmente relacionadas) podem se vistas em ordens diferentes por processos diferentes.</p>
<p><img alt="" src="images/07-08.png" /></p>
<p>W(x)b depende de R(x)a que depende de W(x)a<br/>
 W(x)c e W(x)b são concorrentes.</p>
<p><img alt="" src="images/07-09a.png" /></p>
<p>W(x)b depende de R(x)a que depende de W(x)a. W(x)a deve ser ordenado com W(x)b. P3 não pode ter lido b e depois a.</p>
<p><img alt="" src="images/07-09b.png" /></p>
<h5 id="consistencia-fifo">Consistência FIFO</h5>
<p>Escritas de um processo são vistas por todos os outros processos na ordem em que foram feitas. Escritas de diferentes processos podem ser vistas em ordens diferentes.</p>
<p><img alt="" src="images/07-08b.png" /></p>
<h5 id="operacoes-simples">Operações Simples</h5>
<p>Modelos desenvolvidos para processamento paralelo, especificando a ordem de execução de operações em múltiplos threads/processos.</p>
<h5 id="grupos-de-operacoes">Grupos de Operações</h5>
<p>Efeito de um grupo de operações se torna visível a outros processos ao mesmo tempo. </p>
<p>Efeitos de operações individuais em um grupo não são visíveis.</p>
<ul>
<li>Variáveis de sincronização</li>
<li>Acesso às variáveis de sincronização da datastore é sequencialmente consistente.</li>
<li>Acesso à variável de sincronização não é permitido até que todas as escritas das anteriores tenham sido executadas em todos os lugares.</li>
<li>Acesso aos dados não é permitido até que todas as variáveis de sincronização tenham sido liberadas.</li>
</ul>
<h5 id="variaveis-de-sincronizacao">Variáveis de sincronização</h5>
<p><img alt="" src="images/weaka.png" /></p>
<p><img alt="" src="images/weakb.png" /></p>
<p>Materializando variáveis de sincronização na forma de \emph{locks</p>
<h5 id="consistencia-de-entrada">Consistência de Entrada</h5>
<ul>
<li>Lock de leitura só retorna quando todas as mudanças guardadas por aquele lock tiverem sido executadas no processo.</li>
<li>Lock de escrita só retorna quando nenhum outro processo tiver um lock, de leitura ou escrita.</li>
<li>Para ler uma variável, processo deve primeiro contactar o dono atual do lock cercando a variável, para pegar as mais recentes atualizações.</li>
</ul>
<p><img alt="" src="images/07-10.png" /></p>
<h5 id="transacoes">Transações</h5>
<p>Tornam o trancamento/destrancamento de variáveis transparente.</p>
<h4 id="modelos-centrados-nos-clientes">Modelos Centrados nos Clientes</h4>
<p><strong>Ideia básica</strong></p>
<p>Evitar sincronização global focando-se no que os clientes vêem do sistema. Se para os clientes parecer consistente, tudo bem.</p>
<ul>
<li>
<p>Consistência Eventual</p>
<ul>
<li>Se nenhuma escrita ocorrer em período considerável de tempo, os clientes gradualmente se sincronizarão e ficarão consistentes.</li>
<li>Se clientes sempre acessarem as mesmas réplicas, terão impressão de consistência.</li>
</ul>
</li>
<li>
<p>Garantias são do ponto de vista de <em>um</em> cliente.</p>
<ul>
<li>Leituras monotônicas</li>
<li>Escrita monotônicas</li>
<li>Leia suas escritas</li>
<li>Escritas seguem leituras.</li>
</ul>
</li>
</ul>
<h5 id="modelo-de-sistema">Modelo de Sistema</h5>
<p><img alt="" src="images/07-11.png" /></p>
<p>Cliente pode se mover antes de sua última operação ter replicado do servidor onde estava para o novo servidor.</p>
<h5 id="leituras-monotonicas">Leituras Monotônicas</h5>
<p><strong>Garantia</strong></p>
<p>Se um processo lê o valor de um item <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span>, qualquer leitura sucessiva de <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span> retornará o mesmo valor ou um mais recente.</p>
<ul>
<li>Toda vez que se conecta a um servidor de email, seu cliente lê novas mensagens, caso haja.</li>
<li>O cliente nunca esquece uma mensagem, mesmo que ainda não esteja no servidor conectado por último.</li>
<li>WS(<span><span class="MathJax_Preview">x_i</span><script type="math/tex">x_i</script></span>) -- operações de escrita (\emph{write set}) que levaram a variável <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span> a ter o valor <span><span class="MathJax_Preview">x_i</span><script type="math/tex">x_i</script></span>.</li>
<li>WS(<span><span class="MathJax_Preview">x_i;x_j</span><script type="math/tex">x_i;x_j</script></span>) -- operações de escrita relativas a <span><span class="MathJax_Preview">x_j</span><script type="math/tex">x_j</script></span> incluem operações de escrita relativas a <span><span class="MathJax_Preview">x_i</span><script type="math/tex">x_i</script></span></li>
</ul>
<p><img alt="" src="images/07-12.png" /></p>
<h5 id="escritas-monotonicas">Escritas Monotônicas</h5>
<p><strong>Garantia:</strong></p>
<p>Se um processo escreve em item <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span>, então esta operação deve terminar antes que qualquer escrita sucessiva em <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span> possa ser executada pelo mesmo processo.</p>
<ul>
<li>Em um sistema de arquivos na rede, a escrita do conteúdo de um arquivo, em certa posição, só pode ser feita se escritas anteriores já estão registradas no arquivo, independentemente de o cliente contactar novo servidor de arquivos.</li>
</ul>
<p><img alt="" src="images/07-13.png" /></p>
<h5 id="leia-suas-escritas">Leia suas Escritas</h5>
<p><strong>Garantia:</strong></p>
<p>Se um processo escreve em item <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span>, então leituras sucessivas no mesmo item pelo mesmo processo devem refletir tal escrita.</p>
<ul>
<li>Atualizar código fonte de uma página e exigir que o navegador carrega a nova versão.</li>
</ul>
<p><img alt="" src="images/07-14.png" /></p>
<h5 id="escritas-seguem-leituras">Escritas seguem Leituras</h5>
<p><strong>Garantia:</strong></p>
<p>Se um processo lê um item <span><span class="MathJax_Preview">x</span><script type="math/tex">x</script></span>, então escritas sucessivas no mesmo item só podem ser completadas se o mesmo reflete o valor lido anteriormente.</p>
<ul>
<li>Só é permitido enviar uma resposta a uma mensagem se a mensagem em si é vista, independentemente do cliente ter se movimentado.</li>
</ul>
<p><img alt="" src="images/07-15.png" /></p>
<h5 id="mais-informacoes">Mais informações:</h5>
<ul>
<li><a href="https://aphyr.com/posts/313-strong-consistency-models">Aqui</a></li>
<li><a href="files/encyclopedia18.pdf">e aqui</a></li>
</ul>
<h2 id="posicionamento-de-replicas">Posicionamento de Réplicas</h2>
<p>Onde colocar réplicas para conseguir melhor escalabilidade do sistema? Menor custo de comunicação?</p>
<ul>
<li>Objetos (código/dados)</li>
<li>Permanente</li>
<li>Sob demanda do servidor -- por exemplo em uma CDN</li>
<li>Sob demanda do cliente -- por exemplo um cache.</li>
</ul>
<p><img alt="" src="images/07-17.png" /></p>
<h3 id="sob-demanda-do-servidor">Sob demanda do Servidor</h3>
<ul>
<li><span><span class="MathJax_Preview">Q</span><script type="math/tex">Q</script></span> conta acessos ao arquivo <span><span class="MathJax_Preview">F</span><script type="math/tex">F</script></span></li>
<li>Agrega acessos por possível réplica mais próxima (<span><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span>)</li>
<li>Número de acessos acima de limiar <span><span class="MathJax_Preview">R</span><script type="math/tex">R</script></span>, replica para <span><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span></li>
<li>Número de acessos abaixo de <span><span class="MathJax_Preview">D</span><script type="math/tex">D</script></span>, apaga de <span><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span></li>
<li><span><span class="MathJax_Preview">D &lt; R</span><script type="math/tex">D < R</script></span></li>
<li>Se não é alto o suficiente para replicar nem baixo o suficiente para ignorar (entre <span><span class="MathJax_Preview">D</span><script type="math/tex">D</script></span> e <span><span class="MathJax_Preview">R</span><script type="math/tex">R</script></span>), considera migrar.</li>
</ul>
<p><img alt="" src="images/07-18.png" /></p>
<h3 id="propagacao-de-atualizacoes">Propagação de Atualizações</h3>
<p>Réplicas precisam ser atualizadas.</p>
<ul>
<li>Propagar dados -- não reexecuta operações.</li>
<li>Propagar operações -- não copia todos os dados modificados.</li>
<li>Propagar notificações -- réplica precisa solicitar atualização.<br/> Usado em caches.</li>
</ul>
<p>Melhor opção depende do custo das operações, dados manipulados, e taxa de leitura/escrita dos dados.</p>
<h3 id="propagacao-de-atualizacoes_1">Propagação de Atualizações</h3>
<p>Réplicas precisam ser atualizadas.</p>
<ul>
<li>Propagar dados<ul>
<li>razão leitura/escrita é grande</li>
<li>operações são caras</li>
</ul>
</li>
<li>Propagar operações<ul>
<li>razão leitura/escrita é grande</li>
<li>operações são baratas</li>
</ul>
</li>
<li>Propagar notificações<ul>
<li>razão leitura/escrita é pequena</li>
<li>pouco uso da rede</li>
</ul>
</li>
</ul>
<h3 id="proativopush-ou-reativopull">Proativo/Push ou Reativo/Pull</h3>
<ul>
<li>
<p>Proativo</p>
<ul>
<li>Mantém réplicas consistentes</li>
<li>Desnecessário se leitura <span><span class="MathJax_Preview">&lt;&lt;</span><script type="math/tex"><<</script></span> escrita.</li>
</ul>
</li>
<li>
<p>Reativo</p>
<ul>
<li>Réplicas só se tornam consistentes quando necessário.</li>
<li>Lento se leitura <span><span class="MathJax_Preview">&gt;&gt;</span><script type="math/tex">>></script></span> escrita</li>
</ul>
</li>
</ul>
<p><em>Qual é melhor?</em></p>
<h3 id="hibrido-lease">Híbrido: Lease</h3>
<ul>
<li>Réplica se registra para receber atualizações/notificações por um período.</li>
<li>Estado sobre réplicas é mantido enquanto possível, pelo período contratado.</li>
<li>Em caso de sobrecarga, deixa de mandar atualizações/notificações.</li>
<li>Em caso de lease antigo não renovado, deixa de mandar atualizações/notificações.</li>
<li>Em caso de renovações frequentes, aumenta o período do lease.</li>
</ul>
<h2 id="recuperacao-checkpoint">Recuperação &amp; Checkpoint</h2>
<h3 id="recuperacao">Recuperação</h3>
<p>Suponha que uma série de erros aconteceram no sistema, e que não é possível continuar o processamento como o sistema está. Neste cenário, é necessário ou avançar para um novo estado, livre de erros, ou retroceder a um estado correto anterior.</p>
<p>Voltar a um estado correto parece ser a solução mais fácil.</p>
<p>Para isso, precisamos de <em>Pontos de Recuperação</em></p>
<h4 id="snapshots">Snapshots</h4>
<p>Podem ser usados na:</p>
<ul>
<li>Recuperação do sistema.</li>
<li>Coleta de lixo (remover objetos não referenciados em nenhum outro processo).</li>
<li>Detecção de deadlocks.</li>
<li>Depuração (pausar o sistema).</li>
</ul>
<h4 id="pontos-de-recuperacao">Pontos de Recuperação</h4>
<p>Ponto de Recuperação válidos são a união de backups locais que formam um <em>Estado Global Consistente</em>.</p>
<h4 id="estado-global-consistente">Estado Global Consistente</h4>
<p><strong>O quê?</strong></p>
<p>Conjunto com um estado local de cada processo no sistema tal que toda mensagem recebida no estado local de um processo também precisa fazer parte do estado local do processo remetente.</p>
<p><strong>Linha de recuperação</strong></p>
<p>O mais recente Estado Global Consistente</p>
<p><img alt="" src="images/08-24.png" /></p>
<p><strong>Comunicação Confiável</strong></p>
<p>Se o sistema provê comunicação confiável, então toda mensagem enviada no estado local de um processo também precisa fazer parte do estado local do destinatário.</p>
<h4 id="rollback-em-cascata">Rollback em Cascata</h4>
<p><strong>Bad timing</strong></p>
<p>Se estados locais são capturados na "hora errada", a linha de recuperação pode ser o estado inicial.</p>
<p><img alt="" src="images/08-25.png" /></p>
<h4 id="armazenamento-em-disco">Armazenamento em Disco</h4>
<p>Segue a técnica já estudada.</p>
<p><img alt="" src="images/08-23.png" /></p>
<h3 id="checkpoint">Checkpoint</h3>
<h4 id="checkpointing-independente">Checkpointing independente</h4>
<p>Cada processo faz o checkpoint local independentemente, incorrendo no risco de um <em>rollback</em> em cascata.</p>
<ul>
<li>Seja <span><span class="MathJax_Preview">C_i^m</span><script type="math/tex">C_i^m</script></span> o <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>-ésimo checkpoint do processo <span><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span>.</li>
<li>Seja <span><span class="MathJax_Preview">I_i^m</span><script type="math/tex">I_i^m</script></span> o intervalo entre <span><span class="MathJax_Preview">C_i^{m-1}</span><script type="math/tex">C_i^{m-1}</script></span> e <span><span class="MathJax_Preview">C_i^m</span><script type="math/tex">C_i^m</script></span>.</li>
<li>Quando o processo <span><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span> envia a mensagem no intervalo <span><span class="MathJax_Preview">I_i^m</span><script type="math/tex">I_i^m</script></span>, envia <span><span class="MathJax_Preview">(i,m)</span><script type="math/tex">(i,m)</script></span> em piggyback</li>
<li>Quando o processo <span><span class="MathJax_Preview">p_j</span><script type="math/tex">p_j</script></span> recebe a mensagem no intervalo <span><span class="MathJax_Preview">I_j^n</span><script type="math/tex">I_j^n</script></span>, grava a dependência <span><span class="MathJax_Preview">I_i^m \rightarrow I_j^n</span><script type="math/tex">I_i^m \rightarrow I_j^n</script></span></li>
<li>A dependência <span><span class="MathJax_Preview">I_i^m \rightarrow I_j^n</span><script type="math/tex">I_i^m \rightarrow I_j^n</script></span> é salva junto com o checkpoint <span><span class="MathJax_Preview">C_j^n</span><script type="math/tex">C_j^n</script></span></li>
</ul>
<h4 id="restricao">Restrição</h4>
<ul>
<li>Se o processo <span><span class="MathJax_Preview">p_j</span><script type="math/tex">p_j</script></span> é revertido para o estado <span><span class="MathJax_Preview">C_j^n</span><script type="math/tex">C_j^n</script></span>, então o <span><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span> não pode reverter para nenhum estado anterior a <span><span class="MathJax_Preview">C_i^m</span><script type="math/tex">C_i^m</script></span>, ou não teria enviado as mensagens recebidas por <span><span class="MathJax_Preview">p_j</span><script type="math/tex">p_j</script></span> 4 inclusas em <span><span class="MathJax_Preview">C_j^n</span><script type="math/tex">C_j^n</script></span>.</li>
</ul>
<p>ou</p>
<ul>
<li>Se o processo <span><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span> é revertido para o estado <span><span class="MathJax_Preview">C_i^{m-1}</span><script type="math/tex">C_i^{m-1}</script></span>, então o <span><span class="MathJax_Preview">p_j</span><script type="math/tex">p_j</script></span> tem que ser revertido pelo menos até <span><span class="MathJax_Preview">C_j^{n-1}</span><script type="math/tex">C_j^{n-1}</script></span>, ou incluiria mensagens ainda não enviadas por <span><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span>.</li>
</ul>
<p>Como implementar a recuperação?</p>
<h4 id="caso-patologico">Caso patológico</h4>
<ul>
<li><span><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span> e <span><span class="MathJax_Preview">p_j</span><script type="math/tex">p_j</script></span> no estado inicial (<span><span class="MathJax_Preview">C_i^0, C_j^0</span><script type="math/tex">C_i^0, C_j^0</script></span>)</li>
<li><span><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span> manda mensagens para <span><span class="MathJax_Preview">p_j</span><script type="math/tex">p_j</script></span> (<span><span class="MathJax_Preview">C_i^1 \rightarrow C_j^1</span><script type="math/tex">C_i^1 \rightarrow C_j^1</script></span>)</li>
<li><span><span class="MathJax_Preview">C_j^1</span><script type="math/tex">C_j^1</script></span></li>
<li><span><span class="MathJax_Preview">p_j</span><script type="math/tex">p_j</script></span> manda mensagens para <span><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span> <span><span class="MathJax_Preview">C_j^2 \rightarrow C_i^1</span><script type="math/tex">C_j^2 \rightarrow C_i^1</script></span></li>
<li><span><span class="MathJax_Preview">C_i^1</span><script type="math/tex">C_i^1</script></span></li>
<li><span><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span> manda mensagens para <span><span class="MathJax_Preview">p_j</span><script type="math/tex">p_j</script></span> <span><span class="MathJax_Preview">C_i^2 \rightarrow C_j^2</span><script type="math/tex">C_i^2 \rightarrow C_j^2</script></span></li>
<li><span><span class="MathJax_Preview">C_j^2</span><script type="math/tex">C_j^2</script></span></li>
<li><span><span class="MathJax_Preview">p_j</span><script type="math/tex">p_j</script></span> manda mensagens para <span><span class="MathJax_Preview">p_i</span><script type="math/tex">p_i</script></span> <span><span class="MathJax_Preview">C_j^3 \rightarrow C_i^2</span><script type="math/tex">C_j^3 \rightarrow C_i^2</script></span></li>
<li><span><span class="MathJax_Preview">C_i^2</span><script type="math/tex">C_i^2</script></span></li>
<li>...</li>
</ul>
<h3 id="checkpointing-coordenado">Checkpointing coordenado</h3>
<p>Processos se coordenam por troca de mensagem para executar checkpointing "simultaneamente".</p>
<p>Qual a vantagem sobre o não coordenado?</p>
<h4 id="bloqueio-em-duas-fases">Bloqueio em duas fases</h4>
<ul>
<li>Um coordenador faz multicast da mensagem "checkpoint-request"</li>
<li>Quando um participante recebe "checkpoint-request"<ul>
<li>faz um checkpoint local</li>
<li>para de mandar mensagens da aplicação</li>
<li>responde com "checkpoint-taken"</li>
</ul>
</li>
<li>Quando "checkpoint-taken" recebido de todos os participantes, multicast "checkpoint-done"</li>
<li>Quando receber "checkpoint-done", retoma computação normal</li>
<li>Por quê funciona?  Impede formação de dependências circulares.</li>
<li>Todos os processos precisam participar?  Somente os que dependem da recuperação do coordenador.</li>
</ul>
<p>Pontos negativos? </p>
<ul>
<li>Duas fases? Já vi isso antes...  Se o coordenador falha, outros processos ficam bloqueados?  Timeout!</li>
<li>Como eleger outro coordenador? E se dois aparecerem juntos? Pode ser resolvido com um protocolo de eleição como o do RAFT. Não é garantido, mas aumenta as chances de sucesso.</li>
</ul>
<h3 id="chandy-lamport">Chandy-Lamport</h3>
<ul>
<li>Não interfere na aplicação</li>
<li>
<p>Cada processo grava snapshot independentemente</p>
</li>
<li>
<p>Observador (iniciador do snapshot)</p>
<ul>
<li>Salva o próprio estado</li>
<li>Envia uma mensagem "snapshot" aos outros processos em cada canal de saída</li>
<li>Grava as mensagens chegando em cada canal até que receba uma mensagem "snapshot" naquele canal.</li>
</ul>
</li>
<li>
<p>Um processo <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> que receba "snapshot" de um processo <span><span class="MathJax_Preview">q</span><script type="math/tex">q</script></span></p>
<ul>
<li>grava estado local <span><span class="MathJax_Preview">S_p</span><script type="math/tex">S_p</script></span></li>
<li>grava estado do canal <span><span class="MathJax_Preview">C_{q,p} =\emptyset</span><script type="math/tex">C_{q,p} =\emptyset</script></span></li>
<li>Envia uma mensagem "snapshot" aos outros processos em cada canal de saída</li>
<li>Grava as mensagens chegando em cada canal até que receba uma mensagem "snapshot" naquele canal (excluindo <span><span class="MathJax_Preview">C_{q,p}</span><script type="math/tex">C_{q,p}</script></span>)</li>
</ul>
</li>
<li>
<p>Protocolo termina para o processo <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> quando tiver recebido marcador "snapshot" em cada um de seus canais.</p>
</li>
<li>O estado global consiste dos snapshots + estado em cada um dos canais.</li>
<li>Exige canais FIFO</li>
</ul>
<h3 id="message-logging">Message Logging</h3>
<p>Em vez de checkpoints frequentes, crie um log da comunicação e o re-execute a partir do último checkpoint.</p>
<p><strong>Ideia básica:</strong>   </p>
<p>A computação é determinada pela troca de mensagens (eventos não determinísticos). 
Ao se enviar a mesma mensagem a partir de um certo estado, a computação desencadeada é sempre a mesma.</p>
<p>Realista este modelo? Há outros eventos não determinísticos no sistema?</p>
<p><img alt="" src="images/08-26.png" /></p>
<h4 id="notacao">Notação</h4>
<ul>
<li>
<p><span><span class="MathJax_Preview">Hdr(m)</span><script type="math/tex">Hdr(m)</script></span></p>
<ul>
<li>Cabeçalho da mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> contendo fonte, destino, número de sequência e número de entrega.</li>
<li>O cabeçalho contém a informação necessária para reenviar e re-receber a mensagem na ordem certa (dados devem ser reproduzidos para aplicação).</li>
<li>A mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> é estável se <span><span class="MathJax_Preview">Hdr(m)</span><script type="math/tex">Hdr(m)</script></span> estiver em memória estável.</li>
</ul>
</li>
<li>
<p><span><span class="MathJax_Preview">Dep(m)</span><script type="math/tex">Dep(m)</script></span>: o conjunto de processos a quem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> ou mensagens que dependem de <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> foram entregues.</p>
</li>
<li><span><span class="MathJax_Preview">Copy(m)</span><script type="math/tex">Copy(m)</script></span>: o conjunto de processos que tem uma cópia de <span><span class="MathJax_Preview">Hdr(m)</span><script type="math/tex">Hdr(m)</script></span> em memória volátil.</li>
</ul>
<h3 id="orfaos">Órfãos</h3>
<p><strong>Definição</strong></p>
<p>Se <span><span class="MathJax_Preview">C</span><script type="math/tex">C</script></span> é um conjunto de processos falhos, então <span><span class="MathJax_Preview">Q\not\in C</span><script type="math/tex">Q\not\in C</script></span> é um órfão se existe uma mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> tal que <span><span class="MathJax_Preview">Q \in Dep(m)</span><script type="math/tex">Q \in Dep(m)</script></span> e <span><span class="MathJax_Preview">Copy(m)\subseteq C</span><script type="math/tex">Copy(m)\subseteq C</script></span>    </p>
<p>Se os processos em <span><span class="MathJax_Preview">C</span><script type="math/tex">C</script></span> forem reiniciados, então a computação seguirá um caminho possivelmente distinto do que levou <span><span class="MathJax_Preview">Q</span><script type="math/tex">Q</script></span> a receber <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> ou um mensagem causalmente dependente de <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>.</p>
<h3 id="protocolo-pessimista">Protocolo Pessimista</h3>
<p>Para cada mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> não estável, há no máximo um processo dependente em <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> (<span><span class="MathJax_Preview">Dep(m) \leq 1</span><script type="math/tex">Dep(m) \leq 1</script></span>)</p>
<p>Uma mensagem não estável, no protocolo pessimista, deve ser estabilizada antes do envio da próxima mensagem.</p>
<p>Toda mensagem é precedida por uma escrita em disco.</p>
<p>Para cada mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> não estável, então devemos garantir que se <span><span class="MathJax_Preview">Copy(m) \subseteq C</span><script type="math/tex">Copy(m) \subseteq C</script></span>, então \emph{eventually} <span><span class="MathJax_Preview">Dep(m) \subseteq C</span><script type="math/tex">Dep(m) \subseteq C</script></span>, onde <span><span class="MathJax_Preview">C</span><script type="math/tex">C</script></span> é o conjunto de processos que falharam.</p>
<p>Para garantir que <span><span class="MathJax_Preview">Dep(m) \subseteq C</span><script type="math/tex">Dep(m) \subseteq C</script></span>, fazemos um rollback de cada órfão <span><span class="MathJax_Preview">Q</span><script type="math/tex">Q</script></span> até que <span><span class="MathJax_Preview">Q \not\in Dep(m)</span><script type="math/tex">Q \not\in Dep(m)</script></span></p>
<p>Isto é, forçamos <span><span class="MathJax_Preview">Q</span><script type="math/tex">Q</script></span> a ser recuperado mesmo que não tenha falhado.</p>
<h2 id="bancos-de-dados">Bancos de Dados</h2>
<p>Falar em bancos de dados distribuídos implica falar em bancos transacionais e P2P.</p>
<h3 id="operacoes-atomicas">Operações Atômicas</h3>
<p>Falar em bancos de dados distribuídos implica falar em bancos Relacionais/Transactionais e P2P.</p>
<p>Falar em bancos transacionais, implica falar ACID!
* Atomicidade -- Todas as operações ou nenhuma.
* Consistência -- Os dados transitam de estado válido para estado válido.
* Isolamento -- Transações não interferem umas nas outras.
* Durabilidade -- Efeitos não são esquecidos.</p>
<p>No modelo de Máquinas de Estados Replicadas, operações são enviadas para as réplicas, que as executam em ordem, deterministicamente e também <em>atomicamente</em>. Isto é, cada operação é ou executada independentemente das outras e por completo, ou não é executada.</p>
<h3 id="conjuntos-de-operacoes">Conjuntos de Operações</h3>
<p>Mesmo com Operações Atômicas, frequentemente queremos/precisamos agrupar operações tal que
* <em>todas ou nenhuma</em> sejam executadas
* mesmo na presença de falhas.</p>
<p><em>Atomicidade</em></p>
<h3 id="memoria-estavel">Memória Estável</h3>
<p>Para que os efeitos de operações não sejam esquecidos, eles precisam ser armazenados em \emph{memória estável} como
* HD -- Hard Drives
* SSD -- Solid State Drives
* NVRAM -- Non Volatile RAM</p>
<p><em>Durabilidade</em></p>
<h3 id="o-banco">O Banco</h3>
<p>Conta C</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>C.getSaldo()
C.setSaldo(montante)
</code></pre></div>
</td></tr></table>
<h4 id="transacao">Transação</h4>
<p>Mova 10% do saldo de A, de B para A.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>T1: a -&gt; b
sB = b.getSaldo()
     b.setSaldo(sB*1.1)
sA = a.getSaldo()                          
     a.setSaldo(sA-sB*0.1)
</code></pre></div>
</td></tr></table></p>
<h4 id="transacao_1">Transação</h4>
<p>Qual o saldo total das contas?
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>T2: a + b
sA = a.getSaldo()
sB = b.getSaldo()
sT = sA + sB
</code></pre></div>
</td></tr></table></p>
<h4 id="execucao-concorrente">Execução Concorrente</h4>
<p>Execução concorrente de T1 e T2?
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>T1                           T2
sB = b.getSaldo()            
                             sA = a.getSaldo()
     b.setSaldo(sB*1.1) .    
                             sB = b.getSaldo()
sA = a.getSaldo()                          
     a.setSaldo(sA-sB*0.1) 
                             sT = sA+sB
</code></pre></div>
</td></tr></table></p>
<p>Dados não finais "vazaram". <em>Dirty Read</em>. </p>
<p>Falta <em>Isolamento</em>.</p>
<p>Pode levar a mais que um resultado errado. Pode deixar o BD em estado inválido.</p>
<h4 id="execucao-concorrente_1">Execução Concorrente</h4>
<p>Mova 10\% do saldo de A, de B para A.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>T1                       T1
sB = b.getSaldo()
                          sB = b.getSaldo()
                               b.setSaldo(sB*1.1)
     b.setSaldo(sB*1.1)                                        
                          sA = a.getSaldo()                          
                               a.setSaldo(sA-sB*0.1)
sA = a.getSaldo()                          
     a.setSaldo(sA-sB*0.1)
</code></pre></div>
</td></tr></table></p>
<p><code>sB*0.1</code>  foi perdido. <em>Lost Update</em></p>
<p>Perdeu <em>Consistência</em></p>
<h4 id="solucao">Solução?!</h4>
<p>Para garantir Isolamento
* Execuções dos conjuntos não podem se sobrepor.
* Execute um conjunto de operações por vez, serialmente!
* Garantirá também Consistência</p>
<p><em>Que tal?</em></p>
<p>Limite a concorrência de transações.</p>
<h2 id="equivalencia-serial">Equivalência Serial</h2>
<h3 id="concorrencia">Concorrência</h3>
<p>Além de ACID, queremos o máximo de \emph{concorrência} para garantir o melhor \emph{desempenho}.</p>
<p>Queremos uma execução das transações semelhante à serial, mas com o desempenho de concorrente.</p>
<p>Não queremos uma execução serial, mas uma \alert{Equivalência Serial}, isto é, que os efeitos das transações, executadas concorrentemente, sejam equivalentes aos de alguma execução serial destas transações.</p>
<h3 id="equivalencia-serial_1">Equivalência Serial</h3>
<p>Preocupe-se com Operações Conflitantes</p>
<ul>
<li>Transações diferentes</li>
<li>Uma é escrita</li>
<li>Mesmo dado</li>
</ul>
<p>Duas execuções (de transações) são equivalentes se</p>
<ul>
<li>as transações tem as mesmas operações</li>
<li>quaisquer duas operações conflitantes são executadas na mesma ordem nas duas execuções</li>
</ul>
<p>Uma execução tem Equivalência Serial se é equivalente a alguma execução serial das transações.</p>
<p>Escalone operações concorrentemente, de forma a obter o melhor desempenho, mas de forma a manter Equivalência Serial.</p>
<p>Esta definição difícil de ser testada. Algo mais simples?</p>
<ul>
<li>Como demonstrar Equivalência Serial? </li>
<li>Tenho que testar todas as execuções seriais e ver se uma casa com o que planejo fazer?</li>
<li>É caro fazer este planejamento. É mais eficiente garantir por construção.</li>
</ul>
<p>Simplificação: A execução de duas transações tem Equivalência Serial se todos os pares de operações conflitantes entre as transações são executados na mesma ordem.</p>
<h3 id="lost-update">Lost Update</h3>
<p>Mova 10% do saldo de X, de Y para X.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>a -&gt; b                     c -&gt; b
s = b.getSaldo() [1]
                           [2]s = b.getSaldo()
                           [3]    b.setSaldo(s*1.1)
    b.setSaldo(s*1.1)[4]                                        
                                  c.setSaldo(s*0.1)
    a.setSaldo(s*0.1)
</code></pre></div>
</td></tr></table></p>
<p>Conflitos: 1x3:<span><span class="MathJax_Preview">\rightarrow</span><script type="math/tex">\rightarrow</script></span>, 2x4:<span><span class="MathJax_Preview">\leftarrow</span><script type="math/tex">\leftarrow</script></span>, 3x4:<span><span class="MathJax_Preview">\leftarrow</span><script type="math/tex">\leftarrow</script></span></p>
<p>Consistência -- <code>s*0.1</code> foi perdido</p>
<p>Mova 10% do saldo de X, de Y para X.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>a -&gt; b                    c -&gt; b
                          [2] s = b.getSaldo()
                          [3]     b.setSaldo(s*1.1)
s = b.getSaldo() [1]
    b.setSaldo(s*1.1)[4]                                        
                                  c.setSaldo(s*0.1)
    a.setSaldo(saldo*0.1)
</code></pre></div>
</td></tr></table></p>
<p>Conflitos: 1x3:<span><span class="MathJax_Preview">\leftarrow</span><script type="math/tex">\leftarrow</script></span>, 2x4:<span><span class="MathJax_Preview">\leftarrow</span><script type="math/tex">\leftarrow</script></span>, 3x4:<span><span class="MathJax_Preview">\leftarrow</span><script type="math/tex">\leftarrow</script></span></p>
<h3 id="dirty-read">Dirty Read</h3>
<p>Saldo total?
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>a -&gt; b                  a -&gt; b
s = b.getSaldo()
    b.setSaldo(s*1.1)
    b.setSaldo(s*1.1)                                        
    a.saque(s*0.1)
                        s = b.getSaldo()
                            b.setSaldo(s*1.1)
                            b.setSaldo(s*1.1)                                        
                            a.saque(s*0.1)
</code></pre></div>
</td></tr></table>
 Tem Equivalência Serial.</p>
<p>Exceto se
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>abortTransaction()
</code></pre></div>
</td></tr></table>
Nenhuma transação que fez uma dirty read pode comitar. Logo, aborte a transação da direita.</p>
<h3 id="aborto-em-cascata">Aborto em Cascata</h3>
<p>T1 faz uma escrita. T2 lê o que T1 escreveu e faz outra escrita. T3 lê o que T2 escreveu e faz outra escrita. T4 lê o que... \alert{T1 aborta.</p>
<h3 id="dirty-read_1">Dirty Read</h3>
<p>Como lidar?</p>
<ul>
<li>Suspenda a transação quando esta fizer dirty read.</li>
<li>Se transação foi abortada, todas as suspensas (que leram dela) devem ser abortadas.</li>
<li>Repita passo anterior.</li>
</ul>
<p>E se evitarmos dirty reads em vez de tratarmos?</p>
<ul>
<li>Suspenda antes de fazer dirty read.</li>
<li>Quando transação for terminada, continue execução.</li>
</ul>
<p>Abordagem leva a menor concorrência.</p>
<p>Para nos permitir identificar transações, vamos usar o seguinte framework para operá-las.</p>
<h3 id="transacoes_1">Transações</h3>
<ul>
<li>beginTransaction()</li>
<li>operações</li>
<li>commitTransaction(): Ok/NOk</li>
<li>abortTransaction()</li>
</ul>
<h3 id="escrita-prematura">Escrita Prematura</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Saldo inicial: 100

a.setSaldo(105)
                   a.setSaldo(110)  
                   commitTransaction()
abortTransaction()
</code></pre></div>
</td></tr></table>
<p>A transação da direita não le, apenas escreve. O resultado?  O saldo volta para 100.</p>
<h3 id="strict-execution">Strict Execution</h3>
<ul>
<li>Leituras e Escritas devem ser atrasadas até que todas as transações anteriores que contenham escritas sejam commitadas ou abortadas.</li>
<li>Execução estrita garante Isolamento.</li>
<li>Como implementar eficientemente?</li>
</ul>
<h2 id="controle-de-concorrencia">Controle de Concorrência</h2>
<h3 id="como">Como</h3>
<ul>
<li>locks (pessimista): simples, mas problemático</li>
<li>multi-versão (otimista): custo se há muitos conflitos</li>
<li>timestamp: \alert{time} é algo complicado</li>
</ul>
<h3 id="locks">Locks</h3>
<p>Tranque todos os objetos para que outras transações não consigam ler ou escrevê-los. Destranque quando não mais necessários.</p>
<p>Sofre de dirty reads e escritas prematuras.</p>
<h4 id="strict-two-phase-locking">Strict Two Phase Locking</h4>
<ul>
<li>tranque quando necessário</li>
<li>destranque ao final da transação</li>
<li>termine a transação</li>
</ul>
<p>Como aumentar a concorrência?</p>
<h3 id="read-write-locks">Read-Write Locks</h3>
<ul>
<li>dois níveis de acesso</li>
<li>múltiplos leitores</li>
<li>único escritor</li>
<li>reads por ser transformados em locks</li>
<li>writes \alert{não} podem se transformados em reads (violaria Strict Two-Phase Locking)</li>
</ul>
<!--
### variantes

* two-version locking (read/write/commit)
%   similar idea but now with: read, write and commit locks.
%   
%       * a read lock is allowed unless a commit lock is taken.
%       * one write lock is allowed if no commit lock is taken (i.e. even if read locks are taken)
%       * written values are held local to the transaction and are not visible before commit.
%       * a write lock can be promoted to a commit lock if there are no read locks.
%       * when a transaction commits it tries to promote write locks to commit locks.
%   
* lock hierárquico (granularidades variadas)
%   locks of mixed granularity.
%   
%       * small locks increase concurrency
%       * large locks decrease overhead
%   
-->

<h3 id="lock-por-que-evitar">Lock -- por que evitar?</h3>
<ul>
<li>pessimista</li>
<li>overhead mesmo se não há conflitos</li>
<li>ou restritivo ou risco de deadlock</li>
<li>lock liberado somente no final, para evitar dirty reads/escrita prematura.</li>
</ul>
<h3 id="abordagem-mais-otimista">Abordagem mais otimista?</h3>
<ul>
<li>modifique uma cópia privada dos dados</li>
<li>na hora de terminar a transação, verifique se nenhuma transação modificou o dado, isto é, se a cópia privada ainda é válida</li>
<li>substitua a cópia pública pela privada</li>
</ul>
<p>Esta técnica é conhecida como <em>deferred update</em>, pois o update dos dados só ocorre no final, se a validação passar.</p>
<h4 id="abordagem-otimista">Abordagem otimista</h4>
<ul>
<li>baixo overhead, se não houver conflitos</li>
<li>validação é rápida</li>
<li>update é simples</li>
</ul>
<p>Se houver muitos conflitos, o trabalho da transação é todo desperdiçado.</p>
<h3 id="validacao">Validação</h3>
<p>read e write sets de quaisquer transações concorrentes deve ser disjuntos.</p>
<ul>
<li>t1 não deve ler dados escritos por t2</li>
<li>t2 não deve ler dados escritos por t1</li>
<li>t1/t2 não deve escrever dados escritos por t2/t1</li>
</ul>
<p><img alt="" src="images/trans_validation.png" /></p>
<h4 id="backward-validation">Backward validation</h4>
<ul>
<li>t1: transação sendo validada</li>
<li>t2: transação já comitada.</li>
<li>t1 não deve ler dados escritos por t2</li>
</ul>
<p>Em caso de não validação, aborte t1</p>
<p><img alt="" src="images/trans_validation.png" /></p>
<h4 id="forward-validation">Forward validation</h4>
<ul>
<li>t1: transação sendo validada</li>
<li>t2: transação ainda em execução</li>
<li>t2 não deve ler dados escritos por t1</li>
</ul>
<p>Em caso de não validação, aborte t1, possivelmente nunca terminando uma transação.<br/>
ou aborte t2.</p>
<p><img alt="" src="images/trans_validation.png" /></p>
<h3 id="timestamping">Timestamping</h3>
<ul>
<li>transação recebe um <em>timestamp</em> no início</li>
<li>operações são validadas na execução<ul>
<li>leia somente se nenhuma transação com maior timestamp tiver escrito e comitado</li>
<li>escreva somente se nenhuma transação com maior timestamp tiver lido e comitado</li>
</ul>
</li>
<li>transações "executam na ordem do timestamp"</li>
</ul>
<p>Como implementar?</p>
<h4 id="como-implementar">Como implementar</h4>
<ul>
<li>objetos tem valores <em>tentativos</em>, não comitados</li>
<li>objetos tem versões em que foram escritos</li>
<li>em que foram comitados</li>
<li>e em que foram lidos</li>
</ul>
<p><img alt="" src="images/timestamp1.png" /></p>
<ul>
<li>consistência é testado na execução da operação</li>
</ul>
<h4 id="como-implementar-escrita">Como implementar -- escrita</h4>
<ul>
<li>escritas tem sucesso somente se versão sendo escrita é maior que versões lidas</li>
<li>se versão sendo escrita é menor que versão já escrita, ignore e continue</li>
</ul>
<p><img alt="" src="images/timestamp1.png" /></p>
<h3 id="como-implementar-leitura">como implementar -- leitura</h3>
<ul>
<li>leitura com versão v tem sucesso se maior versão é comitada e menor que v ou alguma não comitada</li>
<li>leitura com versão v é suspensa se maior versão é não comitada e menor que v</li>
</ul>
<p><img alt="" src="images/timestamp2.png" /></p>
<ul>
<li>leitura com versão v é abortada se maior versão comitada é maior que v
<img alt="" src="images/timestamp3.png" /></li>
</ul>
<h4 id="referencias_1">Referências</h4>
<p>Inspirado nas notas de aula de johan montelius e vladimir vlassov, da disciplina id2201 distributed systems, kth royal institute of technology. imagens copiadas descaradamente de seus slides.</p>
<p>Também aqui, <a href="https://www.cs.ucy.ac.cy/~dzeina/courses/epl446/lectures/16.pdf">https://www.cs.ucy.ac.cy/~dzeina/courses/epl446/lectures/16.pdf</a></p>
<h2 id="bancos-de-dados-distribuidos_1">Bancos de dados distribuídos</h2>
<h2 id="bancos-de-dados-transacionais-distribuidos">bancos de dados transacionais distribuídos</h2>
<p>Agora que relembramos como transações funcionam e temos uma noção de como podem ser implementadas em um sistema centralizado, vamos tentar entender como fazê-lo em um sistema distribuído.</p>
<ul>
<li>múltiplos servidores</li>
<li>transações em cada servidor</li>
<li>transações distribuídas</li>
<li>como obter equivalência serial em transações distribuídas</li>
</ul>
<h2 id="transacao-distribuida">Transação distribuída</h2>
<ul>
<li>begintransaction(): tid (transaction id)</li>
<li>operation(tid,op)</li>
<li>endtransaction(tid): ok/nok</li>
<li>aborttransaction(tid)</li>
</ul>
<h3 id="papeis">Papéis</h3>
<ul>
<li>cliente</li>
<li>servidor: <em>resource managers</em></li>
<li>servidor: <em>transaction monitor/manager</em></li>
</ul>
<p><img alt="" src="images/01-10.png" /></p>
<p>Localmente, cada bd funciona como um sistema centralizado normal, usando abordagens otimistas ou pessimista para garantir consistência.</p>
<p>O grande problema no bd distribuído é garantir o <em>acordo</em> na terminação.</p>
<h2 id="comprometimento-distribuido">Comprometimento distribuído</h2>
<h3 id="atomicidade">atomicidade</h3>
<p>O problema...</p>
<ul>
<li>transação <span><span class="MathJax_Preview">t</span><script type="math/tex">t</script></span> acessa recursos nos resource managers (rm)</li>
<li>terminar com sucessos <span><span class="MathJax_Preview">t</span><script type="math/tex">t</script></span> em todos os rm -- commit -- ou</li>
<li>abortar <span><span class="MathJax_Preview">t</span><script type="math/tex">t</script></span> em todos os rm</li>
<li>ainda que enlaces de comunicação, nós e rm falhem, antes ou durante a terminação da transação.</li>
</ul>
<h3 id="2pc-2-phase-commit">2PC - 2 Phase Commit</h3>
<ul>
<li>participante -- resource manager "tocados" pela transação</li>
<li>coordenador -- transaction manager</li>
</ul>
<h4 id="premissas">Premissas</h4>
<ul>
<li>Cliente decide quando iniciar o commit.</li>
<li>Cada participante faz commit ou abort da transação local.<br/>
pode retornar ok ou nok.</li>
<li>Coordenador não começa a commit até que a <span><span class="MathJax_Preview">t</span><script type="math/tex">t</script></span> tenha terminado em todos os participantes e cliente tenha solicitado.</li>
<li>Participantes falham por parada.</li>
</ul>
<h4 id="1pc">1PC</h4>
<ul>
<li>cliente envia \verb|endtransaction(tid)| para o coordenador</li>
<li>coordenador envia mensagem para participantes "comitarem" </li>
<li>e se um participante retornar nok? % enquanto outros retornam ok?</li>
<li>e se um participante não responder?</li>
</ul>
<h4 id="2pc">2PC</h4>
<ul>
<li>cliente envia <code>endtransaction(tid)</code> para o coordenador</li>
<li>coordenador envia mensagem para participantes se prepararem para terminar</li>
<li>coordenador espera que todos se preparem ou digam se não podem</li>
<li>coordenador envia <em>ordem</em> de terminação</li>
</ul>
<h4 id="comprometimento">Comprometimento</h4>
<ul>
<li>um participante <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> está pronto para commit se tiver todos os valores modificados por <span><span class="MathJax_Preview">t</span><script type="math/tex">t</script></span> em memória estável e nenhuma razão para abortar a transação (outras transações conflituosas fizeram commit?)</li>
<li>o coordenador não pode começar a terminação até que todos os participantes estejam prontos.</li>
<li>se algum participante aborta, o coordenador deve abortar. </li>
</ul>
<p>Problema de acordo, mas não igual ao consenso.</p>
<h4 id="2pc-o-protocolo">2PC -- o protocolo</h4>
<ul>
<li>
<p>fase 1</p>
<ul>
<li>a: coordenador envia vote-request para participantes.</li>
<li>b: participante responde com vote-commit ou vote-abort para o coordenador; se vote-abort, aborta localmente.</li>
</ul>
</li>
<li>
<p>fase 2</p>
<ul>
<li>a: coordenador coleta votos de todos os processos; se forem todos vote-commit, envia global-commit para os participantes e ok para o cliente</li>
<li>b: participantes esperam por global-commit ou global-abort</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th><strong>Coordenador</strong></th>
<th><strong>Participante</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="" src="images/08-18a.png" /></td>
<td><img alt="" src="images/08-18b.png" /></td>
</tr>
</tbody>
</table>
<h4 id="falha-no-participante">Falha no Participante</h4>
<p>Participante falha no estado <span><span class="MathJax_Preview">S</span><script type="math/tex">S</script></span> e, ao se recuperar, identifica tal fato ao reprocessar o log de operações em memória durável.</p>
<p>Se está no estado</p>
<ul>
<li>INIT:  nem sabia que a terminação começou.  Aborta unilateralmente, pois ou já abortaram ou vão abortar.</li>
<li>ABORT: havia votado abort ou recebido global-abort -- continua protocolo.</li>
<li>COMMIT: estava pronto para terminar a transação com sucesso -- continua protocolo.</li>
<li>READY:  estava esperando por commit ou abort.  Precisa saber se coordenador enviou global-commit ou global-abort -- consulta coordenador.</li>
</ul>
<h4 id="2pc_1">2PC</h4>
<p>Por que é difícil?</p>
<ul>
<li>E se <span><span class="MathJax_Preview">R_i</span><script type="math/tex">R_i</script></span> falhar depois de ter se preparado?</li>
<li>E se <span><span class="MathJax_Preview">R_i</span><script type="math/tex">R_i</script></span> falhar mas <span><span class="MathJax_Preview">R_j</span><script type="math/tex">R_j</script></span> continuar funcionando?</li>
<li>E se todos estiverem desligados quando <span><span class="MathJax_Preview">R_i</span><script type="math/tex">R_i</script></span> se recuperar?</li>
<li>E se <span><span class="MathJax_Preview">R_i</span><script type="math/tex">R_i</script></span> estiver lento e parecer que a transação falhou?</li>
</ul>
<h4 id="falha-no-participante_1">Falha no Participante</h4>
<ul>
<li>READY: esperando por commit ou abort. Precisa saber se coordenador enviou global-commit our global-abort -- consulta coordenador.</li>
</ul>
<p><em>E se coordenador não estiver presente?</em></p>
<p>Assumindo que participantes se conhecem, contate participante <span><span class="MathJax_Preview">Q</span><script type="math/tex">Q</script></span>   </p>
<ul>
<li>Se <span><span class="MathJax_Preview">Q</span><script type="math/tex">Q</script></span> em COMMIT , vai para COMMIT</li>
<li>Se <span><span class="MathJax_Preview">Q</span><script type="math/tex">Q</script></span> em ABORT , vai para ABORT</li>
<li>Se <span><span class="MathJax_Preview">Q</span><script type="math/tex">Q</script></span> em INIT , ordena que Q aborte e, se confirmado, veja passo anterior</li>
<li>Se <span><span class="MathJax_Preview">Q</span><script type="math/tex">Q</script></span> em READY , consulta outro participante.</li>
</ul>
<p><em>Se todos os participantes em READY?</em>  Possivelmente o coordenador já respondeu ao cliente.</p>
<p><em>Precisa</em> esperar pelo coordenador.</p>
<h4 id="falha-no-coordenador">Falha no Coordenador</h4>
<p>O problema principal é: e se ninguém ouviu a decisão final do coordenador?</p>
<p>Neste caso, o protocolo não pode continuar, enquanto o coordenador não retornar, pois se os RM abortarem, podem estar contradizendo algo dito ao cliente, por exemplo, "Sim, ATM, pode entregar o dinheiro", ou executando um comando que o cliente vê como anulado, como "Reenvie o pedido de mais 27 carros à fábrica."</p>
<h4 id="recuperacao-do-coordenador">Recuperação do Coordenador</h4>
<p>Ao se recuperar, o coordenador:</p>
<ul>
<li>sabe se começou a terminação de alguma transação</li>
<li>sabe se já enviou alguma resposta final para as transações inacabadas</li>
<li>sabe se já recebeu a confirmação de todos os participantes (se transação não estiver em aberto)</li>
<li>reenvia a última mensagem das transações em aberto.</li>
</ul>
<h4 id="otimizacoes">Otimizações</h4>
<ul>
<li>
<p>Participantes "somente-leitura"</p>
<ul>
<li>Não se importa com a decisão; termina após fase 1.</li>
<li>Responde com vote-commit-ro</li>
</ul>
</li>
<li>
<p>Abort presumido</p>
<ul>
<li>Se ocorrer timeout, coordenador envia global-abort a todos e esquece transação</li>
<li>Se questionado, responde com global-abort.</li>
</ul>
</li>
<li>
<p>Transferência de coordenação</p>
<ul>
<li>se houver somente um participante...</li>
<li>vote-request-transfer</li>
<li>participante responde com global-commit/global-abort</li>
</ul>
</li>
</ul>
<h4 id="coleta-de-lixo">Coleta de Lixo</h4>
<p>Mesmo quando somente um participante falha...</p>
<p>Após receber decisão, o participante pode concluir e esquecer a transação. </p>
<p>Mas e se o participante falho precisar se recuperar e todos os outros envolvidos tiverem esquecido a transação?</p>
<p>Coleta de lixo só pode ser feita quando todos tiverem confirmado a execução da transação e, por isso, Fase 2b é necessária.</p>
<h3 id="3-pc">3-PC</h3>
<p>Estende o protocolo para permitir contornar  falha do coordenador.</p>
<h4 id="o-protocolo">O Protocolo</h4>
<ul>
<li>Fase 1a -- Coordenador envia vote-request para participantes.</li>
<li>Fase 1b -- Participante responde com vote-commit ou vote-abort para o coordenador; se vote-abort, aborta localmente.</li>
<li>Fase 2a -- Coordenador coleta votos de todos os processos; se forem todos vote-commit, envia \alert{prepare-commit} para os participantes; se não, global-abort e para.</li>
<li>Fase 2b -- Participantes esperam por prepare-commit ou global-abort; se o primeiro, \alert{respondem com ready-commit}; se o segundo, param.</li>
<li>Fase 3a -- coordenador espera por ready-commit de todos e então envia global-commit.</li>
<li>Fase 3b -- participantes esperam por global-commit.</li>
</ul>
<table>
<thead>
<tr>
<th>Coordenador</th>
<th>Participante</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="" src="images/08-22a.png" /></td>
<td><img alt="" src="images/08-22b.png" /></td>
</tr>
</tbody>
</table>
<h4 id="falha-no-participante_2">Falha no Participante</h4>
<p><span><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span> consegue saber o que fazer após se recuperar da falha no estado READY ou PRE-COMMIT</p>
<ul>
<li>Participantes e coordenador não distam mais que um estado.</li>
<li>Se alguém em READY, o coordenador não mandou global-commit ainda; Aborte.</li>
<li>Se <em>todos</em> em PRE-COMMIT, é possível comitar, comite.</li>
<li>A execução dos passos anteriores tem que anular o poder do coordenador.</li>
</ul>
<p><em>Se todos os participantes em READY?</em></p>
<h4 id="3pc-x-2pc">3PC x 2PC</h4>
<ul>
<li>3PC -- Aumenta disponibilidade</li>
<li>2PC -- Falha do coordenador é "corner case"</li>
<li>3PC -- Aumenta o custo do "caminho feliz" e por isso não é usado na prática</li>
<li>Nenhum escala e não usá-los é uma das razões para o surgimento dos sistemas NoSQL</li>
</ul>
<h3 id="paxos-commit">Paxos-Commit</h3>
<p>Usa instâncias de Consenso Distribuído para votar. Se o consenso é tolerante a falhas e consistente, todos vêem o mesmo resultado na transação.</p>
<h4 id="o-protocolo_1">O protocolo</h4>
<ul>
<li>Para terminar a transação <span><span class="MathJax_Preview">T</span><script type="math/tex">T</script></span>, o coordenador envia request-commit a todos os participantes.</li>
<li>Um participante <span><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span> propõe seu voto na instância <span><span class="MathJax_Preview">T_P</span><script type="math/tex">T_P</script></span> de consenso.</li>
<li>
<p>Todo participante <span><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span> espera pelas decisões das instâncias de consenso <span><span class="MathJax_Preview">T_i</span><script type="math/tex">T_i</script></span> para todos os participantes <span><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span>, inclusive si mesmo; se todas as decisões forem commit, o participante comita a transação.</p>
</li>
<li>
<p>Se cansar de esperar por <span><span class="MathJax_Preview">T_Q</span><script type="math/tex">T_Q</script></span>, o participante propõe abort em <span><span class="MathJax_Preview">T_Q</span><script type="math/tex">T_Q</script></span>.</p>
</li>
</ul>
<h4 id="falha-no-participante_3">Falha no Participante</h4>
<ul>
<li>Se o participante falha antes de votar, então alguém votará abort por ele.</li>
<li>Se o participante <span><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span> falha, ou é suspeito de, então é possível que dois votos diferentes tenham sido propostos em <span><span class="MathJax_Preview">T_P</span><script type="math/tex">T_P</script></span>; isso não é um problema pois a decisão é a mesma para todos observando a instância.</li>
<li>Após se recuperar, o participante recupera as decisões de todas as instâncias <span><span class="MathJax_Preview">T_i</span><script type="math/tex">T_i</script></span> e termina apropriadamente.</li>
</ul>
<h2 id="log-recuperavel">Log Recuperável</h2>
<p>Como garantir que o log poderá ser lido para recuperar o processo?</p>
<h3 id="disco-duplicado">Disco Duplicado</h3>
<p><img alt="" src="images/08-23.png" /></p>
<ul>
<li>Dois discos iguais?</li>
<li>Dados diferentes, mas ambos bons?</li>
<li>Um bom outro estragado?</li>
<li>Ambos estragados?</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../fault/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Tolerância a Falhas
              </div>
            </div>
          </a>
        
        
          <a href="../tech/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Tecnologias
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.fd16492e.min.js"></script>
      <script src="../assets/javascripts/bundle.7836ba4d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>