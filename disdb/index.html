
<!doctype html>
<html lang="pt" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Bancos de Dados - Notas em Sistemas Distribuídos</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-PJX835H7DP","lasarojc.github.org/dsnotes"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#transacoes" class="md-skip">
          Ir para o conteúdo
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-header__button md-logo" aria-label="Notas em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Notas em Sistemas Distribuídos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Bancos de Dados
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Buscar" placeholder="Buscar" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Notas em Sistemas Distribuídos
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../preface/" class="md-nav__link">
        Prefácio
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/" class="md-nav__link">
        Fundamentos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../arch/" class="md-nav__link">
        Arquiteturas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../comm/" class="md-nav__link">
        Comunicação
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../coord/" class="md-nav__link">
        Coordenação
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../time/" class="md-nav__link">
        Tempo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../fault/" class="md-nav__link">
        Tolerância a Falhas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../consistency/" class="md-nav__link">
        Consistência
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Bancos de Dados
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Bancos de Dados
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#transacoes" class="md-nav__link">
    Transações
  </a>
  
    <nav class="md-nav" aria-label="Transações">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#o-banco" class="md-nav__link">
    O Banco
  </a>
  
    <nav class="md-nav" aria-label="O Banco">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transacao" class="md-nav__link">
    Transação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transacao_1" class="md-nav__link">
    Transação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execucao-concorrente" class="md-nav__link">
    Execução Concorrente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execucao-concorrente_1" class="md-nav__link">
    Execução Concorrente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solucao" class="md-nav__link">
    Solução?!
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#equivalencia-serial" class="md-nav__link">
    Equivalência Serial
  </a>
  
    <nav class="md-nav" aria-label="Equivalência Serial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#concorrencia" class="md-nav__link">
    Concorrência
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equivalencia-serial_1" class="md-nav__link">
    Equivalência Serial
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lost-update" class="md-nav__link">
    Lost Update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dirty-read" class="md-nav__link">
    Dirty Read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aborto-em-cascata" class="md-nav__link">
    Aborto em Cascata
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dirty-read_1" class="md-nav__link">
    Dirty Read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transacoes_1" class="md-nav__link">
    Transações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escrita-prematura" class="md-nav__link">
    Escrita Prematura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strict-execution" class="md-nav__link">
    Strict Execution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controle-de-concorrencia" class="md-nav__link">
    Controle de Concorrência
  </a>
  
    <nav class="md-nav" aria-label="Controle de Concorrência">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#como" class="md-nav__link">
    Como
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locks" class="md-nav__link">
    Locks
  </a>
  
    <nav class="md-nav" aria-label="Locks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strict-two-phase-locking" class="md-nav__link">
    Strict Two Phase Locking
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-write-locks" class="md-nav__link">
    Read-Write Locks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lock-por-que-evitar" class="md-nav__link">
    Lock -- por que evitar?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abordagem-mais-otimista" class="md-nav__link">
    Abordagem mais otimista?
  </a>
  
    <nav class="md-nav" aria-label="Abordagem mais otimista?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abordagem-otimista" class="md-nav__link">
    Abordagem otimista
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validacao" class="md-nav__link">
    Validação
  </a>
  
    <nav class="md-nav" aria-label="Validação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backward-validation" class="md-nav__link">
    Backward validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-validation" class="md-nav__link">
    Forward validation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timestamping" class="md-nav__link">
    Timestamping
  </a>
  
    <nav class="md-nav" aria-label="Timestamping">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#como-implementar" class="md-nav__link">
    Como implementar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-implementar-escrita" class="md-nav__link">
    Como implementar -- escrita
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-implementar-leitura" class="md-nav__link">
    como implementar -- leitura
  </a>
  
    <nav class="md-nav" aria-label="como implementar -- leitura">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bancos-de-dados-distribuidos" class="md-nav__link">
    Bancos de dados distribuídos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bancos-de-dados-transacionais-distribuidos" class="md-nav__link">
    bancos de dados transacionais distribuídos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transacao-distribuida" class="md-nav__link">
    Transação distribuída
  </a>
  
    <nav class="md-nav" aria-label="Transação distribuída">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#papeis" class="md-nav__link">
    Papéis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comprometimento-distribuido" class="md-nav__link">
    Comprometimento distribuído
  </a>
  
    <nav class="md-nav" aria-label="Comprometimento distribuído">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#atomicidade" class="md-nav__link">
    atomicidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc-2-phase-commit" class="md-nav__link">
    2PC - 2 Phase Commit
  </a>
  
    <nav class="md-nav" aria-label="2PC - 2 Phase Commit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#premissas" class="md-nav__link">
    Premissas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1pc" class="md-nav__link">
    1PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc" class="md-nav__link">
    2PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprometimento" class="md-nav__link">
    Comprometimento
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc-o-protocolo" class="md-nav__link">
    2PC -- o protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc_1" class="md-nav__link">
    2PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_1" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-coordenador" class="md-nav__link">
    Falha no Coordenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recuperacao-do-coordenador" class="md-nav__link">
    Recuperação do Coordenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#otimizacoes" class="md-nav__link">
    Otimizações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coleta-de-lixo" class="md-nav__link">
    Coleta de Lixo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-pc" class="md-nav__link">
    3-PC
  </a>
  
    <nav class="md-nav" aria-label="3-PC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#o-protocolo" class="md-nav__link">
    O Protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_2" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3pc-x-2pc" class="md-nav__link">
    3PC x 2PC
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paxos-commit" class="md-nav__link">
    Paxos-Commit
  </a>
  
    <nav class="md-nav" aria-label="Paxos-Commit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#o-protocolo_1" class="md-nav__link">
    O protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_3" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#log-recuperavel" class="md-nav__link">
    Log Recuperável
  </a>
  
    <nav class="md-nav" aria-label="Log Recuperável">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disco-duplicado" class="md-nav__link">
    Disco Duplicado
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estruturas-de-dados-para-sd" class="md-nav__link">
    Estruturas de Dados para SD
  </a>
  
    <nav class="md-nav" aria-label="Estruturas de Dados para SD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-structured-merge-tree" class="md-nav__link">
    Log Structured Merge Tree
  </a>
  
    <nav class="md-nav" aria-label="Log Structured Merge Tree">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compactacoes" class="md-nav__link">
    Compactações
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtros-de-bloom" class="md-nav__link">
    Filtros de Bloom
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias_1" class="md-nav__link">
    Referências
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../disfs/" class="md-nav__link">
        Sistemas de Arquivos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tech/" class="md-nav__link">
        Tecnologias
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../projeto/" class="md-nav__link">
        Projeto
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#transacoes" class="md-nav__link">
    Transações
  </a>
  
    <nav class="md-nav" aria-label="Transações">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#o-banco" class="md-nav__link">
    O Banco
  </a>
  
    <nav class="md-nav" aria-label="O Banco">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#transacao" class="md-nav__link">
    Transação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transacao_1" class="md-nav__link">
    Transação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execucao-concorrente" class="md-nav__link">
    Execução Concorrente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execucao-concorrente_1" class="md-nav__link">
    Execução Concorrente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solucao" class="md-nav__link">
    Solução?!
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#equivalencia-serial" class="md-nav__link">
    Equivalência Serial
  </a>
  
    <nav class="md-nav" aria-label="Equivalência Serial">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#concorrencia" class="md-nav__link">
    Concorrência
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equivalencia-serial_1" class="md-nav__link">
    Equivalência Serial
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lost-update" class="md-nav__link">
    Lost Update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dirty-read" class="md-nav__link">
    Dirty Read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aborto-em-cascata" class="md-nav__link">
    Aborto em Cascata
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dirty-read_1" class="md-nav__link">
    Dirty Read
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transacoes_1" class="md-nav__link">
    Transações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#escrita-prematura" class="md-nav__link">
    Escrita Prematura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#strict-execution" class="md-nav__link">
    Strict Execution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controle-de-concorrencia" class="md-nav__link">
    Controle de Concorrência
  </a>
  
    <nav class="md-nav" aria-label="Controle de Concorrência">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#como" class="md-nav__link">
    Como
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#locks" class="md-nav__link">
    Locks
  </a>
  
    <nav class="md-nav" aria-label="Locks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#strict-two-phase-locking" class="md-nav__link">
    Strict Two Phase Locking
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#read-write-locks" class="md-nav__link">
    Read-Write Locks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lock-por-que-evitar" class="md-nav__link">
    Lock -- por que evitar?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#abordagem-mais-otimista" class="md-nav__link">
    Abordagem mais otimista?
  </a>
  
    <nav class="md-nav" aria-label="Abordagem mais otimista?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abordagem-otimista" class="md-nav__link">
    Abordagem otimista
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validacao" class="md-nav__link">
    Validação
  </a>
  
    <nav class="md-nav" aria-label="Validação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backward-validation" class="md-nav__link">
    Backward validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#forward-validation" class="md-nav__link">
    Forward validation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timestamping" class="md-nav__link">
    Timestamping
  </a>
  
    <nav class="md-nav" aria-label="Timestamping">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#como-implementar" class="md-nav__link">
    Como implementar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-implementar-escrita" class="md-nav__link">
    Como implementar -- escrita
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-implementar-leitura" class="md-nav__link">
    como implementar -- leitura
  </a>
  
    <nav class="md-nav" aria-label="como implementar -- leitura">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bancos-de-dados-distribuidos" class="md-nav__link">
    Bancos de dados distribuídos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bancos-de-dados-transacionais-distribuidos" class="md-nav__link">
    bancos de dados transacionais distribuídos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transacao-distribuida" class="md-nav__link">
    Transação distribuída
  </a>
  
    <nav class="md-nav" aria-label="Transação distribuída">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#papeis" class="md-nav__link">
    Papéis
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comprometimento-distribuido" class="md-nav__link">
    Comprometimento distribuído
  </a>
  
    <nav class="md-nav" aria-label="Comprometimento distribuído">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#atomicidade" class="md-nav__link">
    atomicidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc-2-phase-commit" class="md-nav__link">
    2PC - 2 Phase Commit
  </a>
  
    <nav class="md-nav" aria-label="2PC - 2 Phase Commit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#premissas" class="md-nav__link">
    Premissas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1pc" class="md-nav__link">
    1PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc" class="md-nav__link">
    2PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comprometimento" class="md-nav__link">
    Comprometimento
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc-o-protocolo" class="md-nav__link">
    2PC -- o protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2pc_1" class="md-nav__link">
    2PC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_1" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-coordenador" class="md-nav__link">
    Falha no Coordenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recuperacao-do-coordenador" class="md-nav__link">
    Recuperação do Coordenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#otimizacoes" class="md-nav__link">
    Otimizações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coleta-de-lixo" class="md-nav__link">
    Coleta de Lixo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-pc" class="md-nav__link">
    3-PC
  </a>
  
    <nav class="md-nav" aria-label="3-PC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#o-protocolo" class="md-nav__link">
    O Protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_2" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3pc-x-2pc" class="md-nav__link">
    3PC x 2PC
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paxos-commit" class="md-nav__link">
    Paxos-Commit
  </a>
  
    <nav class="md-nav" aria-label="Paxos-Commit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#o-protocolo_1" class="md-nav__link">
    O protocolo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falha-no-participante_3" class="md-nav__link">
    Falha no Participante
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#log-recuperavel" class="md-nav__link">
    Log Recuperável
  </a>
  
    <nav class="md-nav" aria-label="Log Recuperável">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disco-duplicado" class="md-nav__link">
    Disco Duplicado
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estruturas-de-dados-para-sd" class="md-nav__link">
    Estruturas de Dados para SD
  </a>
  
    <nav class="md-nav" aria-label="Estruturas de Dados para SD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#log-structured-merge-tree" class="md-nav__link">
    Log Structured Merge Tree
  </a>
  
    <nav class="md-nav" aria-label="Log Structured Merge Tree">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compactacoes" class="md-nav__link">
    Compactações
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filtros-de-bloom" class="md-nav__link">
    Filtros de Bloom
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias_1" class="md-nav__link">
    Referências
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              

<!-- Edit button -->


  <!--
       Hack: check whether the content contains a h1 headline. If it
       doesn't, the page title (or respectively site name) is used
       as the main headline.
    -->

  <h1>Bancos de Dados</h1>


  <!-- Content -->
  <p>Vejamos alguns destes modelos de consistência, começando por aqueles com que estão mais acostumados, isto é, o que experimentam nos bancos de dados relacionais com que trabalham.
Antes, lembre-mo-nos de que quando falamos em bancos de dados relacionais, pensamos em bancos de dados transacionais, mas o que são transações?</p>
<h2 id="transacoes">Transações</h2>
<p>No modelo de Máquinas de Estados Replicadas, <strong>operações</strong> são enviadas <strong>individualmente</strong> para as réplicas, que as executam em ordem.
Já no modelo transacional, também desejamos que as operações dos clientes sejam executadas atomicamente, mas normalmente pensamos em <strong>conjunto de operações</strong> em vez de operações individuais. 
Estes conjuntos de operações são as <strong>transações</strong>, das quais nos habituamos a esperar algumas propriedades, conhecidas como ACID.</p>
<ul>
<li>Atomicidade - O conjunto de operações em uma transação é tratado como uma unidade e <strong>ou todas as operações na unidade são executadas ou nenhuma é.</strong></li>
<li>Consistência - Toda transação leva o banco de dados <strong>de um estado válido para um estado válido</strong>.</li>
<li>Isolamento - Trata sobre quando e como os efeitos de uma transação passam a ser visíveis para outra transação, tendo vários níveis.</li>
<li>Durabilidade - Garante que os resultados de uma transação são permanentemente gravados no sistema, a despeito de falhas.<ul>
<li><strong>Nemória estável</strong><ul>
<li>HD -- Hard Drives</li>
<li>SSD -- Solid State Drives</li>
<li>NVRAM -- Non Volatile RAM</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="o-banco">O Banco</h3>
<p>Conta C</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>C.getSaldo()
C.setSaldo(montante)
</code></pre></div>
</td></tr></table>
<h4 id="transacao">Transação</h4>
<p>Mova 10% do saldo de B, de A para B.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>T1: a -&gt; b
sB = b.getSaldo()
     b.setSaldo(sB*1.1)
sA = a.getSaldo()                          
     a.setSaldo(sA-sB*0.1)
</code></pre></div>
</td></tr></table></p>
<h4 id="transacao_1">Transação</h4>
<p>Qual o saldo total das contas?
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>T2: a + b
sA = a.getSaldo()
sB = b.getSaldo()
sT = sA + sB
</code></pre></div>
</td></tr></table></p>
<h4 id="execucao-concorrente">Execução Concorrente</h4>
<p>Execução concorrente de T1 e T2?
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>T1                           T2
sB = b.getSaldo()            
                             sA = a.getSaldo()
     b.setSaldo(sB*1.1) .    
                             sB = b.getSaldo()
sA = a.getSaldo()                          
     a.setSaldo(sA-sB*0.1) 
                             sT = sA+sB
</code></pre></div>
</td></tr></table></p>
<p>Dados não finais "vazaram". <em>Dirty Read</em>. </p>
<p>Falta <em>Isolamento</em>.</p>
<p>Pode levar a mais que um resultado errado. Pode deixar o BD em estado inválido.</p>
<h4 id="execucao-concorrente_1">Execução Concorrente</h4>
<p>Mova 10% do saldo de B, de A para B.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>T1                       T1
sB = b.getSaldo()
                          sB = b.getSaldo()
                               b.setSaldo(sB*1.1)
     b.setSaldo(sB*1.1)                                        
                          sA = a.getSaldo()                          
                               a.setSaldo(sA-sB*0.1)
sA = a.getSaldo()                          
     a.setSaldo(sA-sB*0.1)
</code></pre></div>
</td></tr></table></p>
<p><code>sB*0.1</code>  foi perdido. <em>Lost Update</em></p>
<p>Perdeu <em>Consistência</em></p>
<h4 id="solucao">Solução?!</h4>
<p>Para garantir Isolamento</p>
<ul>
<li>Execuções dos conjuntos não podem se sobrepor.</li>
<li>Execute um conjunto de operações por vez, serialmente!</li>
<li>Garantirá também Consistência</li>
</ul>
<p><em>Que tal?</em></p>
<p>Limite a concorrência de transações.</p>
<h2 id="equivalencia-serial">Equivalência Serial</h2>
<h3 id="concorrencia">Concorrência</h3>
<p>Além de ACID, queremos o máximo de <em>concorrência</em> para garantir o melhor <em>desempenho</em>.</p>
<p>Queremos uma execução das transações semelhante à serial, mas com o desempenho de concorrente.</p>
<p>Não queremos uma execução serial, mas uma <em>Equivalência Serial</em>, isto é, que os efeitos das transações, executadas concorrentemente, sejam equivalentes aos de alguma execução serial destas transações.</p>
<h3 id="equivalencia-serial_1">Equivalência Serial</h3>
<p>Preocupe-se com Operações Conflitantes</p>
<ul>
<li>Transações diferentes</li>
<li>Uma é escrita</li>
<li>Mesmo dado</li>
</ul>
<p>Duas execuções (de transações) são equivalentes se</p>
<ul>
<li>as transações tem as mesmas operações</li>
<li>quaisquer duas operações conflitantes são executadas na mesma ordem nas duas execuções</li>
</ul>
<p>Uma execução tem Equivalência Serial se é equivalente a alguma execução serial das transações.</p>
<p>Escalone operações concorrentemente, de forma a obter o melhor desempenho, mas de forma a manter Equivalência Serial.</p>
<p>Esta definição difícil de ser testada. Algo mais simples?</p>
<ul>
<li>Como demonstrar Equivalência Serial? </li>
<li>Tenho que testar todas as execuções seriais e ver se uma casa com o que planejo fazer?</li>
<li>É caro fazer este planejamento. É mais eficiente garantir por construção.</li>
</ul>
<p>Simplificação: A execução de duas transações tem Equivalência Serial se todos os pares de operações conflitantes entre as transações são executados na mesma ordem.</p>
<h3 id="lost-update">Lost Update</h3>
<p>Mova 10% do saldo de X, de Y para X.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>a -&gt; b                     c -&gt; b
s = b.getSaldo() [1]
                           [2]s = b.getSaldo()
                           [3]    b.setSaldo(s*1.1)
    b.setSaldo(s*1.1)[4]                                        
                                  c.setSaldo(s*0.1)
    a.setSaldo(s*0.1)
</code></pre></div>
</td></tr></table></p>
<p>Conflitos: 1x3:<span class="arithmatex">\(\rightarrow\)</span>, 2x4:<span class="arithmatex">\(\leftarrow\)</span>, 3x4:<span class="arithmatex">\(\leftarrow\)</span></p>
<p>Consistência -- <code>s*0.1</code> foi perdido</p>
<p>Mova 10% do saldo de X, de Y para X.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>a -&gt; b                    c -&gt; b
                          [2] s = b.getSaldo()
                          [3]     b.setSaldo(s*1.1)
s = b.getSaldo() [1]
    b.setSaldo(s*1.1)[4]                                        
                                  c.setSaldo(s*0.1)
    a.setSaldo(saldo*0.1)
</code></pre></div>
</td></tr></table></p>
<p>Conflitos: 1x3:<span class="arithmatex">\(\leftarrow\)</span>, 2x4:<span class="arithmatex">\(\leftarrow\)</span>, 3x4:<span class="arithmatex">\(\leftarrow\)</span></p>
<h3 id="dirty-read">Dirty Read</h3>
<p>Saldo total?
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>a -&gt; b                  a -&gt; b
s = b.getSaldo()
    b.setSaldo(s*1.1)
    b.setSaldo(s*1.1)                                        
    a.saque(s*0.1)
                        s = b.getSaldo()
                            b.setSaldo(s*1.1)
                            b.setSaldo(s*1.1)                                        
                            a.saque(s*0.1)
</code></pre></div>
</td></tr></table>
 Tem Equivalência Serial.</p>
<p>Exceto se
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>abortTransaction()
</code></pre></div>
</td></tr></table>
Nenhuma transação que fez uma dirty read pode comitar. Logo, aborte a transação da direita.</p>
<h3 id="aborto-em-cascata">Aborto em Cascata</h3>
<p>T1 faz uma escrita. T2 lê o que T1 escreveu e faz outra escrita. T3 lê o que T2 escreveu e faz outra escrita. T4 lê o que... <em>T1 aborta</em>.</p>
<h3 id="dirty-read_1">Dirty Read</h3>
<p>Como lidar?</p>
<ul>
<li>Suspenda a transação quando esta fizer dirty read.</li>
<li>Se transação foi abortada, todas as suspensas (que leram dela) devem ser abortadas.</li>
<li>Repita passo anterior.</li>
</ul>
<p>E se evitarmos dirty reads em vez de tratarmos?</p>
<ul>
<li>Suspenda antes de fazer dirty read.</li>
<li>Quando transação for terminada, continue execução.</li>
</ul>
<p>Abordagem leva a menor concorrência.</p>
<p>Para nos permitir identificar transações, vamos usar o seguinte framework para operá-las.</p>
<h3 id="transacoes_1">Transações</h3>
<ul>
<li><code>beginTransaction(</code>)</li>
<li>operações</li>
<li><code>commitTransaction(): Ok/NOk</code></li>
<li><code>abortTransaction()</code></li>
</ul>
<h3 id="escrita-prematura">Escrita Prematura</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Saldo inicial: 100

a.setSaldo(105)
                   a.setSaldo(110)  
                   commitTransaction()
abortTransaction()
</code></pre></div>
</td></tr></table>
<p>A transação da direita não le, apenas escreve. O resultado?  O saldo volta para 100.</p>
<h3 id="strict-execution">Strict Execution</h3>
<ul>
<li>Leituras e Escritas devem ser atrasadas até que todas as transações anteriores que contenham escritas sejam commitadas ou abortadas.</li>
<li>Execução estrita garante Isolamento.</li>
<li>Como implementar eficientemente?</li>
</ul>
<h2 id="controle-de-concorrencia">Controle de Concorrência</h2>
<h3 id="como">Como</h3>
<ul>
<li>locks (pessimista): simples, mas problemático</li>
<li>multi-versão (otimista): custo se há muitos conflitos</li>
<li>timestamp: <em>time</em> é algo complicado</li>
</ul>
<h3 id="locks">Locks</h3>
<p>Tranque todos os objetos para que outras transações não consigam ler ou escrevê-los. Destranque quando não mais necessários.</p>
<p>Sofre de dirty reads e escritas prematuras.</p>
<h4 id="strict-two-phase-locking">Strict Two Phase Locking</h4>
<ul>
<li>tranque quando necessário</li>
<li>destranque ao final da transação</li>
<li>termine a transação</li>
</ul>
<p>Como aumentar a concorrência?</p>
<h3 id="read-write-locks">Read-Write Locks</h3>
<ul>
<li>dois níveis de acesso</li>
<li>múltiplos leitores</li>
<li>único escritor</li>
<li>reads por ser transformados em locks</li>
<li>writes <em>não</em> podem se transformados em reads (violaria Strict Two-Phase Locking)</li>
</ul>
<!--
### variantes

* two-version locking (read/write/commit)
%   similar idea but now with: read, write and commit locks.
%   
%       * a read lock is allowed unless a commit lock is taken.
%       * one write lock is allowed if no commit lock is taken (i.e. even if read locks are taken)
%       * written values are held local to the transaction and are not visible before commit.
%       * a write lock can be promoted to a commit lock if there are no read locks.
%       * when a transaction commits it tries to promote write locks to commit locks.
%   
* lock hierárquico (granularidades variadas)
%   locks of mixed granularity.
%   
%       * small locks increase concurrency
%       * large locks decrease overhead
%   
-->

<h3 id="lock-por-que-evitar">Lock -- por que evitar?</h3>
<ul>
<li>pessimista</li>
<li>overhead mesmo se não há conflitos</li>
<li>ou restritivo ou risco de deadlock</li>
<li>lock liberado somente no final, para evitar dirty reads/escrita prematura.</li>
</ul>
<h3 id="abordagem-mais-otimista">Abordagem mais otimista?</h3>
<ul>
<li>modifique uma cópia privada dos dados</li>
<li>na hora de terminar a transação, verifique se nenhuma transação modificou o dado, isto é, se a cópia privada ainda é válida</li>
<li>substitua a cópia pública pela privada</li>
</ul>
<p>Esta técnica é conhecida como <em>deferred update</em>, pois o update dos dados só ocorre no final, se a validação passar.</p>
<h4 id="abordagem-otimista">Abordagem otimista</h4>
<ul>
<li>baixo overhead, se não houver conflitos</li>
<li>validação é rápida</li>
<li>update é simples</li>
</ul>
<p>Se houver muitos conflitos, o trabalho da transação é todo desperdiçado.</p>
<h3 id="validacao">Validação</h3>
<p>read e write sets de quaisquer transações concorrentes deve ser disjuntos.</p>
<ul>
<li>t1 não deve ler dados escritos por t2</li>
<li>t2 não deve ler dados escritos por t1</li>
<li>t1/t2 não deve escrever dados escritos por t2/t1</li>
</ul>
<p><img alt="" src="../images/trans_validation.png" /></p>
<h4 id="backward-validation">Backward validation</h4>
<ul>
<li>t1: transação sendo validada</li>
<li>t2: transação já comitada.</li>
<li>t1 não deve ler dados escritos por t2</li>
</ul>
<p>Em caso de não validação, aborte t1</p>
<p><img alt="" src="../images/trans_validation.png" /></p>
<h4 id="forward-validation">Forward validation</h4>
<ul>
<li>t1: transação sendo validada</li>
<li>t2: transação ainda em execução</li>
<li>t2 não deve ler dados escritos por t1</li>
</ul>
<p>Em caso de não validação, aborte t1, possivelmente nunca terminando uma transação.<br/>
ou aborte t2.</p>
<p><img alt="" src="../images/trans_validation.png" /></p>
<h3 id="timestamping">Timestamping</h3>
<ul>
<li>transação recebe um <em>timestamp</em> no início</li>
<li>operações são validadas na execução<ul>
<li>leia somente se nenhuma transação com maior timestamp tiver escrito e comitado</li>
<li>escreva somente se nenhuma transação com maior timestamp tiver lido e comitado</li>
</ul>
</li>
<li>transações "executam na ordem do timestamp"</li>
</ul>
<p>Como implementar?</p>
<h4 id="como-implementar">Como implementar</h4>
<ul>
<li>objetos tem valores <em>tentativos</em>, não comitados</li>
<li>objetos tem versões em que foram escritos</li>
<li>em que foram comitados</li>
<li>e em que foram lidos</li>
</ul>
<p><img alt="" src="../images/timestamp1.png" /></p>
<ul>
<li>consistência é testado na execução da operação</li>
</ul>
<h4 id="como-implementar-escrita">Como implementar -- escrita</h4>
<ul>
<li>escritas tem sucesso somente se versão sendo escrita é maior que versões lidas</li>
<li>se versão sendo escrita é menor que versão já escrita, ignore e continue</li>
</ul>
<p><img alt="" src="../images/timestamp1.png" /></p>
<h3 id="como-implementar-leitura">como implementar -- leitura</h3>
<ul>
<li>leitura com versão v tem sucesso se maior versão é comitada e menor que v ou alguma não comitada</li>
<li>leitura com versão v é suspensa se maior versão é não comitada e menor que v</li>
</ul>
<p><img alt="" src="../images/timestamp2.png" /></p>
<ul>
<li>leitura com versão v é abortada se maior versão comitada é maior que v
<img alt="" src="../images/timestamp3.png" /></li>
</ul>
<h4 id="referencias">Referências</h4>
<p>Inspirado nas notas de aula de johan montelius e vladimir vlassov, da disciplina id2201 distributed systems, kth royal institute of technology. imagens copiadas descaradamente de seus slides.</p>
<p>Também aqui, <a href="https://www.cs.ucy.ac.cy/~dzeina/courses/epl446/lectures/16.pdf">https://www.cs.ucy.ac.cy/~dzeina/courses/epl446/lectures/16.pdf</a></p>
<h2 id="bancos-de-dados-distribuidos">Bancos de dados distribuídos</h2>
<h2 id="bancos-de-dados-transacionais-distribuidos">bancos de dados transacionais distribuídos</h2>
<p>Agora que relembramos como transações funcionam e temos uma noção de como podem ser implementadas em um sistema centralizado, vamos tentar entender como fazê-lo em um sistema distribuído.</p>
<ul>
<li>múltiplos servidores</li>
<li>transações em cada servidor</li>
<li>transações distribuídas</li>
<li>como obter equivalência serial em transações distribuídas</li>
</ul>
<h2 id="transacao-distribuida">Transação distribuída</h2>
<ul>
<li><code>begintransaction(): tid</code> (transaction id)</li>
<li><code>operation(tid,op)</code></li>
<li><code>endtransaction(tid): ok/nok</code></li>
<li><code>aborttransaction(tid)</code></li>
</ul>
<h3 id="papeis">Papéis</h3>
<ul>
<li>cliente</li>
<li>servidor: <em>resource managers</em></li>
<li>servidor: <em>transaction monitor/manager</em></li>
</ul>
<p><img alt="" src="../images/01-10.png" /></p>
<p>Localmente, cada bd funciona como um sistema centralizado normal, usando abordagens otimistas ou pessimista para garantir consistência.</p>
<p>O grande problema no bd distribuído é garantir o <em>acordo</em> na terminação.</p>
<h2 id="comprometimento-distribuido">Comprometimento distribuído</h2>
<h3 id="atomicidade">atomicidade</h3>
<p>O problema...</p>
<ul>
<li>transação <span class="arithmatex">\(t\)</span> acessa recursos nos resource managers (rm)</li>
<li>terminar com sucessos <span class="arithmatex">\(t\)</span> em todos os rm -- commit -- ou</li>
<li>abortar <span class="arithmatex">\(t\)</span> em todos os rm</li>
<li>ainda que enlaces de comunicação, nós e rm falhem, antes ou durante a terminação da transação.</li>
</ul>
<h3 id="2pc-2-phase-commit">2PC - 2 Phase Commit</h3>
<ul>
<li>participante -- resource manager "tocados" pela transação</li>
<li>coordenador -- transaction manager</li>
</ul>
<h4 id="premissas">Premissas</h4>
<ul>
<li>Cliente decide quando iniciar o commit.</li>
<li>Cada participante faz commit ou abort da transação local.<br/>
pode retornar ok ou nok.</li>
<li>Coordenador não começa a commit até que a <span class="arithmatex">\(t\)</span> tenha terminado em todos os participantes e cliente tenha solicitado.</li>
<li>Participantes falham por parada.</li>
</ul>
<h4 id="1pc">1PC</h4>
<ul>
<li>cliente envia <code>endtransaction(tid)</code> para o coordenador</li>
<li>coordenador envia mensagem para participantes "comitarem" </li>
<li>e se um participante retornar nok? % enquanto outros retornam ok?</li>
<li>e se um participante não responder?</li>
</ul>
<h4 id="2pc">2PC</h4>
<ul>
<li>cliente envia <code>endtransaction(tid)</code> para o coordenador</li>
<li>coordenador envia mensagem para participantes se prepararem para terminar</li>
<li>coordenador espera que todos se preparem ou digam se não podem</li>
<li>coordenador envia <em>ordem</em> de terminação</li>
</ul>
<h4 id="comprometimento">Comprometimento</h4>
<ul>
<li>um participante <span class="arithmatex">\(p\)</span> está pronto para commit se tiver todos os valores modificados por <span class="arithmatex">\(t\)</span> em memória estável e nenhuma razão para abortar a transação (outras transações conflituosas fizeram commit?)</li>
<li>o coordenador não pode começar a terminação até que todos os participantes estejam prontos.</li>
<li>se algum participante aborta, o coordenador deve abortar. </li>
</ul>
<p>Problema de acordo, mas não igual ao consenso.</p>
<h4 id="2pc-o-protocolo">2PC -- o protocolo</h4>
<ul>
<li>
<p>fase 1</p>
<ul>
<li>a: coordenador envia vote-request para participantes.</li>
<li>b: participante responde com vote-commit ou vote-abort para o coordenador; se vote-abort, aborta localmente.</li>
</ul>
</li>
<li>
<p>fase 2</p>
<ul>
<li>a: coordenador coleta votos de todos os processos; se forem todos vote-commit, envia global-commit para os participantes e ok para o cliente</li>
<li>b: participantes esperam por global-commit ou global-abort</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th><strong>Coordenador</strong></th>
<th><strong>Participante</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="" src="../images/08-18a.png" /></td>
<td><img alt="" src="../images/08-18b.png" /></td>
</tr>
</tbody>
</table>
<h4 id="falha-no-participante">Falha no Participante</h4>
<p>Participante falha no estado <span class="arithmatex">\(S\)</span> e, ao se recuperar, identifica tal fato ao reprocessar o log de operações em memória durável.</p>
<p>Se está no estado</p>
<ul>
<li>INIT:  nem sabia que a terminação começou.  Aborta unilateralmente, pois ou já abortaram ou vão abortar.</li>
<li>ABORT: havia votado abort ou recebido global-abort -- continua protocolo.</li>
<li>COMMIT: estava pronto para terminar a transação com sucesso -- continua protocolo.</li>
<li>READY:  estava esperando por commit ou abort.  Precisa saber se coordenador enviou global-commit ou global-abort -- consulta coordenador.</li>
</ul>
<h4 id="2pc_1">2PC</h4>
<p>Por que é difícil?</p>
<ul>
<li>E se <span class="arithmatex">\(R_i\)</span> falhar depois de ter se preparado?</li>
<li>E se <span class="arithmatex">\(R_i\)</span> falhar mas <span class="arithmatex">\(R_j\)</span> continuar funcionando?</li>
<li>E se todos estiverem desligados quando <span class="arithmatex">\(R_i\)</span> se recuperar?</li>
<li>E se <span class="arithmatex">\(R_i\)</span> estiver lento e parecer que a transação falhou?</li>
</ul>
<h4 id="falha-no-participante_1">Falha no Participante</h4>
<ul>
<li>READY: esperando por commit ou abort. Precisa saber se coordenador enviou global-commit our global-abort -- consulta coordenador.</li>
</ul>
<p><em>E se coordenador não estiver presente?</em></p>
<p>Assumindo que participantes se conhecem, contate participante <span class="arithmatex">\(Q\)</span>   </p>
<ul>
<li>Se <span class="arithmatex">\(Q\)</span> em COMMIT , vai para COMMIT</li>
<li>Se <span class="arithmatex">\(Q\)</span> em ABORT , vai para ABORT</li>
<li>Se <span class="arithmatex">\(Q\)</span> em INIT , ordena que Q aborte e, se confirmado, veja passo anterior</li>
<li>Se <span class="arithmatex">\(Q\)</span> em READY , consulta outro participante.</li>
</ul>
<p><em>Se todos os participantes em READY?</em>  Possivelmente o coordenador já respondeu ao cliente.</p>
<p><em>Precisa</em> esperar pelo coordenador.</p>
<h4 id="falha-no-coordenador">Falha no Coordenador</h4>
<p>O problema principal é: e se ninguém ouviu a decisão final do coordenador?</p>
<p>Neste caso, o protocolo não pode continuar, enquanto o coordenador não retornar, pois se os RM abortarem, podem estar contradizendo algo dito ao cliente, por exemplo, "Sim, ATM, pode entregar o dinheiro", ou executando um comando que o cliente vê como anulado, como "Reenvie o pedido de mais 27 carros à fábrica."</p>
<h4 id="recuperacao-do-coordenador">Recuperação do Coordenador</h4>
<p>Ao se recuperar, o coordenador:</p>
<ul>
<li>sabe se começou a terminação de alguma transação</li>
<li>sabe se já enviou alguma resposta final para as transações inacabadas</li>
<li>sabe se já recebeu a confirmação de todos os participantes (se transação não estiver em aberto)</li>
<li>reenvia a última mensagem das transações em aberto.</li>
</ul>
<h4 id="otimizacoes">Otimizações</h4>
<ul>
<li>
<p>Participantes "somente-leitura"</p>
<ul>
<li>Não se importa com a decisão; termina após fase 1.</li>
<li>Responde com vote-commit-ro</li>
</ul>
</li>
<li>
<p>Abort presumido</p>
<ul>
<li>Se ocorrer timeout, coordenador envia global-abort a todos e esquece transação</li>
<li>Se questionado, responde com global-abort.</li>
</ul>
</li>
<li>
<p>Transferência de coordenação</p>
<ul>
<li>se houver somente um participante...</li>
<li>vote-request-transfer</li>
<li>participante responde com global-commit/global-abort</li>
</ul>
</li>
</ul>
<h4 id="coleta-de-lixo">Coleta de Lixo</h4>
<p>Mesmo quando somente um participante falha...</p>
<p>Após receber decisão, o participante pode concluir e esquecer a transação. </p>
<p>Mas e se o participante falho precisar se recuperar e todos os outros envolvidos tiverem esquecido a transação?</p>
<p>Coleta de lixo só pode ser feita quando todos tiverem confirmado a execução da transação e, por isso, Fase 2b é necessária.</p>
<h3 id="3-pc">3-PC</h3>
<p>Estende o protocolo para permitir contornar  falha do coordenador.</p>
<h4 id="o-protocolo">O Protocolo</h4>
<ul>
<li>Fase 1a -- Coordenador envia vote-request para participantes.</li>
<li>Fase 1b -- Participante responde com vote-commit ou vote-abort para o coordenador; se vote-abort, aborta localmente.</li>
<li>Fase 2a -- Coordenador coleta votos de todos os processos; se forem todos vote-commit, envia <em>prepare-commit</em> para os participantes; se não, global-abort e para.</li>
<li>Fase 2b -- Participantes esperam por prepare-commit ou global-abort; se o primeiro, <em>respondem com ready-commit</em>; se o segundo, param.</li>
<li>Fase 3a -- coordenador espera por ready-commit de todos e então envia global-commit.</li>
<li>Fase 3b -- participantes esperam por global-commit.</li>
</ul>
<table>
<thead>
<tr>
<th>Coordenador</th>
<th>Participante</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="" src="../images/08-22a.png" /></td>
<td><img alt="" src="../images/08-22b.png" /></td>
</tr>
</tbody>
</table>
<h4 id="falha-no-participante_2">Falha no Participante</h4>
<p><span class="arithmatex">\(P\)</span> consegue saber o que fazer após se recuperar da falha no estado READY ou PRE-COMMIT</p>
<ul>
<li>Participantes e coordenador não distam mais que um estado.</li>
<li>Se alguém em READY, o coordenador não mandou global-commit ainda; Aborte.</li>
<li>Se <em>todos</em> em PRE-COMMIT, é possível comitar, comite.</li>
<li>A execução dos passos anteriores tem que anular o poder do coordenador.</li>
</ul>
<p><em>Se todos os participantes em READY?</em></p>
<h4 id="3pc-x-2pc">3PC x 2PC</h4>
<ul>
<li>3PC -- Aumenta disponibilidade</li>
<li>2PC -- Falha do coordenador é "corner case"</li>
<li>3PC -- Aumenta o custo do "caminho feliz" e por isso não é usado na prática</li>
<li>Nenhum escala e não usá-los é uma das razões para o surgimento dos sistemas NoSQL</li>
</ul>
<h3 id="paxos-commit">Paxos-Commit</h3>
<p>Usa instâncias de Consenso Distribuído para votar. Se o consenso é tolerante a falhas e consistente, todos vêem o mesmo resultado na transação.</p>
<h4 id="o-protocolo_1">O protocolo</h4>
<ul>
<li>Para terminar a transação <span class="arithmatex">\(T\)</span>, o coordenador envia request-commit a todos os participantes.</li>
<li>Um participante <span class="arithmatex">\(P\)</span> propõe seu voto na instância <span class="arithmatex">\(T_P\)</span> de consenso.</li>
<li>
<p>Todo participante <span class="arithmatex">\(P\)</span> espera pelas decisões das instâncias de consenso <span class="arithmatex">\(T_i\)</span> para todos os participantes <span class="arithmatex">\(i\)</span>, inclusive si mesmo; se todas as decisões forem commit, o participante comita a transação.</p>
</li>
<li>
<p>Se cansar de esperar por <span class="arithmatex">\(T_Q\)</span>, o participante propõe abort em <span class="arithmatex">\(T_Q\)</span>.</p>
</li>
</ul>
<h4 id="falha-no-participante_3">Falha no Participante</h4>
<ul>
<li>Se o participante falha antes de votar, então alguém votará abort por ele.</li>
<li>Se o participante <span class="arithmatex">\(P\)</span> falha, ou é suspeito de, então é possível que dois votos diferentes tenham sido propostos em <span class="arithmatex">\(T_P\)</span>; isso não é um problema pois a decisão é a mesma para todos observando a instância.</li>
<li>Após se recuperar, o participante recupera as decisões de todas as instâncias <span class="arithmatex">\(T_i\)</span> e termina apropriadamente.</li>
</ul>
<h2 id="log-recuperavel">Log Recuperável</h2>
<p>Como garantir que o log poderá ser lido para recuperar o processo?</p>
<h3 id="disco-duplicado">Disco Duplicado</h3>
<p><img alt="" src="../images/08-23.png" /></p>
<ul>
<li>Dois discos iguais?</li>
<li>Dados diferentes, mas ambos bons?</li>
<li>Um bom outro estragado?</li>
<li>Ambos estragados?</li>
</ul>
<!-- ## NoSQL -->

<h2 id="estruturas-de-dados-para-sd">Estruturas de Dados para SD</h2>
<p>Qualquer que seja a escolha de algoritmo para fazer o particionamento dos dados entre servidores, sobra ainda a questão de como manipular os dados dentro do servidor.
Idealmente, toda operação seria executada a partir da memória principal, tendo assim a menor latência possível.
Contudo, para que se tenha também durabilidade das operações executadas, para que os dados manipulados sobrevivam a reinicializações do servidor, intencionais ou não, é preciso armazenar os dados em <strong>memória estável</strong>, da qual a mais comum são os <strong>discos rígidos</strong>.</p>
<p>É notório que escritas em disco são muito mais lentas que em memória principal, mas o que exatamente é lento no acesso ao disco?
Essencialmente, o posicionamento da cabeca de leitura/escrita na trilha correta do disco, pois esta operação é mecânica.
Por esta razão, acessos aleatórios são mais custosos que acessos sequenciais, pois neste o custo de posicionamento é pago apenas uma vez.
Por este motivo, muitos bancos de dados, especialmente DHT pois tem seu uso focado em quantidades muito grandes de dados, gerados e acessados com grande velocidade, tentam acessar o disco sempre de forma sequencial.
Alguns bancos de dados, como o Cassandra, armazenam os dados na forma de uma <em>Log Structured Merge Tree</em>, ou LSMT.</p>
<h3 id="log-structured-merge-tree">Log Structured Merge Tree</h3>
<p>Uma <strong><em>Log Structured Merge Tree</em></strong> é uma forma de se armazenar dados em disco de forma de forma quase sempre sequencial, minimizando assim os o impacto da durabilidade no desempenho do sistema.
Considere um banco armazenando uma pequena quantidade de dados, que cabe em memória principal.
Na LSMT, operações de escrita são adicionadas a um <strong><em>commit log</em></strong>, em disco,  e somente então são executadas em memória principal e confirmadas para o cliente; a estrutura que armazena os dados em memória é denominada <em>memory table</em>, ou simplesmente <strong>memtable</strong>.
Neste cenário o acesso ao disco na escrita é sequencial, o melhor que se pode ter em um disco, e a recuperação dos dados é feita diretamente da memória, rápida.</p>
<p><img alt="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataWritten.html" src="../images/lsm2.png" /></p>
<p>No caso de uma reinicialização do processo, a reexecução do <em>commit log</em> restaurará o estado da memtable. Contudo, se o <em>commit log</em> for extenso, reexecutá-lo demandará um tempo significativo.
Uma forma de acelerar o processo é fazer <strong><em>snapshots</em></strong> da memtable de forma sincronizada com a escrita no log.
Isto é, digamos que todas as operações de escrita, até a décima, estão salvas no commit log e refletidas na memtable.
Digamos também que todas as operações são modificações da mesma linha do banco de dados em memória.
Se um <em>snapshot</em>  é tomado, ele será correspondente ao commit log, isto é, conterá o efeito de exatamente as mesmas 10 operações, mas de forma mais compacta que o log, uma vez que o log conterá dez operações e o snapshot somente uma linha de dados.
Após o snapshot ser concluído, o log correspondente pode ser apagado.
Novas operações de escrita devem ser armazenadas em um novo log e, no caso de uma reinicialização, primeiro se deve restaurar o <em>snapshot</em> e então o novo log.
Para lidar com corrupções de arquivo no sistema, pode ser uma boa ideia manter mais do que o último log e <em>snapshot</em>, já que a recuperação do estado exigiria voltar mais atrás na reexecução de operações.</p>
<p>Observe que, além da escrita dos logs, todos os outros acessos ao disco também são sequenciais, seja o <em>flush</em> das memtables, ou a leitura dos snapshots para recuperação e do commit log para reexecução, e já que operações de leitura são todas respondidas da memória, o sistema terá um excelente desempenho.
Contudo, há outro limitante de desempenho importante, relacionado à premissa pouco realista de que os dados cabem todos em memória. Isto é, se os dados não cabem em memória, <em>snapshots</em>  serão importantes não somente para permitir coletar lixo dos logs, isto é, dados obsoletos, mas também, para usar a capacidade de armazenamento dos discos.</p>
<p>Consideremos então um cenário em que a memtable cabe apenas <em>n</em> entradas; quando a operação para adicionar <span class="arithmatex">\(n+1\)</span>-ésima entrada à memtable é recebida, um <strong><em>flushs</em></strong> dos dados para um novo <em>snapshot</em> é feito e a memtable é <em>resetada</em>, liberando espaço em memória. Para melhorar o desempenho, estas descargas podem ser feitas proativamente antes da chegada de novas entradas e fora do <em>caminho crítico</em> da operação de escrita, mas isto é apenas uma otimização e portanto não a consideraremos aqui.</p>
<p><img alt="https://docs.datastax.com/en/cassandra/3.0/cassandra/dml/dmlHowDataWritten.html" src="../images/lsm2.png" /></p>
<p>Neste novo fluxo, os arquivos em disco não correspondem mais a <em>snapshots</em> do banco de dados, então nos referiremos a eles como <em>stable storage tables</em>, ou <strong>sstables</strong>, em oposição às <em>memtables</em>, pelo menos por enquanto.</p>
<h5 id="compactacoes">Compactações</h5>
<p>Apesar deste novo fluxo de escrita aumentar a capacidade de armazenamento do nosso banco de dados, ele traz problemas para o fluxo de leitura.
Digamos que a chave <span class="arithmatex">\(k\)</span> teve um valor atribuído e descarregado em uma sstable em diversas ocasiões.
O primeiro problema aqui é que há vários valores antigos associados a <span class="arithmatex">\(k\)</span>, inutilmente e ocupando espaço, isto é, lixo.
O segundo é que caso o valor associado a <span class="arithmatex">\(k\)</span> seja requisitado, o sistema deverá retornar a última versão, que pode estar em diversos arquivos.
Para lidar com ambos os problemas, podemos <strong>compactar</strong> as sstables juntas, eliminados dados obsoletos e minimizando o número de arquivos a serem pesquisados no caso de leitura.
Caso a sstables estejam ordenadas, o procedimento de compactação pode ser feito como a união de dois segmentos de dados no <em>merge sort</em>, isto é, iterando-se paralelamente nos dois arquivos e escolhendo sempre a menor chave da vez e movendo-a para um novo segmento que conterá a união dos dados.
A figura a seguir mostra um exemplo que várias sstables de nível 0, aquelas geradas por <em>flushs</em>, são unidas gerando sstables de nível 1 e assim sucessivamente.
Observe como as compactações geram uma árvore (na verdade, uma floresta), razão do nome <em>merge tree</em>.</p>
<p><img alt="https://www.hedvig.io/blog/hedvig-internals-log-structured-merge-trees-and-folding-of-bloom-filters" src="../images/lsm_compac.png" /></p>
<p>No caso de uma pesquisa, somente as tabelas mais à direita e de nível mais alto precisam ser consultadas e portanto as sstables já usadas como entrada podem ser eliminadas como lixo do sistema.
Ainda assim, no caso de uma leitura, diversas sstables potencialmente contém o dado a ser retornado.
O problema se agrava em sistemas em que partes do dado possam ser gravadas independentemente, como no CassandraDB, em que cada coluna é independente das outras.
Diversas propostas poderiam ser feitas para se identificar mais rapidamente se uma sstable contém uma chave.</p>
<p>Por exemplo, pode-se associar a cada tabela um bitmap indicando a presença ou não de uma certa chave, mas esta abordagem obviamente falha se o espaço de chaves for grande.
Outra possibilidade é lembrar a faixa de chaves contida na tabela. Esta estratégia pode ser útil caso haja localidade no espaço de chaves no momento da escrita, mas falhará miseravelmente se o espaço de chaves for usado uniformemente, resultando em faixas grandes entre a menor e maior chaves de cada tabela.
Como acelerar a identificação das sstables pertinentes? Entram em cena os filtros de <strong>Bloom</strong>.</p>
<h3 id="filtros-de-bloom">Filtros de Bloom</h3>
<p>De acordo com nossa fonte mais que confiável, a <a href="https://en.wikipedia.org/wiki/Bloom_filter">Wikipedia</a></p>
<div class="admonition quote">
<p class="admonition-title">Bloom Filter</p>
<p>A Bloom filter is a <strong><em>space-efficient probabilistic</em></strong> data structure, conceived by Burton Howard <em>Bloom</em> in 1970, that is used to test whether an element is a member of a set. False positive matches are possible, but false negatives are not, thus a Bloom filter has a 100% recall rate. In other words, a query returns either <strong>"possibly in set"</strong> or <strong>"definitely not in set"</strong>.</p>
</div>
<p>Se associarmos a cada sstable um filtro de Bloom, então só será preciso lê-la se o filtro correspondente disser que a chave possivelmente está contida, como no seguinte exemplo.</p>
<p><img alt="LSMT+Bloom Filter" src="../images/bf_lsm.jpg" /></p>
<p>Mas como exatamente construímos um filtro de Bloom?
Iniciamos com um vetor de bits inicialmente zerados e um conjunto finito de funções de hash cujo resultado seja uniformemente distribuído no tamanho do vetor de bits.
Para cada elemento colocado no conjunto a ser refletido pelo filtro, aplicamos cada uma das funções hash e colocamos o bit 1 na posição do vetor igual ao resultado da função.
No exemplo a seguir, inserimos os elementos x, y e z e usamos três funções hash.</p>
<p><img alt="By David Eppstein" src="../images/bf.png" /></p>
<p>Na <strong>consulta</strong>, cada elemento passa por pelas mesmas funções hash.
Se algum dos índices apontados não estiver com um 1, como no caso do c, no exemplo, o elemento não pertence ao conjunto.
Caso contrário, o filtro responderá que é possível que pertença.</p>
<p>Mas quão bom é um filtro de Bloom na identificação do das sstables? Ou, de outra forma, quais fatores influenciam na taxa de falsos positivos do filtro?</p>
<ul>
<li>o número <span class="arithmatex">\(n\)</span> de elementos no conjunto, uma vez que quanto mais elementos, mais bits  1;</li>
<li>o número <span class="arithmatex">\(k\)</span> de hashes, pois quanto mais hashes, mais bits transformados em 1; e,</li>
<li>o número <span class="arithmatex">\(m\)</span> de bits no vetor, pois quanto menos bits, mais colisões de bits.</li>
</ul>
<p>De forma mais precisa,</p>
<ul>
<li>a probabilidade de setar um certo bit na inserção de um elemento é <span class="arithmatex">\(1/m\)</span>, e</li>
<li>a probabilidade de não setar tal bit é <span class="arithmatex">\(1 - 1/m\)</span>;</li>
<li>a probabilidade de <span class="arithmatex">\(k\)</span> hashes não setarem um bit é <span class="arithmatex">\((1 - 1/m)^k\)</span>;</li>
<li>a probabilidade de não setar um bit após <span class="arithmatex">\(n\)</span> inserções é <span class="arithmatex">\((1 - 1/m)^{kn}\)</span>;</li>
<li>a probabilidade de setar um bit após <span class="arithmatex">\(n\)</span> inserções é <span class="arithmatex">\(1 - (1 - 1/m)^{kn}\)</span></li>
</ul>
<p>Logo,</p>
<ul>
<li>a probabilidade de falso positivo <span class="arithmatex">\(p = (1 - (1 - 1/m)^{kn})^k \approx (1 - e^{-kn/m})^k\)</span>
O que nos permite chegar à relação</li>
<li><span class="arithmatex">\(m/n = - 1.44\log_2 p\)</span>, em que podemos calcular <span class="arithmatex">\(m\)</span> em função do <span class="arithmatex">\(n\)</span> esperado e do <span class="arithmatex">\(p\)</span> desejado.
E podemos também identificar o <span class="arithmatex">\(k\)</span> ótimo para a situação, pela equação</li>
<li><span class="arithmatex">\(k = - \frac{\ln p}{\ln 2} = - \log_2 p\)</span></li>
</ul>
<p>Uma forma "simples" de visualizar este resultado é dada pela figura a seguir, em que o eixo Y dá a taxa de falsos positivos do filtro em função do número de elementos inseridos, indicado no eixo X, para diversas configurações, apresentadas como curvas.
Por exemplo, com um filtro com <span class="arithmatex">\(m = 2^{24}b = 2MB\)</span>, após 1 milhão de inserções, tem-se probabilidade de falsos positivo <span class="arithmatex">\(p = 0,0001\)</span>.</p>
<h2 id="referencias_1">Referências</h2>
<ul>
<li><a href="http://www.slideshare.net/quipo/modern-algorithms-and-data-structures-1-bloom-filters-merkle-trees">Modern Algorithms and Data Structures: Bloom-Filter</a></li>
<li><a href="https://cloud.google.com/datastore/docs/articles/balancing-strong-and-eventual-consistency-with-google-cloud-datastore/">Balancing Strong and Eventual Consistency with Datastore</a></li>
<li><a href="https://blog.yugabyte.com/a-primer-on-acid-transactions/">https://blog.yugabyte.com/a-primer-on-acid-transactions/</a></li>
<li><a href="https://jepsen.io/consistency">https://jepsen.io/consistency</a></li>
<li><a href="https://fauna.com/blog/demystifying-database-systems-part-4-isolation-levels-vs-consistency-levels">https://fauna.com/blog/demystifying-database-systems-part-4-isolation-levels-vs-consistency-levels</a></li>
</ul>
<div class="admonition todo">
<p class="admonition-title">TODO</p>
<ul>
<li>Mover ED SD de Tecnologias para cá</li>
<li>Combinar<ul>
<li><a href="https://adambcomer.com/blog/simple-database/motivation-design.html">https://adambcomer.com/blog/simple-database/motivation-design.html</a></li>
<li><a href="https://adambcomer.com/blog/simple-database/memtable.html">https://adambcomer.com/blog/simple-database/memtable.html</a></li>
<li><a href="https://adambcomer.com/blog/simple-database/wal.html">https://adambcomer.com/blog/simple-database/wal.html</a></li>
<li><a href="https://www.jasondavies.com/bloomfilter/">https://www.jasondavies.com/bloomfilter/</a></li>
</ul>
</li>
</ul>
</div>

  <!-- Last update of source file -->


              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../consistency/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              Consistência
            </div>
          </div>
        </a>
      
      
        <a href="../disfs/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Próximo
              </span>
              Sistemas de Arquivos
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copiar para \u00e1rea de transfer\u00eancia", "clipboard.copied": "Copiado para \u00e1rea de transfer\u00eancia", "search.config.lang": "pt", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Buscar", "search.result.placeholder": "Digite para iniciar a busca", "search.result.none": "Nenhum resultado encontrado", "search.result.one": "1 resultado encontrado", "search.result.other": "# resultados encontrados", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../javascripts/mathjaxhelper.js"></script>
      
    
  </body>
</html>