


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.1">
    
    
      
        <title>Tolerância a Falhas - Notas em Sistemas Distribuídos</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a676eddb.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-PJX835H7DP","lasarojc.github.org/dsnotes"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tolerancia-a-falhas" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-header-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Notas em Sistemas Distribuídos
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Tolerância a Falhas
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    Notas em Sistemas Distribuídos
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Prólogo" class="md-nav__link">
      Prólogo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../intro/" title="Introdução" class="md-nav__link">
      Introdução
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../basics/" title="Fundamentos" class="md-nav__link">
      Fundamentos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../comm/" title="Comunicação" class="md-nav__link">
      Comunicação
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../arch/" title="Arquiteturas" class="md-nav__link">
      Arquiteturas
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../coord/" title="Coordenação" class="md-nav__link">
      Coordenação
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../time/" title="Tempo" class="md-nav__link">
      Tempo
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Tolerância a Falhas
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="Tolerância a Falhas" class="md-nav__link md-nav__link--active">
      Tolerância a Falhas
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dependabilidade" class="md-nav__link">
    Dependabilidade
  </a>
  
    <nav class="md-nav" aria-label="Dependabilidade">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#falhas-erros-e-defeitos" class="md-nav__link">
    Falhas, Erros e Defeitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ariane-5" class="md-nav__link">
    Ariane 5
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#787-dreamliner" class="md-nav__link">
    787 Dreamliner
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#737-max" class="md-nav__link">
    737 Max
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subaru-suv" class="md-nav__link">
    Subaru SUV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root-cause-analysis" class="md-nav__link">
    Root cause analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-alcancar-dependabilidade" class="md-nav__link">
    Como alcançar dependabilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#classes-de-defeitos" class="md-nav__link">
    Classes de Defeitos
  </a>
  
    <nav class="md-nav" aria-label="Classes de Defeitos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quebra" class="md-nav__link">
    Quebra
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omissao" class="md-nav__link">
    Omissão
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporizacao" class="md-nav__link">
    Temporização
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arbitrarios" class="md-nav__link">
    Arbitrários
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarquia" class="md-nav__link">
    Hierarquia
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas-intermitentes" class="md-nav__link">
    Falhas intermitentes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correlacao-entre-falhas" class="md-nav__link">
    Correlação entre falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#degradacao-graciosa" class="md-nav__link">
    Degradação graciosa
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redundancia-de-processos" class="md-nav__link">
    Redundância de Processos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coordenacao" class="md-nav__link">
    Coordenação
  </a>
  
    <nav class="md-nav" aria-label="Coordenação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uma-historia-de-tres-exercitos" class="md-nav__link">
    Uma história de três exércitos}
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acordo" class="md-nav__link">
    Acordo
  </a>
  
    <nav class="md-nav" aria-label="Acordo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comunicacao-em-grupo" class="md-nav__link">
    Comunicação em Grupo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consenso" class="md-nav__link">
    Consenso
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicacao-de-maquinas-de-estados" class="md-nav__link">
    Replicação de Máquinas de Estados
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-do-raft" class="md-nav__link">
    Estudo de Caso do Raft
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-paxos" class="md-nav__link">
    Estudo de Caso: Paxos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-atomix-copycat" class="md-nav__link">
    Estudo de caso: Atomix Copycat
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../disdb/" title="Bancos de Dados" class="md-nav__link">
      Bancos de Dados
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../disfs/index.md" title="Sistemas de Arquivos" class="md-nav__link">
      Sistemas de Arquivos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tech/" title="Tecnologias" class="md-nav__link">
      Tecnologias
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../projeto/" title="Projeto" class="md-nav__link">
      Projeto
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dependabilidade" class="md-nav__link">
    Dependabilidade
  </a>
  
    <nav class="md-nav" aria-label="Dependabilidade">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#falhas-erros-e-defeitos" class="md-nav__link">
    Falhas, Erros e Defeitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ariane-5" class="md-nav__link">
    Ariane 5
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#787-dreamliner" class="md-nav__link">
    787 Dreamliner
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#737-max" class="md-nav__link">
    737 Max
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subaru-suv" class="md-nav__link">
    Subaru SUV
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root-cause-analysis" class="md-nav__link">
    Root cause analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-alcancar-dependabilidade" class="md-nav__link">
    Como alcançar dependabilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#classes-de-defeitos" class="md-nav__link">
    Classes de Defeitos
  </a>
  
    <nav class="md-nav" aria-label="Classes de Defeitos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quebra" class="md-nav__link">
    Quebra
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omissao" class="md-nav__link">
    Omissão
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporizacao" class="md-nav__link">
    Temporização
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arbitrarios" class="md-nav__link">
    Arbitrários
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarquia" class="md-nav__link">
    Hierarquia
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas-intermitentes" class="md-nav__link">
    Falhas intermitentes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correlacao-entre-falhas" class="md-nav__link">
    Correlação entre falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#degradacao-graciosa" class="md-nav__link">
    Degradação graciosa
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redundancia-de-processos" class="md-nav__link">
    Redundância de Processos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coordenacao" class="md-nav__link">
    Coordenação
  </a>
  
    <nav class="md-nav" aria-label="Coordenação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uma-historia-de-tres-exercitos" class="md-nav__link">
    Uma história de três exércitos}
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acordo" class="md-nav__link">
    Acordo
  </a>
  
    <nav class="md-nav" aria-label="Acordo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#comunicacao-em-grupo" class="md-nav__link">
    Comunicação em Grupo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consenso" class="md-nav__link">
    Consenso
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#replicacao-de-maquinas-de-estados" class="md-nav__link">
    Replicação de Máquinas de Estados
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-do-raft" class="md-nav__link">
    Estudo de Caso do Raft
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-paxos" class="md-nav__link">
    Estudo de Caso: Paxos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-atomix-copycat" class="md-nav__link">
    Estudo de caso: Atomix Copycat
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="tolerancia-a-falhas">Tolerância a Falhas</h1>
<h2 id="dependabilidade">Dependabilidade</h2>
<p>Nós escrevemos software para que resolvam problemas de espectro bem amplo, indo, do controle de braços robóticos em cirurgias remotas à sistemas de comércio eletrônico, do controle de usinas hidroelétricas à jogos de truco online.
Independentemente do problema sendo resolvido, gostaríamos de poder contar com o sistema, de poder depender nele para executar sua tarefa.
Desta situação, surge a ideia de dependabilidade, isto é, de um sistema ter a propriedade de se poder depender do mesmo.</p>
<p>Dizemos que um componente <span><span class="MathJax_Preview">C</span><script type="math/tex">C</script></span> depende de um componente <span><span class="MathJax_Preview">C'</span><script type="math/tex">C'</script></span> se a corretude do comportamento de <span><span class="MathJax_Preview">C</span><script type="math/tex">C</script></span> depende da corretude do componente <span><span class="MathJax_Preview">C'</span><script type="math/tex">C'</script></span>.
E que um componente é "dependável" (<em>dependable</em>) na medida em que outros podem depender dele.
A dependabilidade é essencial aos componentes de sistemas distribuídos, afinal, "uma corrente é tão forte quanto seu elo mais fraco."</p>
<p>De acordo com <a href="https://www.nasa.gov/pdf/636745main_day_3-algirdas_avizienis.pdf">Avizienis et al</a>, tem-se dependabilidade quando os seguintes atributos estão presentes.</p>
<ul>
<li>Disponibilidade (<em>Availability</em>) - Prontidão para uso.</li>
<li>Confiabilidade/Fiabilidade (<em>Reliability</em>) - Continuidade do serviço.</li>
<li>Segurança (<em>Safety</em>) - Tolerância a catástrofes.</li>
<li>Integridade (<em>Integrity</em>) - Tolerância a modificações.</li>
<li>Manutenabilidade (<em>Maintainability</em>) - Facilidade de reparo.</li>
</ul>
<p>Em se falando de <strong>Segurança</strong>, deve-se falar também em <strong>Confidencialidade</strong> (<em>Confidentiality</em>), a garantia de que a informação somente é acessível a quem é devido.
A combinação de <strong>Disponibilidade</strong>, <strong>Integridade</strong> e <strong>Confidencialidade</strong> é também chamada de Segurança (<em>Security</em>).</p>
<p>Mas o que significa, na prática, ser dependável e seguro (<strong>secure</strong>)? Para respondermos a esta questão, primeiro precisamos entender os tipos de problemas que aparecem em vários níveis, desde o seu desenvolvimento até seu uso.</p>
<h3 id="falhas-erros-e-defeitos">Falhas, Erros e Defeitos</h3>
<p>No nível mais básico dos problemas a serem contornados para se obter dependabilidade, temos as <strong>falhas</strong> (<em>defect</em>, <em>fault</em>, para alguns, falta), que é um erro no desenvolvimento do sistema, como <em>bugs</em> ou defeitos de fabricação, que o leva a ficar diferente do que foi especificado. 
Uma falha existe mesmo se for raramente ativada e mesmo se seus efeitos nunca forem percebidos. 
Por exemplo, se o código tem um <code>&lt;=</code> em vez de <code>&lt;</code> na especificação de uma iteração, mas se uma condição faz com que a iteração seja interrompida antes, o código ainda tem uma falha.</p>
<p>No segundo nível, temos o <strong>erro</strong> (<em>error</em>), que é a manifestação da falha levando a algum comportamento indevido. No exemplo acima, um erro seria quando a iteração passasse do ponto correto por causa do <code>&lt;=</code>, por exemplo, na hora de escrever uma <em>string</em> em um array, estourando o limite do array na pilha mas sobrescrevendo uma variável que não seja mais usada.
O erro pode passar despercebido, mas ainda assim é um erro.</p>
<p>Finalmente, no terceiro nível, temos os <strong>defeitos</strong> (<em>failure</em>, para alguns, falha), um erro percebido pelo usuário. 
Continuando o exemplo, um <em>stack overflow</em> que leva a uma falha de segmentação, leva a um defeito.</p>
<p>Quando um componente manifesta um defeito, outros componentes que dele dependem, internalizarão entradas indevidas, uma falha externa, o que levará a seu próprio estado interno a estar errôneo e possivelmente também manifestar um defeito. 
Esta cadeia pode levar cenários catastróficos.
Vejamos alguns exemplos de defeitos famosos.</p>
<h3 id="ariane-5">Ariane 5</h3>
<p>O Ariane 5 foi um foguete desenvolvido pela agencia espacial européia que explodiu durante o lançamento.</p>
<div class="admonition quote">
<p class="admonition-title">The Explosion of the Ariane 5</p>
<p>On June 4, 1996 an unmanned Ariane 5 rocket launched by the European Space Agency exploded just forty seconds after its lift-off [...] after a decade of development costing $7B. The destroyed rocket and its cargo were valued at $500M. [...] the failure was a software error [...] a 64 bit floating point number [...] was converted to a 16 bit signed integer. The number was larger than 32,767, the largest integer storeable in a 16 bit signed integer, and thus the conversion failed.</p>
<p><img alt="Explosão" src="images/ariane5.jpg" /></p>
</div>
<p>O erro gerado foi tratado como input, causando outros erros, que geraram instabilidade e que levou o sistema a se auto-destruir.</p>
<h3 id="787-dreamliner">787 Dreamliner</h3>
<p>O avião 787 dreamliner, da Boeing, tem um problema que tornar necessário reiniciar o sistema elétrico a cada 248 dias, ou o mesmo pode ter uma pane.</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>The plane’s electrical generators fall into a failsafe mode if kept continuously powered on for 248 days. The 787 has four such main generator-control units that, if powered on at the same time, could fail simultaneously and cause a complete electrical shutdown.</p>
</div>
<p>Segundo as "más línguas", o problema é que acontece um <em>overflow</em> em um contador de tempo</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">248 days == 2^31 100ths of a second.<br><br>even in 2015, our airplanes have integer overflow bugs <a href="https://t.co/6Z8d4y9gjM"><a href="https://t.co/6Z8d4y9gjM">https://t.co/6Z8d4y9gjM</a></a></p>&mdash; Fiora @ 日本語でFF14 (@FioraAeterna) <a href="https://twitter.com/FioraAeterna/status/594110518203260929?ref_src=twsrc%5Etfw">May 1, 2015</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
</div>
<h3 id="737-max">737 Max</h3>
<p>Neste outro caso envolvendo a Boeing, um sensor é usado para detectar se o avião estava subindo rápido demais e correndo o risco de perder sustentação, um comportamento que se verificou comum no 737 Max por causa dos grandes motores usados nele e que o diferenciam do 737 original.
Se o risco é detectado, um sistema automatizado força o nariz do avião para baixo para corrigir o problema. 
Contudo, no 737 Max apenas um sensor é usado e no caso de falha do mesmo, o avião é forçado para baixo e em direção ao solo, o que levou à morte de centenas de pessoas.<sup id="fnref:737max"><a class="footnote-ref" href="#fn:737max">1</a></sup></p>
<h3 id="subaru-suv">Subaru SUV</h3>
<p>Em 2018 a Subaru fez um <em>recall</em> gigante, de mais de 1 milhão de unidades de um seus modelos de SUV, porquê uma falha em um software fez com que soldagens fossem feitas incorretamente no chassis dos veículos.
O erro era irreparável, levando a grandes prejuízos.</p>
<p><img alt="[Recall Subaru()https://spectrum.ieee.org/riskfactor/computing/it/coding-error-leads-293-subaru-ascents-to-the-car-crusher)]" src="images/subaru.png" /></p>
<!--Car Hack -- 2017, images/carhack, https://www.wired.com/story/car-hack-shut-down-safety-features/-->

<h3 id="root-cause-analysis"><em>Root cause analysis</em></h3>
<p>Quando defeitos aparecem, é importante identificar suas causas, isto é, a cadeia de eventos que o levou a acontecer.
Algumas empresas publicam a <strong><em>root cause analysis</em></strong> ou a análise <em>post-mortem</em> para a comunidade como forma de compartilhar conhecimento e também por questões de transparência.
Veja esta <a href="https://github.com/danluu/post-mortems">compilação</a> para uma extensa lista de análises.</p>
<h3 id="como-alcancar-dependabilidade">Como alcançar dependabilidade</h3>
<p>Falhas são um fato da vida, uma constante no desenvolvimento de sistemas. Mas se o objetivo é a dependabilidade, precisamos de formas de lidar com falhas, <strong>previnindo</strong>, <strong>removendo</strong> e <strong>tolerando</strong>-as.</p>
<p>A <strong>prevenção de falhas</strong> acontece por meio de técnicas bem estabelecidas de engenharia.
No caso de sistemas de software, modularização, linguagens de programação fortemente tipadas e encapsulamento são passos essencias. 
Uso de especificações formais, testadas ou provadas corretas, são outro passo neste sentido. Por exemplo, diversas empresas usam a linguagem <a href="https://lamport.azurewebsites.net/tla/tla.html">TLA<span><span class="MathJax_Preview">^+</span><script type="math/tex">^+</script></span></a> para verificar a corretude de seus algoritmos<sup id="fnref:tla_real"><a class="footnote-ref" href="#fn:tla_real">2</a></sup>. 
Outras técnicas envolvidas na prevenção de falhas são análise estática, prova de teoremas, execução simbólica, teste de modelos, etc.</p>
<p>Mesmo uma especificação correta pode produzir um sistema com falhas pois a tradução de especificações formais para código é um passo complexo.
Testes e manutenção do sistema permitem a <strong>remoção de falhas</strong> que passarem despercebidas pelas tentativas de prevenção.</p>
<p>Testes, contudo, apenas aumentam a confiança no sistema, não sendo capazes de certificar a ausência de problemas.
Assim, tenta-se desenvolver os sistemas de forma que, mesmo se falhas ainda estiverem presentes, seus efeitos não sejam percebidos como defeitos, isto é, sistemas que tenha <strong>tolerância a falhas</strong> (ou <strong>prevenção de defeitos</strong>).</p>
<p>Para se alcançar tolerância a falhas é necessário detectar e se recuperar de erros. 
Por exemplo, um sistema de arquivos com <em>journal</em>, como o <a href="https://en.wikipedia.org/wiki/Ext3#Journaling_levels">Ext v3</a>, armazena informação redundantemente e, quando <strong>detecta</strong> que os dados em sua forma principal estão corrompidos, usa o <em>journal</em> para <strong>recuperar</strong> os dados, <strong>mascarando</strong> o erro.</p>
<p>De acordo como Avizienis et al, temos as seguintes técnicas para tolerar falhas:</p>
<p><img alt="Avizienis et al" src="images/laprie_fault_tol.png" /></p>
<p>Um sistema que sofra de falhas recorrentes é um bom candidato a previsão de falhas, em que se estima quando uma falha ocorrerá baseado no histórico.
Por exemplo, um sistema que sofra falha por uso excessivo de memória a cada dez dias em uso, pode ser reiniciado no nono dia, em condições controladas, para evitar problemas maiores enquanto a razão do uso excessivo de memória é corrigido.</p>
<h3 id="classes-de-defeitos">Classes de Defeitos</h3>
<p>Para previnirmos e toleramos com falhas, precisamos entender como se manifestam e, para isso, uma classificação é essencial.</p>
<h4 id="quebra">Quebra</h4>
<p>Falhas de <strong>quebra</strong> (<strong><em>crash</em></strong>) são falhas em que o componente para de funcionar, irreversivelmente.
Uma vez que o componente cessa seu funcionamento, qualquer comunicação com o mesmo é interrompida e pode dar bons indicativos da falha aos outros componentes.
Em um sistema assíncrono, contudo, não há garantias de que esta detecção do defeito será correta.</p>
<p>Alguns sistemas, denominados <strong><em>fail-stop</em></strong>, forçam-se a parar de funcionar quando percebem um defeito, imitando uma quebra, e implementando um comportamento <strong><em>fail-fast</em></strong>.
Estes sistemas podem emitir um "canto do cisne" para permitir que outros componentes detectem o defeito.</p>
<p>Após pararem, alguns sistemas podem aplicar passos de recuperação e voltar a funcionar, no que é denominado <strong><em>fail-recover</em></strong>. Ao retornar à operação, o processo poderia assumir uma nova identidade.</p>
<h4 id="omissao">Omissão</h4>
<p>Em um <strong>defeito de omissão</strong> (<strong><em>omission failure</em></strong>), um componente não executa alguma ação. Por exemplo, uma requisição recebida por um servidor não é executada, um disco não armazena os dados no meio magnético, ou uma mensagem não é transmitida.
Este tipo de defeito é difícil de ser identificado pois outros componentes não necessariamente tem acesso direto ao resultado da operação.
Por exemplo, se o meio de comunicação se recusou a entregar uma mensagem, então houve um defeito de omissão.
Mas se a mensagem é retransmitida até que tenha sua entrega confirmada, então o defeito é mascarado.</p>
<h4 id="temporizacao">Temporização</h4>
<p>Em sistemas em que há limites de tempo para a execução de ações, uma violação destes limites é <strong>defeito de temporização</strong>.
Por exemplo, se o meio de comunicação se recusou a entregar uma mensagem, então houve uma falha de omissão.
Novamente considerando problemas de transmissão de mensagens, se o meio de comunicação se recusou a entregar uma mensagem que deveria ser entregue dentro de 3ms, então houve um defeito de omissão.
Mas se a mensagem é retransmitida até que tenha sua entrega confirmada, mas a mesma é entregue com 5ms, então o mesmo que após o limite para então o defeito é mascarado como um defeito de temporização.</p>
<h4 id="arbitrarios">Arbitrários</h4>
<p>Um defeito <strong>arbitrário</strong> ou <strong>bizantino</strong> é um no qual qualquer comportamento pode acontecer. 
Por exemplo, uma mensagem pode ser modificada, um servidor pode reiniciar-se constantemente, todos os dados podem ser apagados, ou acesso pode ser dado a quem não é devido.
Estes defeitos podem ser causados por agentes mal intencionados, como hackers e vírus.</p>
<h4 id="hierarquia">Hierarquia</h4>
<p>Fail-stop <span><span class="MathJax_Preview">\subset</span><script type="math/tex">\subset</script></span> Quebra <span><span class="MathJax_Preview">\subset</span><script type="math/tex">\subset</script></span> Omissão <span><span class="MathJax_Preview">\subset</span><script type="math/tex">\subset</script></span> Temporização <span><span class="MathJax_Preview">\subset</span><script type="math/tex">\subset</script></span> Arbitrária</p>
<h3 id="falhas-intermitentes">Falhas intermitentes</h3>
<p>Algumas falhas fogem à classificação acima por terem um comportamento especial, se manifestando de forma intermitente, por causa de eventos esparsos como picos de energia, ou pelo comportamento emergente da interação com outros sistemas.</p>
<div class="admonition quote">
<p class="admonition-title">Heisenbug</p>
<p>The name may seem to rhyme well with Heisenberg, but the Heisenbug is actually "a bug that disappears or alters its behavior when one attempts to probe or isolate it." The Freenet Project describes a Heisenbug in certain Java virtual machines.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Bohrbug</p>
<p>The Bohrbug is a sort of antonym of the Heisenbug, as this bug does not disappear or alter its characteristics when it is researched.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Mandelbug</p>
<p>The Mandelbug, named after Benoit Mandelbrot (think Mandelbrot set), is a bug whose underlying causes are so complex and obscure as to make its behavior appear chaotic.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Schroedinbug</p>
<p>The Schroedinbug is a design or implementation bug in a program that doesn't manifest until someone reading source or using the program in an unusual way notices that it never should have worked, at which point the program promptly stops working for everybody until fixed. Here, an Office developer describes "stupid SQL tricks" to get rid of a "classic Schroedinbug." </p>
</div>
<h3 id="correlacao-entre-falhas">Correlação entre falhas</h3>
<p>Algumas falhas são ativadas por entradas e, neste caso, mesmo que se tenha várias cópias do mesmo sistema, todas falharão uma vez que a entrada problemática acontecer.
Este é um cenário em que as falhas não são independentes, mas correlatas. Para evitá-lo, podemos usar <strong><em>n-version programming</em></strong>, que consiste basicamente em ter múltiplas implementções do mesmo sistema desenvolvidas de forma independente, isto é, fazendo uso de um ou mais da seguintes opções:</p>
<ul>
<li>múltiplos times</li>
<li>múltiplos sistemas operacionais</li>
<li>múltiplas linguagens de programação.</li>
</ul>
<p>Esta técnica é interessante mais raramente usada, basicamente pelo seu alto custo.
Além disso, erros de especificação são reproduzidos e levam times diferentes a produzir erros iguais.</p>
<h3 id="degradacao-graciosa">Degradação graciosa</h3>
<p>Dependendo dos efeitos e tratamentos.</p>
<ul>
<li>Fail safe - defeito não leva a comportamento inseguro (sistema de entretenimento no avião)</li>
<li>Fail soft - graceful degradation (sistema de controle de vôo)</li>
<li>
<p>Fail fast - para o fluxo de defeitos (e possível reinício)
<img alt="Cadeia de supervisão" src="images/httpatomoreillycomsourceoreillyimages300817.jpg" /></p>
</li>
<li>
<p>Robusto -- erros não atrapalham execução (tratamento de exceções)</p>
</li>
<li>Quebradiço (<em>brittle</em>) -- não resiliente a falhas</li>
</ul>
<h3 id="redundancia-de-processos">Redundância de Processos</h3>
<p>De forma geral, tolerância a defeitos é obtida por algum tipo de redundância. Por exemplo, pense no pneu estepe de um carro, no gerador de eletricidade de um hospital.
Redundância permite remover os pontos únicos de falha, SPOF (<em>Single Point of Failure</em>), isto é, componentes que se pararem, levam o sistema como um todo a parar.</p>
<p>Redundância pode ser aplicada em vários níveis, por exemplo, gastando mais tempo na especificação do projeto, ou montando um laboratório de testes mais próximo do ambiente de produção.</p>
<p>Redundância implica em mais custos, então o grau de redundância a ser utilizado depende de uma análise custo x benefício.</p>
<p>No caso de um sistema distribuído, quando falamos em redundância, normalmente falamos em redundância de processos, cópias ou réplicas, mesmo que não desevolvidos usando <em>n-version programming</em>
Assim, com múltiplas cópias, quando um processo apresenta um defeito, outro podem continuar executando o serviço.
Dois modos clássicos de replicação são o <strong>ativo</strong> e o <strong>primário/cópia</strong>. </p>
<p>No caso da replicação ativa, as várias cópias executam todos os comandos enviados para o sistema, estando assim todas aptas a continuar a executar o serviço. A técnica de replicação de máquinas de estados vista no capítulo anterior é uma instância de replicação ativa e da qual voltaremos a falar adiante.</p>
<p>No caso da replicação <strong>primário/cópia</strong>, também conhecida como <strong>mestre/escravo</strong>, o primário é responsável por lidar com clientes e por informar cópias das modificações de estado.</p>
<p><img alt="ha" src="images/ha-diagram-animated.gif" /></p>
<p>Como as atualizações de estado fluem do primário para a cópia, é possível que a cópia não tenha o estado mais atual.
Para visualizarmos melhor esta situação, vejamos a <strong>eplicação em cadeia</strong>, uma generalização de primário/cópia em que os processos se organizam em um sequência para executar operações.</p>
<p><img alt="Chain replication" src="images/chain.png" /></p>
<p>Atualizações no sistema são sempre direcionadas ao primário, a cabeça da sequência. Leituras, se absolutamente necessitarem dos dados escritos mais recentemente, também devem ser direcionadas à cabeça. Caso contrário, podem ser direcionadas aos processos na cauda, diminuindo a carga de trabalho na cabeça.</p>
<hr />
<h2 id="coordenacao">Coordenação</h2>
<p>Para replicar, precisamos coordenar as execuções dos processos, mas como?</p>
<h3 id="uma-historia-de-tres-exercitos">Uma história de três exércitos}</h3>
<ul>
<li>A e B deve atacar C</li>
<li>Se A e B atacam juntos, ganham</li>
<li>Se atacarem separados, são ambos derrotados.</li>
<li>Comunicação por mensageiros, <ul>
<li>que podem se perder e levar muito tempo para chegar</li>
<li>podem ser mortos no caminho</li>
<li>Atacamos ao amanhecer! (relógios sincronizados)  </li>
</ul>
</li>
</ul>
<p>Será que A não mandou uma resposta? Será que A foi destruído? Será que o mensageiro morreu? Será que parou em um inferninho?</p>
<p>Como saber se o outro recebeu a mensagem e irá atacar ao mesmo tempo? Mensagem de confirmação!
Como saber se o um recebeu a confirmação? Confirmação da confirmação!
Como saber se o outro/um ...?</p>
<p>Nesse cenário, até simples, coordenar os dois processos é \alert{impossível}!
É impossível garantir que chegarão a um \emph{acordo}.</p>
<h3 id="acordo">Acordo</h3>
<h4 id="comunicacao-em-grupo">Comunicação em Grupo</h4>
<p>Dependendo do modelo, pode ser muito fácil ou impossível fazer com que um grupo de processos concorde sobre como agir/entre em acordo.</p>
<p>Um dos fatores é como o grupo é organizado.
Assumindo um grupo estático (sem entrada e saída de processos), em que todos conversam com todos diretamente (grafo completo).</p>
<p><img alt="" src="images/chain.png" /></p>
<p>É mais fácil, mas não trivial neste modelo. Vejamos o problema de difusão confiável. Mas antes, vamos definir.</p>
<ul>
<li>Correto x Falho: Um processo é correto se ele não falha.</li>
</ul>
<p>Difusão Confiável
* Corretude: Se um processo \alert{correto} <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> difunde uma mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> para processos no grupo <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span>, então todos os processos corretos em <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span> entregam a mensagem.
* Acordo: Se um processo correto em <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span> entrega uma mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>, então todo processo correto em <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span> entrega <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>.
* Validade: Somente mensagens difundidas são entregues.</p>
<p>Terminologia}
* Enviar/Receber: rede
* Difundir/Entregar: difusão
* Corretude x Progresso</p>
<div class="admonition example">
<p class="admonition-title">Algoritmo - Difusão Confiável</p>
<p>Para <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> difundir <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> para <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span></p>
<ul>
<li><span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> envia <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> para todo <span><span class="MathJax_Preview">q \in G</span><script type="math/tex">q \in G</script></span></li>
<li>Todo processo <span><span class="MathJax_Preview">q\in G</span><script type="math/tex">q\in G</script></span> que receber a mensagem, envia <span><span class="MathJax_Preview">m_{ack}</span><script type="math/tex">m_{ack}</script></span> para <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span></li>
<li>Ao receber ack de todos os processos <span><span class="MathJax_Preview">q \in G</span><script type="math/tex">q \in G</script></span>, <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> para de retransmitir e entrega <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>.</li>
</ul>
</div>
<p>Satisfaz as duas propriedades? E se um dos receptores falhar?</p>
<p>Assumamos detector de falhas perfeito.</p>
<div class="admonition example">
<p class="admonition-title">Algoritmo - Difusão Confiável</p>
<p>Para <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> difundir <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> para <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span></p>
<ul>
<li><span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> envia <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> para todo <span><span class="MathJax_Preview">q \in G</span><script type="math/tex">q \in G</script></span></li>
<li>Todo processo <span><span class="MathJax_Preview">q\in G</span><script type="math/tex">q\in G</script></span> que receber a mensagem, envia <span><span class="MathJax_Preview">m_{ack}</span><script type="math/tex">m_{ack}</script></span> para <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span></li>
<li>Ao receber ack de todos os processos \alert{corretos} <span><span class="MathJax_Preview">q \in G</span><script type="math/tex">q \in G</script></span>, <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> para de retransmitir e entrega <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>.</li>
</ul>
</div>
<p>Pq <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> só entrega <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> no final?</p>
<p>Posso assumir TCP como protocolo de comunicação? Não! TCP não é confiável neste sentido.</p>
<p>Assuma máximo de <span><span class="MathJax_Preview">f</span><script type="math/tex">f</script></span> falhas, fail stop</p>
<div class="admonition example">
<p class="admonition-title">Algoritmo - Difusão Confiável</p>
<ul>
<li><span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> envia <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> para processos em <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span>.</li>
<li>Todo processo <span><span class="MathJax_Preview">q \in G</span><script type="math/tex">q \in G</script></span> que receber <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span><ul>
<li>envia <span><span class="MathJax_Preview">m_{ack}</span><script type="math/tex">m_{ack}</script></span></li>
<li>repassa <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> para <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span> processos.</li>
</ul>
</li>
<li>Mensagens são retransmitidas de tempos em tempos.</li>
<li>Ao receber <span><span class="MathJax_Preview">f+1</span><script type="math/tex">f+1</script></span> acks, entrega <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>.</li>
</ul>
</div>
<p><a href="https://www.youtube.com/watch?v=uzcALT7sHew"></a></p>
<div class="admonition example">
<p class="admonition-title">Algoritmo - Difusão Confiável</p>
<p>Assuma máximo de <span><span class="MathJax_Preview">f</span><script type="math/tex">f</script></span> falhas e uso de TCP</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* $p$ envia $m$ para processos em $G$.
* Em caso de quebra/falha de conexão, substitua destinatário.
* Todo processo $q \in G$ que receber $m$, repassa $m$ para os outros  processos.
* Entrega $m$.
</code></pre></div>
</td></tr></table>

</div>
<p>Confiável? Somente se conexões quebradas for reestabelecidas e mensagens reenviadas.</p>
<div class="admonition example">
<p class="admonition-title">Difusão Confiável FIFO</p>
<ul>
<li>Corretude.</li>
<li>Acordo.   </li>
<li>Validade.</li>
<li>FIFO: Se <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> difunde <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> e então <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span>, e se <span><span class="MathJax_Preview">q</span><script type="math/tex">q</script></span> entrega <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span>, então <span><span class="MathJax_Preview">q</span><script type="math/tex">q</script></span> entrega <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> antes <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span>.</li>
</ul>
</div>
<p>!!!example "Difusão Totalmente Ordenada
     * Corretude: Se um processo <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> difunde uma mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> para processos no grupo <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span>, e se <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> não falha, então todos os processos corretos em <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span> entregam <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>
     * Acordo: Se um processo correto <span><span class="MathJax_Preview">q</span><script type="math/tex">q</script></span> em <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span> entrega uma mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>, então todo processo correto em <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span> entrega <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>.
     * Ordenação: Se um processo entrega mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span> e depois <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span>, então qualquer processo que entregue a mensagem <span><span class="MathJax_Preview">n</span><script type="math/tex">n</script></span> deve primeiro entregar <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>.
     *  Validade: Somente mensagens difundidas são entregues.</p>
<p>Resolver diretamente este problema não é trivial. Por isso, veremos primeiro o problema do Consenso Distribuído.</p>
<h4 id="consenso">Consenso</h4>
<p>Sejam vários processos. Cada um propõe um único valor por \emph{instância de consenso}. O objetivo é decidir um dentre os valores propostos:</p>
<ul>
<li>Validade: Somente um valor proposto pode ser decidido.</li>
<li>Terminação: Todo processo não falho decide-se.</li>
<li>Acordo: Se um processo decide-se por <span><span class="MathJax_Preview">v</span><script type="math/tex">v</script></span> e outro por <span><span class="MathJax_Preview">w</span><script type="math/tex">w</script></span>, então <span><span class="MathJax_Preview">v = w</span><script type="math/tex">v = w</script></span></li>
</ul>
<p>É impossível resolver deterministicamente o problema do consenso em sistema assíncrono sujeito a falhas. <script type="math/tex; mode=display">Fischer, Lynch, Patterson, 85</script>
Mas o consenso é resolvido frequentemente em sistemas assíncronos sujeitos a falhas. Isso porque normalmente estes sistemas se comportam sincronamente.
Há diversos algoritmos de consenso que terminam quando o sistema se comporta bem. O mais famoso, atualmente, é o <a href="http://paxos.systems/index.html">Paxos</a></p>
<div class="admonition todo">
<p class="admonition-title">Todo</p>
<ul>
<li>Synod</li>
<li>Paxos</li>
</ul>
</div>
<p>Primitivas</p>
<ul>
<li>send\&amp;receive/enviar\&amp;receber -- rede</li>
<li>propose\&amp;decide/propor\&amp;decidir -- consenso</li>
<li>broadcast\&amp;deliver/difundir\&amp;entregar -- difusão</li>
</ul>
<p>Difusão Totalmente Ordenada
Dado infinitas instâncias de consenso, pode-se usá-las para resolver difusão atômica:</p>
<ul>
<li>Ordene as instâncias de consenso.</li>
<li>Para difundir mensagem <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>, proponha a mensagem na menor instância <span><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span> em que não tiver visto uma decisão.</li>
<li>Se a decisão de <span><span class="MathJax_Preview">i</span><script type="math/tex">i</script></span> não é <span><span class="MathJax_Preview">m</span><script type="math/tex">m</script></span>, volte para o passo anterior.</li>
<li>Entregue as decisões na ordem das instâncias.</li>
</ul>
<h4 id="replicacao-de-maquinas-de-estados">Replicação de Máquinas de Estados</h4>
<p>Ativo/Ativo -- Se todos os processos executam a mesma sequência de comandos, todos avançam pelos mesmos estados.</p>
<ul>
<li>Mesmo estado inicial</li>
<li>Comandos determinísticos</li>
<li>Comandos causalmente relacionados são executados em mesma ordem</li>
</ul>
<p>Possíveis diferentes ordens com mesmo efeito?</p>
<ul>
<li><code>touch /tmp/file1</code></li>
<li><code>echo "teste testando" $&gt;&gt;$ /tmp/file2</code></li>
<li><code>rm /tmp/file1</code></li>
<li><code>mkdir /dir1</code></li>
</ul>
<p>Diversos sistemas abstraem problemas de coordenação em sistemas distribuídos.</p>
<p>Estudaremos alguns nas aulas seguintes.</p>
<p>Antes, vamos nos aprofundar no estudo de um protocolo de Consenso/Difusão atômica.</p>
<h3 id="estudo-de-caso-do-raft">Estudo de Caso do Raft</h3>
<p><a href="http://thesecretlivesofdata.com/raft/">The Secret lives of data</a></p>
<h3 id="estudo-de-caso-paxos">Estudo de Caso: Paxos</h3>
<ul>
<li>Sínodo (Synod): consenso</li>
<li>Paxos: Difusão Atômica</li>
</ul>
<h3 id="estudo-de-caso-atomix-copycat">Estudo de caso: Atomix Copycat</h3>
<ul>
<li>Framework de replicação de máquinas de estados implementada pela Atomix. </li>
<li>Implementação do Raft</li>
<li>API simples</li>
<li>Java 8 (lambdas e futures)</li>
<li><a href="http://atomix.io/copycat/">Página Web</a></li>
</ul>
<p>\begin{frame}[fragile,allowframebreaks]{Lambda}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Classe com um único método.
\begin{lstlisting}[language=java]
</code></pre></div>
</td></tr></table>

<p>class Tarefa implements Runnable {
  public void run(){
    while (true)
      System.out.println("Bem vindo a um loop infinito");
    } <br />
}</p>
<p>new Thread(new Tarefa()).start();
    \end{lstlisting}</p>
<p>\framebreak</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Classe anônima -- uso único
</code></pre></div>
</td></tr></table>

<div>
<div class="MathJax_Preview">\begin{lstlisting}[language=java]
new Thread( new Runnable() {
  public void run(){
    while (true)
      System.out.println("Bem vindo a um loop infinito");
  }   
}).start();
\end{lstlisting}</div>
<script type="math/tex; mode=display">\begin{lstlisting}[language=java]
new Thread( new Runnable() {
  public void run(){
    while (true)
      System.out.println("Bem vindo a um loop infinito");
  }   
}).start();
\end{lstlisting}</script>
</div>
<p>\framebreak</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Lambda
</code></pre></div>
</td></tr></table>

<div>
<div class="MathJax_Preview">\begin{lstlisting}[language=java]
new Thread(() -&gt; {
                     while (true)
                       System.out.println("Bem vindo a um loop infinito");
                   }).start();
\end{lstlisting}</div>
<script type="math/tex; mode=display">\begin{lstlisting}[language=java]
new Thread(() -> {
                     while (true)
                       System.out.println("Bem vindo a um loop infinito");
                   }).start();
\end{lstlisting}</script>
</div>
<p>\framebreak
   * Encadeamento (fluent)
<script type="math/tex; mode=display">\begin{lstlisting}[language=java]
   Collection<Pessoa> c = ...;
   c.stream()
    .filter(p -> p.idade > 33)
    .map(Pessoa::sobrenomeNome)//.map(p -> p.sobrenomeNome())
    .forEach(s -> System.out.println(s));
\end{lstlisting}</script>
</p>
<p>\begin{frame}[fragile]{Future}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Promessa de computação e resultado.
</code></pre></div>
</td></tr></table>

<div>
<div class="MathJax_Preview">\begin{lstlisting}[language=java]
ExecutorService executor = Executors.newSingleThreadExecutor();
Future&lt;Integer&gt; futFib = executor.submit(() -&gt; { return Fibonacci(217)};
\end{lstlisting}</div>
<script type="math/tex; mode=display">\begin{lstlisting}[language=java]
ExecutorService executor = Executors.newSingleThreadExecutor();
Future<Integer> futFib = executor.submit(() -> { return Fibonacci(217)};
\end{lstlisting}</script>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Quando será executado?  Em algum momento.
* Como pegar o resultado?
</code></pre></div>
</td></tr></table>

<p>\begin{lstlisting}[language=java]
while (!futFib.isDone())
  System.out.println("tah calculando...");</p>
<p>int fib217 = futFib.get();
\end{lstlisting}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Em qual thread?  Em algum thread. Depende do Executor Service usado.
</code></pre></div>
</td></tr></table>

<p>Atomix-Raft}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Versão &gt;= 2 do copycat
* Melhor desempenho
* Documentação ruim
* \url{https://github.com/atomix/atomix}
</code></pre></div>
</td></tr></table>

<p>Lab}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Versão 1.1.4
* Baseado em \url{http://atomix.io/copycat/docs/getting-started/}
* Código funcional em \url{https://github.com/pluxos/atomix_labs}
</code></pre></div>
</td></tr></table>

<p>Clone e compile o projeto}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Instale dependências: git, maven e JDK &gt;= 1.8 (lembre-se que gRPC precisa de JDK &lt;= 1.8)
* git clone https://github.com/pluxos/atomix\_labs
%https://www.baeldung.com/atomix
* cd atomix\_labs
* cd replication
* mvn compile
* mvn test
</code></pre></div>
</td></tr></table>

<p>\begin{frame}[fragile]{mvn test}
Resultado esperado.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Tests run: 1, Failures: 0, Errors: 0, Skipped: 0

[INFO] ---------------------------------------
[INFO] BUILD SUCCESS
[INFO] ---------------------------------------
[INFO] Total time: 6.898 s
[INFO] Finished at: 2017-10-25T08:38:08-02:00
[INFO] Final Memory: 15M/159M
[INFO] ---------------------------------------
\end{verbatim}
</code></pre></div>
</td></tr></table>

<p>Estrutura}
Explore o projeto. Na pasta/URL \url{<a href="https://github.com/pluxos/atomix_labs/tree/master/replication/src/main/java/atomix_lab/state_machine">https://github.com/pluxos/atomix_labs/tree/master/replication/src/main/java/atomix_lab/state_machine</a>}</p>
<p>Há três pastas. Analise-as nesta ordem</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* type -- tipos dos dados mantidos pela replica (Edge e Vertex)\\
Os tipos são serializable para que o Java saiba como transformá-los em bytes.
* command -- estruturas que contêm informações para modificar os tipos\\
Os comandos serão enviadas do cliente para o cluster e são naturalmente serializable.
* client -- cria comandos e os envia para serem executados no cluster\\
Respostas podem ser esperadas síncrona ou assincronamente.
* server -- recebe os comandos na ordem definida pelo Raft e os executa
</code></pre></div>
</td></tr></table>

<p>Lab}
O projeto foi construído seguindo as instruções no tutorial mencionado antes, saltando-se a parte dos snapshots, isto é:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* crie um projeto maven\\
eclipse tem template para isso
* adicione dependências no pom.xml\\
como so criei um projeto, coloquei as dependências tanto do cliente quando do servidor
* defina Command que modifiquem o estado das réplicas
* defina Queries que consultem o estado das réplicas
* implemente a réplica para lidar com os comandos
* implemente o cliente para emitir comandos
</code></pre></div>
</td></tr></table>

<p>Lab}
Para executar um servidor, você precisa passar como parâmetro</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* identificador do processo (inteiro)
* IP do processo com identificador 0
* porta do processo com identificar 0
* IP do processo com identificador 1
* porta do processo com identificar 1
* ...
</code></pre></div>
</td></tr></table>

<p>Sabendo seu identificador, o servidor sabe em qual porta escutar e em quais IP/porta se conectar.</p>
<p>\begin{frame}[fragile]{Lab}
Execute três servidores. Usando o maven, da linha de comando, fica assim:
\begin{tiny}
\begin{verbatim}
mvn exec:java \
  -Dexec.mainClass="atomix_lab.state_machine.server.GraphStateMachine" \
  -Dexec.args="0 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002"</p>
<p>mvn exec:java \
  -Dexec.mainClass="atomix_lab.state_machine.server.GraphStateMachine" \
  -Dexec.args="1 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002"</p>
<p>mvn exec:java \
  -Dexec.mainClass="atomix_lab.state_machine.server.GraphStateMachine" \
  -Dexec.args="2 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002"
\end{verbatim}
\end{tiny}
%As instruções, sem quebra, estão no README do repositório.</p>
<p>\begin{frame}[fragile]{Lab}
O cliente não precisa de um identificador, apenas dos pares IP/porta dos servidores.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* IP do processo com identificador 0
* porta do processo com identificar 0
* IP do processo com identificador 1
* porta do processo com identificar 1
* ...
</code></pre></div>
</td></tr></table>

<p>Para executá-lo, use o comando
<script type="math/tex; mode=display">\begin{tiny}
\begin{verbatim}
mvn exec:java 
  -Dexec.mainClass="atomix_lab.state_machine.client.GraphClient"
  -Dexec.args="127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002"
\end{verbatim}
\end{tiny}</script>
</p>
<p>Exercício}
Uma vez executado o projeto, modifique-o para incluir uma nova operação (Command) e nova consulta (Query). </p>
<p>\section{Serviços de Coordenação}</p>
<p>Serviços de Coordenação}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Zookeeper
* Atomix
* OpenReplica
</code></pre></div>
</td></tr></table>

<p>\subsection{Estudo de Caso: ZooKeeper}</p>
<p>\subsubsection{Visão Geral}
ZooKeeper}
<script type="math/tex; mode=display">\begin{center}
\includegraphics{images/zklogo}
\end{center}</script>
\url{<a href="http://zookeeper.apache.org/">http://zookeeper.apache.org/</a>}</p>
<p>ZooKeeper}
<script type="math/tex; mode=display">\begin{block}{Zoo?}
Porquê sistemas distribuídos são como zoológicos, com animais de diversas espécies, sendo obrigados a conviver de forma anti-natural.
\end{block}</script>
</p>
<p>ZooKeeper}
<script type="math/tex; mode=display">\begin{block}{O quê?}
ZooKeeper is a \alert{centralized} service for maintaining \alert{configuration} information, \alert{naming}, providing distributed \alert{synchronization}, and providing \alert{group services}. All of these kinds of services are used in some form or another by \alert{distributed applications}. Each time they are implemented there is a lot of work that goes into fixing the bugs and race conditions that are inevitable. Because of the difficulty of implementing these kinds of services, applications initially usually skimp on them, which make them brittle in the presence of change and difficult to manage. Even when done correctly, different implementations of these services lead to management \alert{complexity} when the applications are deployed.
\end{block}</script>
</p>
<p>ZooKeeper}
<script type="math/tex; mode=display">\begin{block}{O quê?}
    ZooKeeper is a \alert{distributed}, open-source \alert{coordination service for distributed applications}. It exposes a \alert{simple set of primitives} that distributed applications can build upon to implement higher level services for synchronization, configuration maintenance, and groups and naming. It is designed to be easy to program to, and uses a data model styled after the familiar \alert{directory tree structure of file systems}. It runs in Java and has bindings for both \alert{Java} and \alert{C}.
\end{block}</script>
</p>
<p>ZooKeeper}
<script type="math/tex; mode=display">\begin{block}{Por quê?}
    Coordination services are notoriously hard to get right. They are especially prone to errors such as race conditions and deadlock. The motivation behind ZooKeeper is to relieve distributed applications the responsibility of implementing coordination services from scratch.
\end{block}</script>
</p>
<p>ZooKeeper}
<script type="math/tex; mode=display">\begin{block}{Como?}
    ZooKeeper allows distributed processes to coordinate with each other through a \alert{shared hierarchal namespace which is organized similarly to a standard file system}. The name space consists of data registers - called \alert{znodes}, in ZooKeeper parlance - and these are \alert{similar to files and directories}. Unlike a typical file system, which is designed for storage, ZooKeeper data is kept \alert{in-memory}, which means ZooKeeper can achieve \alert{high throughput and low latency} numbers.
\end{block}</script>
</p>
<p>ZooKeeper}
\includegraphics[width=.7\textwidth]{images/zknamespace}</p>
<p>ZooKeeper}
<script type="math/tex; mode=display">\begin{block}{Como?}
    ZooKeeper is replicated.\\
    ZooKeeper is ordered.
\end{block}</script>
</p>
<p>\includegraphics[width=1\textwidth]{images/zkservice}</p>
<p>ZooKeeper}
\includegraphics[width=1\textwidth]{images/zkcomponents}</p>
<p>ZooKeeper}
<script type="math/tex; mode=display">\begin{block}{Como?}
    ZooKeeper is fast [...] and it performs best where reads are more common than writes, at ratios of around 10:1.
\end{block}</script>
</p>
<p>Desempenho}
    \includegraphics[width=1\textwidth]{images/zkperfRW_3_2}</p>
<p>\subsubsection{Uso}
ZNodes}
\includegraphics[width=.6\textwidth]{images/zknamespace}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Arquivo e diretório ao mesmo tempo.
* São (devem ser) pequenos.
* Operados atomicamente: todo o dado é lido/escrito.
* API simples

        * C: create
        * R: get
        * U: set
        * D: delete
        * *: get children
</code></pre></div>
</td></tr></table>

<p>\begin{frame}[fragile]{Lab}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Download: wget \url{www-eu.apache.org/dist/zookeeper/zookeeper-3.4.10}
* Unpack: tar xvzf zookeeper*.tgz
* Config: \verb|conf/zoo.cfg| $\Leftarrow$ Copie o exemplo\\
%\verb|tickTime=2000|\\
%\verb|dataDir=/tmp/seuNome/zk0| $\Leftarrow$\\
%\verb|clientPort=2181| $\Leftarrow$
* \verb|./bin/zkServer.sh start-foreground|
* \verb|./bin/zkCli.sh -server 127.0.0.1:2181| $\Leftarrow$
</code></pre></div>
</td></tr></table>

<p>\frame{Exemplo}</p>
<p>ZNodes}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Stat(istics): versão, ACL, timestamps.
</code></pre></div>
</td></tr></table>

<p>\frame{Exemplo}</p>
<p>ZNodes}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Updates condicionais.
</code></pre></div>
</td></tr></table>

<p>\frame{Exemplo}</p>
<p>ZNodes}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Nós efêmeros: presentes enquanto a sessão que os criou estiver ativa.
</code></pre></div>
</td></tr></table>

<p>\frame{Exemplo}</p>
<p>ZNodes}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Watches: notificam clientes de mudanças no nó ou em seus filhos.
* Uso único.
</code></pre></div>
</td></tr></table>

<p>\frame{Exemplo}</p>
<p>Durabilidade?}
Todas as operações são colocadas em um log em disco.</p>
<p>\subsubsection{Receitas}
Receitas}
É possível resolver diversos problemas encontrados em sistemas distribuídos usando-se o ZooKeeper.</p>
<p>Rendezvous}
Ponto de encontro de processos. </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Defina um zNode raiz a ser usado: /rendezvous/app1/ 
* Cada filho de /rendezvous/app1 corresponde a um processo:

        * IP
        * Porta
        * Número de processadores
        * ...

* Processo p ao ser iniciado:

        * procura /rendezvous/app1/p

            * se achar, continua
            * se não achar, cria /rendezvous/app1/p

        * lista os filhos de /rendezvous/app1
</code></pre></div>
</td></tr></table>

<p>Como lidar com saída de processos?}
 Faça todos os zNodes são efêmeros. \
Quando um nó é desconectado, o zNode correspondente será destruído.</p>
<p>Como detectar mudanças no grupo de processos?}
Monitore os filhos de /rendezvous/app1\
Sempre que receber notificações, refaça o cálculo do \emph{membership}.</p>
<p>Eleição de Líderes}
 Rendezvous.\
 Faça os zNodes sequenciais.
 Ordene os zNodes e escolha o primeiro.
 Monitore o zNode. Se ele sumir, eleja outro líder.</p>
<p>Exclusão Mútua}
Construa uma fila usando nós efêmeros e sequenciais. O processo na cabeça da fila tem direito de acesso. Em caso de falhas, o processo é removido da cabeça da fila.</p>
<p>Compartilhamento de Parâmetros de Configuração}
Pronto!</p>
<p>Receitas}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Lock distribuído
* Filas, e.g. de prioridades
* Barreira
* Serviço de nomes
* Terminação em duas fases
* Contador atômico
</code></pre></div>
</td></tr></table>

<p>\url{<a href="http://zookeeper.apache.org/doc/trunk/recipes.html">http://zookeeper.apache.org/doc/trunk/recipes.html</a>}</p>
<p>Curator}
\includegraphics{images/curator-logo}</p>
<p>Um livro de receitas implementadas em ZK.</p>
<p>\url{<a href="http://curator.apache.org">http://curator.apache.org</a>}</p>
<p>Lab}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    * Crie um zNode /teste
    * Debaixo de /teste, crie três outros, sequenciais
</code></pre></div>
</td></tr></table>

<p>Lab}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Crie um zNode /teste2
* Crie um zNode efêmero
* Conecte-se com outro cliente
* Coloque um watch em /teste2
* Desconecte o primeiro cliente
* Observe o evento gerado no segundo cliente
* Reconecte o primeiro cliente
</code></pre></div>
</td></tr></table>

<p>\begin{frame}[fragile]{Multi-node}
Crie três arquivos, zoo1.cfg, zoo2.cfg e zoo3.cfg.\Por exemplo, zoo1.cfg fica assim:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* \verb|dataDir=/tmp/lasaro/zoo1| $\Leftarrow$ Diretórios distintos.
* \verb|server.1=zoo1:2888:3888| $\Leftarrow$ Portas distintas.
* \verb|server.2=zoo2:2889:3889|
* \verb|server.3=zoo3:2890:3890|
* \verb|clientPort=2181| $\Leftarrow$ Portas distintas.
</code></pre></div>
</td></tr></table>

<p>Crie diretórios e arquivos de identificação.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* \verb|mkdir /tmp/lasaro/zoo1|
* \verb|echo 1 &gt; /tmp/lasaro/zoo1/myid|
</code></pre></div>
</td></tr></table>

<p>Execute servidores.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* \verb|./bin/zkServer.sh start conf/zoo1.cfg|
</code></pre></div>
</td></tr></table>

<p>Use \verb|start-foreground| para acompanhar a execução.</p>
<p>Lab}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Crie um znode /contador com valor 0
* Descreva como fazer para que os clientes incrementem atomicamente o valor de /contador.
</code></pre></div>
</td></tr></table>

<p>\subsection{Falhas Bizantinas}</p>
<p>Uma história de três exércitos -- Versão 2}
Exércitos estão às portas de Bizâncio, aka Constantinopla, aka Istambul.</p>
<p>Todos os exércitos tem que atacar em conjunto ou se retirar em conjunto.</p>
<p>Cada exército é comandado por um General. Alguns destes preferem atacar, enquanto outros preferem se retirar.</p>
<p>Alguns generais podem ter sido comprados, e mandar mensagens discrepantes para os outros, ou simplesmente não mandar mensagens.</p>
<p>Fonte: \href{<a href="http://research.microsoft.com/en-us/um/people/lamport/pubs/byz.pdf}{Lamport">http://research.microsoft.com/en-us/um/people/lamport/pubs/byz.pdf}{Lamport</a>, L.; Shostak, R.; Pease, M. (1982). "The Byzantine Generals Problem" (PDF). ACM Transactions on Programming Languages and Systems. 4 (3): 382–401. doi:10.1145/357172.357176.}</p>
<p>Generais e Tenentes}
Problema pode ser mudado para:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Comandante envia ordem.
* Todos os tenentes leais executam ordem recebida.
* Comandante pode ser traidor.
</code></pre></div>
</td></tr></table>

<p>Generais e Tenentes}
Suponha 3 exércitos. \
Comandante (traidor) diz "Ataque!" Tenente A e "Retirada!" tenente B.\
Ou \
Comandante diz "Ataque!" a ambos. Tenente A segue a ordem mas B se retira.</p>
<p>E se os tenentes trocarem informações?</p>
<p>Como diferenciar casos em que Comandante ou Tenente é traidor?</p>
<p>Generais e Tenentes}
Só há solução se mais de <span><span class="MathJax_Preview">\frac{2}{3}</span><script type="math/tex">\frac{2}{3}</script></span> dos Generais/Tenentes são leais.</p>
<p>%<a href="http://www.drdobbs.com/cpp/the-byzantine-generals-problem/206904396?pgno=5">http://www.drdobbs.com/cpp/the-byzantine-generals-problem/206904396?pgno=5</a></p>
<p>Comunicação}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Toda mensagem enviada é entregue corretamente.
* A ausência de mensagem pode ser detectada (mensagem Null é entregue no lugar) (Sistema síncrono)
</code></pre></div>
</td></tr></table>

<p>4/0}
General manda ordens.</p>
<p>Ausência de ordem = Retirada</p>
<p>Tenente repassa ordens</p>
<p>Maioria de comandos é comando a ser seguido</p>
<p>4/0}
General manda ordens.</p>
<p>Ausência de ordem = Retirada</p>
<p>Tenente repassa ordens</p>
<p>Maioria de comandos é comando a ser seguido</p>
<p>Comunicação}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Toda mensagem enviada é entregue corretamente.
* Toda mensagem é assinada.
* A ausência de mensagem pode ser detectada (mensagem Null é entregue no lugar) (Sistema síncrono)
</code></pre></div>
</td></tr></table>

<p>É possível detectar inconsistências e processos bizantinos.</p>
<p>%<a href="http://cs.brown.edu/courses/cs138/s16/lectures/19consen-notes.pdf">http://cs.brown.edu/courses/cs138/s16/lectures/19consen-notes.pdf</a>
\section{Outros tópicos}</p>
<p>%TODO \subsection{Detectores de Falhas}</p>
<p>\subsection{Reconfiguração}</p>
<p>Reconfiguração da Aplicação}
Na segunda entrega do projeto, você distribuiu a carga do seu banco de dados entre vários nós. Caso um nó falhe, parte dos seus dados será perdida.</p>
<p>Para corrigir esta deficiência, na terceira entrega, cada nó será replicado em três vias e, assim, caso um nó falhe, outros dois continuarão a manter o dado.</p>
<p>Reconfiguração da Aplicação}
Ainda assim, há problemas. E se mais de um, de um mesmo conjunto de réplicas, falhar? </p>
<p>Embora seja pequena a probabilidade de dois nós de um mesmo grupo falharem em instantes próximos, dado tempo suficiente, qualquer evento com probabilidade diferente de 0 acontecerá.</p>
<p>Precisamos de uma forma de trocar nós da aplicação que falharam por novos nós. </p>
<p>Este é problema denominado Pertinência de Grupo ou \emph{Group Membership}</p>
<p>Group Membership}
Para não correr o risco, retire o processo falhos do grupo e coloque outro no lugar!</p>
<p>I.e., mude a visão que o sistema de quem é o grupo.</p>
<p>Visões}
\includegraphics[width=.7\textwidth]{images/vc}</p>
<p>Fonte: \href{<a href="https://www.cs.rutgers.edu/~pxk/417/notes/virtual_synchrony.html}{Paul">https://www.cs.rutgers.edu/~pxk/417/notes/virtual_synchrony.html}{Paul</a> Krzyzanowski}</p>
<p><span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span> é o grupo de processos participando do sistema, é a Visão do Sistema.</p>
<p>Inicialmente, <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span> consiste de apenas o processo <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span>, como o processo que cria o cluster no Atomix. Na sequência, outros processo vão se unindo ao grupo através de View Changes. Uma vez que <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> e <span><span class="MathJax_Preview">q</span><script type="math/tex">q</script></span> estão no grupo, inicia-se a comunicação entre eles. Quando <span><span class="MathJax_Preview">r, s</span><script type="math/tex">r, s</script></span> e <span><span class="MathJax_Preview">t</span><script type="math/tex">t</script></span> aparecem, também entram no grupo por meio de uma nova visão.</p>
<p>Finalmente, quando ambos <span><span class="MathJax_Preview">p</span><script type="math/tex">p</script></span> e <span><span class="MathJax_Preview">q</span><script type="math/tex">q</script></span> falham, os outros processo os excluem da visão, e continuam funcionando normalmente.</p>
<p>Impossibilidade de Detecção de Falhas}
Em um sistema distribuído assíncrono, é impossível distinguir com toda certeza um processo falho (parou de funcionar) de um que está lento.</p>
<p>Como decidir se mudar ou não de visão?</p>
<p>Ou aceita a imprecisão e muda quando suspeitar de uma falha, ou corre o risco de ficar esperando \emph{ad eternum} e não mudar, mesmo quando uma falha aconteceu.</p>
<p>Uma ``solução''!}
Quando suspeitar de falha, reporte suspeita a outros processos, que também passarão a suspeitar.</p>
<p>Tome decisão baseado na suspeita, isto é, troque de visão quando houver suspeita.</p>
<p>Pague o preço de uma suspeita errada, isto é, quando um processo for removido da visão indevidamente, adicione-o novamente.</p>
<p>Sincronismos Virtual}
Gerenciamento de Grupo/Group Membership e Comunicação em Grupo</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Processos se unem ao grupo
* Processos saem do grupo
* Processos enviam mensagens para o grupo
* Diferentes ordenações

        * Atomic Multicast
</code></pre></div>
</td></tr></table>

<p>Visão de Grupo}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Visão: conjunto de processos no sistema.
* Multicast feito para processos na visão.
* Visão é consistente entre os processos.
* Entrada e saída de processos muda a visão.
</code></pre></div>
</td></tr></table>

<p>Eventos}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Mensagem
* Mudança de Visão
* Checkpoint
</code></pre></div>
</td></tr></table>

<p>Visões}
\includegraphics[width=.7\textwidth]{images/vc}</p>
<p>Fonte: \href{<a href="https://www.cs.rutgers.edu/~pxk/417/notes/virtual_synchrony.html}{Paul">https://www.cs.rutgers.edu/~pxk/417/notes/virtual_synchrony.html}{Paul</a> Krzyzanowski}</p>
<p>Sincronismo Virtual}
Deve satisfazer</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Se uma mensagem é enviada em uma visão, ela só pode ser entregue naquela visão.
* Se uma mensagem é entregue a um processo correto em uma visão, então é entregue a todos os processos corretos naquela visão.
* Se um processo não recebe a mensagem, ele não estará na próxima visão.
* Ao entrar em uma visão, o processo recebe o estado dos outros processos e seu estado se torna equivalente ao de um processo que recebeu todas as mensagens já entregues.
</code></pre></div>
</td></tr></table>

<p>A troca de Visão é uma barreira.</p>
<p>ISIS Toolkit}
    Sistema de Sincronismo Virtual tolerante a falhas desenvolvido por Ken Birman, Cornell University (\url{<a href="http://www.cs.cornell.edu/Info/Projects/Isis/">http://www.cs.cornell.edu/Info/Projects/Isis/</a>})\
    ISIS: An Environment for Constructing Fault-Tolerant Distributed Systems. Kenneth Birman, D. Skeen, A. El Abbadi, W. C. Dietrich and T. Raeuchle. May 1983.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* 100.000&#39;s/s
* Em uso até 2009
* NY Stock Exchange
* Swiss Exchange
* US Navy
* Precursos de sistemas como Zookeeker
* Totem, ISIS, Horus, Transis (Partições), \alert{Spread}, \alert{Ensamble}, \alert{JGroups}, Appia, QuickSilver, vSynch (née ISIS 2)
</code></pre></div>
</td></tr></table>

<p>Difusão Totalmente Ordenada}</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Corretude: Se um processo $p$ envia uma mensagem $m$ para processos no grupo $G$, então se $p$ não falha, todos os processos corretos em $G$ recebem a mensagem.

* Acordo: Se um processo correto em $G$ recebe uma mensagem $m$, então todo processo correto em $G$ recebe $m$

* Ordenação: Se um processo recebe mensagem $m$ e depois $n$, então qualquer processo que receba a mensagem $n$ deve primeiro receber $m$

* Validade: Somente mensagens difundidas são entregues.
</code></pre></div>
</td></tr></table>

<p>E se mandarmos mensagens do tipo ``A partir da entrega desta mensagem, o grupo de processos é <span><span class="MathJax_Preview">G</span><script type="math/tex">G</script></span>.''</p>
<p>Sincronismo Virtual}
Deve satisfazer</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>* Se uma mensagem é enviada em uma visão, ela só pode ser entregue naquela visão.\\
Mensagens de troca de visão podem incrementar um contador\\
Mensagens normais carregam o valor atual do contador\\
Mensagem descartada se valor na mensagem é maior contador no destinatário

* Se uma mensagem é entregue a um processo correto em uma visão, então é entregue a todos os processos corretos naquela visão.\\
Pela difusão, se a mensagem de troca for entregue para um processo, será entregue para todos os corretos, na mesma ordem
Se mensagem comum for entregue antes para algum, será entregue ante para todos.

* Se um processo não recebe a mensagem, ele não estará na próxima visão.\\
Se um processo não recebe uma mensagem comum que foi entregue pelos outros, então ele não troca de visão.

* Ao entrar em uma visão, o processo recebe o estado dos outros processos e seu estado se torna equivalente ao de um processo que recebeu todas as mensagens já entregues.\\
Caso contrário, não haveria porquê trocar os processos
</code></pre></div>
</td></tr></table>

<p>State Transfer}
\includegraphics[width=.7\textwidth]{images/state_transfer}</p>
<p>\href{<a href="http://www.gsd.inesc-id.pt/~ler/docencia/tfd0405/bib/BSRNA.pdf}{Building">http://www.gsd.inesc-id.pt/~ler/docencia/tfd0405/bib/BSRNA.pdf}{Building</a> Secure and Reliable Network Applications}</p>
<p>Difusão Atômica <span><span class="MathJax_Preview">\equiv</span><script type="math/tex">\equiv</script></span> Sincronismo Virtual?}
Seria uma boa aproximação, mas que poderia ser relaxada. </p>
<p>Em certas aplicações, FIFO ou Causal seriam suficientes dentro da visão, desde que a mensagem de mudança da visão seja totalmente ordenada com as comuns.</p>
<p>Particionamento}
E se dois subconjuntos mutuamente exclusivos se formarem e criarem visões independentes?</p>
<p>\emph{Primary Partition Model} -- Somente a partição primária pode mudar de visão.</p>
<p>Lembram-se que no Raft somente uma partição com uma maioria de processo pode decidir? É exatamente a mesma situação, pois os processos estão chegando a um Consenso sobre quem é a nova visão.</p>
<p>Extended Virtual Synchrony}
\emph{Primary Partition Model} -- Não é adequado a uma rede geograficamente distribuída (Internet scale).</p>
<p>Lembram-se que no Raft somente uma partição com uma maioria de processo pode decidir? É exatamente a mesma situação, pois os processos estão chegando a um Consenso sobre quem é a nova visão.</p>
<p>É possível que no trabalho dois, alguns de vocês tenham tentado gerar locks do sistema para manipular objetos distribuídos no sistema. Esse locks são perigosos por quê processos pode travar/quebrar/falhar e nunca liberarem os locks. O uso de um algoritmo VS poderia ser usado para resolver o problema.\right </p>
<p><a href="https://asafdav2.github.io/2017/swim-protocol/">Swim</a></p>
<p><a href="http://courses.cs.vt.edu/cs5204/fall05-gback/lectures/Lecture8.pdf">http://courses.cs.vt.edu/cs5204/fall05-gback/lectures/Lecture8.pdf</a></p>
<div class="footnote">
<hr />
<ol>
<li id="fn:737max">
<p><a href="https://theconversation.com/boeing-737-max-why-was-it-grounded-what-has-been-fixed-and-is-it-enough-150688">Boeing 737 Max: why was it grounded, what has been fixed and is it enough?</a>&#160;<a class="footnote-backref" href="#fnref:737max" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:tla_real">
<p><a href="https://probablydance.com/2020/10/31/using-tla-in-the-real-world-to-understand-a-glibc-bug/"><em>Using TLA+ in the Real World to Understand a Glibc Bug</em></a>&#160;<a class="footnote-backref" href="#fnref:tla_real" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../time/" title="Tempo" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Tempo
              </div>
            </div>
          </a>
        
        
          <a href="../disdb/" title="Bancos de Dados" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Bancos de Dados
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.c51dfa35.min.js"></script>
      <script src="../assets/javascripts/bundle.eaaa3931.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.58d22e8e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>