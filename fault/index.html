
<!doctype html>
<html lang="pt" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Tolerância a Falhas - Notas em Sistemas Distribuídos</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-PJX835H7DP","lasarojc.github.org/dsnotes"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tolerancia-a-falhas" class="md-skip">
          Ir para o conteúdo
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-header__button md-logo" aria-label="Notas em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Notas em Sistemas Distribuídos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tolerância a Falhas
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Buscar" placeholder="Buscar" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Notas em Sistemas Distribuídos
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../preface/" class="md-nav__link">
        Prefácio
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/" class="md-nav__link">
        Fundamentos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../arch/" class="md-nav__link">
        Arquiteturas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../comm/" class="md-nav__link">
        Comunicação
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../coord/" class="md-nav__link">
        Coordenação
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../time/" class="md-nav__link">
        Tempo
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Tolerância a Falhas
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Tolerância a Falhas
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tolerancia-a-falhas" class="md-nav__link">
    Tolerância a Falhas
  </a>
  
    <nav class="md-nav" aria-label="Tolerância a Falhas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dependabilidade" class="md-nav__link">
    Dependabilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas-erros-e-defeitos" class="md-nav__link">
    Falhas, Erros e Defeitos
  </a>
  
    <nav class="md-nav" aria-label="Falhas, Erros e Defeitos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#classes-de-defeitos" class="md-nav__link">
    Classes de Defeitos
  </a>
  
    <nav class="md-nav" aria-label="Classes de Defeitos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quebra" class="md-nav__link">
    Quebra
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omissao" class="md-nav__link">
    Omissão
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporizacao" class="md-nav__link">
    Temporização
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arbitrarios" class="md-nav__link">
    Arbitrários
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarquia" class="md-nav__link">
    Hierarquia
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defeitos-intermitentes" class="md-nav__link">
    Defeitos intermitentes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correlacao-entre-falhas" class="md-nav__link">
    Correlação entre falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas-bizantinas" class="md-nav__link">
    Falhas Bizantinas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-lidar-com-falhas" class="md-nav__link">
    Como lidar com falhas?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acordo" class="md-nav__link">
    Acordo
  </a>
  
    <nav class="md-nav" aria-label="Acordo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uma-historia-de-tres-exercitos" class="md-nav__link">
    Uma história de três exércitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impossibilidade" class="md-nav__link">
    Impossibilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consenso" class="md-nav__link">
    Consenso
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detectores-de-defeitos-nao-confiaveis" class="md-nav__link">
    Detectores de Defeitos não Confiáveis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paxos-algoritmo-do-sinodo" class="md-nav__link">
    Paxos: Algoritmo do Sínodo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#difusao-totalmente-ordenada" class="md-nav__link">
    Difusão Totalmente Ordenada
  </a>
  
    <nav class="md-nav" aria-label="Difusão Totalmente Ordenada">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-raft" class="md-nav__link">
    Estudo de Caso: Raft
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-paxos" class="md-nav__link">
    Estudo de Caso: Paxos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outras-ordenacoes" class="md-nav__link">
    Outras Ordenações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arcaboucos-para-coordenacao" class="md-nav__link">
    Arcabouços para coordenação
  </a>
  
    <nav class="md-nav" aria-label="Arcabouços para coordenação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-copycat" class="md-nav__link">
    Estudo de caso: Copycat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-ratis" class="md-nav__link">
    Estudo de caso: Ratis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-zookeeper" class="md-nav__link">
    Estudo de caso: Zookeeper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-etcd" class="md-nav__link">
    Estudo de caso: Etcd
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-kafka" class="md-nav__link">
    Estudo de caso: Kafka
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-bft-smart" class="md-nav__link">
    Estudo de caso BFT-Smart
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../disdb/" class="md-nav__link">
        Bancos de Dados
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../disfs/" class="md-nav__link">
        Sistemas de Arquivos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tech/" class="md-nav__link">
        Tecnologias
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../projeto/" class="md-nav__link">
        Projeto
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tolerancia-a-falhas" class="md-nav__link">
    Tolerância a Falhas
  </a>
  
    <nav class="md-nav" aria-label="Tolerância a Falhas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dependabilidade" class="md-nav__link">
    Dependabilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas-erros-e-defeitos" class="md-nav__link">
    Falhas, Erros e Defeitos
  </a>
  
    <nav class="md-nav" aria-label="Falhas, Erros e Defeitos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#classes-de-defeitos" class="md-nav__link">
    Classes de Defeitos
  </a>
  
    <nav class="md-nav" aria-label="Classes de Defeitos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quebra" class="md-nav__link">
    Quebra
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omissao" class="md-nav__link">
    Omissão
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporizacao" class="md-nav__link">
    Temporização
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arbitrarios" class="md-nav__link">
    Arbitrários
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarquia" class="md-nav__link">
    Hierarquia
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defeitos-intermitentes" class="md-nav__link">
    Defeitos intermitentes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correlacao-entre-falhas" class="md-nav__link">
    Correlação entre falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas-bizantinas" class="md-nav__link">
    Falhas Bizantinas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-lidar-com-falhas" class="md-nav__link">
    Como lidar com falhas?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acordo" class="md-nav__link">
    Acordo
  </a>
  
    <nav class="md-nav" aria-label="Acordo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uma-historia-de-tres-exercitos" class="md-nav__link">
    Uma história de três exércitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impossibilidade" class="md-nav__link">
    Impossibilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consenso" class="md-nav__link">
    Consenso
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detectores-de-defeitos-nao-confiaveis" class="md-nav__link">
    Detectores de Defeitos não Confiáveis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paxos-algoritmo-do-sinodo" class="md-nav__link">
    Paxos: Algoritmo do Sínodo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#difusao-totalmente-ordenada" class="md-nav__link">
    Difusão Totalmente Ordenada
  </a>
  
    <nav class="md-nav" aria-label="Difusão Totalmente Ordenada">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-raft" class="md-nav__link">
    Estudo de Caso: Raft
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-paxos" class="md-nav__link">
    Estudo de Caso: Paxos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outras-ordenacoes" class="md-nav__link">
    Outras Ordenações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arcaboucos-para-coordenacao" class="md-nav__link">
    Arcabouços para coordenação
  </a>
  
    <nav class="md-nav" aria-label="Arcabouços para coordenação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-copycat" class="md-nav__link">
    Estudo de caso: Copycat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-ratis" class="md-nav__link">
    Estudo de caso: Ratis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-zookeeper" class="md-nav__link">
    Estudo de caso: Zookeeper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-etcd" class="md-nav__link">
    Estudo de caso: Etcd
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-kafka" class="md-nav__link">
    Estudo de caso: Kafka
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-bft-smart" class="md-nav__link">
    Estudo de caso BFT-Smart
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              

<!-- Edit button -->


  <!--
       Hack: check whether the content contains a h1 headline. If it
       doesn't, the page title (or respectively site name) is used
       as the main headline.
    -->

  <h1>Tolerância a Falhas</h1>


  <!-- Content -->
  <h2 id="tolerancia-a-falhas">Tolerância a Falhas</h2>
<p>Nós escrevemos software para que resolvam problemas de espectro bem amplo, indo, do controle de braços robóticos em cirurgias remotas à sistemas de comércio eletrônico, do controle de usinas hidroelétricas à jogos de truco online.
Independentemente do problema sendo resolvido, gostaríamos de poder contar com o sistema, de poder depender nele para executar sua tarefa.
Desta situação, surge a ideia de dependabilidade, isto é, de um sistema ter a propriedade de se poder depender do mesmo.</p>
<h3 id="dependabilidade">Dependabilidade</h3>
<p>Dizemos que um componente <strong><span class="arithmatex">\(C\)</span> depende de um componente <span class="arithmatex">\(C'\)</span></strong> se a corretude do comportamento de <span class="arithmatex">\(C\)</span> depende da corretude do componente <span class="arithmatex">\(C'\)</span>.
Dizemos também que um componente é "dependável" (<em>dependable</em>) na medida em que outros podem depender dele.
A dependabilidade é essencial aos componentes de sistemas distribuídos, pois como diz o ditado, uma corrente é tão forte quanto seu elo mais fraco.</p>
<p>De acordo com <a href="https://www.nasa.gov/pdf/636745main_day_3-algirdas_avizienis.pdf">Avizienis et al</a>, tem-se dependabilidade quando os seguintes atributos estão presentes.</p>
<ul>
<li>Disponibilidade (<em>Availability</em>) - Prontidão para uso.</li>
<li>Confiabilidade/Fiabilidade (<em>Reliability</em>) - Continuidade do serviço.</li>
<li>Segurança (<em>Safety</em>) - Tolerância a catástrofes.</li>
<li>Integridade (<em>Integrity</em>) - Tolerância a modificações.</li>
<li>Manutenabilidade (<em>Maintainability</em>) - Facilidade de reparo.</li>
</ul>
<p>Além da dependabilidade, outra propriedade importante e desejável para os sistemas é a <strong>Confidencialidade</strong>, que quando combinada à <strong>Integridade</strong> e <strong>Confidencialidade</strong> é também chamada de <strong>Segurança</strong> (<em>Security</em>). </p>
<ul>
<li>Confidencialidade (<em>Confidentiality</em>) -- informação somente é acessível a quem é devido.</li>
</ul>
<p>Aqui nós nos focaremos apenas na disponibilidade que, por si só, é bem abrangente:</p>
<div class="admonition quote">
<p class="admonition-title">Disponibilidade</p>
<p>The term 'availability' means ensuring timely and reliable access to and use of information.</p>
<p><a href="https://doi.org/10.6028/NIST.SP.800-59">NIST SP 800-59</a>, no termo Availability <a href="https://www.gpo.gov/fdsys/granule/USCODE-2011-title44/USCODE-2011-title44-chap35-subchapIII-sec3542">44 U.S.C., Sec. 3542 (b)(1)(C))</a></p>
</div>
<p>Mais especificamente, sobre como manter um sistema online para que possa responder a requisições, mesmo quando problemas aparecem. Mas para isso, primeiro precisamos entender os tipos de problemas que aparecem em vários níveis, desde o seu desenvolvimento até seu uso.</p>
<h3 id="falhas-erros-e-defeitos">Falhas, Erros e Defeitos</h3>
<p>No nível mais básico dos problemas a serem contornados para se obter dependabilidade, temos as <strong>falhas</strong> (<em>defect</em>, <em>fault</em>, para alguns, falta), que é um erro no desenvolvimento do sistema, como <em>bugs</em> ou defeitos de fabricação, que o leva a ficar diferente do que foi especificado, ou mesmo um erro na especificação.
Uma falha existe mesmo se for raramente ativada e mesmo se seus efeitos nunca forem percebidos. 
Por exemplo, se o código tem um <code>&lt;=</code> em vez de <code>&lt;</code> na especificação de uma iteração, mas se uma condição faz com que a iteração seja interrompida antes, o código ainda tem uma falha.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">char</span> <span class="n">minha_string</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="n">initialize</span><span class="p">(</span><span class="n">minha_string</span><span class="p">);</span>

<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">minha_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="n">minha_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">minha_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<p>No segundo nível, temos o <strong>erro</strong> (<em>error</em>), que é a manifestação da falha levando a algum comportamento indevido. No exemplo acima, um erro seria quando a iteração passasse do ponto correto por causa do <code>&lt;=</code>, por exemplo, na hora de escrever uma <em>string</em> em um array, estourando o limite do array na pilha mas sobrescrevendo uma variável que não seja mais usada.
O erro pode passar despercebido, mas ainda assim é um erro.</p>
<p>Finalmente, no terceiro nível, temos os <strong>defeitos</strong> (<em>failure</em>, para alguns, falha), um erro percebido pelo usuário. 
Continuando o exemplo, um <em>stack overflow</em> que leva a uma falha de segmentação, leva a um defeito.</p>
<p>Quando um componente manifesta um defeito, outros componentes que dele dependem, internalizarão entradas indevidas, uma falha externa, o que levará a seu próprio estado interno a estar errôneo e possivelmente também manifestar um defeito. 
Esta cadeia pode levar cenários catastróficos.</p>
<div class="admonition example">
<p class="admonition-title">Falhas Famosas</p>
<div class="tabbed-set" data-tabs="1:4"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">Ariane 5</label><div class="tabbed-content">
<p>O Ariane 5 foi um foguete desenvolvido pela agencia espacial européia que explodiu durante o lançamento.</p>
<div class="admonition quote">
<p class="admonition-title">The Explosion of the Ariane 5</p>
<p>On June 4, 1996 an unmanned Ariane 5 rocket launched by the European Space Agency exploded just forty seconds after its lift-off [...] after a decade of development costing $7B. The destroyed rocket and its cargo were valued at $500M. [...] the failure was a software error [...] a 64 bit floating point number [...] was converted to a 16 bit signed integer. The number was larger than 32,767, the largest integer storeable in a 16 bit signed integer, and thus the conversion failed.</p>
</div>
<p><img alt="Explosão" src="../images/ariane5.jpg" /></p>
<p>O erro gerado foi tratado como input, causando outros erros, que geraram instabilidade e que levou o sistema a se auto-destruir.</p>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">787 Dreamliner</label><div class="tabbed-content">
<p>O avião 787 dreamliner, da Boeing, tem um problema que torna necessário reiniciar o sistema elétrico a cada 248 dias, ou o mesmo pode ter uma pane.</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>The plane’s electrical generators fall into a failsafe mode if kept continuously powered on for 248 days. The 787 has four such main generator-control units that, if powered on at the same time, could fail simultaneously and cause a complete electrical shutdown.</p>
</div>
<p>Segundo as "más línguas", o problema é que acontece um <em>overflow</em> em um contador de tempo</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">248 days == 2^31 100ths of a second.<br><br>even in 2015, our airplanes have integer overflow bugs <a href="https://t.co/6Z8d4y9gjM"><a href="https://t.co/6Z8d4y9gjM">https://t.co/6Z8d4y9gjM</a></a></p>&mdash; Fiora @ 日本語でFF14 (@FioraAeterna) <a href="https://twitter.com/FioraAeterna/status/594110518203260929?ref_src=twsrc%5Etfw">May 1, 2015</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
</div>
</div>
<input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><label for="__tabbed_1_3">737 Max</label><div class="tabbed-content">
<p>O Boeing 737 Max é uma modificação do 737 original em que o motores maiores foram usados sem modificar a estrutura do restante do avião e portanto alterando o seu centro de massa. Por causa da diferença, o avião pode subir rápido demais, correndo o risco de perder sustentação. Para auxiliar os pilotos e evitar a necessidade de treinamento específico, um sensor é usado para detectar se o avião está nesta situação e forcar o nariz do avião para baixo para corrigir o problema.
Contudo, no 737 Max apenas um sensor é usado e no caso de falha do mesmo, o avião é forçado para baixo e em direção ao solo, o que levou à morte de centenas de pessoas.<sup id="fnref:737max"><a class="footnote-ref" href="#fn:737max">1</a></sup></p>
</div>
<input id="__tabbed_1_4" name="__tabbed_1" type="radio" /><label for="__tabbed_1_4">Subaru SUV</label><div class="tabbed-content">
<p>Em 2018 a Subaru fez um <em>recall</em> gigante, de mais de 1 milhão de unidades de um seus modelos de SUV, porquê uma falha em um software fez com que soldagens fossem feitas incorretamente no chassis dos veículos.
O erro era irreparável, levando a grandes prejuízos.</p>
<p><img alt="[Recall Subaru()https://spectrum.ieee.org/riskfactor/computing/it/coding-error-leads-293-subaru-ascents-to-the-car-crusher)]" src="../images/subaru.png" /></p>
<!--Car Hack -- 2017, images/carhack, https://www.wired.com/story/car-hack-shut-down-safety-features/-->
</div>
</div>
</div>
<p>Quando defeitos aparecem, é importante identificar suas causas, isto é, a cadeia de eventos que os levaram a acontecer.
Algumas empresas até publicam as <strong><em>root cause analysis</em></strong> ou a análise <em>post-mortem</em> para a comunidade como forma de compartilhar conhecimento e também por questões de transparência, mas mais importante, conhecer a causa pode ajudar a evitar que novas instâncias da mesma falha ou similares, <sup id="fnref:rca"><a class="footnote-ref" href="#fn:rca">2</a></sup> aumentando a dependabilidade do sistema.</p>
<h4 id="classes-de-defeitos">Classes de Defeitos</h4>
<p>Falhas são um fato da vida, uma constante no desenvolvimento de sistemas, mas se precisamos lidar com elas, previnindo e tolerando sua presença, precisamos entender como se manifestam e, para isso, uma classificação é essencial.</p>
<h5 id="quebra">Quebra</h5>
<p>Defeitos de <strong>quebra</strong> (<strong><em>crash</em></strong>) são defeitos em que o componente para de funcionar, irreversivelmente.
Uma vez que o componente cessa seu funcionamento, qualquer comunicação com o mesmo é interrompida e pode dar bons indicativos do defeito aos outros componentes.
Em um sistema assíncrono, contudo, não há garantias de que esta detecção do defeito será correta.</p>
<p>Alguns sistemas, denominados <strong><em>fail-stop</em></strong>, forçam-se a parar de funcionar quando percebem um defeito, imitando uma quebra, e implementando um comportamento <strong><em>fail-fast</em></strong>.<sup id="fnref:failfastfast"><a class="footnote-ref" href="#fn:failfastfast">3</a></sup>
Estes sistemas podem emitir um "canto do cisne" para permitir que outros componentes detectem o defeito.</p>
<p>Após pararem, alguns sistemas podem aplicar passos de recuperação e voltar a funcionar, no que é denominado <strong><em>fail-recover</em></strong>. Ao retornar à operação, o processo poderia assumir uma nova identidade.</p>
<h5 id="omissao">Omissão</h5>
<p>Em um <strong>defeito de omissão</strong> (<strong><em>omission failure</em></strong>), um componente não executa alguma ação. Por exemplo, uma requisição recebida por um servidor não é executada, um disco não armazena os dados no meio magnético, ou uma mensagem não é transmitida.
Este tipo de defeito é difícil de ser identificado pois outros componentes não necessariamente tem acesso direto ao resultado da operação.
Por exemplo, se o meio de comunicação se recusou a entregar uma mensagem, então houve um defeito de omissão.
Mas se a mensagem é retransmitida até que tenha sua entrega confirmada, então o defeito é mascarado.</p>
<h5 id="temporizacao">Temporização</h5>
<p>Em sistemas em que há limites de tempo para a execução de ações, uma violação destes limites é <strong>defeito de temporização</strong>.
Por exemplo, se o meio de comunicação se recusou a entregar uma mensagem, então houve uma falha de omissão.
Novamente considerando problemas de transmissão de mensagens, se o meio de comunicação se recusou a entregar uma mensagem que deveria ser entregue dentro de 3ms, então houve um defeito de omissão.
Mas se a mensagem é retransmitida até que tenha sua entrega confirmada, mas a mesma é entregue com 5ms, então o defeito é mascarado como um defeito de temporização.
Defeitos de temporização podem acontecer devido a problemas de sincronização de relógios, como no algoritmo de difusão totalmente ordenada visto <a href="time/#usos-de-relogios-sincronizados">anteriormente.</a></p>
<h5 id="arbitrarios">Arbitrários</h5>
<p>Um defeito <strong>arbitrário</strong> ou <strong>bizantino</strong> é um no qual qualquer comportamento pode acontecer. 
Por exemplo, uma mensagem pode ser modificada, um servidor pode reiniciar-se constantemente, todos os dados podem ser apagados, ou acesso pode ser dado a quem não é devido.
Estes defeitos podem ser causados por agentes mal intencionados, como hackers e vírus.</p>
<h5 id="hierarquia">Hierarquia</h5>
<p>Os tipos de defeitos apontados acima podem ser hierarquizados como a seguir, o que quer dizer que uma quebra é apenas uma omissão por tempo infinito:</p>
<p>Fail-stop <span class="arithmatex">\(\subset\)</span> Quebra <span class="arithmatex">\(\subset\)</span> Omissão <span class="arithmatex">\(\subset\)</span> Temporização <span class="arithmatex">\(\subset\)</span> Arbitrária</p>
<h5 id="defeitos-intermitentes">Defeitos intermitentes</h5>
<p>Alguns defeitos fogem à classificação acima por terem um comportamento especial, se manifestando de forma intermitente, por causa de eventos esparsos como picos de energia, ou pelo comportamento emergente da interação com outros sistemas. Para capturar estas idiossincrasias, recorremos a uma outra <a href="http://www.idc-online.com/technical_references/pdfs/information_technology/Classification_Of_Software_Bugs.pdf">classificação</a>, bem informal.</p>
<div class="admonition quote">
<p class="admonition-title">Bohrbug</p>
<p>A BohrBug is just your average, straight-forward bug. Simple like the Bohr model of the atom: A smallsphere. You push it, it moves. BohrBugs are reproducible, and hence are easily fixed once discovered. These are named after Niels Bohr, who proposed a simple and easy-to-understand atomic model in 1913. In Bohr’s model, things like the path and momentum of an electron in an atom are predictable.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Heisenbug</p>
<p>A bug that disappears or alters its behavior when one attempts to probe or isolate it. No matter how much time and effort is spent trying to reproduce the problem, the bug eludes us. Such bugs were named Heisenbugs, after Werner Heisenberg, who is known for his “uncertainty principle”. According to his theory, it is not possible to accurately or certainly determine the position and velocity of an electron in an atom at a particular moment.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Mandelbug</p>
<p>When the cause of the bug is too complex to understand, and the resulting bug appears chaotic, it is called a Mandelbug. These are named after Benoît Mandelbrot, who is considered the father of fractal geometry (fractals are complex, self-similar structures). A bug in an operating system that depends on scheduling is an example of a Mandelbug.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Schroedinbug</p>
<p>Sometimes, you look into the code, and find that it has a bug or a problem that should never have allowed it to work in the first place. When you try out the code, the bug promptly shows up, and the software fails! Though it sounds very uncommon, such bugs do occur and are known as Schroedinbugs. They are named after the scientist Erwin Schrödinger, who proposed that in quantum physics, quantum particles like atoms could exist in two or more quantum states.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Fractal Bugs</p>
<p>A bug, after which its resolution is found, reveals additional self-similar bugs elsewhere in the code, after which they are fixed, likewise appear elsewhere still.</p>
</div>
<h4 id="correlacao-entre-falhas">Correlação entre falhas</h4>
<p>Algumas falhas são ativadas por entradas e, neste caso, mesmo que se tenha várias cópias do mesmo sistema, todas falharão uma vez que a entrada problemática acontecer.
Este é um cenário em que as falhas não são independentes, mas correlatas. Para evitá-lo, podemos usar <strong><em>n-version programming</em></strong>, que consiste basicamente em ter múltiplas implementações do mesmo sistema desenvolvidas de forma independente, isto é, fazendo uso de um ou mais da seguintes opções:</p>
<ul>
<li>múltiplos times</li>
<li>múltiplos sistemas operacionais</li>
<li>múltiplas linguagens de programação.</li>
</ul>
<p>Esta técnica é interessante mais raramente usada, basicamente pelo seu alto custo.
Além disso, erros de especificação são reproduzidos e levam times diferentes a produzir erros iguais.</p>
<!--
### Degradação graciosa

Dependendo dos efeitos e tratamentos.

* Fail safe - defeito não leva a comportamento inseguro (sistema de entretenimento no avião)
* Fail soft - graceful degradation (sistema de controle de vôo)
* Fail fast - para o fluxo de defeitos (e possível reinício)
![Cadeia de supervisão](images/httpatomoreillycomsourceoreillyimages300817.jpg)

* Robusto - erros não atrapalham execução (tratamento de exceções)
* Quebradiço (*brittle*) - não resiliente a falhas
-->

<h4 id="falhas-bizantinas">Falhas Bizantinas</h4>
<details class="todo"><summary>Todo</summary><ul>
<li>exércitos bizantino</li>
</ul>
</details>
<h3 id="como-lidar-com-falhas">Como lidar com falhas?</h3>
<p>Mas se o objetivo é a dependabilidade, isto é, ter o sistema pronto para uso e apto a manter este estado durante o período de uso, mesmo na presença de catástrofes, precisamos de formas de lidar com falhas, <strong>previnindo</strong>, <strong>removendo</strong> e <strong>tolerando</strong>-as.</p>
<p>A <strong>prevenção de falhas</strong> acontece por meio de técnicas bem estabelecidas de engenharia.
No caso de sistemas de software, modularização, uso de linguagens de programação fortemente tipadas e encapsulamento são passos importantes. 
Outras técnicas envolvidas na prevenção de falhas são análise estática, especificação formal, teste e prova destas especificações.
Por exemplo, diversas empresas usam linguagens como <a href="https://lamport.azurewebsites.net/tla/tla.html">TLA<span class="arithmatex">\(^+\)</span></a><sup id="fnref:tla_real"><a class="footnote-ref" href="#fn:tla_real">4</a></sup> e <a href="https://en.wikipedia.org/wiki/Promela">Promela</a>, associados a verificadores de modelo como TLC e Spin, respectivamente, para testar e verificar a corretude de seus algoritmos.</p>
<p>Mesmo uma especificação correta pode produzir um sistema com falhas pois a tradução de especificações formais para código é um passo complexo.
Testes e manutenção do sistema permitem a <strong>remoção de falhas</strong> que passarem despercebidas pelas tentativas de prevenção.</p>
<p>Testes, contudo, apenas aumentam a confiança no sistema, não sendo capazes de certificar a ausência de problemas.
Assim, tenta-se desenvolver os sistemas de forma que, mesmo se falhas ainda estiverem presentes, seus efeitos não sejam percebidos como defeitos, isto é, sistemas que tenha <strong>tolerância a falhas</strong> (ou <strong>prevenção de defeitos</strong>).</p>
<p>Para se alcançar tolerância a falhas é necessário detectar e se recuperar de erros. 
Por exemplo, um sistema de arquivos que mantenha um <em>journal</em>, como o <a href="https://en.wikipedia.org/wiki/Ext3#Journaling_levels">Ext v3</a>, armazena informação de forma redundante e, quando <strong>detecta</strong> que os dados em sua forma principal estão corrompidos, usa o <em>journal</em> para <strong>recuperar</strong> os dados, <strong>mascarando</strong> o erro.</p>
<p>De acordo como Avizienis <em>et al.</em>, temos as seguintes técnicas para tolerar falhas:</p>
<p><img alt="Avizienis et al" src="../images/laprie_fault_tol.png" /></p>
<p>Um sistema que sofra de defeitos recorrentes é um bom candidato a previsão de defeitos, em que se estima quando uma falha ocorrerá baseado no histórico.
Por exemplo, um sistema que sofra falha por uso excessivo de memória a cada dez dias em uso, pode ser reiniciado no nono dia, em condições controladas, para evitar problemas maiores enquanto a razão do uso excessivo de memória é corrigido.</p>
<p>Se remover todas as possibilidades de defeitos de um componente é algo difícil, apostemos na tolerância a falhas.
De forma geral, tolerância a falhas é obtida por algum tipo de <strong>redundância</strong>. 
Redundância pode ser aplicada em vários níveis, por exemplo, gastando <strong>mais tempo na especificação do projeto</strong>, ou montando um laboratório de testes mais próximo do ambiente de produção.</p>
<p>Outra forma óbvia de redundância é a <strong>replicação</strong> de componentes. Por exemplo, pense no pneu estepe de um carro, no gerador de eletricidade de um hospital.
Replicação permite remover os <strong>pontos únicos de falha</strong> (SPOF, <em>Single Point of Failure</em>), ou seja, componentes não dependáveis.
Seja como for, redundância implica em mais custos, então o grau de redundância a ser utilizado depende de uma análise custo x benefício.
No caso de um sistema distribuído, quando falamos em redundância, normalmente falamos em processos redundantes, cópias ou réplicas, mesmo que não desenvolvidos usando <em>n-version programming</em>.
Assim, com múltiplas cópias, quando um processo apresenta um defeito, outro podem continuar executando o serviço.</p>
<p>Dois modos clássicos de replicação são o <strong>primário/cópia</strong> e <strong>ativo/ativo</strong>.
No caso da replicação <strong>primário/cópia</strong>, também conhecida como <strong>mestre/escravo</strong>, o primário é responsável por lidar com clientes e por informar cópias das modificações de estado.</p>
<p><img alt="ha" src="../images/ha-diagram-animated.gif" /></p>
<p>Como as atualizações de estado fluem do primário para a cópia, é possível que a cópia não tenha o estado mais atual.
Para visualizarmos melhor esta situação, vejamos a <strong>replicação em cadeia</strong>, uma generalização de primário/cópia em que os processos se organizam em um sequência para executar operações.</p>
<p><img alt="Chain replication" src="../images/chain.png" /></p>
<p><strong>Atualizações</strong> no sistema são sempre <strong>direcionadas ao primário</strong>, a cabeça da sequência. 
<strong>Leituras</strong>, se absolutamente necessitarem dos dados escritos mais recentemente, também devem ser direcionadas à <strong>cabeça</strong>. 
Caso contrário, podem ser direcionadas aos processos na <strong>cauda</strong>, diminuindo a carga de trabalho na cabeça.</p>
<p>No caso da replicação ativa, as <strong>várias cópias executam todos os comandos</strong> enviados para o sistema, estando assim todas aptas a continuar a executar o serviço. 
A técnica de <strong>replicação de máquinas de estados vista no capítulo anterior</strong> é uma materialização da replicação ativa.
Como vimos anteriormente, replicação de máquinas de estados utiliza primitivas de comunicação em grupo, mas as vistas anteriormente não são funcionais principalmente por não serem tolerantes a falhas. Vejamos a porquê é difícil desenvolver primitivas tolerantes a falhas.</p>
<h2 id="acordo">Acordo</h2>
<p>Há diversas primitivas de comunicação em grupo, das quais se destaca a <strong>difusão atômica</strong>, primitiva pela qual se pode facilmente implementar replicação de máquina de estados.
Difusão atômica, por sua vez, é equivalente ao problema do <strong>consenso distribuído</strong>, que está no coração da classe de problemas de <strong>acordo</strong>.
Problemas de acordo são aqueles em que processos devem concordar em quais ações executar.
Dependendo do modelo computacional em que o problema deve ser resolvido, soluções vão de triviais a impossíveis.
Vejamos um exemplo.</p>
<h3 id="uma-historia-de-tres-exercitos">Uma história de três exércitos</h3>
<p><strong>Era uma vez</strong> uma cidade estado no alto de uma montanha. 
A despeito de sofrer de falta de água, afinal, estava no alto de uma montanha, a cidade era invejada pelos vizinhos.
Como a cidade era muito bem fortificada, ela poderia se defender de qualquer <strong>ataque em uma única frente</strong>. 
Se atacada em <strong>duas frentes</strong>, contudo, cairia.
Sabendo disso, o rei de uma das cidades vizinhas resolveu tomar a cidade e repartiu suas forças em <strong>dois exércitos</strong> sob o comando de Alice (a sociedade era feminista) e Bastião (sim, Bastião, não Bob).<sup id="fnref:2generalsparadox"><a class="footnote-ref" href="#fn:2generalsparadox">5</a></sup></p>
<p><img alt="Paradoxo dos 2 Generais" src="../drawings/2generals.drawio-0.svg" /></p>
<p>Um complicador no ataque é que a <strong>comunicação entre os dois exércitos é feita por mensageiros</strong> que devem contornar a montanha para alcançar o outro exército. 
O trajeto é complexo e cheio de armadilhas e por isso <strong>mensageiros podem se perder</strong> e demorar um longo tempo para chegar ou até mesmo <strong>serem mortos</strong> e nunca entregarem suas mensagens.</p>
<p>Alice, a comandante mais sênior, deve decidir quando atacar e informar a Bastião, por exemplo, simplesmente ordenando "<strong>Atacar no dia 3, ao nascer do sol.</strong>"
Bastião <strong>obedecerá</strong> a ordem de atacar contanto que esteja certo de que Alice também atacará, e é justamente daí que vem a dificuldade do problema.
Se mensagens podem ser perdidas, <strong>Alice não tem garantias de que Bastião recebeu o comando</strong> e por isso não pode simplesmente considerar como certo o ataque de Bastião.
Como o problema pode ser resolvido?</p>
<p>Uma resposta natural é usar <strong>mensagens de confirmação</strong>. Isto é, quando Bastião recebe uma ordem, envia um mensageiro de volta para Alice com uma confirmação da recepção.
Alice ao receber tal mensagem, sabe que Bastião executará a ordem, correto? Mas não é tão simples assim no caso da ordem de atacar.
Lembre-se que qualquer exército que ataque sozinho, perderá, seja Alice ou Bastião. 
Por isso, ao enviar uma mensagem de confirmação do ataque, Bastião precisa estar certo de que Alice a recebeu, ou atacará sozinho.
Novamente podemos apelar para uma mensagem de confirmação ou, neste caso, uma confirmação da confirmação.
E o problema se repete indefinidamente.</p>
<div class="admonition info inline end">
<p class="admonition-title">Paradoxo dos 2 Exércitos</p>
<ul>
<li><span class="arithmatex">\(A\)</span> e <span class="arithmatex">\(B\)</span> devem concordar na hora do ataque.</li>
<li><span class="arithmatex">\(A\)</span> ataca se estiver certo que <span class="arithmatex">\(B\)</span> atacará.</li>
<li><span class="arithmatex">\(B\)</span> ataca se estiver certo que <span class="arithmatex">\(A\)</span> atacará.</li>
<li>A comunicação por troca de mensagens.</li>
<li>Mensagens podem ser arbitrariamente atrasadas.</li>
<li>Mensagens podem ser perdidas.</li>
</ul>
<p>Como um exército tem certeza que o outro irá atacar?</p>
</div>
<p>Suponhamos que <strong>há um algoritmo correto</strong> que executa uma sequência finita de troca de mensagens em que ao final tanto Alice quanto Bastião estão seguros, e corretos em sua segurança, de que o outro também atacará. Seja <span class="arithmatex">\(n\)</span> o número máximo de mensagens trocadas. 
Em uma execução em que todas as <span class="arithmatex">\(n\)</span> mensagens possíveis são usadas, suponha sem perda de generalidade que Alice enviou a <span class="arithmatex">\(n\)</span>-ésima mensagem.</p>
<p><img alt="Paradoxo dos 2 Generais" src="../drawings/2generals.drawio-1.svg" /></p>
<p>Observe que, do ponto de vista de Alice, uma execução do algoritmo em que a nenhuma mensagem é perdida, é indistinguível de uma execução em que a <span class="arithmatex">\(n\)</span>-ésima mensagem é perdida.</p>
<p><img alt="Paradoxo dos 2 Generais" src="../drawings/2generals.drawio-2.svg" /></p>
<p>Dado que ao final da primeira execução completa <strong>Alice ataca</strong>, no final da execução onde a mensagem <span class="arithmatex">\(n\)</span> é perdida, Alice também deve atacar.
Mas se o algoritmo é correto, então também <strong>Bastião ataca</strong>, mesmo sem ter recebido a enésima mensagem. Logo, a enésima mensagem é desnecessária ao algoritmo, que deve funcionar com <span class="arithmatex">\(n-1\)</span> mensagens.</p>
<p>Repetindo-se o argumento mais <span class="arithmatex">\(n-1\)</span> vezes, temos que o algoritmo deve funcionar com zero mensagens, o que é um <strong>absurdo</strong>. Logo não existem algoritmos corretos para o problema como definido, isto é, em que mensagens podem ser perdidas; é <strong>impossível</strong> resolver o problema.</p>
<div class="admonition info inline end">
<p class="admonition-title">Impossibilidades</p>
<p>Impossibilidade de resolução x resolução na prática.</p>
</div>
<p>Apesar de ser impossível resolver este problema aparentemente simples, devemos fazê-lo frequentemente no mundo real. Como reconciliar estes dois fatos?</p>
<h3 id="impossibilidade">Impossibilidade</h3>
<p>Quando dizemos que é impossível resolver um problema queremos dizer que é impossível produzir um algoritmo que <strong>sempre levará a uma resposta correta</strong>.
Isto quer dizer, ignorando-se algoritmos que sempre levarão a respostas incorretas, podemos produzir algoritmos que ou às vezes <strong>levarão a respostas incorretas</strong> ou que, mesmo que nunca levem a respostas incorretas, às vezes <strong>não levarão a respostas</strong> alguma; ambos podem ser úteis na prática.</p>
<p>Por exemplo, ainda no problema dos exércitos tentando tomar a cidade, suponha que em vez de mandar um único mensageiro com a ordem de ataque, Alice envie 100, ou 200, ou 1000.
A <strong>confiança</strong> de Alice de que Bastião também atacaria, seria muito maior e não precisaria receber uma confirmação de entrega de mensagens.
Esta abordagem faria com com que o ataque funcionasse com uma <strong>alta probabilidade</strong> <span class="arithmatex">\(P\)</span>, mas com uma pequena probabilidade <span class="arithmatex">\(P-1\)</span> de levar a um ataque fracassado, onde <span class="arithmatex">\(P\)</span> pode ser feita <strong>tão grande quanto se "queira"</strong>.</p>
<p>Resultados de impossibilidade abundam na área de computação distribuída<sup id="fnref:impossibilidades"><a class="footnote-ref" href="#fn:impossibilidades">6</a></sup> e não podem nos desencorajar de continuar a buscar soluções práticas.</p>
<h3 id="consenso">Consenso</h3>
<p>O problema que os comandantes estão tentando resolver é, essencialmente, o problema do Consenso Distribuído.
Neste problema, cada um de um conjunto de processos propõe um único valor, sua <strong>proposta</strong>. O objetivo é decidir um dentre os valores propostos, garantindo as seguintes propriedades.</p>
<ul>
<li>Validade: Somente um valor proposto pode ser decidido.</li>
<li>Acordo: Se um processo decide-se por <span class="arithmatex">\(v\)</span> e outro por <span class="arithmatex">\(w\)</span>, então <span class="arithmatex">\(v = w\)</span></li>
<li>Terminação: Todo processo não <strong>defeituoso</strong> decide-se.</li>
</ul>
<p>Um processo é defeituoso se apresentou um defeito; como estamos considerando apenas defeitos do tipo quebra, um processo é defeituoso se ele parou de funcionar.
Um processo que não é defeituoso é um processo correto.</p>
<div class="admonition info inline end">
<p class="admonition-title">Terminação</p>
<p>Na prática, algoritmos exploram oportunidades para progredir, mesmo que não garantam que vão terminar.</p>
</div>
<p>Dependendo do modelo computacional, é possível resolver este problema. Contudo, <strong>é impossível resolver deterministicamente o problema do consenso em sistema assíncrono sujeito a falhas</strong>,<sup id="fnref:flp85"><a class="footnote-ref" href="#fn:flp85">7</a></sup> e assíncrono sujeito a falhas é exatamente o que temos, a rigor, na Internet.
Mas o consenso é resolvido frequentemente em sistemas assíncronos sujeitos a falhas. Isso porque normalmente estes sistemas se comportam sincronamente.
Há diversos algoritmos de consenso que terminam quando o sistema se comporta bem, sendo os mais famosos, atualmente, <a href="https://raft.github.io/">Raft</a> e <a href="http://paxos.systems/index.html">Paxos</a></p>
<p>A grande razão para que seja impossível chegar a um acordo entre processos neste modelo é a impossibilidade de diferenciar processos defeituosos de processos corretos, mas lentos. Em termos do paradoxo dos 2 generais, a resposta do comandante não chegou porquê ele morreu ou porquê ele está demorando para responder?
Os detectores de defeito abstraem este problema.</p>
<h3 id="detectores-de-defeitos-nao-confiaveis">Detectores de Defeitos não Confiáveis</h3>
<p>Chandra e Toueg<sup id="fnref:CT96"><a class="footnote-ref" href="#fn:CT96">8</a></sup> introduziram o conceito de <strong>Detectores de Defeitos</strong> como forma de encapsular a percepção do estado funcional dos outros processos.
Assim, um detector de defeitos pode ser visto como <strong>oráculo distribuído</strong>, com módulos acoplados aos processos do sistema e que trabalha monitorando os outros processos.</p>
<p><img alt="Failure Detector" src="../drawings/failure_detector.drawio-0.svg" /></p>
<p>Chandra e Toueg classificaram os detectores de defeitos segundo suas características de completude (<em>completeness</em>) e acurácia (<em>accuracy</em>), ou seja, a capacidade de suspeitar de um processo defeituoso e a capacidade de não suspeitar de um processo correto, respectivamente. 
Embora não seja obrigatório, detectores de falhas são normalmente implementados por meio de trocas de mensagens de <em>heartbeat</em>.
Mensagens são esperadas em momentos específicos para sugerir que o remetente continua funcional.</p>
<p><img alt="Failure Detector" src="../drawings/failure_detector.drawio-1.svg" /></p>
<p>Quando os <em>heartbeats</em> não chegam até o limite de tempo, o processo remetente passa a ser considerado <strong>suspeito</strong> de falha.</p>
<p><img alt="Failure Detector" src="../drawings/failure_detector.drawio-2.svg" /></p>
<p><em>Heartbeats</em>  que chegam depois podem corrigir erros, mas também podem levar a atrasos na detecção de defeitos.</p>
<p><img alt="Failure Detector" src="../drawings/failure_detector.drawio-3.svg" /></p>
<p>Para capturar estas combinações de eventos, foram definidos os seguintes níveis de </p>
<p>Os níveis destas propriedades são os seguintes:</p>
<ul>
<li>Completude Forte - A partir de algum instante futuro, todo processo defeituoso é suspeito permanentemente por todos os processos corretos.</li>
<li>Completude Fraca - A partir de algum instante futuro, todo processo defeituoso é suspeito permanentemente por algum processo correto.</li>
<li>Precisão Forte - Todos os processos são suspeitos somente após terem apresentado defeito.</li>
<li>Precisão Fraca - Algum processo correto nunca é suspeito de ter apresentado defeito.</li>
<li>Precisão Eventual Forte - A partir de algum instante futuro, todos os processos são suspeitos somente após apresentarem defeito.</li>
<li>Precisão Eventual Fraca - A partir de algum instante futuro, algum processo ativo nunca é suspeito antes de ter apresentado defeito.</li>
</ul>
<p>Um detector ideal seria um com Completude Forte e Precisão Forte, pois detectaria somente processos defeituosos e todos os processos defeituosos.
Este detector é conhecido como <span class="arithmatex">\(P\)</span> ou <em>Perfect</em>.
Infelizmente os detectores perfeitos só podem ser implementados em sistemas síncronos, onde se pode confiar que a falta de uma mensagem implica em que a mensagem não será entregue por quê o remetente deve ser defeituosos.
Assim, é preciso se focar em detectores não perfeitos ou <strong>não confiáveis</strong>.</p>
<p>Em ambientes <strong>parcialmente síncronos</strong>, ou seja, assíncronos aumentados com algum tipo de sincronia, já é possível implementar detectores não confiáveis.
Por exemplo, se os processos dispõem de <strong>temporizadores</strong> precisos, um detector pode contar a passagem do tempo nos intervalos de comunicação com outros processos e, considerando um <strong>limite de tempo</strong> para estes intervalos, tentar determinar se tais processos encontram-se defeituosos ou não. 
Esta determinação é por certo imprecisa e os detectores podem voltar atrás em suas suspeitas tão logo percebam um erro. 
Entretanto, a despeito desta incerteza, a informação provida por estes detectores já pode ser suficiente para que se alcance o consenso se combinada a uma restrição de que <strong>uma maioria dos processos não seja defeituosa</strong>.</p>
<details class="todo"><summary>Maioria</summary><p>Adicionar prova.</p>
</details>
<p>Chandra, Hadzilacos e Toueg  demonstram que o detector mais fraco com o qual se pode resolver consenso tem as propriedades de Completude Fraca e Acurácia Eventual Fraca.<sup id="fnref:CHT96"><a class="footnote-ref" href="#fn:CHT96">9</a></sup> 
Este detector, conhecido como <span class="arithmatex">\(\Diamond W\)</span>, ou <em>Eventual Weak</em>, e é implementável em sistemas nos quais há um <strong>limite superior</strong> de tempo para a transmissão de mensagens, <strong>mesmo que este limite seja desconhecido</strong>.
Vários protocolos de consenso utilizam o detector equivalente, <span class="arithmatex">\(\Diamond S\)</span>, equivalente ao <span class="arithmatex">\(\Diamond W\)</span> mas com completude forte, ou o eleitor de líderes <span class="arithmatex">\(\Omega\)</span>, que usa a informação do <span class="arithmatex">\(\Diamond S\)</span> para sugerir um líder entre os processos.
Estes protocolos são escritos de forma que se o limite superior não existe, o protocolo não termina e um <strong>resultado errado nunca é alcançado</strong>, ou seja, os protocolos sempre garantem que as propriedades de corretude não são violadas, mesmo que não garanta que a terminação será alcançada.</p>
<details class="todo"><summary>Figura</summary><p>figura 2.2 da dissertação.</p>
</details>
<h3 id="paxos-algoritmo-do-sinodo">Paxos: Algoritmo do Sínodo</h3>
<details class="todo"><summary>Algoritmo</summary><p>Descrever. Por enquanto, vejam esta explicação ou [<a href="https://www.cs.rutgers.edu/~pxk/417/notes/paxos.html">https://www.cs.rutgers.edu/~pxk/417/notes/paxos.html</a>] ou este vídeo [<a href="https://www.youtube.com/watch?v=JEpsBg0AO6o">https://www.youtube.com/watch?v=JEpsBg0AO6o</a>] ou este video [<a href="https://www.youtube.com/watch?v=s8JqcZtvnsM">https://www.youtube.com/watch?v=s8JqcZtvnsM</a>].</p>
</details>
<h3 id="difusao-totalmente-ordenada">Difusão Totalmente Ordenada</h3>
<p>Se pudermos resolver o consenso, podemos então resolver o problema da <strong>difusão totalmente ordenada</strong> (<em>total order multicast</em>) e com ela implementar a replicação de máquinas de estados.
Relembrando, na  temos que:</p>
<ul>
<li>Difusão: mensagens são enviadas de 1 para n (comunicação em grupo)</li>
<li>Totalmente Ordenada: todos os processos entregam as mensagens na mesma ordem.</li>
</ul>
<p><img alt="Total order multicast" src="../drawings/group_com.drawio-1.svg" /></p>
<p>Para fazermos isso, precisamos primeiro formalizar as primitivas em vários níveis da resolução do problema.
No nível do canal de comunicação, da rede, processos <strong>enviam</strong> e <strong>recebem</strong> mensagens.
No nível do consenso, processos fazem <strong>propostas</strong> e <strong>aprendem</strong> um valor decidido. Para chegar a uma única decisão, várias mensagens podem ser enviadas e recebidas.
No nível da difusão atômica, mensagens são <strong>difundidas</strong> e <strong>entregues</strong>. Se implementado sobre o consenso, para uma difusão ser bem sucedida, uma instância de consenso é necessária.</p>
<div class="admonition note">
<p class="admonition-title">Primitivas de comunicação</p>
<ul>
<li>enviar &amp; receber (<em>send &amp; receive</em>) - rede</li>
<li>propor &amp; decidir (<em>propose &amp; decide</em>) - consenso</li>
<li>difundir &amp; entregar (<em>broadcast &amp; deliver</em>) - difusão</li>
</ul>
</div>
<p><img alt="Total order multicast" src="../drawings/abcast2.drawio-0.svg" /></p>
<p>Dado infinitas instâncias de consenso, pode-se usá-las para resolver difusão atômica usando o seguinte procedimento:</p>
<ul>
<li>Ordene as instâncias de consenso.</li>
<li>Para difundir mensagem <span class="arithmatex">\(m\)</span>, proponha a mensagem na menor instância <span class="arithmatex">\(i\)</span> em que não tiver visto uma decisão.</li>
<li>Se a decisão de <span class="arithmatex">\(i\)</span> não é <span class="arithmatex">\(m\)</span>, volte para o passo anterior.</li>
<li>Entregue as decisões na ordem das instâncias.</li>
</ul>
<p>No exemplo a seguir, duas mensagens, <span class="arithmatex">\(m\)</span> e <span class="arithmatex">\(m'\)</span> foram <strong>difundidas</strong> pelas aplicações App1 e App2, respectivamente, por meio do módulo de difusão atômica junto a cada aplicação.
O módulo de difusão determina qual a menor instância de consenso ainda não decidida, azul, em que propõem as mensagens.
Ao final da instância de conseno, <span class="arithmatex">\(m\)</span> é decidida e é entregue pelos módulos de difusão.
O módulo ABCast2 insiste na difusão de <span class="arithmatex">\(m'\)</span>, propondo-a na próxima instância, vermelha, que decide <span class="arithmatex">\(m'\)</span> e leva esta mensagem a ser entregue.</p>
<div class="mermaid">sequenceDiagram
    participant App1
    participant ABCast1
    participant Consenso
    participant ABCast2
    participant App2


    App1 --&gt;&gt;+ ABCast1: difundir m
      App2 --&gt;&gt;+ ABCast2: difundir m'

rect rgb(100,255,255)
    ABCast1 -&gt;&gt;+ Consenso: propor m na inst 1
    ABCast2 -&gt;&gt;+ Consenso: propor m' na inst 1


    Consenso -&gt;&gt;- ABCast1: decidir m
    Consenso -&gt;&gt;- ABCast2: decidir m
end
    ABCast1 --&gt;&gt;- App1: entregar m
      ABCast2 --&gt;&gt; App2: entregar m

rect rgba(255,0,0,.5)
    ABCast2 -&gt;&gt;+ Consenso: propor m' na inst 2

    Consenso -&gt;&gt; ABCast1: decidir m'
    Consenso -&gt;&gt;- ABCast2: decidir m'
end
    ABCast1 --&gt;&gt; App1: entregar m'
      ABCast2 --&gt;&gt;- App2: entregar m'
</div>
<p>Ambas as aplicações, embora tivessem intenções diferentes sobre qual deveria ser a próxima mensagem entregue, entregam-nas na mesma ordem, isto é, primeiro <span class="arithmatex">\(m\)</span> e depois <span class="arithmatex">\(m'\)</span>.
Se forem usadas como entrada para algum processamento, na ordem em que foram entregues, as aplicações chegarão ao mesmo estado, em algum momento.</p>
<h4 id="estudo-de-caso-raft">Estudo de Caso: Raft</h4>
<p>Raft é um protocolo de difusão atômica associado a um protocolo de eleição de líderes.
Líderes são eleitos para mandatos pelo voto de uma maioria de processos, o que garante que nunca existirão dois líderes para um mesmo mandato.
Um mandato se estende enquanto o líder mantiver seus seguidores cientes de sua presença, o que faz pelo envio periódico de <em>heartbeats</em>.
Atrasos na comunicação ou a falha do líder atual levam a uma suspeita de que o líder falhou, levando a nova eleição e novo mandado.
A comunicação necessária para implementar a difusão atômica acontece em <em>piggyback</em> nos <em>heartbeats</em>.</p>
<p>No tutorial <a href="http://thesecretlivesofdata.com/raft/">The Secret lives of data</a>, podemos ver com mais detalhes como o protocolo funciona.
O tutorial, entretando, foge da nomenclatura padrão da área usando <em>log-replication</em> no lugar de difusão atômica (ou totalmente ordenada).</p>
<h4 id="estudo-de-caso-paxos">Estudo de Caso: Paxos</h4>
<details class="todo"><summary>Paxos</summary><ul>
<li>Sínodo (Synod): consenso</li>
<li>Paxos: Difusão Atômica</li>
</ul>
</details>
<h3 id="outras-ordenacoes">Outras Ordenações</h3>
<p>Como colocado diversas vezes, se todos os processos executam a mesma sequência de comandos determinísticos, todos avançam pelos mesmos estados, implementando a técnica da replicação de máquinas de estados.
Se usada em um sistema de arquivos, por exemplo, a seguinte sequência de comandos levará sempre ao estado final em que há um arquivo <code>/tmp/file2</code> e uma pasta denominada <code>/dir1</code>.</p>
<ul>
<li><code>touch /tmp/file1</code></li>
<li><code>echo "teste testando" &gt;&gt; /tmp/file2</code></li>
<li><code>rm /tmp/file1</code></li>
<li><code>mkdir /dir1</code></li>
</ul>
<p>Há outras ordens dos mesmos comandos que levariam ao mesmo efeito, como a seguinte. Alguns protocolos de replicação de máquinas de estados permitem que reordenações ocorram, desde que não afetem o resultado final dos comandos. 
Contudo, estes protocolos são mais complexos de se implementar e por isso raramente usados.</p>
<ul>
<li><code>echo "teste testando" &gt;&gt; /tmp/file2</code></li>
<li><code>mkdir /dir1</code></li>
<li><code>touch /tmp/file1</code></li>
<li><code>rm /tmp/file1</code></li>
</ul>
<h3 id="arcaboucos-para-coordenacao">Arcabouços para coordenação</h3>
<p>Há muitas formas de se usar algoritmos de acordo em uma aplicação, embora se recomente que seu escopo seja minimizado a um núcleo onde a consistência forte é absolutamente necessária e que este núcleo seja usado para suportar outras partes do sistema<sup id="fnref:cons_core"><a class="footnote-ref" href="#fn:cons_core">11</a></sup>.
Seja implementando a replicação de máquinas de estados, seja implementando um core, ou qualquer outra abstração sobre algoritmos de acordo ou comunicação em grupo, você tem a opção de implementar o protocolo zero, uma tarefa ingrata<sup id="fnref:paxosmade"><a class="footnote-ref" href="#fn:paxosmade">10</a></sup>. Felizmente, também tem a opção de usar arcabouços prontos tanto para para comunicação em grupo quanto para diversos outros problemas de coordenação comuns em sistemas distribuídos.</p>
<h4 id="estudo-de-caso-copycat">Estudo de caso: Copycat</h4>
<p><a href="http://atomix.io/copycat/">Copycat</a> é um arcabouço de replicação de máquinas de estados implementada pela <a href="http://atomix.io/">Atomix</a>.
Na base do Copycat está uma implementação do Raft.
Sobre o Raft, uma API simples mas moderna permite a criação de máquinas de estados usando <strong>lambdas</strong>, <strong>futures</strong>, e o estilo <strong>fluent</strong> de encadeamento de invocações.</p>
<div class="admonition note">
<div class="tabbed-set" data-tabs="2:3"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">Lambda</label><div class="tabbed-content">
<ul>
<li>Classe com um único método.</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">Tarefa</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bem vindo a um loop infinito&quot;</span><span class="p">);</span>
    <span class="p">}</span>   
<span class="p">}</span>

<span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Tarefa</span><span class="p">()).</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Classe anônima - uso único</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">new</span> <span class="n">Thread</span><span class="p">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bem vindo a um loop infinito&quot;</span><span class="p">);</span>
  <span class="p">}</span>   
<span class="p">}).</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Lambda</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span>
                <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
                  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bem vindo a um loop infinito&quot;</span><span class="p">);</span>
              <span class="p">}).</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><label for="__tabbed_2_2">Fluent</label><div class="tabbed-content">
<ul>
<li>Encadeamento</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Pessoa</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="p">...;</span>
    <span class="n">c</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
      <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="p">.</span><span class="na">idade</span> <span class="o">&gt;</span> <span class="mi">33</span><span class="p">)</span>
      <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Pessoa</span><span class="p">::</span><span class="n">sobrenomeNome</span><span class="p">)</span><span class="c1">//.map(p -&gt; p.sobrenomeNome())</span>
      <span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><label for="__tabbed_2_3">Future</label><div class="tabbed-content">
<ul>
<li>Promessa de computação e resultado.</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="p">.</span><span class="na">newSingleThreadExecutor</span><span class="p">();</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">futFib</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Fibonacci</span><span class="p">(</span><span class="mi">217</span><span class="p">)};</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Quando será executado?  Em algum momento.    </li>
<li>Como pegar o resultado? </li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">futFib</span><span class="p">.</span><span class="na">isDone</span><span class="p">())</span>
  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;tah calculando...&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">fib217</span> <span class="o">=</span> <span class="n">futFib</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Em qual thread?  Em algum thread. Depende do Executor Service usado.  </li>
</ul>
</div>
</div>
</div>
<p>Há várias versões do Copycat disponíveis, com vantagens e desvantagens.</p>
<div class="admonition note">
<p class="admonition-title">Versões</p>
<div class="tabbed-set" data-tabs="3:3"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><label for="__tabbed_3_1">Versão 1.1.4</label><div class="tabbed-content">
<ul>
<li>Baseado em <a href="http://atomix.io/copycat/docs/getting-started/">http://atomix.io/copycat/docs/getting-started/</a> e <a href="https://www.baeldung.com/atomix">https://www.baeldung.com/atomix</a></li>
<li>Código funcional em <a href="https://github.com/pluxos/atomix_labs">https://github.com/pluxos/atomix_labs</a></li>
<li>Documentação oficial removida</li>
</ul>
</div>
<input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><label for="__tabbed_3_2">Versão &gt;= 2</label><div class="tabbed-content">
<ul>
<li>Melhor desempenho</li>
<li>Documentação ruim ou inexistente</li>
<li><a href="https://github.com/atomix/atomix">https://github.com/atomix/atomix</a></li>
</ul>
</div>
<input id="__tabbed_3_3" name="__tabbed_3" type="radio" /><label for="__tabbed_3_3">Versão 3</label><div class="tabbed-content">
<ul>
<li>em Go</li>
<li>evolução rápida</li>
<li>o código é a documentação</li>
</ul>
</div>
</div>
</div>
<p>Aqui usaremos a versão 1.1.4, que apesar de antiga, é a melhor documentada atualmente, pelo tutorial referenciado acima.</p>
<ul>
<li>Clone e compile o projeto<ul>
<li>Instale dependências:</li>
<li>git</li>
<li>maven </li>
<li>JDK &gt;= 1.8</li>
<li><code>git clone https://github.com/pluxos/atomix_labs</code></li>
<li><code>cd atomix_labs</code></li>
<li><code>cd replication</code></li>
<li><code>mvn compile</code></li>
<li><code>mvn test</code></li>
</ul>
</li>
</ul>
<p>Você deve ver uma saída semelhante à seguinte, o que quer dizer que seu código está compilando perfeitamente.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Tests run: <span class="m">1</span>, Failures: <span class="m">0</span>, Errors: <span class="m">0</span>, Skipped: <span class="m">0</span>

<span class="o">[</span>INFO<span class="o">]</span> ---------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> BUILD SUCCESS
<span class="o">[</span>INFO<span class="o">]</span> ---------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> Total time: <span class="m">6</span>.898 s
<span class="o">[</span>INFO<span class="o">]</span> Finished at: <span class="m">2017</span>-10-25T08:38:08-02:00
<span class="o">[</span>INFO<span class="o">]</span> Final Memory: 15M/159M
<span class="o">[</span>INFO<span class="o">]</span> ---------------------------------------
</code></pre></div>
</td></tr></table>
<p>Antes de começar a escrever suas prórpia máquinas de estado, familiarize-se com a estrutura do projeto em <a href="https://github.com/pluxos/atomix_labs/tree/master/replication/src/main/java/atomix_lab/state_machine">https://github.com/pluxos/atomix_labs/tree/master/replication/src/main/java/atomix_lab/state_machine</a></p>
<p>Observe que há três pastas: </p>
<ul>
<li><code>type</code> - tipos dos dados mantidos pela replica (Edge e Vertex)<br />
   Os tipos são serializable para que o Java saiba como transformá-los em bytes.</li>
<li><code>command</code> - estruturas que contêm informações para modificar os tipos<br />
    Os comandos serão enviadas do cliente para o cluster e são naturalmente serializable.</li>
<li><code>client</code> - cria comandos e os envia para serem executados no cluster<br />
    Respostas podem ser esperadas síncrona ou assincronamente.</li>
<li><code>server</code> - recebe os comandos na ordem definida pelo Raft e os executa</li>
</ul>
<p>O projeto foi construído seguindo as instruções no tutorial mencionado antes, saltando-se a parte dos snapshots, isto é:</p>
<ul>
<li>crie um projeto maven<br />
    eclipse tem template para isso</li>
<li>adicione dependências no <code>pom.xml</code><br />
    como so criei um projeto, coloquei as dependências tanto do cliente quando do servidor</li>
<li>defina <code>Command</code> que modifiquem o estado das réplicas</li>
<li>defina <code>Queries</code> que consultem o estado das réplicas</li>
<li>implemente a réplica para lidar com os comandos</li>
<li>implemente o cliente para emitir comandos</li>
</ul>
<p>Para executar um servidor, você precisa passar diversos parâmetros</p>
<ul>
<li>identificador do processo (inteiro)</li>
<li>IP do processo com identificador 0</li>
<li>porta do processo com identificar 0</li>
<li>IP do processo com identificador 1</li>
<li>porta do processo com identificar 1</li>
<li>...</li>
</ul>
<p>Sabendo seu identificador, o servidor sabe em qual porta escutar e em quais IP/porta se conectar para se comunicar com os outros servidores.</p>
<p>Para testar o projeto, execute três servidores, em três terminais distintos. 
Usando o maven, da linha de comando, basta executar os seguintes comandos[^\]:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.server.GraphStateMachine&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;0 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>

mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.server.GraphStateMachine&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;1 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>

mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.server.GraphStateMachine&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;2 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>
</code></pre></div>
</td></tr></table>
<p>O cliente não precisa de um identificador, apenas dos pares IP/porta dos servidores.
Por exemplo, use o comando:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.client.GraphClient&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>
</code></pre></div>
</td></tr></table>
<div class="admonition exercise">
<p class="admonition-title">Exercício</p>
<p>Uma vez executado o projeto, modifique-o para incluir uma nova operação (<code>Command</code>) e nova consulta (<code>Query</code>), de sua escolha.</p>
</div>
<h4 id="estudo-de-caso-ratis">Estudo de caso: Ratis</h4>
<p><a href="http://ratis.apache.org/">Ratis</a> é um arcabouço de coordenação recentemente emancipado como um projeto no <a href="https://apache.org">Apache</a>.
Embora mal documentado, o projeto tem alguns exemplos que demonstram como usar abstrações já implementadas. 
A seguir veremos um passo-a-passo, baseado nestes exemplos, de como usar o Ratis para implementar uma máquina de estados replicada.</p>
<p>Crie um novo projeto Maven com o nome <code>ChaveValor</code> (eu estou usando IntelliJ, mas as instruções devem ser semelhantes para Eclipse).</p>
<p><img alt="Novo Projeto Maven" src="../images/newmaven.png" /></p>
<p>Abra o arquivo <code>pom.xml</code> do seu projeto e adicione o seguinte trecho, com as dependências do projeto, incluindo o próprio Ratis.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">&lt;dependencies&gt;</span>
    <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.ratis/ratis-server --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.ratis<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>ratis-server<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.0.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

    <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.ratis/ratis-netty --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.ratis<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>ratis-netty<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.0.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.ratis<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>ratis-grpc<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.0.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.beust<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jcommander<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.78<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>slf4j-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.7.25<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-slf4j-impl --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-slf4j-impl<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.14.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.14.1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.14.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div>
</td></tr></table>
<p>Adicione também o plugin Maven e o plugin para gerar um <code>.jar</code> com todas as dependências. Observe que estou usando Java 14, mas você pode mudar para a sua versão.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
        <span class="nt">&lt;plugin&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${maven.compiler.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
                <span class="nt">&lt;source&gt;</span>14<span class="nt">&lt;/source&gt;</span>
                <span class="nt">&lt;target&gt;</span>14<span class="nt">&lt;/target&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;plugin&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>maven-assembly-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;executions&gt;</span>
                <span class="nt">&lt;execution&gt;</span>
                    <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
                    <span class="nt">&lt;goals&gt;</span>
                        <span class="nt">&lt;goal&gt;</span>single<span class="nt">&lt;/goal&gt;</span>
                    <span class="nt">&lt;/goals&gt;</span>
                <span class="nt">&lt;/execution&gt;</span>
            <span class="nt">&lt;/executions&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
                <span class="nt">&lt;descriptorRefs&gt;</span>
                    <span class="nt">&lt;descriptorRef&gt;</span>jar-with-dependencies<span class="nt">&lt;/descriptorRef&gt;</span>
                <span class="nt">&lt;/descriptorRefs&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</code></pre></div>
</td></tr></table>
<p>Crie uma nova classe denominada <code>Cliente</code> no arquivo <code>Cliente.java</code>.
Nesta classe, iremos criar um objeto <code>RaftClient</code> que será usado para enviar operações para os servidores. 
Esta classe é importada juntamente com outras várias dependências, adicionadas no <code>pom.xml</code>, que devemos instanciar antes do <code>RaftClient</code>.</p>
<p>Neste exemplo eu coloco praticamente todos os parâmetros de configuração do Ratis <em>hardcoded</em> para simplificar o código.
Obviamente que voce deveria ser estes parâmetros como argumentos para o programa ou de um arquivo de configuração.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.apache.ratis.client.RaftClient</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.conf.Parameters</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.conf.RaftProperties</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.grpc.GrpcFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.protocol.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.thirdparty.com.google.protobuf.ByteString</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cliente</span>
<span class="p">{</span>
</code></pre></div>
</td></tr></table>
<p>O campo <code>raftGroupId</code> identifica um cluster Ratis; isso quer dizer que um mesmo processo pode participar de vários <em>clusters</em>, mas aqui nos focaremos em apenas um. O valor do campo deve ter exatamente caracteres, o que soma 32 bytes em java, e será interpretado como um <a href="https://pt.wikipedia.org/wiki/Identificador_%C3%BAnico_universal">UUID</a>.</p>
<p><code>id2addr</code> é um mapa do identificador de cada processo no cluster para seu endereço IP + Porta.
Aqui usei várias portas distintas porquê todos os processos estão rodando na mesma máquina, mas se estivesse executando em máquinas distintas, com IP distintos, poderia usar a mesma porta em todos.</p>
<p><code>addresses</code> é uma lista de <code>RaftPeer</code> construída a parti de <code>id2addr</code>.</p>
<p>O campo <code>raftGroup</code> é uma referência a todos os servidores, associados ao identificador do grupo, <code>raftGroupId</code>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="p">{</span>
        <span class="n">String</span> <span class="n">raftGroupId</span> <span class="o">=</span> <span class="s">&quot;raft_group____um&quot;</span><span class="p">;</span> <span class="c1">// 16 caracteres.</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">InetSocketAddress</span><span class="o">&gt;</span> <span class="n">id2addr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p1&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p2&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">3500</span><span class="p">));</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p3&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">));</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">RaftPeer</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">id2addr</span><span class="p">.</span><span class="na">entrySet</span><span class="p">()</span>
                <span class="p">.</span><span class="na">stream</span><span class="p">()</span>
                <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">RaftPeer</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setId</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getKey</span><span class="p">()).</span><span class="na">setAddress</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getValue</span><span class="p">()).</span><span class="na">build</span><span class="p">())</span>
                <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>

        <span class="kd">final</span> <span class="n">RaftGroup</span> <span class="n">raftGroup</span> <span class="o">=</span> <span class="n">RaftGroup</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">RaftGroupId</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">ByteString</span><span class="p">.</span><span class="na">copyFromUtf8</span><span class="p">(</span><span class="n">raftGroupId</span><span class="p">)),</span> <span class="n">addresses</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>Uma vez criado o grupo, criamos o cliente usando a fábrica retornada por <code>RaftClient.newBuilder()</code>.
A fábrica deve ser configurada com os dados do grupo e o tipo de transporte, neste caso gRPC.
Também é necessário o identificador do processo que está se conectando ao grupo; neste caso, usamos um identificador aleatório qualquer, diferente do que faremos com os servidores.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="n">RaftProperties</span> <span class="n">raftProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RaftProperties</span><span class="p">();</span>

        <span class="n">RaftClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">RaftClient</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
                                      <span class="p">.</span><span class="na">setProperties</span><span class="p">(</span><span class="n">raftProperties</span><span class="p">)</span>
                                      <span class="p">.</span><span class="na">setRaftGroup</span><span class="p">(</span><span class="n">raftGroup</span><span class="p">)</span>
                                      <span class="p">.</span><span class="na">setClientRpc</span><span class="p">(</span><span class="k">new</span> <span class="n">GrpcFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">Parameters</span><span class="p">())</span>
                                      <span class="p">.</span><span class="na">newRaftClientRpc</span><span class="p">(</span><span class="n">ClientId</span><span class="p">.</span><span class="na">randomId</span><span class="p">(),</span> <span class="n">raftProperties</span><span class="p">))</span>
                                      <span class="p">.</span><span class="na">build</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>Uma vez criado o cliente, podemos fazer invocações de operações nos servidores. Cada operação será invocada em todos os servidores, na mesma ordem.
Este protótipo suporta duas operações, <code>add</code> e <code>get</code>, incluindo algumas variações, que ignoraremos por enquanto.
A operação <code>add</code> é codificada como uma <code>String</code>, <code>add:k:v</code>, onde <code>k</code> e <code>v</code> são do tipo <code>String</code>. <code>add:k:v</code> adiciona uma entrada em um mapa implementado pelo nosso servidor com chave <code>k</code> e valor <code>v</code>.
Já a operação <code>get:k</code> recupera o valor <code>v</code> associado à chave <code>k</code>, se presente no mapa.</p>
<p>O método <code>RaftClient.io().send</code> é usado para enviar modificações para as réplicas e deve, necessariamente, passar pelo protocolo Raft.
Já o método <code>RaftClient.io().sendReadOnly</code> é usado para enviar consultas a qualquer das réplicas.
Ambos os métodos codificam o comando sendo enviado (<code>add:k:v</code> ou <code>get:k</code>) no formato interno do Ratis para as réplicas e retorna um objeto <code>RaftClientReply</code>, que pode ser usado para pegar a resposta da operação. 
O código é auto explicativo.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="n">RaftClientReply</span> <span class="n">getValue</span><span class="p">;</span>
        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">RaftClientReply</span><span class="o">&gt;</span> <span class="n">compGetValue</span><span class="p">;</span>
        <span class="n">String</span> <span class="n">response</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">){</span>
            <span class="k">case</span> <span class="s">&quot;add&quot;</span><span class="p">:</span>
                <span class="n">getValue</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">io</span><span class="p">().</span><span class="na">send</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="s">&quot;add:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">));</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getContent</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">());</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Resposta:&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s">&quot;get&quot;</span><span class="p">:</span>
                <span class="n">getValue</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">io</span><span class="p">().</span><span class="na">sendReadOnly</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="s">&quot;get:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">));</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getContent</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">());</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Resposta:&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s">&quot;add_async&quot;</span><span class="p">:</span>
                <span class="n">compGetValue</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">async</span><span class="p">().</span><span class="na">send</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="s">&quot;add:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">));</span>
                <span class="n">getValue</span> <span class="o">=</span> <span class="n">compGetValue</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getContent</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">());</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Resposta: &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s">&quot;get_stale&quot;</span><span class="p">:</span>
                <span class="n">getValue</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">io</span><span class="p">().</span><span class="na">sendStaleRead</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="s">&quot;get:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RaftPeerId</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">));</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getContent</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">());</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Resposta: &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;comando inválido&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">client</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Um vez criado o cliente, crie a classe <code>Servidor</code>, no arquivo <code>Servidor.java</code>; a parte inicial do código é semelhante à do cliente.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.apache.ratis.conf.RaftProperties</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.grpc.GrpcConfigKeys</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.protocol.RaftGroup</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.protocol.RaftGroupId</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.protocol.RaftPeer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.protocol.RaftPeerId</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.server.RaftServer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.server.RaftServerConfigKeys</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.thirdparty.com.google.protobuf.ByteString</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.util.LifeCycle</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Servidor</span>
<span class="p">{</span>

    <span class="c1">//Parametros: myId</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">InterruptedException</span>
    <span class="p">{</span>
        <span class="n">String</span> <span class="n">raftGroupId</span> <span class="o">=</span> <span class="s">&quot;raft_group____um&quot;</span><span class="p">;</span> <span class="c1">// 16 caracteres.</span>

        <span class="c1">//Setup for node all nodes.</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">InetSocketAddress</span><span class="o">&gt;</span> <span class="n">id2addr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p1&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p2&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">3500</span><span class="p">));</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p3&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">));</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">RaftPeer</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">id2addr</span><span class="p">.</span><span class="na">entrySet</span><span class="p">()</span>
                                          <span class="p">.</span><span class="na">stream</span><span class="p">()</span>
                                          <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">RaftPeer</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setId</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getKey</span><span class="p">()).</span><span class="na">setAddress</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getValue</span><span class="p">()).</span><span class="na">build</span><span class="p">())</span>
                                          <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
</code></pre></div>
</td></tr></table>
<p>A primeira diferença vem na necessidade de identificar o servidor dentro do conjunto de servidores, o que é feito com um <code>RaftPeerId</code>.
Como cada servidor deve usar um identificador único, do conjunto pré-determinado em <code>id2addr</code>, o identificador é passado como argumento para o programa, obrigatoriamente.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="c1">//Setup for this node.</span>
        <span class="n">RaftPeerId</span> <span class="n">myId</span> <span class="o">=</span> <span class="n">RaftPeerId</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">addresses</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">noneMatch</span><span class="p">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">myId</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Identificador &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot; é inválido.&quot;</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Encare a seção seguinte como uma receita, mas observe que o método <code>RaftServerConfigKeys.setStorageDir</code> recebe o nome de uma pasta como argumento, que será usada para armazenar o estado da máquina de estados.
Se você executar o servidor múltiplas vezes, a cada nova execução o estado anterior do sistema será recuperado desta pasta.
Para <strong>limpar</strong> o estado, apague as pastas de cada servidor.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="n">RaftProperties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RaftProperties</span><span class="p">();</span>
        <span class="n">properties</span><span class="p">.</span><span class="na">setInt</span><span class="p">(</span><span class="n">GrpcConfigKeys</span><span class="p">.</span><span class="na">OutputStream</span><span class="p">.</span><span class="na">RETRY_TIMES_KEY</span><span class="p">,</span> <span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">);</span>
        <span class="n">GrpcConfigKeys</span><span class="p">.</span><span class="na">Server</span><span class="p">.</span><span class="na">setPort</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
        <span class="n">RaftServerConfigKeys</span><span class="p">.</span><span class="na">setStorageDir</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">Collections</span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="s">&quot;/tmp/&quot;</span> <span class="o">+</span> <span class="n">myId</span><span class="p">)));</span>
</code></pre></div>
</td></tr></table>
<p>A máquina de estados em si é especificada no próximo excerto, em <code>setStateMachine</code>, que veremos a seguir.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="c1">//Join the group of processes.</span>
        <span class="kd">final</span> <span class="n">RaftGroup</span> <span class="n">raftGroup</span> <span class="o">=</span> <span class="n">RaftGroup</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">RaftGroupId</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">ByteString</span><span class="p">.</span><span class="na">copyFromUtf8</span><span class="p">(</span><span class="n">raftGroupId</span><span class="p">)),</span> <span class="n">id2addr</span><span class="p">);</span>
        <span class="n">RaftServer</span> <span class="n">raftServer</span> <span class="o">=</span> <span class="n">RaftServer</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
                <span class="p">.</span><span class="na">setServerId</span><span class="p">(</span><span class="n">myId</span><span class="p">)</span>
                <span class="p">.</span><span class="na">setStateMachine</span><span class="p">(</span><span class="k">new</span> <span class="n">MaquinaDeEstados</span><span class="p">())</span>
                <span class="p">.</span><span class="na">setProperties</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
                <span class="p">.</span><span class="na">setGroup</span><span class="p">(</span><span class="n">raftGroup</span><span class="p">)</span>
                <span class="p">.</span><span class="na">build</span><span class="p">();</span>
        <span class="n">raftServer</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>Uma vez iniciado o servidor, basta esperar que ele termine antes de sair do programa.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="k">while</span><span class="p">(</span><span class="n">raftServer</span><span class="p">.</span><span class="na">getLifeCycleState</span><span class="p">()</span> <span class="o">!=</span> <span class="n">LifeCycle</span><span class="p">.</span><span class="na">State</span><span class="p">.</span><span class="na">CLOSED</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Vamos agora para a definição da classe <code>MaquinaDeEstados</code>, no arquivo <code>MaquinaDeEstados.java</code>.
Esta classe deve implementar a interface <code>org.apache.ratis.statemachine.StateMachine</code> e seus vários métodos ou, mais simples, estende <code>org.apache.ratis.statemachine.impl.BaseStateMachine</code>, a abordagem que usaremos aqui.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MaquinaDeEstados</span> <span class="kd">extends</span> <span class="n">BaseStateMachine</span>
<span class="p">{</span>
</code></pre></div>
</td></tr></table>
<p>Por enquanto, ignoraremos o armazenamento do estado em disco, mantendo-o simplesmente em memória no campo <code>key2values</code>, e simplesmente implementaremos o processamento de comandos, começando pela implementação do método <code>query</code>.</p>
<p>Este método é reponsável por implementar operações que não alteram o estado da máquina de estados, enviadas com o método <code>RaftClient::sendReadOnly</code>. A única <code>query</code> no nosso sistema é o <code>get</code>.
No código, o conteúdo da requisição enviada pelo cliente deve ser recuperado em quebrado em operação (<code>get</code>) e chave , usando <code>:</code> como delimitador.
Recuperado o valor associado à chave, o mesmo é colocado em um <code>CompletableFuture</code> e retornado.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">key2values</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="nf">query</span><span class="p">(</span><span class="n">Message</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">opKey</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="na">getContent</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">()).</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">);</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">opKey</span><span class="o">[</span><span class="mi">0</span><span class="o">]+</span> <span class="s">&quot;:&quot;</span><span class="o">+</span> <span class="n">key2values</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">opKey</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">);</span>

        <span class="n">LOG</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;{}: {} = {}&quot;</span><span class="p">,</span> <span class="n">opKey</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">opKey</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>O método <code>applyTransaction</code> implementa operações que alteram o estado, como <code>add</code>, enviadas com o método <code>RaftClient::send</code>. 
Da mesma forma que em <code>get</code>, a operação deve ser recuperada em quebrada em operação (<code>add</code>), chave e valor, usando <code>:</code> como delimitador.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="nf">applyTransaction</span><span class="p">(</span><span class="n">TransactionContext</span> <span class="n">trx</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="n">RaftProtos</span><span class="p">.</span><span class="na">LogEntryProto</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">trx</span><span class="p">.</span><span class="na">getLogEntry</span><span class="p">();</span>
        <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">opKeyValue</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="na">getStateMachineLogEntry</span><span class="p">().</span><span class="na">getLogData</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">()).</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">);</span>

        <span class="kd">final</span> <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">opKeyValue</span><span class="o">[</span><span class="mi">0</span><span class="o">]+</span> <span class="s">&quot;:&quot;</span><span class="o">+</span> <span class="n">key2values</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">opKeyValue</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">opKeyValue</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">);</span>

        <span class="kd">final</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>

        <span class="kd">final</span> <span class="n">RaftProtos</span><span class="p">.</span><span class="na">RaftPeerRole</span> <span class="n">role</span> <span class="o">=</span> <span class="n">trx</span><span class="p">.</span><span class="na">getServerRole</span><span class="p">();</span>
        <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;{}:{} {} {}={}&quot;</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">getId</span><span class="p">(),</span> <span class="n">opKeyValue</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">opKeyValue</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">opKeyValue</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Pronto, você já tem uma máquina de estados replicada, bastando agora apenas compilá-la e executá-la.
Para compilar, de raiz do projeto execute o comando <code>mvn package</code>. 
A primeira vez que faz isso pode demorar um pouco pois várias dependências são baixadas da Internet.
Ao final da execução do comando você deveria ver algo semelhante ao seguinte</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>...
INFO<span class="o">]</span> ------------------------------------------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> BUILD SUCCESS
<span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> Total time:  <span class="m">4</span>.793 s
<span class="o">[</span>INFO<span class="o">]</span> Finished at: <span class="m">2020</span>-12-06T23:06:32-03:00
<span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
</code></pre></div>
</td></tr></table>
<p>Então, em três terminais diferentes, execute os seguintes comandos:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Servidor p1
java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Servidor p2
java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Servidor p3
</code></pre></div>
</td></tr></table>
<p>Para executar o cliente, em um outro terminal, faça, por exemplo,</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Cliente add k1 testek1
java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Cliente get k1

java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Cliente add k2 testek2
</code></pre></div>
</td></tr></table>
<p>Todo o código está disponível no <a href="https://github.com/lasarojc/ds_notes/tree/master/docs/fault/code/ChaveValor">Github</a></p>
<details class="todo"><summary>Exercício</summary><ul>
<li>Adicionar operações <ul>
<li><code>del</code></li>
<li><code>clear</code></li>
</ul>
</li>
</ul>
</details>
<h6>Operações assíncronas</h6>
<details class="todo"><summary>TODO</summary><ul>
<li>Operações assíncronas usando <code>async()</code> em vez de <code>io()</code>.</li>
<li><code>CompletableFuture</code></li>
</ul>
</details>
<h6>Leituras "velhas"</h6>
<details class="todo"><summary>TODO</summary><ul>
<li><em>stale reads</em> usando <code>sendStaleRead</code> em vez de <code>sendRead</code>.</li>
<li>índice inicial</li>
<li>nó</li>
<li><code>java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Cliente get_stale  k1 p1</code></li>
</ul>
</details>
<h4 id="estudo-de-caso-zookeeper">Estudo de caso: Zookeeper</h4>
<p>O <a href="http://zookeeper.apache.org/">Zookeeper</a> foi criado para coordenar as ações dos componentes de sistemas distribuídos, porquê sistemas distribuídos são como zoológicos, com animais de diversas espécies, sendo obrigados a conviver de forma anti-natural.</p>
<p><img alt="http://zookeeper.apache.org/" src="../images/zklogo.jpeg" /></p>
<h6>Visão Geral</h6>
<div class="admonition quote">
<p class="admonition-title">O quê?</p>
<p>ZooKeeper is a <strong>centralized</strong> service for maintaining <strong>configuration</strong> information, <strong>naming</strong>, providing distributed <strong>synchronization</strong>, and providing <strong>group services</strong>. All of these kinds of services are used in some form or another by <strong>distributed applications</strong>. Each time they are implemented there is a lot of work that goes into fixing the bugs and race conditions that are inevitable. Because of the difficulty of implementing these kinds of services, applications initially usually skimp on them, which make them brittle in the presence of change and difficult to manage. Even when done correctly, different implementations of these services lead to management <strong>complexity</strong> when the applications are deployed.</p>
</div>
<p>O arcabouço foi criado pelo <a href="http://www.yahoo.com">Yahoo!</a> para servir como peça na construção de sistemas distribuídos dentro da empresa.</p>
<div class="admonition quote">
<p class="admonition-title">Por quê?</p>
<p>Coordination services are notoriously hard to get right. They are especially prone to errors such as race conditions and deadlock. The motivation behind ZooKeeper is to relieve distributed applications the responsibility of implementing coordination services from scratch.</p>
</div>
<p>Mais tarde o sistema tornou-se <em>Open Source</em> e parte de diversos projetos, tanto abertos quanto proprietários.
A razão de seu sucesso, arrisco dizer, é a simplicidade de sua API, semelhante a um sistema de arquivos.</p>
<div class="admonition quote">
<p class="admonition-title">Como?</p>
<p>[ZooKeeper] exposes a <strong>simple set of primitives</strong> that distributed applications can build upon to implement higher level services for synchronization, configuration maintenance, and groups and naming. It is designed to be easy to program to, and uses a data model styled after the familiar <strong>directory tree structure of file systems</strong>. It runs in Java and has bindings for both <strong>Java</strong> and <strong>C</strong>.</p>
<p>ZooKeeper allows distributed processes to coordinate with each other through a <strong>shared hierarchal namespace which is organized similarly to a standard file system</strong>. ... Unlike a typical file system, which is designed for storage, ZooKeeper data is kept <strong>in-memory</strong>, which means ZooKeeper can achieve <strong>high throughput and low latency</strong> numbers.</p>
</div>
<p>O sistema de arquivos do Zookeeper tem nós denominados <strong>znodes</strong>, em referência aos i-nodes do mundo Unix.
O znode raiz é denominado <code>/</code> e um filho da raiz nomeado <code>teste</code> é referido como <code>/teste</code>.
Cada znode pode ser visto como <strong>arquivo</strong> e <strong>diretório</strong> ao mesmo tempo.</p>
<p><img alt="" src="../images/zknamespace.jpg" /></p>
<p>Znodes são manipulados, essencialmente, por 4 operações, implementando CRUD, e uma quinta operação que lista os znodes filhos de um dado znode.</p>
<ul>
<li>C: create</li>
<li>R: get</li>
<li>U: set</li>
<li>D: delete</li>
<li>ls *: get children</li>
</ul>
<p>Znodes são lidos e escritos sempre integralmente. Isto é, não se pode escrever apenas parte do conteúdo do "arquivo". Por isso, recomenda-se que os arquivos sejam sempre pequenos, onde pequeno é relativo.</p>
<p>O sistema de arquivos do Zookeeper é replicado em vários nós, usando a técnica de replicação de máquinas de estados estudada. 
A difusão ordenada de comandos é implementadas O protocolo utilizado é pelo protocolo de difusão atômica próprio do Zookeeper, ZAB (<a href="https://zookeeper.apache.org/doc/r3.7.0/zookeeperInternals.html#sc_atomicBroadcast"><em>Zookeeper Atomic Broadcast</em></a>).</p>
<p>Comandos de modificação do sistema de arquivos, como <strong>create</strong> e <strong>delete</strong>, podem ser enviados para qualquer das réplicas, mas serão internamente encaminhados para um processos líder e de lá replicados.</p>
<p><img alt="" src="../images/zkservice.jpg" /></p>
<p>Já comandos de leitura são executados direto na réplica que os recebe, sendo respondidos mais rapidamente mas que, devido à assincronia do sistema, podem ser respondidos com dados antigos. Por este motivo, clientes sempre conversam com o mesmo servidor, a não ser que sejam forçados a estabelecer nova conexão, e só emitem novos comandos depois que o anterior tiver sido respondido. Este comportamento resulta em garantias de consistência específicas, denominadas <a href="https://zookeeper.apache.org/doc/r3.7.0/zookeeperInternals.html#sc_consistency">consistência sequencial ordenada</a>.</p>
<p><img alt="" src="../images/zkcomponents.jpg" /></p>
<p>Por causa do custo em termos de mensagens trocadas entre os processos para mensagens de atualização e pelo baixo custo das mensagens de leitura, o zookeeper é recomendado para cargas de trabalho com poucas escritas.</p>
<div class="admonition quote">
<p class="admonition-title">Desempenho</p>
<p>ZooKeeper is fast [...] and it performs best where reads are more common than writes, at ratios of around 10:1.</p>
</div>
<p>O gráfico seguinte mostra como o desempenho do sistema varia com o número de processos.
No eixo Y, a quantidade de requisições processadas por segundo, ou seja, a vazão.
No eixo X, a percentagem das requisições do teste que são leituras e, portanto, repondidas na réplica em que são recebidas.
As diferentes curvas mostram diferentes configurações do sistema, indo de 3 a 12 réplicas.</p>
<p><img alt="" src="../images/zkperfRW_3_2.jpg" /></p>
<p>Em geral, todas as configurações apresentam melhor desempenho quando há uma percentagem maior de leituras.
Mas observe como as curvas se invertem, se focando primeiro na curva para 3 servidores: quando todas as operações são de escrita, e portanto precisam passar pelo protocolo de difusão atômica, esta curva apresenta os melhores resultados. Isto ocorre porquê o <em>overhead</em> de executar o protocolo é mais baixo entre 3 servidores que entre 13. Em compensação, quando temos mais leituras, que não precisam de sincronização, então ter mais servidores é mais vantajoso pois sobre menos carga de trabalho para cada servidor.</p>
<h6>Laboratório</h6>
<p>Instale o Zookeeper em sua máquina seguindo estas instruções.</p>
<ul>
<li>Baixe: <code>wget www-eu.apache.org/dist/zookeeper/zookeeper-3.6.2</code></li>
<li>Descomprima: <code>tar xvzf zookeeper*.tgz</code></li>
<li>Entre na pasta criada.</li>
<li>Configure: copie o arquivo <code>conf/zoo_sample.cfg</code> para <code>conf/zoo.cfg</code></li>
<li>Execute<ul>
<li><code>./bin/zkServer.sh start-foreground</code> em um terminal</li>
<li><code>./bin/zkCli.sh -server 127.0.0.1:2181</code> em outro terminal</li>
</ul>
</li>
</ul>
<p>Do shell do programa cliente (executado por último), digite <code>help</code> e enter para ver uma lista de todos os comandos disponíveis.
Vejamos alguns exemplos básicos.</p>
<ul>
<li><code>ls /</code> - lista os nós filhos da raiz.</li>
<li><code>create /teste lala</code> - cria o nó <code>/teste</code> com conteúdo <code>lala</code></li>
<li><code>get /teste</code> - pega o conteúdo do arquivo</li>
<li><code>set /teste lele</code> - atualiza o conteúdo do arquivo</li>
<li><code>delete /teste</code> - apaga o arquivo</li>
</ul>
<p>Outros comandos interessantes são:</p>
<ul>
<li><code>stat /teste</code> - mostra medatados do arquivo, por exemplo versão, e <em>timestamps</em></li>
<li><code>set -v V /teste lili</code> - faz um update condiciona, isto é, atualiza o conteúdo do arquivo se a versão do mesmo, como mostrada pelo comando <code>stat</code>, for igual a <code>V</code></li>
</ul>
<h6>Nós Efêmeros e Watches</h6>
<p>O Zookeeper tem muitas funcionalidades interessantes, mas chamarei a atenção a duas que são particularmente úteis:</p>
<p>Nós <strong>efêmeros</strong>, criados com a flag <code>-e</code>, p.e., <code>create -ef /teste/noefemero efemero</code>, são automaticamente destruídos quando o cliente que os criou se desconecta do servidor. E <strong>watches</strong> avisam ao cliente quando uma operação em um certo znode ou em seus filhos acontece. Para ser avisado quando os dados de um nó forem alterados, use a opção <code>-w</code> do get, por exemplo, <code>get -w /teste</code>. Para monitorar alterações no conjunto de filhos de um nó, use <code>-w</code> no <code>ls</code>, por exemplo, <code>ls -w /teste</code>.</p>
<div class="admonition exercise">
<p class="admonition-title">Nós Efêmeros e Watches</p>
<ul>
<li>Crie um zNode /teste</li>
<li>
<p>Debaixo de /teste, crie três outros, sequenciais</p>
</li>
<li>
<p>Crie um zNode /teste2</p>
</li>
<li>Crie um zNode efêmero</li>
<li>Conecte-se com outro cliente</li>
<li>Coloque um watch em /teste2</li>
<li>Desconecte o primeiro cliente</li>
<li>Observe o evento gerado no segundo cliente</li>
<li>Reconecte o primeiro cliente</li>
</ul>
</div>
<h6>Cluster tolerante a falhas</h6>
<p>Observe que você está executando o Zookeeper em apenas um nó, ou seja, não há tolerância a falhas alguma aqui.
Para tolerar falhas, você precisa de um cluster multi-nós, mesmo que seja em uma única máquina. 
Neste caso, crie três arquivos de configuração, <code>zoo1.cfg</code>, <code>zoo2.cfg</code> e <code>zoo3.cfg</code>. O arquivo <code>zooX.cfg</code>, onde <code>1 &lt;= X &lt;= 3</code>, fica assim:</p>
<ul>
<li><code>dataDir=/tmp/lasaro/zooX #Substitua o X pelo valor correto</code></li>
<li><code>server.1=zoo1:2888:3888</code></li>
<li><code>server.2=zoo2:2889:3889</code></li>
<li><code>server.3=zoo3:2890:3890</code></li>
<li><code>clientPort=218X #Substitua o X pelo valor correto</code></li>
</ul>
<p>Crie diretórios e arquivos de identificação.</p>
<ul>
<li><code>mkdir /tmp/lasaro/zooX</code></li>
<li><code>echo X &gt; /tmp/lasaro/zooX/myid</code></li>
</ul>
<p>Execute servidores.</p>
<ul>
<li><code>./bin/zkServer.sh start conf/zooX.cfg</code></li>
</ul>
<p>Ainda que tenha três servidores executando em uma mesma máquina, seu cluster parará de funcionar se a máquina parar de funcionar. O ideal é que cada servidor execute em uma máquina distinta.</p>
<h6>Receitas</h6>
<p>É possível resolver diversos problemas encontrados em sistemas distribuídos usando-se o ZooKeeper, por exemplo, o problema de descoberta de processos.</p>
<div class="admonition example">
<p class="admonition-title">Rendezvous</p>
<p>Ponto de encontro de processos. </p>
<ul>
<li>Defina um zNode raiz a ser usado: /rendezvous/app1/ </li>
<li>Cada filho de /rendezvous/app1 corresponde a um processo:<ul>
<li>IP</li>
<li>Porta</li>
<li>Número de processadores</li>
<li>...</li>
</ul>
</li>
<li>Processo p ao ser iniciado:<ul>
<li>procura /rendezvous/app1/p</li>
<li>se achar, continua</li>
<li>se não achar, cria /rendezvous/app1/p</li>
</ul>
</li>
<li>lista os filhos de /rendezvous/app1</li>
</ul>
</div>
<p>Como lidar com saída de processos?
Faça todos os zNodes são efêmeros.
Quando um nó é desconectado, o zNode correspondente será destruído.</p>
<p>Como detectar mudanças no grupo de processos?</p>
<p>Monitore os filhos de /rendezvous/app1<br />
Sempre que receber notificações, refaça o cálculo do <strong><em>membership</em></strong>.</p>
<p>Eleição de Líderes
Rendezvous.
Faça os zNodes sequenciais.
Ordene os zNodes e escolha o primeiro.
Monitore o zNode. Se ele sumir, eleja outro líder.</p>
<div class="admonition exaple">
<p class="admonition-title">Exclusão Mútua</p>
<p>Construa uma fila usando nós efêmeros e sequenciais. O processo na cabeça da fila tem direito de acesso. Em caso de falhas, o processo é removido da cabeça da fila.</p>
</div>
<p>Várias outras receitas podem ser facilmente encontradas no <a href="http://zookeeper.apache.org/doc/trunk/recipes.html">sítio do projeto</a>:</p>
<ul>
<li>Lock distribuído</li>
<li>Filas, e.g. de prioridades</li>
<li>Barreira</li>
<li>Serviço de nomes</li>
<li>Terminação em duas fases</li>
<li>Contador atômico</li>
</ul>
<p>Além destas, outro projeto, o <a href="http://curator.apache.org">Curator</a> se dedica apenas a colecionar implementações corretas de receitas para o Zookeeper.</p>
<h4 id="estudo-de-caso-etcd">Estudo de caso: Etcd</h4>
<details class="todo"><summary>Todo</summary><p><a href="https://etcd.io/">etcd</a></p>
</details>
<h4 id="estudo-de-caso-kafka">Estudo de caso: Kafka</h4>
<details class="todo"><summary>Todo</summary><p><a href="https://kafka.apache.org/">Kafka</a></p>
</details>
<h4 id="estudo-de-caso-bft-smart">Estudo de caso BFT-Smart</h4>
<details class="todo"><summary>Todo</summary><p><a href="https://github.com/bft-smart/library">BFT-Smart</a></p>
</details>
<!--
O quê?
* Manter dados/serviços disponíveis a despeito de falhas.

Replicação
* No Kafka, o \alert{Replication Factor} determina quantas cópias de cada tópico (todas as partições no tópico).

Líder e Seguidor
*  Produtor conversa com líder. Líder grava localmente e envia ack ao produtor.
*  Consumidor conversa com líder. Líder envia dados ao consumidor.
*  Líder replica dados para seguidores.

Replicar
* Passo 6  ensina a criar um sistema com múltiplos brokers.

*  Identificador
*  Porta (mesmo servidor)
*  \alert{Log directory}

Replicar
*  Crie um novo tópico, com RF = 3 e duas partições
*  \lstinline|bin/kafka-topics.sh --list --zookeeper localhost:2181 --describe --topic <topico>|
*  Lista de réplicas
*  Lista de réplicas sincronizadas: \emph{list of \alert{i}n \alert{s}ync \alert{r}eplicas}


Zookeeper
*  Permite que nós do cluster se descubram
*  Elege líder

Armazenamento
*  Dado deve ser removido depois de um tempo de ``retenção''
*  Pode definir retenção por tamanho (por partição, não tópico)


Produtor

*  Produtor envia mensagens para os brokers
*  Producer API
*  [Learning Journal](https://github.com/LearningJournal/ApacheKafkaTutorials)

SimpleProducer.java

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.apache.kafka.clients.producer.KafkaProducer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.kafka.clients.producer.Producer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.kafka.clients.producer.ProducerRecord</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleProducer</span> <span class="p">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">String</span> <span class="n">topicName</span> <span class="o">=</span> <span class="s">&quot;SimpleProducerTopic&quot;</span><span class="p">;</span>
  <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;Chave&quot;</span><span class="p">;</span>
  <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;Valor&quot;</span><span class="p">;</span>
  <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="p">();</span>
  <span class="n">props</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;bootstrap.servers&quot;</span><span class="p">,</span> <span class="s">&quot;localhost:9092, localhost:9093&quot;</span><span class="p">);</span>
  <span class="n">props</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;key.serializer&quot;</span><span class="p">,</span> <span class="s">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="p">);</span>
  <span class="n">props</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;value.serializer&quot;</span><span class="p">,</span> <span class="s">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="p">);</span>

  <span class="n">Producer</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">producer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KafkaProducer</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">props</span><span class="p">);</span>

  <span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">record</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">topicName</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

  <span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
  <span class="n">producer</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>

  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;SimpleProducer Completed.&quot;</span><span class="p">);</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>

Workflow
![]()images/kafka6.png)

*  Particionador default
    *  Partition
    *  Hash da ``chave''
    *  Round robin
*  Retry automático


Fire and Forget
* Envia a mensagem e não se importa com o resultado.

Synchronous Call
* Envia a mensagem e espera para saber se foi entregue ou não.

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">{</span>
 <span class="n">RecordMetadata</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">record</span><span class="p">).</span><span class="na">get</span><span class="p">();</span>
 <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Message is sent to Partition no &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">.</span><span class="na">partition</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; and offset &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">.</span><span class="na">offset</span><span class="p">());</span>
 <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;SynchronousProducer Completed with success.&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
 <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
 <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;SynchronousProducer failed with an exception&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="k">finally</span><span class="p">{</span>
 <span class="n">producer</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>

*  Future

Callback
Envia a mensagem e é invocado depois de receber um ACK

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>producer.send(record, new MyProducerCallback());

...

class MyProducerCallback implements Callback{
 @Override
 public  void onCompletion(RecordMetadata recordMetadata, Exception e) {
  if (e != null)
   System.out.println(&quot;AsynchronousProducer failed with an exception&quot;);
  else
   System.out.println(&quot;AsynchronousProducer call Success:&quot;);
 }
}
</code></pre></div>
</td></tr></table>

*  max.in.flight.requests.per.connection


Default Partitioner
![](images/kafka6.png)

*  Partition
*  Hash da ``chave'' \% \#partition
*  Round robin

\href{https://github.com/LearningJournal/ApacheKafkaTutorials/blob/master/ProducerExamples/SensorPartitioner.java}{Exemplo de Custom Partitioner}
\end{frame}

\subsection{Consumidor}

\begin{frame}{Consumer Groups}
\begin{itemize}
*  Múltiplos consumidores processam dados em paralelo
*  Grupo de consumidores de tópicos
*  Grupo pertence à mesma aplicação
    \includegraphics[width=.6\textwidth]{images/kafka7}
*  Duplicate reads? Consumidores não compartilham partições
*  Group coordinator (broker eleito): lista de consumidores
*  Group líder: rebalanceamento
\end{itemize}
\end{frame}

\begin{frame}[fragile, allowframebreaks]{Consumer}
\begin{lstlisting}[language=Java]
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;

import java.io.IOException;
import java.util.Arrays;
import java.util.Properties;

public class SimpleConsumer {
 public static void main(String[] args) throws IOException {
  String topicName = "SimpleProducerTopic";
  String groupName = "SupplierTopicGroup";

  Properties props = new Properties();
  props.put("bootstrap.servers", "localhost:9092,localhost:9093");
  props.put("group.id", groupName);
  props.put("key.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
  props.put("value.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");

  KafkaConsumer<String, String> consumer = null;

  try {
   consumer = new KafkaConsumer<String, String>(props);
   consumer.subscribe(Arrays.asList(topicName));

   while (true) {
    ConsumerRecords<String,String> records = consumer.poll(100);

    for (ConsumerRecord<String, String> record: records)
     System.out.println("Key = " + record.key() + " Value = " + record.value());
   }
  } catch (Exception ex) {
   ex.printStackTrace();
  } finally {
   consumer.close();
  }
 }
}
\end{lstlisting}

\begin{itemize}
*  Se não definir grupo, será novo grupo, e lerá todas as mensagens disponíveis
\end{itemize}
\end{frame}


\begin{frame}{Poll}
\begin{itemize}
*  poll também envia hearbeat
*  executar a cada 3s, no mínimo    
*  Current offset: a cada poll, broker incrementa current offset
*  Commited offset: o consumidor informa quais índices foram processados
    \begin{itemize}
    *  Auto Commit
        \begin{itemize}
        *  enable.auto.commit
        *  auto.commit.interval.ms
        *  Pode causar reprocessamento de mensagens
        \end{itemize}
    *  Manual Commit
        \begin{itemize}
        *  CommitSync
        *  CommitAsync
        \end{itemize}
    \end{itemize}
\end{itemize}
\end{frame}


\subsection{Arquitetura}
%\begin{frame}{Líder}

%\end{frame}

%mensagens são ack depois de copiadas para todas as réplicas
%replicas lentas são removidas se lentas ou falhas
%at least once, at most once, exactly one (nao suportado)
%rolling upgrade
%tls security
%rest
%CRUD












### Falhas Bizantinas 

Uma história de três exércitos -- Versão 2}
Exércitos estão às portas de Bizâncio, aka Constantinopla, aka Istambul.

Todos os exércitos tem que atacar em conjunto ou se retirar em conjunto.

Cada exército é comandado por um General. Alguns destes preferem atacar, enquanto outros preferem se retirar.

Alguns generais podem ter sido comprados, e mandar mensagens discrepantes para os outros, ou simplesmente não mandar mensagens.

Fonte: \href{http://research.microsoft.com/en-us/um/people/lamport/pubs/byz.pdf}{Lamport, L.; Shostak, R.; Pease, M. (1982). "The Byzantine Generals Problem" (PDF). ACM Transactions on Programming Languages and Systems. 4 (3): 382–401. doi:10.1145/357172.357176.}


Generais e Tenentes
Problema pode ser mudado para:

    * Comandante envia ordem.
    * Todos os tenentes leais executam ordem recebida.
    * Comandante pode ser traidor.




Generais e Tenentes
Suponha 3 exércitos. \\
Comandante (traidor) diz "Ataque!" Tenente A e "Retirada!" tenente B.\\
Ou \\
Comandante diz "Ataque!" a ambos. Tenente A segue a ordem mas B se retira.

 E se os tenentes trocarem informações?

 Como diferenciar casos em que Comandante ou Tenente é traidor?





Generais e Tenentes
Só há solução se mais de $\frac{2}{3}$ dos Generais/Tenentes são leais.


%http://www.drdobbs.com/cpp/the-byzantine-generals-problem/206904396?pgno=5

Comunicação}

    * Toda mensagem enviada é entregue corretamente.
    * A ausência de mensagem pode ser detectada (mensagem Null é entregue no lugar) (Sistema síncrono)




4/0}
General manda ordens.

Ausência de ordem = Retirada

Tenente repassa ordens

Maioria de comandos é comando a ser seguido



4/0}
General manda ordens.

Ausência de ordem = Retirada

Tenente repassa ordens

Maioria de comandos é comando a ser seguido



Comunicação}

    * Toda mensagem enviada é entregue corretamente.
    * Toda mensagem é assinada.
    * A ausência de mensagem pode ser detectada (mensagem Null é entregue no lugar) (Sistema síncrono)


 É possível detectar inconsistências e processos bizantinos.



%http://cs.brown.edu/courses/cs138/s16/lectures/19consen-notes.pdf
\section{Outros tópicos}

%TODO \subsection{Detectores de Falhas}




\subsection{Reconfiguração}

Reconfiguração da Aplicação}
Na segunda entrega do projeto, você distribuiu a carga do seu banco de dados entre vários nós. Caso um nó falhe, parte dos seus dados será perdida.

Para corrigir esta deficiência, na terceira entrega, cada nó será replicado em três vias e, assim, caso um nó falhe, outros dois continuarão a manter o dado.



Reconfiguração da Aplicação}
Ainda assim, há problemas. E se mais de um, de um mesmo conjunto de réplicas, falhar? 

 Embora seja pequena a probabilidade de dois nós de um mesmo grupo falharem em instantes próximos, dado tempo suficiente, qualquer evento com probabilidade diferente de 0 acontecerá.

 Precisamos de uma forma de trocar nós da aplicação que falharam por novos nós. 

Este é problema denominado Pertinência de Grupo ou \emph{Group Membership}



Group Membership}
Para não correr o risco, retire o processo falhos do grupo e coloque outro no lugar!

I.e., mude a visão que o sistema de quem é o grupo.




Visões}
\includegraphics[width=.7\textwidth]{images/vc}

Fonte: \href{https://www.cs.rutgers.edu/~pxk/417/notes/virtual_synchrony.html}{Paul Krzyzanowski}

$G$ é o grupo de processos participando do sistema, é a Visão do Sistema.


Inicialmente, $G$ consiste de apenas o processo $p$, como o processo que cria o cluster no Atomix. Na sequência, outros processo vão se unindo ao grupo através de View Changes. Uma vez que $p$ e $q$ estão no grupo, inicia-se a comunicação entre eles. Quando $r, s$ e $t$ aparecem, também entram no grupo por meio de uma nova visão.

Finalmente, quando ambos $p$ e $q$ falham, os outros processo os excluem da visão, e continuam funcionando normalmente.


Impossibilidade de Detecção de Falhas}
Em um sistema distribuído assíncrono, é impossível distinguir com toda certeza um processo falho (parou de funcionar) de um que está lento.

 Como decidir se mudar ou não de visão?


Ou aceita a imprecisão e muda quando suspeitar de uma falha, ou corre o risco de ficar esperando \emph{ad eternum} e não mudar, mesmo quando uma falha aconteceu.

Uma ``solução''!}
Quando suspeitar de falha, reporte suspeita a outros processos, que também passarão a suspeitar.

Tome decisão baseado na suspeita, isto é, troque de visão quando houver suspeita.

Pague o preço de uma suspeita errada, isto é, quando um processo for removido da visão indevidamente, adicione-o novamente.



Sincronismos Virtual}
Gerenciamento de Grupo/Group Membership e Comunicação em Grupo

    * Processos se unem ao grupo
    * Processos saem do grupo
    * Processos enviam mensagens para o grupo
    * Diferentes ordenações

            * Atomic Multicast




Visão de Grupo}

    * Visão: conjunto de processos no sistema.
    * Multicast feito para processos na visão.
    * Visão é consistente entre os processos.
    * Entrada e saída de processos muda a visão.



Eventos}

    * Mensagem
    * Mudança de Visão
    * Checkpoint



Visões}
\includegraphics[width=.7\textwidth]{images/vc}

Fonte: \href{https://www.cs.rutgers.edu/~pxk/417/notes/virtual_synchrony.html}{Paul Krzyzanowski}


Sincronismo Virtual}
Deve satisfazer

    * Se uma mensagem é enviada em uma visão, ela só pode ser entregue naquela visão.
    * Se uma mensagem é entregue a um processo correto em uma visão, então é entregue a todos os processos corretos naquela visão.
    * Se um processo não recebe a mensagem, ele não estará na próxima visão.
    * Ao entrar em uma visão, o processo recebe o estado dos outros processos e seu estado se torna equivalente ao de um processo que recebeu todas as mensagens já entregues.


A troca de Visão é uma barreira.


ISIS Toolkit}
    Sistema de Sincronismo Virtual tolerante a falhas desenvolvido por Ken Birman, Cornell University (\url{http://www.cs.cornell.edu/Info/Projects/Isis/})\\
    ISIS: An Environment for Constructing Fault-Tolerant Distributed Systems. Kenneth Birman, D. Skeen, A. El Abbadi, W. C. Dietrich and T. Raeuchle. May 1983.


    * 100.000's/s
    * Em uso até 2009
    * NY Stock Exchange
    * Swiss Exchange
    * US Navy
    * Precursos de sistemas como Zookeeker
    * Totem, ISIS, Horus, Transis (Partições), \alert{Spread}, \alert{Ensamble}, \alert{JGroups}, Appia, QuickSilver, vSynch (née ISIS 2)



Difusão Totalmente Ordenada}

    * Corretude: Se um processo $p$ envia uma mensagem $m$ para processos no grupo $G$, então se $p$ não falha, todos os processos corretos em $G$ recebem a mensagem.

    * Acordo: Se um processo correto em $G$ recebe uma mensagem $m$, então todo processo correto em $G$ recebe $m$

    * Ordenação: Se um processo recebe mensagem $m$ e depois $n$, então qualquer processo que receba a mensagem $n$ deve primeiro receber $m$

    * Validade: Somente mensagens difundidas são entregues.


E se mandarmos mensagens do tipo ``A partir da entrega desta mensagem, o grupo de processos é $G$.''


Sincronismo Virtual}
Deve satisfazer

    * Se uma mensagem é enviada em uma visão, ela só pode ser entregue naquela visão.\\
    Mensagens de troca de visão podem incrementar um contador\\
    Mensagens normais carregam o valor atual do contador\\
    Mensagem descartada se valor na mensagem é maior contador no destinatário

    * Se uma mensagem é entregue a um processo correto em uma visão, então é entregue a todos os processos corretos naquela visão.\\
    Pela difusão, se a mensagem de troca for entregue para um processo, será entregue para todos os corretos, na mesma ordem
    Se mensagem comum for entregue antes para algum, será entregue ante para todos.

    * Se um processo não recebe a mensagem, ele não estará na próxima visão.\\
    Se um processo não recebe uma mensagem comum que foi entregue pelos outros, então ele não troca de visão.

    * Ao entrar em uma visão, o processo recebe o estado dos outros processos e seu estado se torna equivalente ao de um processo que recebeu todas as mensagens já entregues.\\
    Caso contrário, não haveria porquê trocar os processos



State Transfer}
\includegraphics[width=.7\textwidth]{images/state_transfer}


\href{http://www.gsd.inesc-id.pt/~ler/docencia/tfd0405/bib/BSRNA.pdf}{Building Secure and Reliable Network Applications}



Difusão Atômica $\equiv$ Sincronismo Virtual?}
Seria uma boa aproximação, mas que poderia ser relaxada. 

Em certas aplicações, FIFO ou Causal seriam suficientes dentro da visão, desde que a mensagem de mudança da visão seja totalmente ordenada com as comuns.



Particionamento}
E se dois subconjuntos mutuamente exclusivos se formarem e criarem visões independentes?

 \emph{Primary Partition Model} -- Somente a partição primária pode mudar de visão.

 Lembram-se que no Raft somente uma partição com uma maioria de processo pode decidir? É exatamente a mesma situação, pois os processos estão chegando a um Consenso sobre quem é a nova visão.



Extended Virtual Synchrony}
\emph{Primary Partition Model} -- Não é adequado a uma rede geograficamente distribuída (Internet scale).

 Lembram-se que no Raft somente uma partição com uma maioria de processo pode decidir? É exatamente a mesma situação, pois os processos estão chegando a um Consenso sobre quem é a nova visão.


É possível que no trabalho dois, alguns de vocês tenham tentado gerar locks do sistema para manipular objetos distribuídos no sistema. Esse locks são perigosos por quê processos pode travar/quebrar/falhar e nunca liberarem os locks. O uso de um algoritmo VS poderia ser usado para resolver o problema.\right 




[Swim](https://asafdav2.github.io/2017/swim-protocol/)




http://courses.cs.vt.edu/cs5204/fall05-gback/lectures/Lecture8.pdf



-->

<div class="footnote">
<hr />
<ol>
<li id="fn:737max">
<p><a href="https://theconversation.com/boeing-737-max-why-was-it-grounded-what-has-been-fixed-and-is-it-enough-150688">Boeing 737 Max: why was it grounded, what has been fixed and is it enough?</a>&#160;<a class="footnote-backref" href="#fnref:737max" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:rca">
<p><a href="https://github.com/danluu/post-mortems">Post-mortems</a> para uma extensa lista de análises.&#160;<a class="footnote-backref" href="#fnref:rca" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:failfastfast">
<p><a href="https://pathelland.substack.com/p/fail-fast-is-failing-fast">Fail Fast Is Failing… Fast!</a>&#160;<a class="footnote-backref" href="#fnref:failfastfast" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:tla_real">
<p><a href="https://probablydance.com/2020/10/31/using-tla-in-the-real-world-to-understand-a-glibc-bug/"><em>Using TLA+ in the Real World to Understand a Glibc Bug</em></a>&#160;<a class="footnote-backref" href="#fnref:tla_real" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:2generalsparadox">
<p>Esta é uma variação do problema de coordenação de <em>gangsters</em> apresentado no em <a href="https://doi.org/10.1145%2F800213.806523">Some constraints and trade-offs in the design of network communications</a>&#160;<a class="footnote-backref" href="#fnref:2generalsparadox" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:impossibilidades">
<p><a href="https://groups.csail.mit.edu/tds/papers/Lynch/MIT-LCS-TM-394.pdf">Hundred Impossibility Proofs for Distributed Computing</a>, <a href="https://doi.org/10.2200/S00551ED1V01Y201311DCT012">Impossibility Results for Distributed Computing</a>&#160;<a class="footnote-backref" href="#fnref:impossibilidades" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:flp85">
<p><a href="https://groups.csail.mit.edu/tds/papers/Lynch/jacm85.pdf">Impossibility of Distributed Consensus with One Faulty Process</a>. Uma explicação da prova está disponível no <a href="https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/">Paper Trail</a>&#160;<a class="footnote-backref" href="#fnref:flp85" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:CT96">
<p><a href="https://www.cs.utexas.edu/~lorenzo/corsi/cs380d/papers/p225-chandra.pdf">Unreliable Failure Detectors for Reliable Distributed Systems</a>&#160;<a class="footnote-backref" href="#fnref:CT96" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
<li id="fn:CHT96">
<p><a href="https://www.cs.utexas.edu/~lorenzo/corsi/cs380d/papers/weakestfd.pdf">The Weakest Failure Detector for Solving Consensus</a>&#160;<a class="footnote-backref" href="#fnref:CHT96" title="Jump back to footnote 9 in the text">&#8617;</a></p>
</li>
<li id="fn:paxosmade">
<p>Um exemplo de como traduzir um algoritmo complexo para código pode se ingrato é reportado em <a href="https://www.cs.utexas.edu/users/lorenzo/corsi/cs380d/papers/paper2-1.pdf">Paxos Made Live - An Engineering Perspective</a>.&#160;<a class="footnote-backref" href="#fnref:paxosmade" title="Jump back to footnote 10 in the text">&#8617;</a></p>
</li>
<li id="fn:cons_core">
<p><a href="https://martinfowler.com/articles/patterns-of-distributed-systems/consistent-core.html">Consistent Core</a>&#160;<a class="footnote-backref" href="#fnref:cons_core" title="Jump back to footnote 11 in the text">&#8617;</a></p>
</li>
<li id="fn:\\">
<p>O <code>\\</code> no final da linha é só para mostrar que o comando continua na próxima e facilitar a visualização. 
Na hora de executar, use apenas uma linha, sem o <code>\\</code>.&#160;<a class="footnote-backref" href="#fnref:\\" title="Jump back to footnote 12 in the text">&#8617;</a></p>
</li>
</ol>
</div>

  <!-- Last update of source file -->


              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../time/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              Tempo
            </div>
          </div>
        </a>
      
      
        <a href="../disdb/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Próximo
              </span>
              Bancos de Dados
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copiar para \u00e1rea de transfer\u00eancia", "clipboard.copied": "Copiado para \u00e1rea de transfer\u00eancia", "search.config.lang": "pt", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Buscar", "search.result.placeholder": "Digite para iniciar a busca", "search.result.none": "Nenhum resultado encontrado", "search.result.one": "1 resultado encontrado", "search.result.other": "# resultados encontrados", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../javascripts/mathjaxhelper.js"></script>
      
    
  </body>
</html>