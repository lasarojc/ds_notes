


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.1">
    
    
      
        <title>Tolerância a Falhas - Notas em Sistemas Distribuídos</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a676eddb.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-PJX835H7DP","lasarojc.github.org/dsnotes"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tolerancia-a-falhas" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-header-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Notas em Sistemas Distribuídos
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Tolerância a Falhas
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    Notas em Sistemas Distribuídos
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Prólogo" class="md-nav__link">
      Prólogo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../intro/" title="Introdução" class="md-nav__link">
      Introdução
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../basics/" title="Fundamentos" class="md-nav__link">
      Fundamentos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../comm/" title="Comunicação" class="md-nav__link">
      Comunicação
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../arch/" title="Arquiteturas" class="md-nav__link">
      Arquiteturas
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../coord/" title="Coordenação" class="md-nav__link">
      Coordenação
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../time/" title="Tempo" class="md-nav__link">
      Tempo
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Tolerância a Falhas
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="Tolerância a Falhas" class="md-nav__link md-nav__link--active">
      Tolerância a Falhas
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dependabilidade" class="md-nav__link">
    Dependabilidade
  </a>
  
    <nav class="md-nav" aria-label="Dependabilidade">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#falhas-erros-e-defeitos" class="md-nav__link">
    Falhas, Erros e Defeitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root-cause-analysis" class="md-nav__link">
    Root cause analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-alcancar-dependabilidade" class="md-nav__link">
    Como alcançar dependabilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#classes-de-defeitos" class="md-nav__link">
    Classes de Defeitos
  </a>
  
    <nav class="md-nav" aria-label="Classes de Defeitos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quebra" class="md-nav__link">
    Quebra
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omissao" class="md-nav__link">
    Omissão
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporizacao" class="md-nav__link">
    Temporização
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arbitrarios" class="md-nav__link">
    Arbitrários
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarquia" class="md-nav__link">
    Hierarquia
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas-intermitentes" class="md-nav__link">
    Falhas intermitentes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correlacao-entre-falhas" class="md-nav__link">
    Correlação entre falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redundancia-de-processos" class="md-nav__link">
    Redundância de Processos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problemas-de-acordo" class="md-nav__link">
    Problemas de Acordo
  </a>
  
    <nav class="md-nav" aria-label="Problemas de Acordo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uma-historia-de-tres-exercitos" class="md-nav__link">
    Uma história de três exércitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impossibilidade" class="md-nav__link">
    Impossibilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consenso" class="md-nav__link">
    Consenso
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detectores-de-defeitos" class="md-nav__link">
    Detectores de Defeitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#difusao-totalmente-ordenada" class="md-nav__link">
    Difusão Totalmente Ordenada
  </a>
  
    <nav class="md-nav" aria-label="Difusão Totalmente Ordenada">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-do-raft" class="md-nav__link">
    Estudo de Caso do Raft
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-paxos" class="md-nav__link">
    Estudo de Caso: Paxos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outras-ordenacoes" class="md-nav__link">
    Outras Ordenações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arcaboucos-para-coordenacao" class="md-nav__link">
    Arcabouços para coordenação
  </a>
  
    <nav class="md-nav" aria-label="Arcabouços para coordenação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-ratis" class="md-nav__link">
    Estudo de caso: Ratis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-atomix" class="md-nav__link">
    Estudo de caso: Atomix
  </a>
  
    <nav class="md-nav" aria-label="Estudo de caso: Atomix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lambda" class="md-nav__link">
    Lambda
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future" class="md-nav__link">
    Future
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atomix-raft" class="md-nav__link">
    Atomix-Raft
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-zookeeper" class="md-nav__link">
    Estudo de caso: Zookeeper
  </a>
  
    <nav class="md-nav" aria-label="Estudo de caso: Zookeeper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#visao-geral" class="md-nav__link">
    Visão Geral
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#laboratorio" class="md-nav__link">
    Laboratório
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-tolerante-a-falhas" class="md-nav__link">
    Cluster tolerante a falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receitas" class="md-nav__link">
    Receitas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../disdb/" title="Bancos de Dados" class="md-nav__link">
      Bancos de Dados
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../disfs/index.md" title="Sistemas de Arquivos" class="md-nav__link">
      Sistemas de Arquivos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tech/" title="Tecnologias" class="md-nav__link">
      Tecnologias
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../projeto/" title="Projeto" class="md-nav__link">
      Projeto
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dependabilidade" class="md-nav__link">
    Dependabilidade
  </a>
  
    <nav class="md-nav" aria-label="Dependabilidade">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#falhas-erros-e-defeitos" class="md-nav__link">
    Falhas, Erros e Defeitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root-cause-analysis" class="md-nav__link">
    Root cause analysis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#como-alcancar-dependabilidade" class="md-nav__link">
    Como alcançar dependabilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#classes-de-defeitos" class="md-nav__link">
    Classes de Defeitos
  </a>
  
    <nav class="md-nav" aria-label="Classes de Defeitos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quebra" class="md-nav__link">
    Quebra
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#omissao" class="md-nav__link">
    Omissão
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#temporizacao" class="md-nav__link">
    Temporização
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arbitrarios" class="md-nav__link">
    Arbitrários
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarquia" class="md-nav__link">
    Hierarquia
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas-intermitentes" class="md-nav__link">
    Falhas intermitentes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correlacao-entre-falhas" class="md-nav__link">
    Correlação entre falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redundancia-de-processos" class="md-nav__link">
    Redundância de Processos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problemas-de-acordo" class="md-nav__link">
    Problemas de Acordo
  </a>
  
    <nav class="md-nav" aria-label="Problemas de Acordo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uma-historia-de-tres-exercitos" class="md-nav__link">
    Uma história de três exércitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impossibilidade" class="md-nav__link">
    Impossibilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consenso" class="md-nav__link">
    Consenso
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detectores-de-defeitos" class="md-nav__link">
    Detectores de Defeitos
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#difusao-totalmente-ordenada" class="md-nav__link">
    Difusão Totalmente Ordenada
  </a>
  
    <nav class="md-nav" aria-label="Difusão Totalmente Ordenada">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-do-raft" class="md-nav__link">
    Estudo de Caso do Raft
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-paxos" class="md-nav__link">
    Estudo de Caso: Paxos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#outras-ordenacoes" class="md-nav__link">
    Outras Ordenações
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arcaboucos-para-coordenacao" class="md-nav__link">
    Arcabouços para coordenação
  </a>
  
    <nav class="md-nav" aria-label="Arcabouços para coordenação">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-ratis" class="md-nav__link">
    Estudo de caso: Ratis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-atomix" class="md-nav__link">
    Estudo de caso: Atomix
  </a>
  
    <nav class="md-nav" aria-label="Estudo de caso: Atomix">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lambda" class="md-nav__link">
    Lambda
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future" class="md-nav__link">
    Future
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atomix-raft" class="md-nav__link">
    Atomix-Raft
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estudo-de-caso-zookeeper" class="md-nav__link">
    Estudo de caso: Zookeeper
  </a>
  
    <nav class="md-nav" aria-label="Estudo de caso: Zookeeper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#visao-geral" class="md-nav__link">
    Visão Geral
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#laboratorio" class="md-nav__link">
    Laboratório
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster-tolerante-a-falhas" class="md-nav__link">
    Cluster tolerante a falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receitas" class="md-nav__link">
    Receitas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="tolerancia-a-falhas">Tolerância a Falhas</h1>
<h2 id="dependabilidade">Dependabilidade</h2>
<p>Nós escrevemos software para que resolvam problemas de espectro bem amplo, indo, do controle de braços robóticos em cirurgias remotas à sistemas de comércio eletrônico, do controle de usinas hidroelétricas à jogos de truco online.
Independentemente do problema sendo resolvido, gostaríamos de poder contar com o sistema, de poder depender nele para executar sua tarefa.
Desta situação, surge a ideia de dependabilidade, isto é, de um sistema ter a propriedade de se poder depender do mesmo.</p>
<p>Dizemos que um componente <span class="arithmatex">\(C\)</span> depende de um componente <span class="arithmatex">\(C'\)</span> se a corretude do comportamento de <span class="arithmatex">\(C\)</span> depende da corretude do componente <span class="arithmatex">\(C'\)</span>.
E que um componente é "dependável" (<em>dependable</em>) na medida em que outros podem depender dele.
A dependabilidade é essencial aos componentes de sistemas distribuídos, afinal, "uma corrente é tão forte quanto seu elo mais fraco."</p>
<p>De acordo com <a href="https://www.nasa.gov/pdf/636745main_day_3-algirdas_avizienis.pdf">Avizienis et al</a>, tem-se dependabilidade quando os seguintes atributos estão presentes.</p>
<ul>
<li>Disponibilidade (<em>Availability</em>) - Prontidão para uso.</li>
<li>Confiabilidade/Fiabilidade (<em>Reliability</em>) - Continuidade do serviço.</li>
<li>Segurança (<em>Safety</em>) - Tolerância a catástrofes.</li>
<li>Integridade (<em>Integrity</em>) - Tolerância a modificações.</li>
<li>Manutenabilidade (<em>Maintainability</em>) - Facilidade de reparo.</li>
</ul>
<p>Outra propriedade importante neste contexto é a </p>
<ul>
<li><strong>Confidencialidade</strong> (<em>Confidentiality</em>), a garantia de que a informação somente é acessível a quem é devido.</li>
</ul>
<p>A combinação de <strong>Disponibilidade</strong>, <strong>Integridade</strong> e <strong>Confidencialidade</strong> é também chamada de <strong>Segurança</strong> (<em>Security</em>).</p>
<p>Mas o que significa, na prática, ser dependável e seguro (<strong>secure</strong>)? Para respondermos a esta questão, primeiro precisamos entender os tipos de problemas que aparecem em vários níveis, desde o seu desenvolvimento até seu uso.</p>
<h3 id="falhas-erros-e-defeitos">Falhas, Erros e Defeitos</h3>
<p>No nível mais básico dos problemas a serem contornados para se obter dependabilidade, temos as <strong>falhas</strong> (<em>defect</em>, <em>fault</em>, para alguns, falta), que é um erro no desenvolvimento do sistema, como <em>bugs</em> ou defeitos de fabricação, que o leva a ficar diferente do que foi especificado. 
Uma falha existe mesmo se for raramente ativada e mesmo se seus efeitos nunca forem percebidos. 
Por exemplo, se o código tem um <code>&lt;=</code> em vez de <code>&lt;</code> na especificação de uma iteração, mas se uma condição faz com que a iteração seja interrompida antes, o código ainda tem uma falha.</p>
<p>No segundo nível, temos o <strong>erro</strong> (<em>error</em>), que é a manifestação da falha levando a algum comportamento indevido. No exemplo acima, um erro seria quando a iteração passasse do ponto correto por causa do <code>&lt;=</code>, por exemplo, na hora de escrever uma <em>string</em> em um array, estourando o limite do array na pilha mas sobrescrevendo uma variável que não seja mais usada.
O erro pode passar despercebido, mas ainda assim é um erro.</p>
<p>Finalmente, no terceiro nível, temos os <strong>defeitos</strong> (<em>failure</em>, para alguns, falha), um erro percebido pelo usuário. 
Continuando o exemplo, um <em>stack overflow</em> que leva a uma falha de segmentação, leva a um defeito.</p>
<p>Quando um componente manifesta um defeito, outros componentes que dele dependem, internalizarão entradas indevidas, uma falha externa, o que levará a seu próprio estado interno a estar errôneo e possivelmente também manifestar um defeito. 
Esta cadeia pode levar cenários catastróficos.</p>
<div class="admonition example">
<p class="admonition-title">Falhas Famosas</p>
<div class="tabbed-set" data-tabs="1:4"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">Ariane 5</label><div class="tabbed-content">
<p>O Ariane 5 foi um foguete desenvolvido pela agencia espacial européia que explodiu durante o lançamento.</p>
<div class="admonition quote">
<p class="admonition-title">The Explosion of the Ariane 5</p>
<p>On June 4, 1996 an unmanned Ariane 5 rocket launched by the European Space Agency exploded just forty seconds after its lift-off [...] after a decade of development costing $7B. The destroyed rocket and its cargo were valued at $500M. [...] the failure was a software error [...] a 64 bit floating point number [...] was converted to a 16 bit signed integer. The number was larger than 32,767, the largest integer storeable in a 16 bit signed integer, and thus the conversion failed.</p>
</div>
<p><img alt="Explosão" src="images/ariane5.jpg" /></p>
<p>O erro gerado foi tratado como input, causando outros erros, que geraram instabilidade e que levou o sistema a se auto-destruir.</p>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">787 Dreamliner</label><div class="tabbed-content">
<p>O avião 787 dreamliner, da Boeing, tem um problema que tornar necessário reiniciar o sistema elétrico a cada 248 dias, ou o mesmo pode ter uma pane.</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>The plane’s electrical generators fall into a failsafe mode if kept continuously powered on for 248 days. The 787 has four such main generator-control units that, if powered on at the same time, could fail simultaneously and cause a complete electrical shutdown.</p>
</div>
<p>Segundo as "más línguas", o problema é que acontece um <em>overflow</em> em um contador de tempo</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">248 days == 2^31 100ths of a second.<br><br>even in 2015, our airplanes have integer overflow bugs <a href="https://t.co/6Z8d4y9gjM"><a href="https://t.co/6Z8d4y9gjM">https://t.co/6Z8d4y9gjM</a></a></p>&mdash; Fiora @ 日本語でFF14 (@FioraAeterna) <a href="https://twitter.com/FioraAeterna/status/594110518203260929?ref_src=twsrc%5Etfw">May 1, 2015</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>
</div>
</div>
<input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><label for="__tabbed_1_3">737 Max</label><div class="tabbed-content">
<p>Neste outro caso envolvendo a Boeing, um sensor é usado para detectar se o avião estava subindo rápido demais e correndo o risco de perder sustentação, um comportamento que se verificou comum no 737 Max por causa dos grandes motores usados nele e que o diferenciam do 737 original.
Se o risco é detectado, um sistema automatizado força o nariz do avião para baixo para corrigir o problema. 
Contudo, no 737 Max apenas um sensor é usado e no caso de falha do mesmo, o avião é forçado para baixo e em direção ao solo, o que levou à morte de centenas de pessoas.<sup id="fnref:737max"><a class="footnote-ref" href="#fn:737max">1</a></sup></p>
</div>
<input id="__tabbed_1_4" name="__tabbed_1" type="radio" /><label for="__tabbed_1_4">Subaru SUV</label><div class="tabbed-content">
<p>Em 2018 a Subaru fez um <em>recall</em> gigante, de mais de 1 milhão de unidades de um seus modelos de SUV, porquê uma falha em um software fez com que soldagens fossem feitas incorretamente no chassis dos veículos.
O erro era irreparável, levando a grandes prejuízos.</p>
<p><img alt="[Recall Subaru()https://spectrum.ieee.org/riskfactor/computing/it/coding-error-leads-293-subaru-ascents-to-the-car-crusher)]" src="images/subaru.png" /></p>
<!--Car Hack -- 2017, images/carhack, https://www.wired.com/story/car-hack-shut-down-safety-features/-->

</div>
</div>
</div>
<h3 id="root-cause-analysis"><em>Root cause analysis</em></h3>
<p>Quando defeitos aparecem, é importante identificar suas causas, isto é, a cadeia de eventos que o levou a acontecer.
Algumas empresas publicam a <strong><em>root cause analysis</em></strong> ou a análise <em>post-mortem</em> para a comunidade como forma de compartilhar conhecimento e também por questões de transparência.
Veja esta <a href="https://github.com/danluu/post-mortems">compilação</a> para uma extensa lista de análises.</p>
<h3 id="como-alcancar-dependabilidade">Como alcançar dependabilidade</h3>
<p>Falhas são um fato da vida, uma constante no desenvolvimento de sistemas. Mas se o objetivo é a dependabilidade, precisamos de formas de lidar com falhas, <strong>previnindo</strong>, <strong>removendo</strong> e <strong>tolerando</strong>-as.</p>
<p>A <strong>prevenção de falhas</strong> acontece por meio de técnicas bem estabelecidas de engenharia.
No caso de sistemas de software, modularização, linguagens de programação fortemente tipadas e encapsulamento são passos essencias. 
Uso de especificações formais, testadas ou provadas corretas, são outro passo neste sentido. Por exemplo, diversas empresas usam a linguagem <a href="https://lamport.azurewebsites.net/tla/tla.html">TLA<span class="arithmatex">\(^+\)</span></a> para verificar a corretude de seus algoritmos<sup id="fnref:tla_real"><a class="footnote-ref" href="#fn:tla_real">2</a></sup>. 
Outras técnicas envolvidas na prevenção de falhas são análise estática, prova de teoremas, execução simbólica, teste de modelos, etc.</p>
<p>Mesmo uma especificação correta pode produzir um sistema com falhas pois a tradução de especificações formais para código é um passo complexo.
Testes e manutenção do sistema permitem a <strong>remoção de falhas</strong> que passarem despercebidas pelas tentativas de prevenção.</p>
<p>Testes, contudo, apenas aumentam a confiança no sistema, não sendo capazes de certificar a ausência de problemas.
Assim, tenta-se desenvolver os sistemas de forma que, mesmo se falhas ainda estiverem presentes, seus efeitos não sejam percebidos como defeitos, isto é, sistemas que tenha <strong>tolerância a falhas</strong> (ou <strong>prevenção de defeitos</strong>).</p>
<p>Para se alcançar tolerância a falhas é necessário detectar e se recuperar de erros. 
Por exemplo, um sistema de arquivos com <em>journal</em>, como o <a href="https://en.wikipedia.org/wiki/Ext3#Journaling_levels">Ext v3</a>, armazena informação redundantemente e, quando <strong>detecta</strong> que os dados em sua forma principal estão corrompidos, usa o <em>journal</em> para <strong>recuperar</strong> os dados, <strong>mascarando</strong> o erro.</p>
<p>De acordo como Avizienis et al, temos as seguintes técnicas para tolerar falhas:</p>
<p><img alt="Avizienis et al" src="images/laprie_fault_tol.png" /></p>
<p>Um sistema que sofra de falhas recorrentes é um bom candidato a previsão de falhas, em que se estima quando uma falha ocorrerá baseado no histórico.
Por exemplo, um sistema que sofra falha por uso excessivo de memória a cada dez dias em uso, pode ser reiniciado no nono dia, em condições controladas, para evitar problemas maiores enquanto a razão do uso excessivo de memória é corrigido.</p>
<h3 id="classes-de-defeitos">Classes de Defeitos</h3>
<p>Para previnirmos e toleramos com falhas, precisamos entender como se manifestam e, para isso, uma classificação é essencial.</p>
<h4 id="quebra">Quebra</h4>
<p>Falhas de <strong>quebra</strong> (<strong><em>crash</em></strong>) são falhas em que o componente para de funcionar, irreversivelmente.
Uma vez que o componente cessa seu funcionamento, qualquer comunicação com o mesmo é interrompida e pode dar bons indicativos da falha aos outros componentes.
Em um sistema assíncrono, contudo, não há garantias de que esta detecção do defeito será correta.</p>
<p>Alguns sistemas, denominados <strong><em>fail-stop</em></strong>, forçam-se a parar de funcionar quando percebem um defeito, imitando uma quebra, e implementando um comportamento <strong><em>fail-fast</em></strong>.<sup id="fnref:failfastfast"><a class="footnote-ref" href="#fn:failfastfast">3</a></sup>
Estes sistemas podem emitir um "canto do cisne" para permitir que outros componentes detectem o defeito.</p>
<p>Após pararem, alguns sistemas podem aplicar passos de recuperação e voltar a funcionar, no que é denominado <strong><em>fail-recover</em></strong>. Ao retornar à operação, o processo poderia assumir uma nova identidade.</p>
<h4 id="omissao">Omissão</h4>
<p>Em um <strong>defeito de omissão</strong> (<strong><em>omission failure</em></strong>), um componente não executa alguma ação. Por exemplo, uma requisição recebida por um servidor não é executada, um disco não armazena os dados no meio magnético, ou uma mensagem não é transmitida.
Este tipo de defeito é difícil de ser identificado pois outros componentes não necessariamente tem acesso direto ao resultado da operação.
Por exemplo, se o meio de comunicação se recusou a entregar uma mensagem, então houve um defeito de omissão.
Mas se a mensagem é retransmitida até que tenha sua entrega confirmada, então o defeito é mascarado.</p>
<h4 id="temporizacao">Temporização</h4>
<p>Em sistemas em que há limites de tempo para a execução de ações, uma violação destes limites é <strong>defeito de temporização</strong>.
Por exemplo, se o meio de comunicação se recusou a entregar uma mensagem, então houve uma falha de omissão.
Novamente considerando problemas de transmissão de mensagens, se o meio de comunicação se recusou a entregar uma mensagem que deveria ser entregue dentro de 3ms, então houve um defeito de omissão.
Mas se a mensagem é retransmitida até que tenha sua entrega confirmada, mas a mesma é entregue com 5ms, então o mesmo que após o limite para então o defeito é mascarado como um defeito de temporização.</p>
<h4 id="arbitrarios">Arbitrários</h4>
<p>Um defeito <strong>arbitrário</strong> ou <strong>bizantino</strong> é um no qual qualquer comportamento pode acontecer. 
Por exemplo, uma mensagem pode ser modificada, um servidor pode reiniciar-se constantemente, todos os dados podem ser apagados, ou acesso pode ser dado a quem não é devido.
Estes defeitos podem ser causados por agentes mal intencionados, como hackers e vírus.</p>
<h4 id="hierarquia">Hierarquia</h4>
<p>Fail-stop <span class="arithmatex">\(\subset\)</span> Quebra <span class="arithmatex">\(\subset\)</span> Omissão <span class="arithmatex">\(\subset\)</span> Temporização <span class="arithmatex">\(\subset\)</span> Arbitrária</p>
<h3 id="falhas-intermitentes">Falhas intermitentes</h3>
<p>Algumas falhas fogem à classificação acima por terem um comportamento especial, se manifestando de forma intermitente, por causa de eventos esparsos como picos de energia, ou pelo comportamento emergente da interação com outros sistemas.</p>
<div class="admonition quote">
<p class="admonition-title">Heisenbug</p>
<p>The name may seem to rhyme well with Heisenberg, but the Heisenbug is actually "a bug that disappears or alters its behavior when one attempts to probe or isolate it." The Freenet Project describes a Heisenbug in certain Java virtual machines.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Bohrbug</p>
<p>The Bohrbug is a sort of antonym of the Heisenbug, as this bug does not disappear or alter its characteristics when it is researched.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Mandelbug</p>
<p>The Mandelbug, named after Benoit Mandelbrot (think Mandelbrot set), is a bug whose underlying causes are so complex and obscure as to make its behavior appear chaotic.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">Schroedinbug</p>
<p>The Schroedinbug is a design or implementation bug in a program that doesn't manifest until someone reading source or using the program in an unusual way notices that it never should have worked, at which point the program promptly stops working for everybody until fixed. Here, an Office developer describes "stupid SQL tricks" to get rid of a "classic Schroedinbug." </p>
</div>
<h3 id="correlacao-entre-falhas">Correlação entre falhas</h3>
<p>Algumas falhas são ativadas por entradas e, neste caso, mesmo que se tenha várias cópias do mesmo sistema, todas falharão uma vez que a entrada problemática acontecer.
Este é um cenário em que as falhas não são independentes, mas correlatas. Para evitá-lo, podemos usar <strong><em>n-version programming</em></strong>, que consiste basicamente em ter múltiplas implementções do mesmo sistema desenvolvidas de forma independente, isto é, fazendo uso de um ou mais da seguintes opções:</p>
<ul>
<li>múltiplos times</li>
<li>múltiplos sistemas operacionais</li>
<li>múltiplas linguagens de programação.</li>
</ul>
<p>Esta técnica é interessante mais raramente usada, basicamente pelo seu alto custo.
Além disso, erros de especificação são reproduzidos e levam times diferentes a produzir erros iguais.</p>
<!--
### Degradação graciosa

Dependendo dos efeitos e tratamentos.

* Fail safe - defeito não leva a comportamento inseguro (sistema de entretenimento no avião)
* Fail soft - graceful degradation (sistema de controle de vôo)
* Fail fast - para o fluxo de defeitos (e possível reinício)
![Cadeia de supervisão](images/httpatomoreillycomsourceoreillyimages300817.jpg)

* Robusto -- erros não atrapalham execução (tratamento de exceções)
* Quebradiço (*brittle*) -- não resiliente a falhas
-->

<h3 id="redundancia-de-processos">Redundância de Processos</h3>
<p>Se remover todas as possbilidades de defeitos de um componente é algo difícil, apostemos na tolerância a falhas.
De forma geral, tolerância a falhas é obtida por algum tipo de <strong>redundância</strong>. 
Redundância pode ser aplicada em vários níveis, por exemplo, gastando <strong>mais tempo na especificação do projeto</strong>, ou montando um laboratório de testes mais próximo do ambiente de produção.</p>
<p>Outra forma óbvia de redundância é a <strong>replicação</strong> de componentes. Por exemplo, pense no pneu estepe de um carro, no gerador de eletricidade de um hospital.
Replicação permite remover os <strong>pontos únicos de falha</strong> (SPOF, <em>Single Point of Failure</em>), ou seja, componentes não dependáveis.
Seja como for, redundância implica em mais custos, então o grau de redundância a ser utilizado depende de uma análise custo x benefício.</p>
<p>No caso de um sistema distribuído, quando falamos em redundância, normalmente falamos em processos redundantes, cópias ou réplicas, mesmo que não desevolvidos usando <em>n-version programming</em>
Assim, com múltiplas cópias, quando um processo apresenta um defeito, outro podem continuar executando o serviço.
Dois modos clássicos de replicação são o <strong>primário/cópia</strong> e <strong>ativo</strong>.</p>
<p>No caso da replicação <strong>primário/cópia</strong>, também conhecida como <strong>mestre/escravo</strong>, o primário é responsável por lidar com clientes e por informar cópias das modificações de estado.</p>
<p><img alt="ha" src="images/ha-diagram-animated.gif" /></p>
<p>Como as atualizações de estado fluem do primário para a cópia, é possível que a cópia não tenha o estado mais atual.
Para visualizarmos melhor esta situação, vejamos a <strong>replicação em cadeia</strong>, uma generalização de primário/cópia em que os processos se organizam em um sequência para executar operações.</p>
<p><img alt="Chain replication" src="images/chain.png" /></p>
<p><strong>Atualizações</strong> no sistema são sempre <strong>direcionadas ao primário</strong>, a cabeça da sequência. 
<strong>Leituras</strong>, se absolutamente necessitarem dos dados escritos mais recentemente, também devem ser direcionadas à <strong>cabeça</strong>. 
Caso contrário, podem ser direcionadas aos processos na <strong>cauda</strong>, diminuindo a carga de trabalho na cabeça.</p>
<p>No caso da replicação ativa, as <strong>várias cópias executam todos os comandos</strong> enviados para o sistema, estando assim todas aptas a continuar a executar o serviço. 
A técnica de <strong>replicação de máquinas de estados vista no capítulo anterior</strong> é uma materialização da replicação ativa.
Como vimos anteriormente, replicação de máquinas de estados utiliza primitivas de comunicação em grupo, mas as vistas anteriormente não são funcionais principalmente por não serem tolerantes a falhas. Vejamos a porquê é difícil desenvolver primitivas tolerantes a falhas.</p>
<h2 id="problemas-de-acordo">Problemas de Acordo</h2>
<p>Há diversas primitivas de comunicação em grupo, das quais se destaca a <strong>difusão atômica</strong>, primitiva pela qual se pode facilmente implementar replicação de máquina de estados.
Difusão atômica, por sua vez, é equivalente ao problema do <strong>consenso distribuído</strong>, que está no coração da classe de problemas de <strong>acordo</strong>.
Problemas de acordo são aqueles em que processos devem concordar em quais ações executar.
Dependendo do modelo computacional em que o problema deve ser resolvido, soluções vão de triviais a impossíveis.
Vejamos um exemplo.</p>
<h3 id="uma-historia-de-tres-exercitos">Uma história de três exércitos</h3>
<p><strong>Era uma vez</strong> uma cidade estado no alto de uma montanha. 
A despeito de sofrer de falta de água, afinal, estava no alto de uma montanha, a cidade era invejada pelos vizinhos.
Como a cidade era muito bem fortificada, ela poderia se defender de qualquer <strong>ataque em uma única frente</strong>. 
Se atacada em <strong>duas frentes</strong>, contudo, cairia.
Sabendo disso, o rei de uma das cidades vizinhas resolveu tomar a cidade e repartiu suas forças em <strong>dois exércitos</strong> sob o comando de Alice (a sociedade é muito feminista naquela época) e Bastião (sim, Bastião, não Bob).<sup id="fnref:2generalsparadox"><a class="footnote-ref" href="#fn:2generalsparadox">4</a></sup></p>
<p><img alt="Paradoxo dos 2 Generais" src="drawings/2generals.drawio-0.svg" /></p>
<p>Um complicador no ataque é que a <strong>comunicação entre os dois exércitos é feita por mensageiros</strong> que devem contornar a montanha para alcançar o outro exército. 
O trajeto é complexo e cheio de armadilhas e por isso <strong>mensageiros podem se perder</strong> e demorar um longo tempo para chegar ou até mesmo <strong>serem mortos</strong> e nunca entregarem suas mensagens.</p>
<p>Alice, a comandante mais sênior, deve decidir quando atacar, pode exemplo simplesmente ordenando "<strong>Atacar no dia 3, ao nascer do sol.</strong>"
Bastião <strong>obedecerá</strong> a ordem de atacar contanto que esteja certo de que Alice também atacará, e é justamente daí que vem a dificuldade do problema.
Se mensagens podem ser perdidas, <strong>Alice não tem garantias de que Bastião recebeu o comando</strong> e por isso não pode simplesmente considerar como certo o ataque de Bastião.
Como o problema pode ser resolvido?</p>
<p>Uma resposta natural é usar <strong>mensagens de confirmação</strong>. Isto é, quando Bastião recebe uma ordem, envia um mensageiro de volta para Alice com uma confirmação da recepção.
Alice ao receber tal mensagem, sabe que Bastião executará a ordem, correto? Mas não é tão simples assim no caso da ordem de atacar.
Lembre-se que qualquer exército que ataque sozinho, perderá, seja Alice ou Bastião. 
Por isso, ao enviar uma mensagem de confirmação do ataque, Bastião precisa estar certo de que Alice a recebeu, ou atacará sozinho.
Novamente podemos apelar para uma mensagem de confirmação ou, neste caso, uma confirmação da confirmação.
E o problema se reinicia...</p>
<details class="question"><summary>Paradoxo dos 2 Exércitos</summary><ul>
<li><span class="arithmatex">\(A\)</span> e <span class="arithmatex">\(B\)</span> devem concordar na hora do ataque.</li>
<li><span class="arithmatex">\(A\)</span> ataca se estiver certo que <span class="arithmatex">\(B\)</span> atacará.</li>
<li><span class="arithmatex">\(B\)</span> ataca se estiver certo que <span class="arithmatex">\(A\)</span> atacará.</li>
<li>A comunicação por troca de mensagens.</li>
<li>Mensagens podem ser arbitrariamente atrasadas.</li>
<li>Mensagens podem ser perdidas.</li>
</ul>
<p>Como um exército tem certeza que o outro irá atacar?</p>
</details>
<p>Suponhamos que <strong>há um algoritmo correto</strong> que executa uma sequência finita de troca de mensagens em que ao final tanto Alice quanto Bastião estão seguros, e corretos em sua segurança, de que o outro também atacará. Seja <span class="arithmatex">\(n\)</span> o número máximo de mensagens trocadas. 
Em uma execução em que todas as <span class="arithmatex">\(n\)</span> mensagens possíveis são usadas, suponha sem perda de generalidade que Alice enviou a <span class="arithmatex">\(n\)</span>-ésima mensagem.</p>
<p><img alt="Paradoxo dos 2 Generais" src="drawings/2generals.drawio-1.svg" /></p>
<p>Observe que, do ponto de vista de Alice, uma execução do algoritmo em que a nenhuma mensagem é perdida, é indistinguível de uma execução em que a <span class="arithmatex">\(n\)</span>-ésima mensagem é perdida.</p>
<p><img alt="Paradoxo dos 2 Generais" src="drawings/2generals.drawio-2.svg" /></p>
<p>Dado que ao final da primeira execução completa <strong>Alice ataca</strong>, no final da execução onde a mensagem <span class="arithmatex">\(n\)</span> é perdida, Alice também deve atacar.
Mas se o algoritmo é correto, então também <strong>Bastião ataca</strong>, mesmo sem ter recebido a enésima mensagem. Logo, a enésima mensagem é desnecessária ao algoritmo, que deve funcionar com <span class="arithmatex">\(n-1\)</span> mensagens.
Repetindo-se o argumento mais <span class="arithmatex">\(n-1\)</span> vezes, temos que o algoritmo deve funcionar com zero mensagens, o que é um <strong>absurdo</strong>. Logo não existem algoritmos corretos para o problema como definido, isto é, em que mensagens podem ser perdidas; é <strong>impossível</strong> resolver o problema.</p>
<p>Apesar de ser impossível resolver este problema aparentemente simples, devemos fazê-lo frequentemente no mundo real. Como reconciliar estes dois fatos?</p>
<h3 id="impossibilidade">Impossibilidade</h3>
<p>Quando dizemos que é impossível resolver um problema queremos dizer que é impossível produzir um algoritmo que <strong>sempre levará a uma resposta correta</strong>.
Isto quer dizer que podemos produzir algoritmos, mas ou eles às vezes <strong>levarão a respostas incorretas</strong> ou eles às vezes <strong>não levarão a respostas</strong>; ambos podem ser úteis na prática.</p>
<p>Por exemplo, ainda no problema dos exércitos tentando tomar a cidade, suponha que em vez de mandar um único mensageiro com a ordem de ataque, Alice envie 100, ou 200, ou 1000.
A <strong>confiança</strong> de Alice de que Bastião também atcaria, seria muito maior e não precisaria receber uma confirmação de entrega de mensagens.
Esta abordagem faria com com que o ataque funcionasse com uma <strong>certa probabilidade</strong>, mas com uma pequena probabilidade <span class="arithmatex">\(P\)</span> de levar a um ataque fracassado, onde <span class="arithmatex">\(P\)</span> pode ser feita <strong>tão pequena quanto se "queira"</strong>.</p>
<p>Resultados de impossibilidade abundam na área de computação distribuída<sup id="fnref:impossibilidades"><a class="footnote-ref" href="#fn:impossibilidades">5</a></sup> e não podem nos desencorajar de continuar a buscar soluções práticas.</p>
<h3 id="consenso">Consenso</h3>
<p>O problema que os comandantes estão tentando resolver é, essencialmente, o problema do Consenso Distribuído.
Neste problema, cada um de um conjunto de processos propõe um único valor, sua <strong>proposta</strong>. O objetivo é decidir um dentre os valores propostos, garantindo as seguintes propriedades.</p>
<ul>
<li>Validade: Somente um valor proposto pode ser decidido.</li>
<li>Acordo: Se um processo decide-se por <span class="arithmatex">\(v\)</span> e outro por <span class="arithmatex">\(w\)</span>, então <span class="arithmatex">\(v = w\)</span></li>
<li>Terminação: Todo processo não <strong>defeituoso</strong> decide-se.</li>
</ul>
<p>Um processo é defeituoso se apresentou um defeito; como estamos considerando apenas defeitos do tipo quebra, um processo é defeituso se ele parou de funcionar.
Um processo que não é defeituoso é um processo correto.</p>
<p><strong>É impossível resolver deterministicamente o problema do consenso em sistema assíncrono sujeito a falhas</strong><sup id="fnref:flp85"><a class="footnote-ref" href="#fn:flp85">6</a></sup>.
Mas o consenso é resolvido frequentemente em sistemas assíncronos sujeitos a falhas. Isso porque normalmente estes sistemas se comportam sincronamente.
Há diversos algoritmos de consenso que terminam quando o sistema se comporta bem, sendo os mais famosos, atualmente, Raft e <a href="http://paxos.systems/index.html">Paxos</a></p>
<p>A grande razão para que seja impossível chegar a um acordo entre processos neste modelo é a impossibilidade de diferenciar processos defeituosos de processos corretos mas lentos. Em termos do paradoxo dos 2 generais, a resposta do comandante não chegou porquê ele morreu ou porquê ele está demorando para responder?
Os detectores de defeito abstraem este problema.</p>
<h3 id="detectores-de-defeitos">Detectores de Defeitos</h3>
<p>Chandra e Toueg <sup id="fnref:CT96"><a class="footnote-ref" href="#fn:CT96">7</a></sup> introduziram o conceito de <strong>Detectores de Defeitos Não Confiáveis</strong>. 
Um detector de defeitos pode ser visto como <strong>oráculo distribuído</strong>, com módulos acoplados aos processos do sistema e que trabalha determinando o estado funcional dos outros processos.</p>
<details class="todo"><summary>Todo</summary><p>figura</p>
</details>
<p>Os detectores de defeitos <strong>não podem ser implementados em sistemas totalmente assíncronos</strong>. 
Em ambientes parcialmente síncronos, nos quais os processos dispõem de <strong>temporizadores</strong> precisos, um detector pode contar a passagem do tempo nos intervalos de comunicação com outros processos e, considerando um <strong>limite de tempo</strong> para estes intervalos, tentar determinar se tais processos encontram-se defeituosos ou não. 
Esta determinação é por certo imprecisa, e os detectores podem voltar atrás em suas suspeitas tão logo percebam um erro. 
Entretanto, a despeito desta incerteza, a informação provida por estes detectores já é suficiente para que se alcance o consenso, salvo a restrição de que a maioria dos processos não sofra defeitos e que os mesmos provejam certas propriedades mínimas, descritas adiante. 
Os detectores não confiáveis encapsulam, de certa forma, o sincronismo necessário à resolução do consenso.</p>
<p>Chandra e Toueg classificaram os detectores de defeitos segundo suas características de completude (<em>completeness</em>) e acurácia (<em>accuracy</em>), ou seja, a capacidade de suspeitar de um processo defeituoso e a capacidade de não suspeitar de um processo correto, respectivamente. Alguns níveis destas propriedades são descritos a seguir:</p>
<ul>
<li>Completude Forte - A partir de algum instante futuro, todo processo defeituoso é suspeito permanentemente por todos os processos corretos.</li>
<li>Completude Fraca - A partir de algum instante futuro, todo processo defeituoso é suspeito permanentemente por algum processo correto.</li>
<li>Precisão Forte - Todos os processos são suspeitos somente após terem apresentado defeito.</li>
<li>Precisão Fraca - Algum processo correto nunca é suspeito de ter apresentado defeito.</li>
<li>Precisão Eventual Forte - A partir de algum instante futuro, todos os processos são suspeitos somente após apresentarem defeito.</li>
<li>Precisão Eventual Fraca - A partir de algum instante futuro, algum processo ativo nunca é suspeito antes de ter apresentado defeito.</li>
</ul>
<p>Chandra, Hadzilacos e Toueg  demonstram que detector mais fraco com o qual se pode resolver consenso tem as propriedades de completude fraca e acucárias eventual fraca.<sup id="fnref:CHT96"><a class="footnote-ref" href="#fn:CHT96">8</a></sup> 
Este detector, conhecido como <span class="arithmatex">\(\diamont W\)</span> e é implementável em sistemas nos quais há um <strong>limite superior</strong> de tempo para a transmissão de mensagens, <strong>mesmo que este limite seja desconhecido</strong>.
Vários protocolos de consenso utilizam o detector equivalente, <span class="arithmatex">\(\diamond S\)</span>, equivalente ao <span class="arithmatex">\(\diamond W\)</span> mas com completude forte.
Estes protocolos são escritos de forma que se o limite superior não existe, o protocolo não termina; um <strong>resultado errado nunca é alcançado</strong>.</p>
<h3 id="difusao-totalmente-ordenada">Difusão Totalmente Ordenada</h3>
<p>Se pudermos resolver o consenso, podemos então resolver o problema da difusão atômica e com ela implementar a replicação de máquinas de estados.
Relembrando, na difusão Totalmente Ordenada (Total Order Multicast) temos que:</p>
<ul>
<li>Difusão: mensagens são enviadas de 1 para n (comunicação em grupo)</li>
<li>Totalmente Ordenada: todos os processos entregam as mensagens na mesma ordem.</li>
</ul>
<p><img alt="Total order multicast" src="../time/drawings/multicast.drawio-1.svg" /></p>
<p>Para fazermos isso, precisamos primeiro formalizar as primitivas em vários níveis da resolução do problema.
No nível do canal de comunicação, da rede, processos <strong>enviam</strong> e <strong>recebem</strong> mensagens.
No nível do consenso, processos fazem <strong>propostas</strong> e <strong>aprendem</strong> um valor decidido. Para chegar a uma única decisão, várias mensagens podem ser enviadas e recebidas.
No nível da difusão atômica, mensagens são <strong>difundidas</strong> e <strong>entregues</strong>. Se implementado sobre o consenso, para uma difusão ser bem sucedida, uma instância de consenso é necessária.</p>
<div class="admonition note">
<p class="admonition-title">Primitivas de comunicação</p>
<ul>
<li>enviar &amp; receber (<em>send &amp; receive</em>) - rede</li>
<li>propor &amp; decidir (<em>propose &amp; decide</em>) - consenso</li>
<li>difundir &amp; entregar (<em>broadcast &amp; deliver</em>) - difusão</li>
</ul>
</div>
<p><img alt="Total order multicast" src="drawings/abcast.drawio-0.svg" /></p>
<p>Dado infinitas instâncias de consenso, pode-se usá-las para resolver difusão atômica usando o seguinte procedimento:</p>
<ul>
<li>Ordene as instâncias de consenso.</li>
<li>Para difundir mensagem <span class="arithmatex">\(m\)</span>, proponha a mensagem na menor instância <span class="arithmatex">\(i\)</span> em que não tiver visto uma decisão.</li>
<li>Se a decisão de <span class="arithmatex">\(i\)</span> não é <span class="arithmatex">\(m\)</span>, volte para o passo anterior.</li>
<li>Entregue as decisões na ordem das instâncias.</li>
</ul>
<p>No exemplo a seguir, duas mensagens, <span class="arithmatex">\(m\)</span> e <span class="arithmatex">\(m'\)</span> foram <strong>difundidas</strong> pelas aplicações App1 e App2, respectivamente, por meio do módulo de difusão atômica junto a cada aplicação.
O módulo de difusão determina qual a menor instância de consenso ainda não decidida, azul, em que propõem as mensagens.
Ao final da instância de conseno, <span class="arithmatex">\(m\)</span> é decidida e é entregue pelos módulos de difusão.
O módulo ABCast2 insiste na difusão de <span class="arithmatex">\(m'\)</span>, propondo-a na próxima instância, vermelha, que decide <span class="arithmatex">\(m'\)</span> e leva esta mensagem a ser entregue.</p>
<div class="mermaid">sequenceDiagram
    participant App1
    participant ABCast1
    participant Cons1
    participant Cons3
    participant Cons2
    participant ABCast2
    participant App2


    App1 --&gt;&gt;+ ABCast1: difundir m
      App2 --&gt;&gt;+ ABCast2: difundir m'

rect rgb(100,255,255)
    ABCast1 -&gt;&gt;+ Cons1: propor m na inst 1
    ABCast2 -&gt;&gt;+ Cons2: propor m' na inst 1


    Cons1 -&gt;&gt;- ABCast1: decidir m
    Cons2 -&gt;&gt;- ABCast2: decidir m
end
    ABCast1 --&gt;&gt;- App1: entregar m
      ABCast2 --&gt;&gt; App2: entregar m

rect rgba(255,0,0,.5)
    ABCast2 -&gt;&gt;+ Cons2: propor m' na inst 2

    Cons1 -&gt;&gt; ABCast1: decidir m'
    Cons2 -&gt;&gt;- ABCast2: decidir m'
end
    ABCast1 --&gt;&gt; App1: entregar m'
      ABCast2 --&gt;&gt;- App2: entregar m'
</div>

<p>Ambas as aplicações, embora tivessem intenções diferentes sobre qual deveria ser a próxima mensagem entregue, entregam-nas na mesma ordem, isto é, primeiro <span class="arithmatex">\(m\)</span> e depois <span class="arithmatex">\(m'\)</span>.
Se forem usadas como entrada para algum processamento, na ordem em que foram entregues, as aplicações chegarão ao mesmo estado, em algum momento.</p>
<h4 id="estudo-de-caso-do-raft">Estudo de Caso do Raft</h4>
<p>Raft é um protocolo de difusão atômica associado a um protocolo de eleição de líderes.
Líderes são eleitos para mandatos pelo voto de uma maioria de processos, o que garante que nunca existirão dois líderes para um mesmo mandato.
Um mandato se estende enquanto o líder mantiver seus seguidores cientes de sua presença, o que faz pelo envio periódico de <em>heartbeats</em>.
Atrasos na comunicação ou a falha do líder atual levam a uma suspeita de que o líder falhou, levando a nova eleição e novo mandado.
A comunicação necessária para implementar a difusão atômica acontece em <em>piggyback</em> nos <em>heartbeats</em>.</p>
<p>No tutorial <a href="http://thesecretlivesofdata.com/raft/">The Secret lives of data</a>, podemos ver com mais detalhes como o protocolo funciona.
O tutorial, entretando, foge da nomenclatura padrão da área usando <em>log-replication</em> no lugar de difusão atômica (ou totalmente ordenada).</p>
<h4 id="estudo-de-caso-paxos">Estudo de Caso: Paxos</h4>
<details class="todo"><summary>Paxos</summary><ul>
<li>Sínodo (Synod): consenso</li>
<li>Paxos: Difusão Atômica</li>
</ul>
</details>
<h3 id="outras-ordenacoes">Outras Ordenações</h3>
<p>Como colocado diversas vezes, se todos os processos executam a mesma sequência de comandos determinísticos, todos avançam pelos mesmos estados, implementando a técnica da replicação de máquinas de estados.
Se usada em um sistema de arquivos, por exemplo, a seguinte sequência de comandos levará sempre ao estado final em que há um arquivo <code>/tmp/file2</code> e uma pasta denominada <code>/dir1</code>.</p>
<ul>
<li><code>touch /tmp/file1</code></li>
<li><code>echo "teste testando" &gt;&gt; /tmp/file2</code></li>
<li><code>rm /tmp/file1</code></li>
<li><code>mkdir /dir1</code></li>
</ul>
<p>Há outras ordens dos mesmos comandos que levariam ao mesmo efeito, como a seguinte. Alguns protocolos de replicação de máquinas de estados permitem que reordenações ocorram, desde que não afetem o resultado final dos comandos. 
Contudo, estes protocolos são mais complexos de se implementar e por isso raramente usados.</p>
<ul>
<li><code>echo "teste testando" &gt;&gt; /tmp/file2</code></li>
<li><code>mkdir /dir1</code></li>
<li><code>touch /tmp/file1</code></li>
<li><code>rm /tmp/file1</code></li>
</ul>
<h3 id="arcaboucos-para-coordenacao">Arcabouços para coordenação</h3>
<p>Caso você queira implementar a replicação de máquinas de estados ou qualquer outro solução que possa ser construída sobre primitivas de comunicação em grupo, você tem a opção de implementar um protocolo de difusão atômica desde o zero.
A tarefa, contudo, é ingrata.<sup id="fnref:paxosmade"><a class="footnote-ref" href="#fn:paxosmade">9</a></sup>
Felizmente também tem a opção de usar arcabouços prontos tanto para para comunicação em grupo quanto para diversos outros problemas de coordenaç!ao coordenação comuns em sistemas distribuídos.</p>
<h4 id="estudo-de-caso-ratis">Estudo de caso: Ratis</h4>
<div class="admonition todo">
<p class="admonition-title">Todo</p>
</div>
<h4 id="estudo-de-caso-atomix">Estudo de caso: Atomix</h4>
<ul>
<li>Framework de replicação de máquinas de estados implementada pela Atomix. </li>
<li>Implementação do Raft</li>
<li>API simples</li>
<li>Java 8 (lambdas e futures)</li>
<li><a href="http://atomix.io/copycat/">Página Web</a></li>
</ul>
<h5 id="lambda">Lambda</h5>
<ul>
<li>
<p>Classe com um único método.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">Tarefa</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bem vindo a um loop infinito&quot;</span><span class="p">);</span>
    <span class="p">}</span>   
<span class="p">}</span>

<span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Tarefa</span><span class="p">()).</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table></p>
</li>
<li>
<p>Classe anônima - uso único
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">new</span> <span class="n">Thread</span><span class="p">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bem vindo a um loop infinito&quot;</span><span class="p">);</span>
  <span class="p">}</span>   
<span class="p">}).</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table></p>
</li>
<li>
<p>Lambda
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span>
                     <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
                       <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bem vindo a um loop infinito&quot;</span><span class="p">);</span>
                   <span class="p">}).</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table></p>
</li>
<li>
<p>Encadeamento (fluent)
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>   <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Pessoa</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="p">...;</span>
   <span class="n">c</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
    <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="p">.</span><span class="na">idade</span> <span class="o">&gt;</span> <span class="mi">33</span><span class="p">)</span>
    <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Pessoa</span><span class="p">::</span><span class="n">sobrenomeNome</span><span class="p">)</span><span class="c1">//.map(p -&gt; p.sobrenomeNome())</span>
    <span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
</code></pre></div>
</td></tr></table></p>
</li>
</ul>
<h5 id="future">Future</h5>
<ul>
<li>
<p>Promessa de computação e resultado.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="p">.</span><span class="na">newSingleThreadExecutor</span><span class="p">();</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">futFib</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Fibonacci</span><span class="p">(</span><span class="mi">217</span><span class="p">)};</span>
</code></pre></div>
</td></tr></table></p>
</li>
<li>
<p>Quando será executado?  Em algum momento.</p>
</li>
<li>
<p>Como pegar o resultado? 
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">futFib</span><span class="p">.</span><span class="na">isDone</span><span class="p">())</span>
  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;tah calculando...&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">fib217</span> <span class="o">=</span> <span class="n">futFib</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
</td></tr></table></p>
</li>
<li>
<p>Em qual thread?  Em algum thread. Depende do Executor Service usado.  </p>
</li>
</ul>
<h5 id="atomix-raft">Atomix-Raft</h5>
<ul>
<li>
<p>Versão &gt;= 2 do copycat</p>
<ul>
<li>Melhor desempenho</li>
<li>Documentação ruim</li>
<li><a href="https://github.com/atomix/atomix">https://github.com/atomix/atomix</a></li>
</ul>
</li>
<li>
<p>Versão 1.1.4</p>
<ul>
<li>Baseado em <a href="http://atomix.io/copycat/docs/getting-started/">http://atomix.io/copycat/docs/getting-started/</a> e <a href="https://www.baeldung.com/atomix">https://www.baeldung.com/atomix</a></li>
<li>Código funcional em <a href="https://github.com/pluxos/atomix_labs">https://github.com/pluxos/atomix_labs</a></li>
</ul>
</li>
<li>
<p>Clone e compile o projeto}</p>
<ul>
<li>Instale dependências: git, maven e JDK &gt;= 1.8 (lembre-se que gRPC precisa de JDK &lt;= 1.8)</li>
<li><code>git clone https://github.com/pluxos/atomix_labs</code></li>
<li><code>cd atomix_labs</code></li>
<li><code>cd replication</code></li>
<li><code>mvn compile</code></li>
<li><code>mvn test</code></li>
</ul>
</li>
</ul>
<p>Resultado esperado.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Tests run: <span class="m">1</span>, Failures: <span class="m">0</span>, Errors: <span class="m">0</span>, Skipped: <span class="m">0</span>

<span class="o">[</span>INFO<span class="o">]</span> ---------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> BUILD SUCCESS
<span class="o">[</span>INFO<span class="o">]</span> ---------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> Total time: <span class="m">6</span>.898 s
<span class="o">[</span>INFO<span class="o">]</span> Finished at: <span class="m">2017</span>-10-25T08:38:08-02:00
<span class="o">[</span>INFO<span class="o">]</span> Final Memory: 15M/159M
<span class="o">[</span>INFO<span class="o">]</span> ---------------------------------------
</code></pre></div>
</td></tr></table>

<p>Explore o projeto na pasta/URL <a href="https://github.com/pluxos/atomix_labs/tree/master/replication/src/main/java/atomix_lab/state_machine">https://github.com/pluxos/atomix_labs/tree/master/replication/src/main/java/atomix_lab/state_machine</a>)
Há três pastas. Analise-as nesta ordem</p>
<ul>
<li>type - tipos dos dados mantidos pela replica (Edge e Vertex)<br />
   Os tipos são serializable para que o Java saiba como transformá-los em bytes.</li>
<li>command - estruturas que contêm informações para modificar os tipos<br />
    Os comandos serão enviadas do cliente para o cluster e são naturalmente serializable.</li>
<li>client - cria comandos e os envia para serem executados no cluster<br />
    Respostas podem ser esperadas síncrona ou assincronamente.</li>
<li>server - recebe os comandos na ordem definida pelo Raft e os executa</li>
</ul>
<p>O projeto foi construído seguindo as instruções no tutorial mencionado antes, saltando-se a parte dos snapshots, isto é:</p>
<ul>
<li>crie um projeto maven<br />
    eclipse tem template para isso</li>
<li>adicione dependências no pom.xml<br />
    como so criei um projeto, coloquei as dependências tanto do cliente quando do servidor</li>
<li>defina Command que modifiquem o estado das réplicas</li>
<li>defina Queries que consultem o estado das réplicas</li>
<li>implemente a réplica para lidar com os comandos</li>
<li>implemente o cliente para emitir comandos</li>
</ul>
<p>Para executar um servidor, você precisa passar como parâmetro</p>
<ul>
<li>identificador do processo (inteiro)</li>
<li>IP do processo com identificador 0</li>
<li>porta do processo com identificar 0</li>
<li>IP do processo com identificador 1</li>
<li>porta do processo com identificar 1</li>
<li>...</li>
</ul>
<p>Sabendo seu identificador, o servidor sabe em qual porta escutar e em quais IP/porta se conectar.</p>
<p>Execute três servidores. Usando o maven, da linha de comando, fica assim:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.server.GraphStateMachine&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;0 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>

mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.server.GraphStateMachine&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;1 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>

mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.server.GraphStateMachine&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;2 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>
</code></pre></div>
</td></tr></table>

<p>O cliente não precisa de um identificador, apenas dos pares IP/porta dos servidores.</p>
<ul>
<li>IP do processo com identificador 0</li>
<li>porta do processo com identificar 0</li>
<li>IP do processo com identificador 1</li>
<li>porta do processo com identificar 1</li>
<li>...</li>
</ul>
<p>Para executá-lo, use o comando</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>mvn exec:java 
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.client.GraphClient&quot;</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>
</code></pre></div>
</td></tr></table>

<div class="admonition exercise">
<p class="admonition-title">Exercício</p>
<p>Uma vez executado o projeto, modifique-o para incluir uma nova operação (Command) e nova consulta (Query). </p>
</div>
<h4 id="estudo-de-caso-zookeeper">Estudo de caso: Zookeeper</h4>
<p>Porquê sistemas distribuídos são como zoológicos, com animais de diversas espécies, sendo obrigados a conviver de forma anti-natural, foi criado o <a href="http://zookeeper.apache.org/">Zookeeper</a></p>
<p><img alt="http://zookeeper.apache.org/" src="images/zklogo.jpeg" /></p>
<h5 id="visao-geral">Visão Geral</h5>
<div class="admonition quote">
<p class="admonition-title">O quê?</p>
<p>ZooKeeper is a <strong>centralized</strong> service for maintaining <strong>configuration</strong> information, <strong>naming</strong>, providing distributed <strong>synchronization</strong>, and providing <strong>group services</strong>. All of these kinds of services are used in some form or another by <strong>distributed applications</strong>. Each time they are implemented there is a lot of work that goes into fixing the bugs and race conditions that are inevitable. Because of the difficulty of implementing these kinds of services, applications initially usually skimp on them, which make them brittle in the presence of change and difficult to manage. Even when done correctly, different implementations of these services lead to management <strong>complexity</strong> when the applications are deployed.</p>
</div>
<p>O arcabouço foi criado pelo <a href="http://www.yahoo.com">Yahoo!</a> para servir como peça na construção de sistemas distribuídos dentro da empresa.</p>
<div class="admonition quote">
<p class="admonition-title">Por quê?</p>
<p>Coordination services are notoriously hard to get right. They are especially prone to errors such as race conditions and deadlock. The motivation behind ZooKeeper is to relieve distributed applications the responsibility of implementing coordination services from scratch.</p>
</div>
<p>Mais tarde o sistema tornou-se <em>Open Source</em> e tornou-se parte de diversos projetos, também abertos e proprietários.
A razão de seu sucesso, arrisco dizer, é a simplicidade de sua API, semelhante a um sistema de arquivos.</p>
<div class="admonition quote">
<p class="admonition-title">Como?</p>
<p>ZooKeeper is a <strong>distributed</strong>, open-source <strong>coordination service for distributed applications</strong>. It exposes a <strong>simple set of primitives</strong> that distributed applications can build upon to implement higher level services for synchronization, configuration maintenance, and groups and naming. It is designed to be easy to program to, and uses a data model styled after the familiar <strong>directory tree structure of file systems*. It runs in Java and has bindings for both **Java</strong> and <strong>C</strong>.</p>
<p>ZooKeeper allows distributed processes to coordinate with each other through a <strong>shared hierarchal namespace which is organized similarly to a standard file system</strong>. The name space consists of data registers - called <strong>znodes</strong>, in ZooKeeper parlance - and these are <strong>similar to files and directories</strong>. Unlike a typical file system, which is designed for storage, ZooKeeper data is kept <strong>in-memory</strong>, which means ZooKeeper can achieve <strong>high throughput and low latency</strong> numbers.</p>
</div>
<p>O sistema de arquivos do Zookeeper tem nós denominados <strong>znodes</strong>, em referência aos i-nodes do mundo Unix.
O znode raiz é denominado <code>/</code> e um filho da raiz nomeado <code>teste</code> é referido como <code>/teste</code>.
Cada znode pode ser visto como <strong>arquivo</strong> e <strong>diretório</strong> ao mesmo tempo.</p>
<p><img alt="" src="images/zknamespace.jpg" /></p>
<p>O sistema de arquivos do Zookeeper é replicado em vários nós.</p>
<p><img alt="" src="images/zkservice.jpg" /></p>
<p>Znodes são manipulados, essencialmente, por 4 operações</p>
<ul>
<li>C: create</li>
<li>R: get</li>
<li>U: set</li>
<li>D: delete</li>
<li>ls *: get children</li>
</ul>
<p>Znodes são lidos e escritos sempre integralmente. Isto é, não se pode escrever apenas parte do conteúdo do "arquivo". Por isso, recomenda-se que os arquivos sejam sempre pequenos, onde pequeno é relativo.</p>
<p>Os comandos que atualizam dados, como <strong>create</strong> e <strong>delete</strong> são enviados para todas as réplicas via o protocolo ZAB, Zookeeper Atomic Broadcast, que entrega as mensagens de forma totalmente ordenada. O sistema de arquivos é, portanto, uma máquina de estados replicada.
Já comandos de leitura são executados direto na réplica que os recebe.</p>
<p><img alt="" src="images/zkcomponents.jpg" /></p>
<p>Por causa do custo em termos de mensagens trocadas entre os processos para mensagens de atualização e pelo baixo custo das mensagens de leitura, o zookeeper é recomendado para cargas de trabalho com poucas escritas.</p>
<div class="admonition quote">
<p class="admonition-title">Desempenho</p>
<p>ZooKeeper is fast [...] and it performs best where reads are more common than writes, at ratios of around 10:1.</p>
</div>
<p>O gráfico seguinte mostra como o desempenho do sistema varia com o número de processos.
No eixo Y, a quantidade de requisições processadas por segundo, ou seja, a vazão.
No eixo X, a percentagem das requisições do teste que são leituras e, portanto, repondidas na réplica em que são recebidas.
As diferentes curvas mostram diferentes configurações do sistema, indo de 3 a 12 réplicas.</p>
<p><img alt="" src="images/zkperfRW_3_2.jpg" /></p>
<p>Em geral, todas as configurações apresentam melhor desempenho quando há uma percentagem maior de leituras.
Mas observe como as curvas se invertem, se focando primeiro na curva para 3 servidores: quando todas as operações são de escrita, e portanto precisam passar pelo protocolo de difusão atômica, esta curva apresenta os melhores resultados. Isto ocorre porquê o <em>overhead</em> de executar o protocolo é mais baixo entre 3 servidores que entre 13. Em compensação, quando temos mais leituras, que não precisam de sincronização, então ter mais servidores é mais vantajoso pois sobre menos carga de trabalho para cada servidor.</p>
<h5 id="laboratorio">Laboratório</h5>
<p>Instale o Zookeeper em sua máquina seguindo estas instruções.</p>
<ul>
<li>Baixe: <code>wget www-eu.apache.org/dist/zookeeper/zookeeper-3.6.2</code></li>
<li>Descomprima: <code>tar xvzf zookeeper*.tgz</code></li>
<li>Entre na pasta criada.</li>
<li>Configure: copie o arquivo <code>conf/zoo_sample.cfg</code> para <code>conf/zoo.cfg</code></li>
<li>Execute<ul>
<li><code>./bin/zkServer.sh start-foreground</code> em um terminal</li>
<li><code>./bin/zkCli.sh -server 127.0.0.1:2181</code> em outro terminal</li>
</ul>
</li>
</ul>
<p>Do shell do programa cliente (executado por último), digite <code>help</code> e enter para ver uma lista de todos os comandos disponíveis.
Vejamos alguns exemplos básicos.</p>
<ul>
<li><code>ls /</code> - lista os nós filhos da raiz.</li>
<li><code>create /teste lala</code> - cria o nó <code>/teste</code> com conteúdo <code>lala</code></li>
<li><code>get /teste</code> - pega o conteúdo do arquivo</li>
<li><code>set /teste lele</code> - atualiza o conteúdo do arquivo</li>
<li><code>delete /teste</code> - apaga o arquivo</li>
</ul>
<p>Outros comandos interessantes são:</p>
<ul>
<li><code>stat /teste</code> - mostra medatados do arquivo, por exemplo versão, e <em>timestamps</em></li>
<li><code>set -v V /teste lili</code> - faz um update condiciona, isto é, atualiza o conteúdo do arquivo se a versão do mesmo, como mostrada pelo comando <code>stat</code>, for igual a <code>V</code></li>
</ul>
<h6>Nós Efêmeros e Watches</h6>
<p>O Zookeeper tem muitas funcionalidades interessantes, mas chamarei a atenção a duas que são particularmente úteis:</p>
<p>Nós <strong>efêmeros</strong>, criados com a flag <code>-e</code>, p.e., <code>create -ef /teste/noefemero efemero</code>, são automaticamente destruídos quando o cliente que os criou se desconecta do servidor. E <strong>watches</strong> avisam ao cliente quando uma operação em um certo znode ou em seus filhos acontece. Para ser avisado quando os dados de um nó forem alterados, use a opção <code>-w</code> do get, por exemplo, <code>get -w /teste</code>. Para monitorar alterações no conjunto de filhos de um nó, use <code>-w</code> no <code>ls</code>, por exemplo, <code>ls -w /teste</code>.</p>
<div class="admonition exercise">
<p class="admonition-title">Nós Efêmeros e Watches</p>
<ul>
<li>Crie um zNode /teste</li>
<li>
<p>Debaixo de /teste, crie três outros, sequenciais</p>
</li>
<li>
<p>Crie um zNode /teste2</p>
</li>
<li>Crie um zNode efêmero</li>
<li>Conecte-se com outro cliente</li>
<li>Coloque um watch em /teste2</li>
<li>Desconecte o primeiro cliente</li>
<li>Observe o evento gerado no segundo cliente</li>
<li>Reconecte o primeiro cliente</li>
</ul>
</div>
<h5 id="cluster-tolerante-a-falhas">Cluster tolerante a falhas</h5>
<p>Observe que você está executando o Zookeeper em apenas um nó, ou seja, não há tolerância a falhas alguma aqui.
Para tolerar falhas, você precisa de um cluster multi-nós, mesmo que seja em uma única máquina. 
Neste caso, crie três arquivos de configuração, <code>zoo1.cfg</code>, <code>zoo2.cfg</code> e <code>zoo3.cfg</code>. O arquivo <code>zooX.cfg</code>, onde <code>1 &lt;= X &lt;= 3</code>, fica assim:</p>
<ul>
<li><code>dataDir=/tmp/lasaro/zooX #Substitua o X pelo valor correto</code></li>
<li><code>server.1=zoo1:2888:3888</code></li>
<li><code>server.2=zoo2:2889:3889</code></li>
<li><code>server.3=zoo3:2890:3890</code></li>
<li><code>clientPort=218X #Substitua o X pelo valor correto</code></li>
</ul>
<p>Crie diretórios e arquivos de identificação.</p>
<ul>
<li><code>mkdir /tmp/lasaro/zooX</code></li>
<li><code>echo X &gt; /tmp/lasaro/zooX/myid</code></li>
</ul>
<p>Execute servidores.</p>
<ul>
<li><code>./bin/zkServer.sh start conf/zooX.cfg</code></li>
</ul>
<p>Ainda que tenha três servidores executando em uma mesma máquina, seu cluster parará de funcionar se a máquina parar de funcionar. O ideal é que cada servidor execute em uma máquina distinta.</p>
<h5 id="receitas">Receitas</h5>
<p>É possível resolver diversos problemas encontrados em sistemas distribuídos usando-se o ZooKeeper, por exemplo, o problema de descoberta de processos.</p>
<div class="admonition example">
<p class="admonition-title">Rendezvous</p>
<p>Ponto de encontro de processos. </p>
<ul>
<li>Defina um zNode raiz a ser usado: /rendezvous/app1/ </li>
<li>Cada filho de /rendezvous/app1 corresponde a um processo:<ul>
<li>IP</li>
<li>Porta</li>
<li>Número de processadores</li>
<li>...</li>
</ul>
</li>
<li>Processo p ao ser iniciado:<ul>
<li>procura /rendezvous/app1/p</li>
<li>se achar, continua</li>
<li>se não achar, cria /rendezvous/app1/p</li>
</ul>
</li>
<li>lista os filhos de /rendezvous/app1</li>
</ul>
</div>
<p>Como lidar com saída de processos?
Faça todos os zNodes são efêmeros.
Quando um nó é desconectado, o zNode correspondente será destruído.</p>
<p>Como detectar mudanças no grupo de processos?</p>
<p>Monitore os filhos de /rendezvous/app1<br />
Sempre que receber notificações, refaça o cálculo do <strong><em>membership</em></strong>.</p>
<p>Eleição de Líderes
Rendezvous.
Faça os zNodes sequenciais.
Ordene os zNodes e escolha o primeiro.
Monitore o zNode. Se ele sumir, eleja outro líder.</p>
<div class="admonition exaple">
<p class="admonition-title">Exclusão Mútua</p>
<p>Construa uma fila usando nós efêmeros e sequenciais. O processo na cabeça da fila tem direito de acesso. Em caso de falhas, o processo é removido da cabeça da fila.</p>
</div>
<p>Várias outras receitas podem ser facilmente encontradas no <a href="http://zookeeper.apache.org/doc/trunk/recipes.html">sítio do projeto</a>:</p>
<ul>
<li>Lock distribuído</li>
<li>Filas, e.g. de prioridades</li>
<li>Barreira</li>
<li>Serviço de nomes</li>
<li>Terminação em duas fases</li>
<li>Contador atômico</li>
</ul>
<p>Além destas, outro projeto, o <a href="http://curator.apache.org">Curator</a> se dedica apenas a colecionar implementações corretas de receitas para o Zookeeper.</p>
<details class="todo"><summary>Todo</summary></details>
<div class="footnote">
<hr />
<ol>
<li id="fn:737max">
<p><a href="https://theconversation.com/boeing-737-max-why-was-it-grounded-what-has-been-fixed-and-is-it-enough-150688">Boeing 737 Max: why was it grounded, what has been fixed and is it enough?</a>&#160;<a class="footnote-backref" href="#fnref:737max" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:tla_real">
<p><a href="https://probablydance.com/2020/10/31/using-tla-in-the-real-world-to-understand-a-glibc-bug/"><em>Using TLA+ in the Real World to Understand a Glibc Bug</em></a>&#160;<a class="footnote-backref" href="#fnref:tla_real" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:failfastfast">
<p><a href="https://pathelland.substack.com/p/fail-fast-is-failing-fast">Fail Fast Is Failing… Fast!</a>&#160;<a class="footnote-backref" href="#fnref:failfastfast" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:2generalsparadox">
<p>Esta é uma variação do problema de coordenação de <em>gangsters</em> apresentado no em <a href="https://doi.org/10.1145%2F800213.806523">Some constraints and trade-offs in the design of network communications</a>&#160;<a class="footnote-backref" href="#fnref:2generalsparadox" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:impossibilidades">
<p><a href="https://groups.csail.mit.edu/tds/papers/Lynch/MIT-LCS-TM-394.pdf">Hundred Impossibility Proofs for Distributed Computing</a>, <a href="https://doi.org/10.2200/S00551ED1V01Y201311DCT012">Impossibility Results for Distributed Computing</a>&#160;<a class="footnote-backref" href="#fnref:impossibilidades" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:flp85">
<p><a href="https://groups.csail.mit.edu/tds/papers/Lynch/jacm85.pdf">Impossibility of Distributed Consensus with One Faulty Process</a>. Uma explicação da prova está disponível no <a href="https://www.the-paper-trail.org/post/2008-08-13-a-brief-tour-of-flp-impossibility/">Paper Trail</a>&#160;<a class="footnote-backref" href="#fnref:flp85" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:CT96">
<p><a href="https://www.cs.utexas.edu/~lorenzo/corsi/cs380d/papers/p225-chandra.pdf">Unreliable Failure Detectors for Reliable Distributed Systems</a>&#160;<a class="footnote-backref" href="#fnref:CT96" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:CHT96">
<p><a href="https://www.cs.utexas.edu/~lorenzo/corsi/cs380d/papers/weakestfd.pdf">The Weakest Failure Detector for Solving Consensus</a>&#160;<a class="footnote-backref" href="#fnref:CHT96" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
<li id="fn:paxosmade">
<p>Um exemplo de como traduzir um algoritmo complexo para código pode se ingrato é reportado em <a href="https://www.cs.utexas.edu/users/lorenzo/corsi/cs380d/papers/paper2-1.pdf">Paxos Made Live - An Engineering Perspective</a>.&#160;<a class="footnote-backref" href="#fnref:paxosmade" title="Jump back to footnote 9 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../time/" title="Tempo" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Tempo
              </div>
            </div>
          </a>
        
        
          <a href="../disdb/" title="Bancos de Dados" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Bancos de Dados
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.c51dfa35.min.js"></script>
      <script src="../assets/javascripts/bundle.eaaa3931.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.58d22e8e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../javascripts/mathjaxhelper.js"></script>
      
    
  </body>
</html>