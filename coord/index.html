
<!doctype html>
<html lang="pt" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Coordenação - Notas em Sistemas Distribuídos</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-PJX835H7DP","lasarojc.github.org/dsnotes"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#concorrencia" class="md-skip">
          Ir para o conteúdo
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-header__button md-logo" aria-label="Notas em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Notas em Sistemas Distribuídos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Coordenação
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Buscar" placeholder="Buscar" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Notas em Sistemas Distribuídos
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../preface/" class="md-nav__link">
        Prefácio
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Comunicação
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Comunicação" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Comunicação
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../comm/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../comm/redes/" class="md-nav__link">
        Redes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../comm/internet/" class="md-nav__link">
        Internet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../comm/sockets/" class="md-nav__link">
        Sockets
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../comm/datarep/" class="md-nav__link">
        Representação
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../comm/middleware/" class="md-nav__link">
        Middlewares
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../comm/rpc/" class="md-nav__link">
        RPC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../comm/mom/" class="md-nav__link">
        MOM
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../comm/epidemics/" class="md-nav__link">
        Epidêmicos
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../comm/refs/" class="md-nav__link">
        Referências
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../arch/" class="md-nav__link">
        Arquiteturas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/" class="md-nav__link">
        Modelos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../p2p/" class="md-nav__link">
        P2P
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../microservices/" class="md-nav__link">
        Microsserviços
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Coordenação
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Coordenação
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#concorrencia" class="md-nav__link">
    Concorrência
  </a>
  
    <nav class="md-nav" aria-label="Concorrência">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cliente" class="md-nav__link">
    Cliente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servidor" class="md-nav__link">
    Servidor
  </a>
  
    <nav class="md-nav" aria-label="Servidor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-threaded" class="md-nav__link">
    Single-threaded
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-per-request" class="md-nav__link">
    Thread per request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-pool" class="md-nav__link">
    Thread pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estagios" class="md-nav__link">
    Estágios
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#desafios" class="md-nav__link">
    Desafios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estado" class="md-nav__link">
    Estado
  </a>
  
    <nav class="md-nav" aria-label="Estado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sessao" class="md-nav__link">
    Sessão
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas" class="md-nav__link">
    Falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stateless-x-stateful" class="md-nav__link">
    Stateless x Stateful
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multithread-na-pratica" class="md-nav__link">
    Multithread na prática
  </a>
  
    <nav class="md-nav" aria-label="Multithread na prática">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#posix" class="md-nav__link">
    POSIX
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    Python
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java" class="md-nav__link">
    Java
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coordenacao" class="md-nav__link">
    Coordenação
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coordenacao_1" class="md-nav__link">
    Coordenação
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exclusao-mutua" class="md-nav__link">
    Exclusão Mútua
  </a>
  
    <nav class="md-nav" aria-label="Exclusão Mútua">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#coordenador" class="md-nav__link">
    Coordenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anel" class="md-nav__link">
    Anel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lidando-com-falhas" class="md-nav__link">
    Lidando com Falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quorum" class="md-nav__link">
    Quórum
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eleicao-de-lideres" class="md-nav__link">
    Eleição de Líderes
  </a>
  
    <nav class="md-nav" aria-label="Eleição de Líderes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#algoritmo-do-brigao-bully" class="md-nav__link">
    Algoritmo do Brigão (Bully)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#algoritmos-em-aneis" class="md-nav__link">
    Algoritmos em Anéis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#algoritmo-do-yoyo" class="md-nav__link">
    Algoritmo do YoYo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#questoes-importantes" class="md-nav__link">
    Questões importantes
  </a>
  
    <nav class="md-nav" aria-label="Questões importantes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#split-brain" class="md-nav__link">
    Split-brain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estabilidade" class="md-nav__link">
    Estabilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deteccao-de-falhas" class="md-nav__link">
    Detecção de falhas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../time/" class="md-nav__link">
        Tempo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../fault/" class="md-nav__link">
        Tolerância a Falhas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../consistency/" class="md-nav__link">
        Consistência
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../disdb/" class="md-nav__link">
        Bancos de Dados
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../disfs/" class="md-nav__link">
        Sistemas de Arquivos
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14" type="checkbox" id="__nav_14" >
      
      <label class="md-nav__link" for="__nav_14">
        Estudos de Caso
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Estudos de Caso" data-md-level="1">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          Estudos de Caso
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cases/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cases/cassandra/" class="md-nav__link">
        Cassandra
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cases/chord/" class="md-nav__link">
        Chord
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cases/dynamo/" class="md-nav__link">
        Dynamo
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cases/grpc/" class="md-nav__link">
        gRPC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cases/mosquito/" class="md-nav__link">
        Mosquito
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cases/rmi/" class="md-nav__link">
        RMI
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cases/thrift/" class="md-nav__link">
        Thrift
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cases/refs/" class="md-nav__link">
        Referências
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tech/" class="md-nav__link">
        Tecnologias
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../projeto/" class="md-nav__link">
        Projeto
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#concorrencia" class="md-nav__link">
    Concorrência
  </a>
  
    <nav class="md-nav" aria-label="Concorrência">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cliente" class="md-nav__link">
    Cliente
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servidor" class="md-nav__link">
    Servidor
  </a>
  
    <nav class="md-nav" aria-label="Servidor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-threaded" class="md-nav__link">
    Single-threaded
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-per-request" class="md-nav__link">
    Thread per request
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#thread-pool" class="md-nav__link">
    Thread pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estagios" class="md-nav__link">
    Estágios
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#desafios" class="md-nav__link">
    Desafios
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estado" class="md-nav__link">
    Estado
  </a>
  
    <nav class="md-nav" aria-label="Estado">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sessao" class="md-nav__link">
    Sessão
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#falhas" class="md-nav__link">
    Falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stateless-x-stateful" class="md-nav__link">
    Stateless x Stateful
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multithread-na-pratica" class="md-nav__link">
    Multithread na prática
  </a>
  
    <nav class="md-nav" aria-label="Multithread na prática">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#posix" class="md-nav__link">
    POSIX
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python" class="md-nav__link">
    Python
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#java" class="md-nav__link">
    Java
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#coordenacao" class="md-nav__link">
    Coordenação
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coordenacao_1" class="md-nav__link">
    Coordenação
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exclusao-mutua" class="md-nav__link">
    Exclusão Mútua
  </a>
  
    <nav class="md-nav" aria-label="Exclusão Mútua">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#coordenador" class="md-nav__link">
    Coordenador
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anel" class="md-nav__link">
    Anel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lidando-com-falhas" class="md-nav__link">
    Lidando com Falhas
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quorum" class="md-nav__link">
    Quórum
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eleicao-de-lideres" class="md-nav__link">
    Eleição de Líderes
  </a>
  
    <nav class="md-nav" aria-label="Eleição de Líderes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#algoritmo-do-brigao-bully" class="md-nav__link">
    Algoritmo do Brigão (Bully)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#algoritmos-em-aneis" class="md-nav__link">
    Algoritmos em Anéis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#algoritmo-do-yoyo" class="md-nav__link">
    Algoritmo do YoYo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#questoes-importantes" class="md-nav__link">
    Questões importantes
  </a>
  
    <nav class="md-nav" aria-label="Questões importantes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#split-brain" class="md-nav__link">
    Split-brain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estabilidade" class="md-nav__link">
    Estabilidade
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deteccao-de-falhas" class="md-nav__link">
    Detecção de falhas
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              

<!-- Edit button -->


  <!--
       Hack: check whether the content contains a h1 headline. If it
       doesn't, the page title (or respectively site name) is used
       as the main headline.
    -->

  <h1>Coordenação</h1>


  <!-- Content -->
  <h2 id="concorrencia">Concorrência</h2>
<p>Também importantes, de um ponto de vista prático do desenvolvimento, são os conceitos de concorrência e paralelismo, pois componentes pode necessitar manter várias "conversas" em paralelo com múltiplos outros componentes.</p>
<p>É impossível pensar em sistemas distribuídos sem pensar em concorrência na forma de múltiplos processos executando (normalmente) em hosts distintos e em termos de múltiplos <em>threads</em> nos processos.
Os exemplos apresentados até agora, consistem todos em um processo cliente requisitando ações de algum processo servidor.
Apesar disso, a interação entre tais processos aconteceu sempre de forma sincronizada, <em>lock-step</em>, em que o cliente requisitava o serviço e ficava bloqueado esperando a resposta do servidor para então prosseguir em seu processamento, e o servidor fica bloqueado esperando requisições que atende e então volta a dormir.
Este cenário, apresentado na figura a seguir, mostra que apesar do uso de processadores distintos e da concorrência na execução dos processos, temos um baixo grau de efetivo paralelismo; a requisição (2) só é processada depois que a resposta (1) é enviada.</p>
<div class="mermaid">sequenceDiagram
    activate Cliente
    note left of Cliente: Ativo gerando requisição
    note right of Servidor: Inativo esperando requisição
    activate Cliente2
    note right of Cliente2: Ativo gerando requisição
    Cliente-&gt;&gt;+Servidor: Request (1)
    deactivate Cliente 
    note left of Cliente: Inativo esperando resposta
  Cliente2--&gt;&gt;Servidor: Request (2)
    deactivate Cliente2
    note right of Cliente2: Inativo esperando resposta
    note right of Servidor: Ativo processando requisição (1)
    Servidor-&gt;&gt;-Cliente: Response (1)
      activate Cliente
    activate Servidor
    note left of Cliente: Ativo processando resposta (1)
    note right of Servidor: Ativo processando requisição (2)
  Servidor--&gt;&gt;Cliente2: Response (2)
    deactivate Servidor
    activate Cliente2
    note right of Servidor: Inativo esperando requisição
    note right of Cliente2: Ativo processando resposta (2)
    deactivate Cliente
  deactivate Cliente2</div>
<p>Este modelo de sincronização entre as partes comunicantes é um exemplo de <strong>E/S bloqueante</strong>. 
O principal ponto positivo desta estratégia é a <strong>simplicidade do código</strong> e o principal ponto negativo é a <strong>limitação do paralelismo</strong> no uso de recursos, uma das razões de ser da computação distribuída.</p>
<p>Para usarmos melhor os recursos disponíveis, tanto do lado dos clientes quanto servidores, temos então que pensar em termos de eventos sendo disparados entre os componentes, que devem ser tratados assim que recebidos ou tão logo haja recursos para fazê-lo. 
Estes eventos correspondem tanto a requisições quanto a respostas (efetivamente tornando difícil a distinção).</p>
<p>No modelo bloqueante, quando um evento é disparado (no exemplo, a requisição), o sistema fica bloqueado até que um evento específico seja observado (no exemplo, a chegada da resposta).
Sempre que possível, um componente não deve ficar esperando por eventos em específico, aproveitando a chance executar outras tarefas; quando eventos são recebidos, são então atendidos. Esta é a forma de fazer <strong>E/S assíncrona</strong>.</p>
<p>Dada que processos interagem com a rede usando sockets, cuja interface mais simples para operações de leitura é bloqueante, neste curso não falaremos especificamene sobre E/S assíncrono<sup id="fnref:asyncio"><a class="footnote-ref" href="#fn:asyncio">1</a></sup> e por isso, para vermos como aumentar a concorrência no sistema, é necessário falar de <em>multithreading</em> e as várias formas em que aparecem nos sistemas.</p>
<p>Há duas razões claras para estudarmos <em>multithreading</em>. 
A primeira, de ordem prática, é a discutida acima: permitir o desenvolvimento de componentes que utilizem "melhormente" os recursos em um host.
A segunda, didática, é o fato que muitos dos problemas que aparecem em programação <em>multithread</em>, aparecem em programação multi-processo (como nos sistemas distribuídos), apenas em um grau de complexidade maior.
Para relembrar, há várias diferenças entre <em>threads</em> e processos, mas a abstração é essencialmente a mesma:</p>
<table>
<thead>
<tr>
<th></th>
<th>Processo</th>
<th>Thread</th>
</tr>
</thead>
<tbody>
<tr>
<td>Definição</td>
<td>Instância de um programa</td>
<td>"Processo leve"</td>
</tr>
<tr>
<td>Função de entrada</td>
<td><code>main</code></td>
<td>função "qualquer"</td>
</tr>
<tr>
<td>Compartilhamento de código e dados</td>
<td>Privado ao processo</td>
<td>Compartilhado pelos threads</td>
</tr>
<tr>
<td>Estado</td>
<td>Código, Stack, Heap, descritores (e.g, file descriptors), controle de acesso</td>
<td>Stack, variáveis locais</td>
</tr>
<tr>
<td>Comunicação</td>
<td>IPC (<em>Inter Process Communication</em>): sockets, FIFO, memória compartilhada, etc</td>
<td>IPC, mutex, variáveis de condição, semáforos, etc</td>
</tr>
<tr>
<td>Nível da implementação</td>
<td>Sistema operacional</td>
<td>Diferentes implementações</td>
</tr>
<tr>
<td>API</td>
<td></td>
<td>Posix, C++, Java, ...</td>
</tr>
<tr>
<td>Bloqueio</td>
<td>Mudança de contexto para outro thread mesmo sem terminar quantum</td>
<td>Mudança de contexto para outro thread do mesmo processo</td>
</tr>
<tr>
<td>Tempo de criação, terminação e mudança de contexto</td>
<td>Demora mais</td>
<td>Demora menos</td>
</tr>
</tbody>
</table>
<p>Vejamos como o uso de múltiplos threads podem melhorar o desenvolvimento de sistemas distribuídos na prática.
Considere os exemplos de clientes e servidores vistos <a href="#tcp">anteriormente</a>.
Imagine que em vez do serviço simples feito no exemplo, o servidor retorne uma página Web.
Detalhes do protocolo seguido por navegadores e servidores serão vistos mais tarde. Por agora, considere apenas que uma requisição <code>GET arquivo.html</code> será enviada para o servidor que lerá o arquivo especificado do sistema de arquivos; como você sabe, ler um arquivo é uma operação lenta e que não requer CPU.</p>
<h3 id="cliente">Cliente</h3>
<p>Do ponto de vista do cliente, a vantagem do uso de múltiplos threads são claras: permite lidar com <strong>várias tarefas concorrentemente</strong>, por exemplo solicitar CSS, HTML e imagens concorrentemente, <strong>escondendo latência</strong> das várias operações, e permite <strong>organizar código</strong> em blocos/módulos.
Se você usar o console de desenvolvimento do navegador, verá como múltiplos arquivos são baixados em paralelo quando acessa um sítio. 
A figura a seguir mostra a carga do sítio da <a href="https://www.facom.ufu.br">Facom</a>.
O primeiro arquivo, <code>index.html</code> é baixado individualmente, mas uma vez que isso acontece e são determinados quais os demais arquivos necessários, requisições concorrentes são disparadas, minimizando o tempo total da operação.</p>
<p><img alt="Facom loading times" src="../images/facom.png" /></p>
<p>Como outros exemplos, considere um formulário <em>online</em> em que a validação de um campo é executada enquanto o campo seguinte está sendo preenchido, ou um serviço de email em que arquivos são carregados enquanto a mensagem é confeccionada.</p>
<h3 id="servidor">Servidor</h3>
<p>Do lado dos servidores há diversas possibilidades de uso de threads para aumentar o paralelismo no processamento de requisições, melhor utilizando recursos disponíveis e melhorando a experiência do usuário.</p>
<h4 id="single-threaded">Single-threaded</h4>
<p>A estratégia mais simples de se implementar é a de usar apenas um thread, como temos feito até agora.
Considere um servidor Web com esta esta característica; o fluxo no tratamento de uma requisição é exemplificado na pela figura a seguir:</p>
<p><img alt="Single Threaded" src="../images/singlethreadedserver.gif" /></p>
<ol>
<li>O servidor é iniciado, criando o socket e invocando accept</li>
<li>o cliente envia a requisição para o servidor</li>
<li>o servidor aceita a conexão em seu único thread</li>
<li>uma tarefa é gerada para ler o arquivo</li>
<li>o arquivo é lido, de forma bloqueante, e uma resposta para o cliente é preparada</li>
<li>a resposta é enviada para o cliente, de forma bloqueante</li>
<li>a requisição é descartada</li>
<li>o thread do servidor volta a esperar uma nova requisição</li>
</ol>
<p>Se novas requisições forem recebidas enquanto o servidor está executando os passos de 2 a 6, sejam requisições paralelas do mesmo cliente ou de um outro cliente, estas ficarão bloqueadas. 
A espera será maior quanto mais o servidor demorar para atender à primeira requisição, por exemplo, se precisar consultar um banco de dados ou carregar o arquivo requisitado do disco.
Para evitar que isto ocorra, o servidor pode usar mais threads.</p>
<h4 id="thread-per-request">Thread per request</h4>
<p>O servidor pode criar um novo thread para cada nova requisição, permitindo que múltiplas requisições sejam tratadas concorrentemente.
Isto é, mesmo que um thread do servidor seja bloqueado por muito tempo, somente um cliente terá sua resposta atrasada (excluindo-se necessidades de coordenação entre múltiplos threads) e outros clientes podem continuar sendo atendidos normalmente, como mostrado na figura a seguir.</p>
<p><img alt="Multi Threaded" src="../images/multithreadedserver.gif" /></p>
<p>Lembre-se, entretanto, que o número de threads que se pode criar em um SO é limitado, pois cada thread usa recursos do SO. 
Além disso, a criação e destruição de threads é cara pois é feita por meio de uma chamada de sistema, pelo kernel, e portanto implica em alternar entre modo usuário e modo protegido.
Se possível, devemos evitar a criação de novos threads em aplicações com requisitos de desempenho, e recliclá-los pode ser uma boa estratégia.</p>
<h4 id="thread-pool">Thread pool</h4>
<p>Para reciclarmos threads, podemos criar <em>pools</em>, um balde de threads que são usados quando necessário e devolvidos para o balde quando não mais.
No cerne desta abordagem, junto com o <em>pool</em> de threads, fica uma fila bloquenante na qual tarefas são inseridas e de onde os threads tentam retirá-las.</p>
<p>Como a fila é bloqueante, se estiver vazia, o thread é bloqueado e para de consumir recursos. Tão logo nova tarefa seja inserida, a fila acorda os threads para que a processem. Para garantir a corretude no processamento, a fila deve ser <strong>thread-safe</strong>, isto é, que se mantem correta mesmo quando múltiplos threads operam nela tanto para inserir quanto remover tarefas.</p>
<p>Na figura, um thread principal é encarregado de receber as requisições e colocar na fila bloqueante; se a fila fica cheia, o thread principal fica bloqueado esperando por espaço, fazendo com que novas conexões tenham que esperar.</p>
<p><a href="https://www3.nd.edu/~dthain/courses/cse30341/spring2009/project4/project4.html"><img alt="Pool Threaded" src="../images/poolthreadedserver.gif" /></a></p>
<p>Os threads do pool removem uma tarefa da fila, a tratam e, ao final do atendimento,  pegam nova requisição na fila, em um loop infinito; requisições que demandam menor processamento liberam o thread mais rapidamente para que pegue nova tarefa.
Se todas as tarefas são pequenas, os threds ficarão bloqueados por muito tempo. Se todas são grandes, as tarefas se acumularão na fila.
Por isso é importante dimensionar bem o tamanho to <em>pool</em>, ou mesmo torná-lo dinâmico para que use menos recursos (threads) quando não necessário e não deixe tarefas pendentes por muito tempo. </p>
<p>Se considerarmos que cada tarefa na verdade tem várias partes, 
é possível refinar mais este modelo, quebrando o processamento em vários pools.</p>
<h4 id="estagios">Estágios</h4>
<p>Na arquitetura baseada em estágios, e.g.,  <strong>Staged Event-Driven Architecture</strong>, SEDA, cada <strong>estágio</strong>, cada estágio é responsável por processar uma parte da tarefa, passada adiante até que seja completada.<sup id="fnref:seda"><a class="footnote-ref" href="#fn:seda">2</a></sup></p>
<p><a href="http://images.cnitblog.com/blog/13665/201306/15180500-a54c8eb3d73246469f1b74ee74f2119b.png"><img alt="Seda" src="../images/seda1.png" /></a></p>
<p>Uma característica importante deste modelo é que cada estágio pode ser escalado individualmente de acordo com a demanda uma vez que cada estágio tem seu próprio <em>pool</em>. Por exemplo, se um estágio faz algum cálculo leve, então poucos <em>threads</em> são necessários ao mesmo. Já um estágio que precise efetuar E/S talvez precise mais <em>threads</em>, uma vez que estes ficam bloqueandos enquanto a operação é executada. <sup id="fnref:ioasync"><a class="footnote-ref" href="#fn:ioasync">3</a></sup></p>
<p><a href="http://images.cnitblog.com/blog/13665/201306/15180500-a54c8eb3d73246469f1b74ee74f2119b.png"><img alt="Seda" src="../images/seda2.png" /></a></p>
<h3 id="desafios">Desafios</h3>
<p>Embora a ideia de usar múltiplos threads seja melhorar desempenho e experiência do usuário, fazê-lo efetivamente é não trivial.
Vejamos por exemplo o problema do falso compartilhamento; considere o seguinte pseudo-código:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">...</span>
<span class="n">int32</span> <span class="n">X</span><span class="p">;</span>
<span class="n">int32</span> <span class="n">Y</span><span class="p">;</span>

<span class="n">thread1</span> <span class="o">=</span> <span class="n">tread_new</span><span class="p">(</span><span class="n">threadfunction</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">X</span><span class="p">);</span>
<span class="n">thread2</span> <span class="o">=</span> <span class="n">tread_new</span><span class="p">(</span><span class="n">threadfunction</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Y</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">threadfunction</span><span class="p">(</span><span class="n">int32</span> <span class="o">*</span> <span class="n">exclusivo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">int32</span> <span class="n">local</span> <span class="o">=</span> <span class="o">*</span><span class="n">exclusivo</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">local</span> <span class="o">=</span> <span class="n">processa</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
        <span class="o">*</span><span class="n">exclusivo</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">...</span>
</code></pre></div>
</td></tr></table>
<p>Cada um dos threads criados acessa exclusivamente uma das variáveis. Logo, não há interferência entre as threads e se cada uma for colocada em um processador diferente, executarão no máximo de seu potencial, correto?
Não exatamente, pois mesmo este código simplíssimo podemos sofrer de <a href="https://dzone.com/articles/false-sharing">falso compartilhamento</a>.
Isto acontece, por exemplo, se cada linha da cache do sistema onde este programa executa tiver 8 ou mais bytes de comprimento. Como tanto <code>X</code> quanto <code>Y</code> no programa tem 4 bytes, as duas variáveis poderão ficar na mesma linha da cache e toda vez que uma thread modificar uma variável a cache da outra será invalidada para leitura.</p>
<p><img alt="Multithreaded" src="../images/cache-line.png" /></p>
<p>Para que isto não ocorra, é preciso se certificar que as variáveis fiquem em linhas diferentes da cache; no exemplo, poderia-se definir X e Y como vetores do tamanho da linha da cache e usar efetivamente apenas a primeira posição de cada vetor.</p>
<p>Se o compartilhamento for real, por exemplo se ambos os threads usarem a variável X, então o problema não será tão facilmente resolvível.
Neste caso, poder-se-ia definir afinidade entre threads, isto é, notar quais threads compartilham estado de forma que threads afins sejam colocados nos mesmos processadores e compartilhem as mesmas memórias. 
Isto torna muito mais fácil e eficiente o controle de concorrência, do ponto de vista do SO e hardware.</p>
<p><img alt="Multithreaded" src="../images/multithread2.png" /></p>
<details class="- info inline end"><summary>Multiprogramação</summary><p><img alt="Multithreaded" src="../images/multithreaded.jpg" /></p>
</details>
<p>Fazer esta divisão pode ser complicado pois a relação de compartilhamento entre threads pode ser complexa em função da tarefa sendo resolvida, por exemplo, se diferentes threads compartilharem diferentes variáveis uns com os. Ainda que que uma configuração ótima em termos de afinidade exista, encontrá-la pode ser custo.
Ainda assim, precisamos lidar com estado compartilhado e enfrentar condições de corrida de forma a não levar a <strong>inconsistências</strong> na executação de tarefas, nos referindo a inconsistência aqui como qualquer desvio no comportamento do programa daquilo que foi especificado pelo desenvolvedor.
Para isso, usamos as primitivas de controle de concorrência que estudaram em SO, que também tem seus problemas em potencial, como <strong>deadlocks</strong> e <strong>inanição</strong>.
Veja o seguinte vídeo para uma análise de diversos pontos importantes no uso de multithreads.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/JRaDkV0itbM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<h3 id="estado">Estado</h3>
<p>A questão das regiões críticas está intimamente relacionada à questão da manutenção de estado nos servidores.
Quanto a este respeito, podemos classificar servidores como <strong>stateful</strong> e <strong>stateless</strong>, dois termos que ouvirão frequentemente enquanto trabalhando com SD.</p>
<details class="- info inline end"><summary>To state or not to state?</summary><ul>
<li>Complexidade e desempenho</li>
<li>Falhas</li>
<li>Balanceamento</li>
</ul>
</details>
<p>O "state" nos dois nomes se refere ao estado mantido por um serviço para atender a requisições.
Caso mantenha estado, por exemplo informando em quais arquivos o cliente está interessado, fica mais fácil para o servidor continuar o trabalho feito em requisições anteriores.
Imagine por exemplo que um cliente esteja acessando linhas em um banco de dados, de forma paginada: a cada requisição, o cliente recebe <span class="arithmatex">\(n\)</span> novas linhas para processar e, quando estiver pronto, requisite <span class="arithmatex">\(n\)</span> novas linhas.
Imagine quão infeficiente seria se o servidor seguisse o seguinte fluxo:</p>
<ol>
<li>receba requisição informando a última linha lida</li>
<li>recalcule todas as respostas para consulta</li>
<li>salte até a linha informada pelo cliente</li>
<li>retorne as próximas <span class="arithmatex">\(n\)</span> linhas para o cliente</li>
<li>feche o resultado da consulta.</li>
</ol>
<p>Se em vez disso o servidor mantiver um mapa com consultas recentes, em que a chave seja algum identificador do cliente e o valor uma <em>visão</em>  dos resultados; a cada nova requisição, basta o servidor resgatar a visão usando o identificador do cliente e selecionar as seguintes <span class="arithmatex">\(n\)</span> entradas da visão. Manter o mapa como estado acelera o processamento e melhora a experiência do usuário, neste caso.
Por outro lado, considere que múltiplos clientes fazem consultas concorrentemente: quanto recurso seria necessário para que o servidor mantenha a visão de todos os clientes?</p>
<p>Também a complexidade do servidor aumenta. Considere as algumas de muitas perguntas possíveis neste cenário:</p>
<ul>
<li>Como o servidor mantém as respostas a novas requisições consistentes com as respostas anteriores? E se linhas são removidas ou inseridas no banco de dados?</li>
<li>Se múltiplos servidores existem, como compartilhar os estado entre os mesmos?</li>
<li>Se o cliente resolva não fazer mais requisições, por exemplo por ter encontrado o que procurava, por quanto tempo o servidor deve manter a visão aberta?</li>
</ul>
<p>Você já deve ter adivinhado que no primeiro exemplo temos um servidor <em>stateless</em> e no segundo um <em>stateful</em>, e percebido que cada um tem suas vantagens e desvantagens.
Vejamos mais algumas.</p>
<h4 id="sessao">Sessão</h4>
<p>Essencialmente, o servidor <em>stateless</em> não mantem informação sobre a sessão do cliente e requer que a cada nova requisição, quaisquer informações necessárias para realizar a tarefa requisitada sejam novamente fornecidas ao servidor.
No caso <em>stateful</em>, o servidor pode se lembrar, como no exemplo anterior, até onde o trabalho já foi executado, quais arquivos o cliente manipulou (e mantê-los abertos), qual o endereço o cliente e enviar-lhe notificações importantes (e.g., "Novo dado inserido!").</p>
<h4 id="falhas">Falhas</h4>
<p>Enquanto servidores <em>stateful</em> obviamente levam a melhor desempenho no <em>happy path</em> (contanto que recursos suficientes sejam providos), no caso de falhas, serviços <em>stateless</em> tendem a voltar ao ar mais rapidamente, uma vez que não há estado que precise ser recuperado.
Pela mesma razão, clientes que percebem que um servidor falhou podem rapidamente se dirigir a outros servidores e continuar suas requisições de onde estavam, uma vez que são detentores de toda a informação necessária para o próximo passo do processamento.</p>
<p>Lidar com falhas também introduz outro requisito aos servidores: memória estável.
Para que possa o recuperar o estado anterior à falha, o servidor precisa colocar o estado em algum lugar que independa do processo para se manter, por exemplo,
<a href="https://en.wikipedia.org/wiki/Non-volatile_random-access_memory">nvRAM</a>, <a href="https://en.wikipedia.org/wiki/Solid-state_drive">SSD</a> ou <a href="https://en.wikipedia.org/wiki/Hard_disk_drive#Spindle">spindles</a>.
A perda deste estado implicaria na incapacidade de prover o serviço corretamente.
Um projeto <em>stateless</em> não depende deste estado e por isso pode ser mais rapidamente recuperado, replicado ou substituído.</p>
<h4 id="stateless-x-stateful">Stateless x Stateful</h4>
<p>Não surpreendentemente, a resposta para "qual abordagem é melhor, <em>stateful</em> ou <em>stateless</em>?" é <strong>depende</strong>.
Ambos as opções tem suas vantagens e desvantagens e para algums serviços apenas uma opção será viável.
Se seu serviço precisa manter estado (um SGBD, por exemplo), ele terá que manter estado, mesmo que não sobre clientes.
Veja um pequeno comparativo das características das duas abordagens.</p>
<table>
<thead>
<tr>
<th>Stateless</th>
<th>Stateful</th>
</tr>
</thead>
<tbody>
<tr>
<td>Resultado depende da entrada</td>
<td>Depende do histórico de entradas</td>
</tr>
<tr>
<td>Qualquer servidor pode atender</td>
<td>Mesmo servidor deve atender</td>
</tr>
<tr>
<td>Não promete notificar o cliente</td>
<td>Assina contrato com o cliente</td>
</tr>
<tr>
<td>Repete operações</td>
<td>Aproveita resultados anteriores</td>
</tr>
<tr>
<td>Não fica inconsistente com relação ao cliente</td>
<td>Pode ficar inconsistente se perder estado ou conexão feita com outro servidor</td>
</tr>
<tr>
<td>re-autenticação (mesmo que simplficada) a cada requisição</td>
<td>Autentica no começo da sessão</td>
</tr>
</tbody>
</table>
<h3 id="multithread-na-pratica">Multithread na prática</h3>
<h4 id="posix">POSIX</h4>
<p><a href="https://en.wikipedia.org/wiki/POSIX_Threads">POSIX Threads</a> ou PThreads, são uma definição <strong>aberta</strong> de como <em>threads</em> devem funcionar em sistemas operacionais.
Várias implementações desta especificação estão disponíveis tanto para sistemas Unix, que se esforçam para ser compatíveis com especifições POSIX, mas também para Windows, via subsistemas que compatibilizam diferentes API.
Além disso, mesmo implementações não POSIX tem funcionalidade equivalentes e, por este motivo, entender POSIX servirá de base para entender quaisquer API para programação <em>multi-threaded</em>.</p>
<p>Para se definir um <em>thread</em>, é necessário definir uma função de entrada, que será para o <em>thread</em> como a função <code>main</code> é para o processo em si.
No exemplo a seguir a função foi definida com retorno <code>void *</code> e com único parâmetro, também <code>void *</code>; esta é uma obrigatoriedade para funções de entrata PThread.
Observe contudo que <code>void *</code> pode ser tratado como um blob para mascarar outros tipos de dados, por exemplo um vetor, um ponteiro para uma enumeração ou uma <code>struct</code>.
Também observe que a função tem uma variável local <code>my_id</code> que só está definida no contexto da thread (linha 8); se múltiplas <em>threads</em> forem instanciadas, cada uma terá a sua versão da variável. 
Há também uma variável global <code>thread_count</code>, compartilhada por todas as instâncias (linha 5).</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">thread_count</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">hello</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="n">my_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello from thread %ld of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">my_id</span><span class="p">,</span> <span class="n">thread_count</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Um <em>thread</em>  é criado pela função <code>pthread_create</code> (linha 14), que coloca em um <code>pthread_t</code> um <em>handle</em> para o <em>thread</em>.
O <em>handle</em> do <em>thread</em> deve ser alocado previamente à função de criação do <em>thread</em> (linha 11).
A função recebe como parâmetros opções para configuração, a função de entrada, e o parâmetro do tipo <code>void *</code>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="kr">thread</span><span class="p">;</span>
    <span class="n">pthread_t</span><span class="o">*</span> <span class="n">thread_handles</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: %s &lt;number of threads&gt;&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> 
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">thread_count</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">thread_handles</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">thread_count</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pthread_t</span><span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">thread</span> <span class="o">&lt;</span> <span class="n">thread_count</span><span class="p">;</span> <span class="kr">thread</span><span class="o">++</span><span class="p">)</span>
        <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_handles</span><span class="p">[</span><span class="kr">thread</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hello</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="kr">thread</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello from the main thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>É possível esperar pelo fim da execução do <em>thread</em> usando o <code>pthread_join</code>, que recebe como parâmetro o <em>handle</em> do <em>thread</em> e um ponteiro para onde o resultado da função de entrada deve ser colocado, do tipo <code>void **</code> (linha 2). No exemplo, nenhum retorno é esperado, então um endereço nulo é passado como parâmetro.
Ao final da execução, o <em>handle</em> deve ser liberado (linha 4).</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="k">for</span> <span class="p">(</span><span class="kr">thread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="kr">thread</span> <span class="o">&lt;</span> <span class="n">thread_count</span><span class="p">;</span> <span class="kr">thread</span><span class="o">++</span><span class="p">)</span>
        <span class="n">pthread_join</span><span class="p">(</span><span class="n">thread_handles</span><span class="p">[</span><span class="kr">thread</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">free</span><span class="p">(</span><span class="n">thread_handles</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>Para executar um programa PThread, compile com
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>gcc -pthread teste.c -o teste
</code></pre></div>
</td></tr></table>
e execute com
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./teste <span class="m">5</span>
</code></pre></div>
</td></tr></table>
e observe que a saída das threads é <em>ordenada</em>. </p>
<p>Agora experimente
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./teste <span class="m">200</span>
</code></pre></div>
</td></tr></table>
Observe que a saída é desordenada (pode ser necessário executar múltiplas vezes ou aumentar de 200 para, digamos, 1000 para observar a desordem.
Isto acontece porquê a execução das threads independe da ordem de criação.
De fato, usando PThreads, temos pouco controle sobre os threads que criamos. 
Mas isto não quer dizer que estamos "órfãos" de API; várias outras operações podem ser executadas, e podem ser encontradas a partir do <a href="http://man7.org/linux/man-pages/man3/pthread_create.3.html">manual de <code>pthread_create</code></a>. Alguns exemplos interessantes:</p>
<ul>
<li><code>pthread_tryjoin</code> - espera thread terminar</li>
<li>
<p><code>pthread_exit</code> - termina a thread e retorna resultado </p>
<blockquote>
<p>An implicit call to <code>pthread_exit()</code> is made when a thread other than the thread in which <code>main()</code> was first invoked returns from the start routine that was used to create it. The function's return value serves as the thread's exit status. <a href="http://man7.org/linux/man-pages/man3/pthread_exit.3.html">Manual de <code>pthread_exit</code></a>.</p>
</blockquote>
</li>
<li>
<p><code>pthread_attr_setaffinity_np</code> - ajusta afinidade dos threads.</p>
</li>
</ul>
<h4 id="python">Python</h4>
<p>Em Python, como seria de se esperar, há várias formas de se trabalhar com <em>threads</em>. 
O exemplo a seguir usa o pacote <code>thread</code> e é essencialmente um envólucro POSIX.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">thread</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Define a function for the thread</span>
<span class="k">def</span> <span class="nf">print_time</span><span class="p">(</span> <span class="n">threadName</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
   <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
   <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
      <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">threadName</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="p">)</span>

<span class="c1"># Create two threads as follows</span>
<span class="k">try</span><span class="p">:</span>
   <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span> <span class="n">print_time</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Thread-1&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
   <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span> <span class="n">print_time</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;Thread-2&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
   <span class="nb">print</span> <span class="s2">&quot;Error: unable to start thread&quot;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
   <span class="k">pass</span>
</code></pre></div>
</td></tr></table>
<p>Já o próximo exemplo usa o pacote <code>threading</code> e uma abordagem orientada a objetos. Observe que há momentos distintos no ciclo de vida do thread em que acontece a criação e o início da execução.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">exitFlag</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">myThread</span> <span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threadID</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>
      <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">threadID</span> <span class="o">=</span> <span class="n">threadID</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span>
   <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="nb">print</span> <span class="s2">&quot;Starting &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
      <span class="n">print_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
      <span class="nb">print</span> <span class="s2">&quot;Exiting &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

   <span class="k">def</span> <span class="nf">print_time</span><span class="p">(</span><span class="n">threadName</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
      <span class="k">while</span> <span class="n">counter</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">exitFlag</span><span class="p">:</span>
            <span class="n">threadName</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
         <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
         <span class="nb">print</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threadName</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
         <span class="n">counter</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="c1"># Create new threads</span>
<span class="n">thread1</span> <span class="o">=</span> <span class="n">myThread</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Thread-1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">thread2</span> <span class="o">=</span> <span class="n">myThread</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Thread-2&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Start new Threads</span>
<span class="n">thread1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">thread2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="nb">print</span> <span class="s2">&quot;Exiting Main Thread&quot;</span>
</code></pre></div>
</td></tr></table>
<p>Uma consequência desta divisão é que um mesmo objeto do tipo <code>Thread</code> pode ser reciclado e executado várias vezes.</p>
<h4 id="java">Java</h4>
<p>Outro exemplo importante de API para multithreading é a do Java, pois nesta linguagem há, essencialmente, duas formas de se conseguir concorrência. 
A primeira é via instâncias explícitas da classe <code>Thread</code> e, a segunda, via abstrações de mais alto nível, os <code>Executors</code>.
Aqui nos focaremos em aspectos básicos de concorrência na linguagem, mas esteja ciente de que a mesma é muito rica neste tópico, por exemplo provendo diversas estruturas para comunicação e coordenação de <em>threads</em> no pacote <code>java.util.concurrent</code>.
Uma ótima documentação sobre o uso de <em>threads</em> e estruturas é dispobinilizada pela <a href="https://docs.oracle.com/javase/tutorial/essential/concurrency/">Oracle</a>.</p>
<p>Há duas formas básicas de definir um novo <em>thread</em> em Java, ou via extensão da classe <code>Thread</code> ou via implementação da interface <code>Runnable</code>; observe o quão pouco muda no código dos exemplos a seguir.
Note também que, nos dois exemplos, um método <code>run()</code> é implementado com o código a ser executado pelo <em>thread</em> mas que em nenhum momento tal método é invocado diretamente.
Em vez disto, o método <code>start()</code> é que é invocado, porquê antes de executar as instruções definidas pelo pelo programador no método <code>run()</code>,
a máquina virtual precisa executar alguma "mágica" por baixo dos panos como, por exemplo, solicitar ao sistema operacional a criação de um <em>thread</em> do SO, que servirá de hospedeiro para o <em>thread</em> Java. 
Isto acontece dentro do <code>start()</code>, que em algum ponto de sua execução levará à invocação do método <code>run()</code>.</p>
<div class="tabbed-set" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">Thread</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello from a thread!&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hello</span><span class="p">();</span>
        <span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">Runnable</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello from a thread!&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Hello</span><span class="p">());</span>
        <span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Além de servider base para outras classes, a classe <code>Thread</code> também provê uma série de métodos que permitem gerenciar a vida dos <em>threads</em> criados.
Por exemplo, o método de classe <code>Thread.sleep()</code> permite bloquear o thread no qual a invocação aconteceu por um determinado período.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">){</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello at instant &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;awoken&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Hello</span><span class="p">());</span>
        <span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Observe que a chamada a <code>sleep()</code> deve estar dentro de um bloco <code>try/catch</code>, pois é permitido à JVM acordar o <em>thread</em> em qualquer instante, antes ou após o tempo especificado. 
Assim, embora normalmente o tempo "dormido" seja próximo ao especificado, se há requisitos de precisão, é sugerido que a <em>thread</em> durma em pequenas frações até chegar ao valor total e que, ao acordar, verifique se já não dormiu o suficiente.
No exemplo seguinte, o <em>thread</em> dorme por pelo menos 1000 milissegundos a cada iteração.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">){</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello at instant &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
            <span class="kt">long</span> <span class="n">before</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
            <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span><span class="n">before</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()){</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">before</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">)));</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;awoken&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Hello</span><span class="p">());</span>
        <span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Quando um <em>thread</em> está sendo executado, outros podem ter que esperar até que complete. Por exemplo, no caso de um navegador
Web, o <em>thread</em> que faz a renderização da página não pode começar a trabalhar enquanto o <em>thread</em>  que solicitou o HTML
do servidor não receber sua resposta. Um <em>thread</em> indica a intenção de esperar por outro usando o método <code>join()</code>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Random</span> <span class="n">rand</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">){</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Hello at instant &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
            <span class="kt">long</span> <span class="n">before</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
            <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">901</span> <span class="o">+</span> <span class="n">rand</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
            <span class="k">while</span><span class="p">(</span><span class="n">before</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()){</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">before</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">)));</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;awoken&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Hello</span><span class="p">());</span>
        <span class="c1">//t.setDaemon(true);</span>
        <span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">t</span><span class="p">.</span><span class="na">join</span><span class="p">();</span>
            <span class="c1">//t.join(10000);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Waiting was interrupted&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">isAlive</span><span class="p">())</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Got tired of waiting&quot;</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Wait is over&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Invocar <code>t.join()</code> fará com que o <em>thread</em> corrente, neste caso o principal, espere indefinidamente até que <code>t</code> termine de executar.
Caso seja necessário limitar o tempo de espera, um limite pode ser especificado como na linha comentada.
Caso a espera termine por causa de um <em>timeout</em>, é possível testar o estado atual do thread com <code>Thread.isAlive()</code>.</p>
<p>Outro método interessante, <code>Thread.setDaemon()</code>, especifica que o <em>thread</em> pode ser terminado quando a <em>thread</em> principal terminar. Descomente a invocação e teste o efeito.</p>
<div class="admonition question">
<p class="admonition-title">Exercício: contador</p>
<p>Façamos um exercício simples do uso de <em>threads</em>. Considere a classe e siga as instruções abaixo.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">Counter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">++</span><span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">decrement</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">--</span><span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">value</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Instancie um programa que gere 10 <em>threads</em>. </li>
<li>Todos os <em>threads</em> devem compartilhar <strong>uma mesma instância</strong> de <code>Counter</code></li>
<li>Cada <em>thread</em> deve executar um <em>loop</em> em que incrementa o valor do contador 20 vezes </li>
<li>a cada vez, imprime o resultado precedido do identificador do <em>thread</em> (use <code>Thread.getName()</code> ou <code>Thread.currentThread().getName()</code>)</li>
<li>A <em>thread</em>  principal deve esperar todas as outras terminarem antes de terminar (use <code>Thread.join()</code>).</li>
<li>Analise a saída do programa observando a ordem de execução dos <em>threads</em>.</li>
</ul>
<details class="note"><summary>Análise</summary><p>É fácil observar que a saída do programa é aleatória nos identificadores e tende a ser incremental nos contadores, mas nem sempre isso é verdade. Isso acontece porquê a execução dos <em>threads</em> é não determinística; uma vez que estejam prontos para executar, cabe ao escalonador do sistema operacional a decisão sobre qual processo e em qual processador deverá executar.</p>
</details>
</div>
<p>Além de extensão de <code>Thread</code> e implementação de <code>Runnable</code>, Java disponibiliza também <code>ExecutorService</code> como abstração de mais alto nível para execução de tarefas concorrentes.
Os <code>ExecutorService</code>, de forma genérica, provê o acesso a <em>pools</em> de <em>thread</em> e a API para submeter tarefas para este pool.
Para iniciar tal processo, você pode criar um executor service usando uma das muitas fábricas providas pela classe <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Executors.html"><code>Executors</code></a> ou pela instanciação de <em>thread</em> <em>pools</em>  diretamente.
O mais simples é o de tamanho fixo em que há um número inicial de <em>threads</em> criados e que, no caso de algum ser terminado, por exemplo por causa de uma exceção não tratada, cria substitutos para manter o número constante.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">ExecutorService</span> <span class="n">es1</span> <span class="o">=</span> <span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">ExecutorService</span> <span class="n">es2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="n">L</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">,</span> <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">());</span>
</code></pre></div>
</td></tr></table>
<p>Uma vez criado o executor, você atribui tarefas para serem executadas, que devem implementar <code>Runnable</code> ou <code>Callable</code>.
No caso de <code>Runnable</code>, você pode usar o método <code>execute</code> para executá-las em algum momento, sem a possibilidade de retorno de resultados.</p>
<div class="tabbed-set" data-tabs="2:3"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">Implements</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">MyRunnable</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;R0&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyRunnable</span><span class="p">();</span>

<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es2</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><label for="__tabbed_2_2">Anônimo</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;R1&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es2</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><label for="__tabbed_2_3">Lambda</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;R2&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es1</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="n">es2</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<p>Já usando <code>Callable</code>, é possível retornar resultados na forma de <code>Future&lt;T&gt;</code>. No exemplo a seguir, a <code>c</code> retorna um <code>Integer</code>, e portanto <code>submit</code> retorna <code>Future&lt;Integer&gt;</code>; para acessar o resultado, use <code>Future&lt;&gt;.get()</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Callable</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;C1&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">es1</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

<span class="cm">/* Outras tarefas... */</span>

<span class="kt">int</span> <span class="n">resultado</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>Outros métodos interessantes dos <code>ExecutorService</code> são <code>invokeAny()</code> e <code>invokeAll()</code>, que permitem passar uma lista de tarefas e retornam o resultado de qualquer tarefa ou implica na execução de todas, respectivamente.</p>
<p>Alguns executores são interessantes por razões diferentes. Primeiro, o <code>ForkJoinPool</code> é um executor interessante por funcionar da seguinte forma: </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>if (my portion of the work is small enough)
  do the work directly
else
  split my work into two pieces
  invoke the two pieces and wait for the results
</code></pre></div>
</td></tr></table>
<p>Segundo, os <code>ScheduledExecutorService</code> permitem a execução agendada ou periódica de tarefas, por exemplo:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">ScheduledExecutorService</span> <span class="n">es3</span> <span class="o">=</span> <span class="n">Executors</span><span class="p">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="p">();</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">executorService</span><span class="p">.</span><span class="na">schedule</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span>
<span class="c1">//Executa a cada 5 segundos, depois de esperar por 1 segundo para começar. </span>
<span class="n">executorService</span><span class="p">.</span><span class="na">scheduleAtFixedDelay</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span>
<span class="c1">//Como a anterior, mas pode atrasar a próxima invocação para permiter à anterior que termine.</span>
<span class="n">executorService</span><span class="p">.</span><span class="na">scheduleAtFixedRate</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<h4 id="coordenacao">Coordenação</h4>
<p>Como visto no exercício anterior, a execução de <em>threads</em> é não determinística. Contudo, estas execuções frequentemente precisam ser coordenadas para que não pisem uns nos calcanhares dos outros, por exemplo, decidindo quem deve ser o próximo a entrar em uma região crítica ou será o responsável por uma determinada tarefa. </p>
<p>Há várias astrações que podem ser usadas para coordenar as operações de <em>threads</em>, como deve se lembrar no estudo de Sistemas Operacionais. Alguns exemplos são <em>locks</em>, variáveis de condição e semáforos.</p>
<p>Especificamente em Java, provavelmente a abstração mais simples são os blocos <code>synchronized</code>.</p>
<h6><code>synchronized</code></h6>
<p>Ao definir métodos como <code>synchronized</code>, garante-se que os mesmos nunca serão executados concorrentemente. 
Observe a classe a seguir, que modifica o contador do exercício anterior.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SynchronizedCounter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">++</span><span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">decrement</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">--</span><span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">value</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Caso dois <em>threads</em> invoquem os métodos <code>increment</code> e <code>decrement</code> ao mesmo tempo, por exemplo, a JVM fará com que um dos <em>threads</em> pare sua execução até que o outro tenha completado a invocação.
Isto não quer dizer que executar o exercício anterior com esta versão do contador levará a saídas com incrementos completamente sequenciais, pois um <em>thread</em>  poderia parar de ser executado logo após incrementar o contador, depois de terminado o método <code>increment</code>, e só voltar a executar depois que outro tenha incrementado e impresso na tela o valor obtido. 
O que quer dizer é que, mesmo que saídas estranhas existam, cada método foi executada integralmente antes da operação seguinte.</p>
<div class="admonition question">
<p class="admonition-title">Exercício: synchronized</p>
<p>Modifique o código do exercício anterior para usar a versão <code>synchronized</code> do contador. Depois de executá-lo, adicione um <code>println("Dentro: " + c)</code> <strong>dentro</strong> do método de incremento para verificar que estas saídas acontecem ordenadamente.</p>
</div>
<p><code>synchronized</code> funciona porquê limita a concorrência, mas é problemático exatamente pela mesma razão. 
Por isso, é essencial que o <code>synchronized</code> seja o mais limitado possível em termos de escopo, o que nos leva ao uso de <code>synchronized</code> em blocos de código menores que métodos. Por exemplo:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Namer</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">lastName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nameCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">lastName</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
        <span class="kd">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">nameCount</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">nameList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Neste caso, blocos sincronizados <strong>no mesmo objeto</strong>, não são executados concorrentemente, mas outros blocos sim.</p>
<div class="admonition question">
<p class="admonition-title">Exercício: bloco synchronized</p>
<p>Neste exercício, use dois objetos para travar o acesso a dois contadores. Instancie um programa com dois <em>threads</em>  tal que:</p>
<ul>
<li>executem um loop 1000 vezes em que</li>
<li>o primeiro <em>thread</em> primeiro invoca <code>inc1</code> e depois <code>inc2</code></li>
<li>o segundo <em>thread</em> primeiro invoca <code>inc2</code> e depois <code>inc1</code></li>
<li>ambos os threads imprimem o valor de <code>c1</code> e <code>c2</code></li>
</ul>
<details class="tip"><summary>Análise</summary><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MsLunch</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">c1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">c2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Object</span> <span class="n">lock1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span>
    <span class="kd">private</span> <span class="n">Object</span> <span class="n">lock2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inc1</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">synchronized</span><span class="p">(</span><span class="n">lock1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">c1</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">inc2</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">synchronized</span><span class="p">(</span><span class="n">lock2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">c2</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</details>
</div>
<h6>Sinalização</h6>
<p>Usados corretamente, o bloco <code>synchronized</code> é executado de forma atômica, isto é, indivisível.
Algumas operações muito simples são naturalmente atômicas, e não precisam ser "protegidas" pelo <code>synchronized</code>.
Por exemplo, leituras e escritas de tipos básicos como <code>int</code>, <code>char</code> e <code>byte</code>, mas não <code>long</code> ou <code>double</code>, pois usam mais de uma palavra em algumas arquiteturas, ou variáveis declaradas <code>volatile</code>.
Usando estas variáveis, é possível coordenar <em>threads</em>, como no exemplo a seguir.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kt">boolean</span> <span class="n">condicao</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="p">...</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">espereCondicao</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">condicao</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;condicao alcancada.&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">satisfacaCondicao</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">condicao</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Embora correta, esta abordagem, conhecida como <strong>espera ocupada</strong>, não é eficiente pois desperdiça computação.
Felizmente, em Java, todos os objetos implementam os métodos <code>wait</code> e <code>notify/notifyAll</code>, que podem ser usados para sincronizar eficientemente <em>threads</em>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sync</span><span class="p">{</span>
   <span class="n">Object</span> <span class="n">synch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span>
   <span class="kt">boolean</span> <span class="n">condicao</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">espereCondicao</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">condicao</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">try</span> <span class="p">{</span>
             <span class="kd">synchronized</span><span class="p">(</span><span class="n">synch</span><span class="p">){</span>
                 <span class="n">synch</span><span class="p">.</span><span class="na">wait</span><span class="p">();</span>
             <span class="p">}</span>
         <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
      <span class="p">}</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Condicao alcancada&quot;</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">...</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">satisfacaCondicao</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">condicao</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="kd">synchronized</span><span class="p">(</span><span class="n">synch</span><span class="p">){</span>
          <span class="n">synch</span><span class="p">.</span><span class="na">notifyAll</span><span class="p">();</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Neste exemplo a execução da função <code>espereCondicao</code> é "pausada" por <code class="highlight"><span class="n">synch</span><span class="p">.</span><span class="na">wait</span><span class="p">()</span></code> até que uma notificação seja enviada via <code class="highlight"><span class="n">sync</span><span class="p">.</span><span class="na">notifiyAll</span><span class="p">()</span></code>, na função <code class="highlight"><span class="n">satisfacaCondicao</span><span class="p">()</span></code>.
Observe que estas operações só podem ocorrer dentro de blocos sincronizados na variável usada na sinalização.</p>
<h6><em>Locks</em></h6>
<p>Outras abstrações para coordenação de <em>threads</em> estão disponíveis no pacote <code>java.util.concurrent</code>. 
As mais simples delas são <code>java.util.concurrent.locks.Lock</code> e <code>java.util.concurrent.locks.ReentrantLock</code>. 
Veja um exemplo de uso, notando o idioma de uso dentro de block <code>try/catch/finally</code>, que garante que o <em>lock</em> será liberado a despeito de exceções no bloco.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Lock</span> <span class="n">l</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="p">();</span>
  <span class="n">l</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span>
  <span class="k">try</span> <span class="p">{</span>
     <span class="c1">// access the resource protected by this lock</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
     <span class="n">l</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Como bem sabido, o uso dos "locks" em ordens diferentes pode levar a um <em>deadlock</em> pois um ciclo de dependências pode ser formado entre locks, detentores de locks e interessados em locks. O grafo de dependência seguinte exemplifica o cenário, em que o <em>thread</em> T1 obteve o lock2 e tenta obter o lock1, e o <em>thread</em> T2 obteve o lock1 e tenta obter o lock2.</p>
<div class="mermaid">graph LR
      T1 --&gt; lock1 --&gt; T2 --&gt; lock2 --&gt; T1</div>
<h6>Estruturas <em>thread-safe</em></h6>
<p>Finalmente, Java também disponibiliza estruturas de dados que podem ser acessadas concorrentemente por múltiplos <em>threads</em> sem risco de corrupção, denominadas <em>thread-safe</em>.</p>
<ul>
<li><code>BlockingQueue</code> - bloqueia <em>threads</em>  se não houver elementos na fila.</li>
<li><code>ConcurrentMap/ConcurrentHashMap</code> - operações atômicas;</li>
<li><code>if (!m.containsKey(k)) m.put(k,v);</code></li>
<li><code>vOld = m.putIfAbsent(k,v);</code></li>
</ul>
<h6>Tipos Atômicos</h6>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">AtomicCounter</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">decrement</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="na">decrementAndGet</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">value</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">c</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h6>ThreadLocal</h6>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">private</span> <span class="kd">static</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">myId</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
   <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">initialValue</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">Random</span><span class="p">().</span><span class="na">nexInt</span><span class="p">();</span>
   <span class="p">}</span> 
<span class="p">};</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">Integer</span> <span class="nf">getMyId</span><span class="p">()</span> <span class="p">{</span> 
    <span class="k">return</span> <span class="n">myId</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<div class="admonition question">
<p class="admonition-title">Exercício - Anel Multithread</p>
<ul>
<li>Usando uma linguagem de alto-nível como C/C++/Java, escrever um programa que crie 30 threads e faça com que uma mensagem circule entre os mesmos. </li>
<li>A mensagem é uma string aleatória de pelo menos 80 caracteres. </li>
<li>A cada vez que um thread recebe a mensagem ele a imprime, modifica o primeiro caractere minúsculo para maiúsculo, caso exista, dorme por 1 segundo, e repassa a mensagem. </li>
<li>Quando todos os caracteres forem maiúsculos, o processo repassa a mensagem e então termina. </li>
<li>Antes de terminar, o processo deve imprimir a mensagem resultante.</li>
</ul>
</div>
<h2 id="referencias">Referências</h2>
<ul>
<li>
<p>Sockets</p>
<ul>
<li><a href="http://pymotw.com/2/socket/udp.html">UDP em Python</a></li>
<li><a href="http://www.tutorialspoint.com/python/python_networking.htm">UDP em Python</a></li>
<li><a href="lycog.com/programming/multicast-programming-java/">Multicast em Java</a></li>
<li><a href="https://pymotw.com/2/socket/multicast.html">Multicast em Python</a></li>
<li><a href="https://beej.us/guide/bgnet/">Beej's Guide to Network Programming - Using Internet Sockets</a></li>
</ul>
</li>
<li>
<p>Concorrência em Java</p>
<ul>
<li><a href="http://jcip.net/">Java Concurrency in Practice</a></li>
<li><a href="https://www.manning.com/books/the-well-grounded-java-developer">The Well-Grounded Java Developer</a></li>
<li><a href="http://docs.oracle.com/javase/tutorial/essential/concurrency/simple.html">Concorrência em Java</a></li>
<li><a href="http://winterbe.com/posts/2015/04/07/java8-concurrency-tutorial-thread-executor-examples/">Futures e Promises</a></li>
<li><a href="http://winterbe.com/posts/2015/04/30/java8-concurrency-tutorial-synchronized-locks-examples/">Locks</a></li>
<li><a href="http://winterbe.com/posts/2015/05/22/java8-concurrency-tutorial-atomic-concurrent-map-examples/">Tipos Atômicos</a></li>
</ul>
</li>
<li>
<p>Concorrência em Python</p>
<ul>
<li><a href="https://www.tutorialspoint.com/python/python_multithreading.htm">Threads em Python</a></li>
</ul>
</li>
<li>
<p>Estado</p>
<ul>
<li>Uma visão interessante sobre estado é apresentada em <a href="https://leonmergen.com/on-stateless-software-design-what-is-state-72b45b023ba2">On stateless software design</a>. Observe que não necessariamente eu concordo com tudo o que está escrito aqui, principalmente a questão sobre <em>stateful</em> ser sempre mais complexo. A discrepância de visão está no fato de parte da complexidade ser levada para o cliente, no caso dos servidores <em>stateless</em>, mas não necessariamente ser eliminada.</li>
<li><a href="https://www.developer.com/java/data/understanding-asynchronous-socket-channels-in-java.html">Sobre IO não bloqueante em Java.</a></li>
</ul>
</li>
</ul>
<h2 id="coordenacao_1">Coordenação</h2>
<p>Como visto na seção sobre <a href="../fundamentals/#concorrencia">concorrência</a>, diversas tarefas exigem coordenação entre threads em uma aplicação monolítica em que se faz uso de concorrência para melhor uso de recursos computacionais, obtenção de melhor desempenho, e modularização do código. </p>
<p>Sistemas distribuídos levam concorrência a um novo patamar de complexidade, fazendo uso de múltiplos processos, cada um com possivelmente múltiplos <em>threads</em>, ainda por cima, espalhados geograficamente. 
Outras soluções e abstrações são portanto necessárias.</p>
<h2 id="exclusao-mutua">Exclusão Mútua</h2>
<p>Um dos problemas enfrentados em sistemas que fazem uso de concorrência, distribuídos ou não, é a exclusão mútua.
Em um sistema monolítico, uma variável global, um lock, ou outra primitiva de sincronização podem ser usadas na sincronização, mas em um sistema distribuído, primitivas simples como estas provavelmente não estarão disponíveis ou o sistema será muito restrito.
Como, então, controlar o acesso de múltiplos processos a um recurso compartilhado, garantindo que cada processo controla <strong>exclusivamente</strong> aquele recurso durante seu acesso?
Qualquer solução que se proponha a este problema de exclusão mútua, precisa ter as propriedades 1, 2, 3, e, idealmente, a 4, a seguir:</p>
<div class="admonition info">
<p class="admonition-title">Exclusão Mútua</p>
<ol>
<li><strong>exclusão mútua</strong> - somente um processo pode estar na <strong>região crítica</strong> em qualquer instante de tempo;</li>
<li><strong>ausência de deadlocks</strong> - se processos estão tentando acessar o recurso, então <strong>algum processo deve conseguir acesso</strong> em algum instante, dado que nenhum processo fique na região crítica indefinidamente;</li>
<li><strong>não-inanição</strong> - todos os processos interessados conseguem, em algum momento, acessar o recurso;</li>
<li><strong>espera limitada</strong> - o tempo de espera pelo recurso é limitado.</li>
</ol>
</div>
<p>Há diversas soluções para exclusão mútua em sistemas distribuídos, em diversos cenários, com seus prós e contras.
Três das mais simples, e que ilustram o universo de soluções são via um processo centralizador, em um anel em que "a vez" é circulada, e baseada em quóruns.</p>
<h3 id="coordenador">Coordenador</h3>
<p>Enquanto em um sistema monolítico há um sistema operacional que  provê abstrações simples para os processos a serem coordenados, em um sistema distribuído, não há naturalmente tal entidade.
Uma possível solução para o problema de exclusão mútua em um ambiente distribuído é justamente dar um passo para trás e introduzir um coordenador.</p>
<p>Nesta abordagem, os processos que precisam acessar a região crítica são denominados <strong>participantes</strong> e um dos processos assume o papel de <strong>coordenador</strong>. É possível que um mesmo processo atue nos dois papéis sem nenhum prejuízo. Os processos executam o seguinte protocolo:</p>
<div class="admonition example">
<p class="admonition-title">Participante</p>
<ol>
<li>Envia requisição de acesso ao coordenador</li>
<li>Espera por resposta do coordenador</li>
<li>Acessa o recurso</li>
<li>Envia liberação do recurso para o coordenador</li>
</ol>
</div>
<div class="admonition example">
<p class="admonition-title">Coordenador</p>
<ol>
<li>Inicializa recurso como livre</li>
<li>Ao receber uma requisição, a enfileira</li>
<li>Ao receber uma liberação, marca o recurso como livre</li>
<li>Sempre que recurso estiver marcado como livre <strong>E</strong> a fila não estiver vazia<ol>
<li>remove primeiro processo da fila</li>
<li>envia liberação para processo removido</li>
<li>marca o recurso como ocupado</li>
</ol>
</li>
</ol>
</div>
<p>O diagrama a seguir apresenta uma execução deste protocolo em um cenário com três participantes.
O estado do coordenador mostra se o recurso está livre ou ocupado e quais processos esperam por permissão de acesso.</p>
<div class="mermaid">sequenceDiagram
    participant Coordenador
    note over Coordenador: Recurso=livre/Fila = []
        Part1-&gt;&gt;Coordenador: RequestAccess
    note over Coordenador: Recurso=livre/Fila = [Part1]
        Coordenador-&gt;&gt;+Part1: ResponseOK
    note over Coordenador: Recurso=ocupado/Fila = []
        Part2-&gt;&gt;Coordenador: RequestAccess
    note over Coordenador: Recurso=ocupado/Fila = [Part2]
        Part1-&gt;&gt;-Coordenador: RequestFree
    note over Coordenador: Recurso=livre/Fila = [Part2]
        Coordenador-&gt;&gt;Part1: ResponseFree
        Part3-&gt;&gt;Coordenador: RequestAccess
    note over Coordenador: Recurso=livre/Fila = [Part2,Part3]
        Coordenador-&gt;&gt;+Part2: ResponseOK
    note over Coordenador: Recurso=ocupado/Fila = [Part3]
        Part2-&gt;&gt;-Coordenador: RequestFree
    note over Coordenador: Recurso=livre/Fila = [Part3]
        Coordenador-&gt;&gt;Part2: ResponseFree
    note over Coordenador: Recurso=ocupado/Fila = []
        Coordenador-&gt;&gt;+Part3: ResponseOK
        Part3-&gt;&gt;-Coordenador: RequestFree
    note over Coordenador: Recurso=livre/Fila = []
        Coordenador-&gt;&gt;Part3: ResponseFree</div>
<p>Este algoritmo satisfaz as características elencadas acima.   </p>
<ul>
<li>Exclusão mútua - se o coordenador autoriza um participante X, somente após o participante X liberar o recurso é que outro participante poderá obter nova autorização.</li>
<li>Ausência de deadlocks - Todo processo que requisitar o recurso, entrará em uma fila, em apenas uma posição; assim, a fila proverá uma ordem total para os acessos, sem a possibilidade de circularidade nesta ordem.</li>
<li>Não-inanição - Dado que ninguém fura a fila e que a cada vez que o recurso é liberado a fila anda, em algum momento a vez do processo chegará.</li>
<li>Espera limitada - Dado que a posição na fila pode apenas decrementar, seria possível estimar quanto tempo o participante precisa esperar para acessar o recurso.</li>
</ul>
<p>Outra vantagem deste algoritmo é sua simplicidade e, consequentemente, facilidade de implementação.
Contudo, este algoritmo tem também desvantagens, por exemplo, se muitas requisições de acesso forem feitas, o coordenador pode ser sobrecarregado e se tornar um <strong>gargalo</strong> no acesso à região crítica.</p>
<p>Mais sério ainda é a questão de como lidar com falhas, por exemplo, se ou o coordenador ou o participante que detem o direito de acesso ao recurso para de funcionar,  então nenhum outro processo conseguirá acesso.
Estes aspectos nos permitem mergulhar na área de tolerância a falhas, e o faremos, mas mais tarde. 
Por enquanto, consideraremos tolerância a falhas de forma superficial, após discutirmos outra abordagem.</p>
<h3 id="anel">Anel</h3>
<p>Nesta abordagem, os processos se organizam em um anel lógico, com um processo antes e outro depois. 
Um dos processos é iniciado com um <em>token</em> que dá acesso ao recurso e o <em>token</em> é passado adiante no anel; sempre que estiver de posse do token, o processo pode acessar o recurso. Ou seja, todos os participantes executam o seguinte protocolo:</p>
<div class="admonition example">
<p class="admonition-title">Participante</p>
<ol>
<li>Ao receber o <em>token</em> de acesso, se quiser acessar o recurso, acessa.</li>
<li>Envia o <em>token</em> para o próximo nó do anel.</li>
</ol>
</div>
<p>O diagrama adiante mostra uma execução do algoritmo em que apenas os participantes 1 e 3 acessam o recurso.</p>
<div class="mermaid">sequenceDiagram
    Part1-&gt;&gt;Part2: Permissão de Acesso
    Part2-&gt;&gt;Part3: Permissão de Acesso
        note over Part3: Acessa o recurso
    Part3-&gt;&gt;Part4: Permissão de Acesso
    Part4-&gt;&gt;Part1: Permissão de Acesso
        note over Part1: Acessa o recurso
        Part1-&gt;&gt;Part2: Permissão de Acesso
    Part2-&gt;&gt;Part3: Permissão de Acesso
        note over Part3: Acessa o recurso
    Part3-&gt;&gt;Part4: Permissão de Acesso
    Part4-&gt;&gt;Part1: Permissão de Acesso</div>
<p>Como o algoritmo centralizado, o algoritmo do anel também garante as propriedades 1, 2, 3 e 4, além de ser fácil de implementar, testar e entender.
Diferente do algoritmo centralizado, o algoritmo do anel não sofre com problemas de gargalo, pois nenhum processo precisa participar em todos os acessos, como o coordenador.
Contudo, o algoritmo do anel desperdiça tempo passando o <em>token</em> para quem não necessariamente quer acessar a região crítica.
Também importante é que este algoritmo também sofre com falhas: se um participante falha enquanto com o <em>token</em>, levando-o para além.</p>
<h3 id="lidando-com-falhas">Lidando com Falhas</h3>
<p>Em ambos os algoritmos, centralizado e do anel, se um processo falhar, o algoritmo pode ficar "travado". 
Vejamos alguns casos específicos:</p>
<ul>
<li>No algoritmo centralizado, se o coordenador falha antes de liberar o acesso para algum processo, ele leva consigo a permissão.</li>
<li>Em ambos os algoritmos, se o processo acessando o recurso falha, a permissão é perdida e os demais processos sofrerão inanição.</li>
<li>No algoritmo do anel, se qualquer outro processo falha, o anel é interrompido o anel não conseguirá circular.</li>
</ul>
<p>Observe que nem falamos de falhas dos canais e já temos diversos cenários a serem resolvidos, para os quais se lhes pedir uma solução, tenho certeza absoluta de que me oferecerão alguma baseada em <em>timeouts</em>.
Por exemplo, se o processo não devolver a permissão de acesso antes de que uma certa quantidade de tempo tenha passado, um <em>timeout</em>, então assuma que o mesmo parou de funcionar e não voltará mais, e gere uma nova permissão a ser passada a outros requisitantes.  Aplicada esta ideia do <em>timeout</em>  no algoritmo com coordenador, teremos o efeito ilustrado a seguir.</p>
<div class="mermaid">sequenceDiagram
    participant Coordenador
    note over Coordenador: Recurso=livre/Fila = []
        Part1-&gt;&gt;Coordenador: RequestAccess
    note over Coordenador: Recurso=livre/Fila = [Part1]
        Coordenador-&gt;&gt;+Part1: ResponseOK
    note over Coordenador: Recurso=ocupado/Fila = []
        Part2-&gt;&gt;Coordenador: RequestAccess
    note over Coordenador: Recurso=ocupado/Fila = [Part2]
        Part1-&gt;&gt;-Coordenador: RequestFree
    note over Coordenador: Recurso=livre/Fila = [Part2]
        Coordenador-&gt;&gt;Part1: ResponseFree
        Part3-&gt;&gt;Coordenador: RequestAccess
    note over Coordenador: Recurso=livre/Fila = [Part2,Part3]
        Coordenador-&gt;&gt;Part2: ResponseOK
    activate Part2
    note over Coordenador: Recurso=ocupado/Fila = [Part3]

    note over Part2: 💀☠️💀☠️💀☠️💀
    deactivate Part2
        Coordenador-&gt;&gt;Coordenador: Timeout

    note over Coordenador: Recurso=livre/Fila = [Part3]
    note over Coordenador: Recurso=ocupado/Fila = []
        Coordenador-&gt;&gt;+Part3: ResponseOK
        Part3-&gt;&gt;-Coordenador: RequestFree
    note over Coordenador: Recurso=livre/Fila = []
        Coordenador-&gt;&gt;Part3: ResponseFree</div>
<p>O problema desta e outras "soluções" baseadas em <em>timeouts</em> está no <strong>assumir que o processo parou de funcionar</strong>, pois caso isso não seja verdade, teremos agora duas autorizações ao mesmo tempo no sistema, podendo levar à violação da propriedade de exclusão mútua. </p>
<div class="mermaid">sequenceDiagram
    participant Coordenador
    note over Coordenador: Recurso=livre/Fila = []
        Part1-&gt;&gt;Coordenador: RequestAccess
    note over Coordenador: Recurso=livre/Fila = [Part1]
        Coordenador-&gt;&gt;+Part1: ResponseOK
    note over Coordenador: Recurso=ocupado/Fila = []
        Part2-&gt;&gt;Coordenador: RequestAccess
    note over Coordenador: Recurso=ocupado/Fila = [Part2]
        Part1-&gt;&gt;-Coordenador: RequestFree
    note over Coordenador: Recurso=livre/Fila = [Part2]
        Coordenador-&gt;&gt;Part1: ResponseFree
        Part3-&gt;&gt;Coordenador: RequestAccess
    note over Coordenador: Recurso=livre/Fila = [Part2,Part3]
        Coordenador-&gt;&gt;+Part2: ResponseOK
    note over Coordenador: Recurso=ocupado/Fila = [Part3]

        Coordenador-&gt;&gt;Coordenador: Timeout

    note over Coordenador: Recurso=livre/Fila = [Part3]
    note over Coordenador: Recurso=ocupado/Fila = []
    rect rgb(200, 0, 0)
        Coordenador-&gt;&gt;+Part3: ResponseOK

        Part2-&gt;&gt;-Coordenador: RequestFree
        Part3-&gt;&gt;-Coordenador: RequestFree
    end
    note over Coordenador: Recurso=livre/Fila = []
        Coordenador-&gt;&gt;Part3: ResponseFree</div>
<p>Por mais que se ajuste o valor do temporizador, em um sistema distribuído assíncrono, mesmo que aumentado com um relógio para medir a passagem do tempo local, o mesmo pode <strong>sempre</strong> estar errado. </p>
<div class="admonition warning">
<p class="admonition-title">Impossibilidade de detecção de falhas</p>
<p>Em um sistema distribuído assíncrono, é impossível distinguir um processo falho de um processo lento.</p>
</div>
<p>Mais tarde discutiremos as implicações desta impossibilidade. Por agora, tentemos responder à seguinte questão.</p>
<div class="admonition question">
<p class="admonition-title">Pergunta!</p>
<p>Qual deve ser um <em>timeout</em>  <strong>razoável</strong> para o meu sistema?</p>
</div>
<p>A resposta depende de mais perguntas, como:</p>
<ul>
<li>Qual o custo <span class="arithmatex">\(E\)</span> de esperar por mais tempo?</li>
<li>Qual o custo <span class="arithmatex">\(C\)</span> de cometer um engano?</li>
<li>Qual a probabilidade <span class="arithmatex">\(p\)</span> de cometer um engano?</li>
</ul>
<p>O custo esperado por causa dos erros, isto é, a esperança matemática da variável aleatória custo, é menor que o custo de se esperar por mais tempo, isto é, <span class="arithmatex">\(C * p &lt; E\)</span>?</p>
<p>Embora esta análise possa ser feita para estes algoritmos, a verdade é que são realmente limitados e outras abordagens seriam melhor destino dos seus esforços.
Por exemplo, podemos partir para a análise de algoritmos probabilísticos, pois afinal, como disse certa vez Werner Vogels, CTO da Amazon</p>
<blockquote>
<p>Se o mundo é probabilístico, porquê meus algoritmos devem ser determinísticos?"</p>
</blockquote>
<p>Uma abordagem probabilística interessante é baseada em quóruns.</p>
<h3 id="quorum">Quórum</h3>
<p>De acordo com o <a href="https://dicionario.priberam.org/quorum">Dicionário Priberam da Língua Portuguesa, consultado em 17-04-2019</a>, "quórum" é o  </p>
<blockquote>
<p>Número de pessoas imprescindível para a realização de algo.</p>
</blockquote>
<p>Aqui, este este <em>algo</em> será a liberação de acesso ao recurso almejado pelos processos no sistema distribuído.</p>
<p>Esta abordagem é semelhante em vários aspectos à coordenada.
De fato, um dos papéis na abordagem é o de coordenador, que executa o mesmo protocolo que antes.
Entretanto, em vez de apenas um coordenador no sistema, temos <span class="arithmatex">\(n\)</span>, dos quais o participante precisa obter <span class="arithmatex">\(m &gt; n/2\)</span> autorizações antes de acessar o recurso; <span class="arithmatex">\(m\)</span> é o quórum do sistema.</p>
<div class="admonition note">
<p class="admonition-title">Quórum</p>
<ul>
<li><span class="arithmatex">\(n\)</span> coordenadores.</li>
<li><span class="arithmatex">\(m &gt; n/2\)</span> coordenadores</li>
</ul>
</div>
<p>Já os demais participantes devem agora considerar todo o conjunto de coordenadores antes de assumir que tem acesso a um recurso. O algoritmo completo é o seguinte:   </p>
<div class="admonition example">
<p class="admonition-title">Coordenador</p>
<ol>
<li>Inicializa recurso como livre</li>
<li>Ao receber uma requisição, a enfileira</li>
<li>Ao receber uma liberação<ol>
<li>se do processo a quem autorizou, marca o recurso como livre</li>
<li>senão e se de um processo na fila, remove o processo da fila<sup id="fnref:id"><a class="footnote-ref" href="#fn:id">4</a></sup></li>
<li>senão, ignore mensagem.</li>
</ol>
</li>
<li>Sempre que recurso estiver marcado como livre <strong>E</strong> a fila não estiver vazia<ol>
<li>remove primeiro processo da fila</li>
<li>envia liberação para processo removido</li>
<li>marca o recurso como ocupado</li>
</ol>
</li>
</ol>
</div>
<div class="admonition example">
<p class="admonition-title">Participante</p>
<ol>
<li>Envia requisição de acesso aos <span class="arithmatex">\(n\)</span> coordenadores</li>
<li>Espera por resposta de <span class="arithmatex">\(m\)</span> coordenadores</li>
<li>Acessa o recurso</li>
<li>Envia liberação do recurso para os <span class="arithmatex">\(n\)</span> coordenadores</li>
</ol>
</div>
<p>Vejamos uma execução bem sucedida destes algoritmo, com <span class="arithmatex">\(n=3\)</span> e <span class="arithmatex">\(m=2\)</span>.</p>
<div class="mermaid">sequenceDiagram
    participant Coord1
    participant Coord2
    participant Coord3
    note over Coord1,Coord3: Recurso=livre/Fila = []
        Part1-&gt;&gt;Coord1: RequestAccess
        Part1-&gt;&gt;Coord2: RequestAccess

        Part2-&gt;&gt;Coord1: RequestAccess
        Part2-&gt;&gt;Coord2: RequestAccess

        Part2-&gt;&gt;Coord3: RequestAccess

        Part1-&gt;&gt;Coord3: RequestAccess

    note over Coord1,Coord2: Recurso=ocupado/Fila = [Part2]
        Coord1-&gt;&gt;Part1: ResponseOK
        Coord2-&gt;&gt;+Part1: ResponseOK


    note over Coord3: Recurso=ocupado/Fila = [Part1]
        Coord3-&gt;&gt;Part2: ResponseOK

    Part1-&gt;&gt;-Coord1: RequestFree
    Part1-&gt;&gt;Coord2: RequestFree
    Part1-&gt;&gt;Coord3: RequestFree

    note over Coord3: Recurso=ocupado/Fila = []

    note over Coord1,Coord2: Recurso=ocupado/Fila = []
        Coord1-&gt;&gt;+Part2: ResponseOK
        Coord2-&gt;&gt;Part2: ResponseOK

    Part2-&gt;&gt;-Coord1: RequestFree
    Part2-&gt;&gt;Coord2: RequestFree
    Part2-&gt;&gt;Coord3: RequestFree

    note over Coord1,Coord3: Recurso=livre/Fila = []</div>
<p>Para tornamos o problema mais interessante e demonstrar o potencial deste algoritmo, consideremos que as autorizações são armazenadas somente em memória, e que coordenadores, ao falhar e então resumir suas atividades, esquecem das autorizações já atribuídas.</p>
<div class="admonition warning">
<p class="admonition-title">Perda de memória</p>
<p>Quando um coordenador falha, esquece que deu ok e reinicia seu estado.</p>
</div>
<p>Este algoritmo é bom? Suponhamos o seguinte cenário:</p>
<ul>
<li>Coordenadores = {Coord1,Coord2,Coord3}</li>
<li><span class="arithmatex">\(n = 3\)</span></li>
<li><span class="arithmatex">\(m = 2\)</span></li>
<li>Participante Part1 consegue autorização de {Coord1,Coord2} e entra na região crítica.</li>
<li>Coordenador Coord2 falha e se recupera</li>
<li>Participante Part2 consegue autorização de {Coord2,Coord3} e entra na região crítica.</li>
</ul>
<div class="mermaid">sequenceDiagram
    participant Coord1
    participant Coord2
    participant Coord3
    note over Coord1,Coord3: Recurso=livre/Fila = []
        Part1-&gt;&gt;Coord1: RequestAccess
        Part1-&gt;&gt;Coord2: RequestAccess

        Part2-&gt;&gt;Coord1: RequestAccess
        Part1-&gt;&gt;Coord3: RequestAccess
        Part2-&gt;&gt;Coord3: RequestAccess

    note over Coord1,Coord2: Recurso=livre/Fila = [Part1,Part2]
    note over Coord3: Recurso=livre/Fila = [Part2,Part1]


    note over Coord1,Coord2: Recurso=ocupado/Fila = [Part2]
    note over Coord3: Recurso=ocupado/Fila = [Part1]

        Coord1-&gt;&gt;Part1: ResponseOK
        Coord2-&gt;&gt;+Part1: ResponseOK
        Coord3-&gt;&gt;Part2: ResponseOK

    note over Coord2: 💀☠️💀☠️💀☠️💀
    note over Coord2: Recurso=livre/Fila = []

        Part2-&gt;&gt;Coord2: RequestAccess
    note over Coord2: Recurso=livre/Fila = [Part2]
    note over Coord2: Recurso=livre/Fila = []
rect rgb(200, 0, 0)
        Coord2-&gt;&gt;+Part2: ResponseOk


        Part1-&gt;&gt;-Coord1: RequestFree
end
        Part1-&gt;&gt;Coord2: RequestFree
        Part1-&gt;&gt;Coord3: RequestFree

        Part2-&gt;&gt;-Coord1: RequestFree
        Part2-&gt;&gt;Coord2: RequestFree
        Part2-&gt;&gt;Coord3: RequestFree</div>
<p>Neste cenário, a propriedade de <strong>Exclusão Mútua</strong> é violada. 
Isto porquê, dados os dois quóruns, todos os processos na interseção foram reiniciados.
Mas de forma geral, qual a probabilidade de isso acontecer? 
Ou seja, dados dois quóruns, de tamanho <span class="arithmatex">\(m\)</span>, que se sobrepõem em <span class="arithmatex">\(k\)</span> processos, qual a probabilidade <span class="arithmatex">\(P_v\)</span> de que os <span class="arithmatex">\(k\)</span> processos na interseção sejam reiniciados e levem à violação?</p>
<p><img alt="Quoruns" src="../drawings/quorum_k.drawio-0.svg" /></p>
<p>Seja a <span class="arithmatex">\(P\)</span> a probabilidade de <strong>um coordenador em específico falhar</strong> e se recuperar dentro de uma janela de tempo <span class="arithmatex">\(\delta t\)</span>. Temos</p>
<ul>
<li>Probabilidade de falha de <strong>exatamente 1</strong> coordenador: <span class="arithmatex">\(P^1(1-P)^{n-1}\)</span></li>
<li>Probabilidade de <strong><span class="arithmatex">\(k\)</span> coordenadores</strong> falharem: <span class="arithmatex">\(P^k(1-P)^{n-k}\)</span></li>
<li>Probabilidade de quaisquer <span class="arithmatex">\(k\)</span> em <span class="arithmatex">\(m\)</span> coordenadores falharem: <span class="arithmatex">\(\binom{m}{k} P^k(1-P)^{m-k}\)</span>       </li>
</ul>
<p>Mas qual é o tamanho <span class="arithmatex">\(k\)</span> da interseção?</p>
<ul>
<li><span class="arithmatex">\(\left| A \cup B\right| = \left| A \right| + \left|B\right| - \left| A \cap B \right| \Rightarrow n = m + m - k\)</span></li>
<li><span class="arithmatex">\(\left| A \cap B \right| = \left| A \right| + \left|B\right| - \left| A \cup B\right| \Rightarrow k = m + m - n = 2m - n\)</span></li>
</ul>
<p>Até agora consideramos que a <span class="arithmatex">\(k\)</span> corresponde à cardinalidade da interseção dos dois quóruns, mas se mais do que a interseção forem reiniciados, também teremos problemas. Assim, se <span class="arithmatex">\(k\)</span> assume qualquer valor entre o tamanho da interseção e o número total de coordenadores, teremos problemas. </p>
<ul>
<li>Probabilidade de quaisquer <span class="arithmatex">\(k\)</span> em <span class="arithmatex">\(m\)</span> coordenadores falharem, para qualquer <span class="arithmatex">\(k\)</span> variando de <span class="arithmatex">\(2m-n\)</span> a <span class="arithmatex">\(n\)</span>: <span class="arithmatex">\(P_v = \sum_{k=2m-n}^n \binom{m}{k} P^k(1-P)^{m-k}\)</span></li>
</ul>
<p>Para facilitar o entendimento desta grandeza, considere o exemplo:</p>
<ul>
<li><span class="arithmatex">\(P=0.0001\)</span> (1 minuto a cada 10 dias)</li>
<li><span class="arithmatex">\(n = 32\)</span></li>
<li><span class="arithmatex">\(m = 0.75n\)</span></li>
<li><span class="arithmatex">\(P_v &lt; 10^{-40}\)</span> (<a href="https://cosmosmagazine.com/mathematics/the-big-baffling-number-at-the-heart-of-a-cosmic-coincidence">Curiosidade sobre <span class="arithmatex">\(10^{40}\)</span></a>)</li>
</ul>
<p>A probabilidade de violação da exclusão mútua, neste caso, é muito pequena, a despeito de suportar falhas dos coordenadores. </p>
<div class="admonition note">
<p class="admonition-title">Pró</p>
<ul>
<li>Tolera falhas de coordenadores, com probabilidade controlada de violação de exclusão mútua.</li>
</ul>
</div>
<p>Mas e as outras propriedades desejáveis do algoritmo de exclusão mútua, são alcançadas? Relembrando:</p>
<div class="admonition note">
<p class="admonition-title">Contras</p>
<ul>
<li>Exclusão Mútua probabilística: <span class="arithmatex">\(1 - P_v\)</span></li>
<li>Não-inanição<ul>
<li>E se cada participante obtiver o ok de um coordenador?</li>
<li>Temporizador para quebrar o <em>deadlock</em>?</li>
</ul>
</li>
<li>Espera limitada<ul>
<li>Aborts podem levar a espera infinita.</li>
</ul>
</li>
</ul>
</div>
<p>Assim, este algoritmo também pode não ser adequado para certas situações. Vamos tentar re-acessar os problemas da primeira abordagem.
Por um lado, o uso de um líder para coordenar ações em um SD simplifica o projeto, mas, por outro, o coordenador pode se tornar um ponto único de falha, como no algoritmo de exclusão mútua centralizado.
Mas e se substituíssemos o coordenador no caso de falhas? Este é o problema conhecido como eleição de líderes.</p>
<details class="bug"><summary>TODO</summary><ul>
<li>Maekawa - Diminui número de votos necessários (<a href="https://www.geeksforgeeks.org/maekawas-algorithm-for-mutual-exclusion-in-distributed-system/?ref=rp">descrição</a>)</li>
<li>Lamport - Usa relógios lógicos, mas é possível entender sem este background (<a href="https://www.geeksforgeeks.org/lamports-algorithm-for-mutual-exclusion-in-distributed-system/">descrição</a>)</li>
<li>Ricart-Agrawala - Melhora algoritmo de Lamport (<a href="https://www.geeksforgeeks.org/ricart-agrawala-algorithm-in-mutual-exclusion-in-distributed-system/?ref=rp">descrição</a>)</li>
<li><a href="https://www.cs.cmu.edu/~dga/15-440/F09/lectures/Distributed-Mutual-Exclusion-slides.pdf">Distributed-Mutual-Exclusion-slides</a></li>
</ul>
</details>
<h2 id="eleicao-de-lideres">Eleição de Líderes</h2>
<p>O problema da escolha de um processo centralizador, ou líder, pode ser posto informalmente como o procedimento pelo qual <strong>um processo é escolhido</strong> dentre os demais processos, sendo que o <strong>processo escolhido é ciente da escolha</strong> e <strong>todos os demais processos o identificam como eleito</strong>. Uma <strong>nova eleição</strong> deve acontecer sempre que o líder se tornar <strong>indisponível</strong>.
Formalmente, um algoritmo de eleição de líderes deve satisfazer as seguintes condições.</p>
<div class="admonition note">
<p class="admonition-title">Eleição de Líderes<sup id="fnref:guptaetal"><a class="footnote-ref" href="#fn:guptaetal">5</a></sup></p>
<ul>
<li>Terminação: algum processo deve se considerar líder em algum momento.</li>
<li>Unicidade: somente um processo se considera líder.</li>
<li>Acordo: todos os outros processos sabem quem foi eleito líder.</li>
</ul>
</div>
<p>Para entendermos melhor o problema, tentemos desenvolver um protocolo simples para escolhermos um líder, por exemplo, em sua turma da disciplina de Sistemas Distribuídos. Vejamos algumas questões importantes.</p>
<ul>
<li>Candidatos: todos os membros são elegíveis ou apenas um subconjunto dos mesmos?</li>
<li>Comunicação: todos se conhecem e se falam diretamente ou há grupos incomunicáveis dentro da turma?</li>
<li>Estabilidade: de que adianta eleger um dos colegas se frequentemente não está presente quando necessário?</li>
</ul>
<p>Em termos computacionais, estas questões são relevantes pois todos os processos <strong>não</strong> nascem iguais; alguns residem em máquinas com mais memória, mais poder de processamento, melhor conexão com o resto do mundo ou maior grau de conectividade. Talvez este processo seja um líder mais útil que os demais.
Além disso, se o processo está frequentemente desconectado, mesmo que bem servido de recursos, não será um bom líder.</p>
<p>Ainda que assumamos um conjunto de processos indiferenciáveis entre si, com acesso equivalente a recursos e que estejam sempre disponíveis, ou exatamente por isso, temos  um problem mais fundamental para resolver: <strong>para eleger um líder, precisamos diferenciar processos</strong>.
Dentro de uma única máquina, identificamos processos facilmente usando seu <strong>PID</strong>, ou <em>process id</em>, um inteiro associado a cada processo instanciado pelo sistema operacional; o PID é válido enquanto o processo estiver executando e pode ser reciclado uma vez que o processo para de executar, o que pode ser um problema. Além disso, se o <em>host</em> é reiniciado, os PID também são, e portanto esta identificação não é duradoura. Mais importante, o PID só faz sentido dentro de uma única máquina e não em um sistema distribuído.</p>
<p>Se apenas uma instância do processo executa em um mesmo <em>host</em>, então o identificador do <em>host</em> (e.g., endereço IP) em si é suficiente e, de fato, comumente utilizado. 
Se mais de um processo executa no mesmo <em>host</em>, então cabe ao desenvolvedor criar um esquema que permita diferenciar os processos, e não precisa ser nada complicado; pode ser apenas um <strong>parâmetro</strong> passado na inicialização do processo ou a combinação <strong>IP/porta</strong>.</p>
<p>Assumindo que um esquema de nomeação está disponível e que todos os processos se conhecem, voltemos ao problema de eleger um líder para sua turma.
Uma abordagem que pode funcionar é colocar todos os candidatos para brigar e quem sobrar em pé no final, é o novo líder.</p>
<p><a href="https://esportes.umcomo.com.br/artigo/como-construir-um-octogono-de-mma-21408.html"><img alt="" src="../images/octogono.jpg" /></a></p>
<p>A despeito desta opção gerar um líder não muito popular, o algoritmo do brigão é um clássico.</p>
<h3 id="algoritmo-do-brigao-bully">Algoritmo do Brigão (<em>Bully</em>)</h3>
<p>No algoritmo do brigão, alguma <strong>característica comparável</strong> dos processos é escolhida e aquele processo funcional com o valor de tal característica mais vantajoso para um líder é escolhido como tal.
Por exemplo, pode ser vantajoso ter um líder com maior quantidade de memória, frequência da CPU ou largura de banda da conexão com a Internet; no caso de empate, o identificador do processo pode ser usado para gerar uma ordem total entre os processos.</p>
<p>Para simplificar, vamos assumir que o identificador do processo reflete as qualidades do mesmo para a liderança, tal que o processo com maior identificador seja o melhor candidato. Os maiores processos, os "brigões", eliminam os processos menores da competição, sempre que uma eleição acontecer. 
O algoritmo é apresentado a seguir, onde <span class="arithmatex">\(p\)</span> e <span class="arithmatex">\(q\)</span> são usados para representar tanto identificadores de processos quando os processos em si.</p>
<div class="admonition example">
<p class="admonition-title">Algoritmo do Brigão</p>
<ul>
<li>Quando <span class="arithmatex">\(p\)</span> suspeita que o líder não está presente (muito tempo se receber mensagens do mesmo)<ul>
<li><span class="arithmatex">\(p\)</span> envia mensagem (ELEICAO,<span class="arithmatex">\(p\)</span>) para todos os processos com identificador maior que <span class="arithmatex">\(p\)</span></li>
<li>Inicia temporizador de respostas</li>
</ul>
</li>
<li>Quando temporizador de respostas expira<ul>
<li>Envia (COORD,<span class="arithmatex">\(p\)</span>) para todos os processos</li>
</ul>
</li>
<li>Quando recebe (Ok,<span class="arithmatex">\(p\)</span>)<ul>
<li>Para temporizador de resposta</li>
</ul>
</li>
<li>Quando <span class="arithmatex">\(p\)</span> recebe (ELEICAO,<span class="arithmatex">\(q\)</span>), <span class="arithmatex">\(q &lt; p\)</span><ul>
<li>Envia (OK,<span class="arithmatex">\(q\)</span>)</li>
</ul>
</li>
<li>Quando um processo falho se recupera<ul>
<li>Inicia uma eleição</li>
</ul>
</li>
</ul>
</div>
<p>Observe como o algoritmo foi descrito em termos de <strong>eventos</strong> e não de forma sequencial. Este tipo de especificação é comum para algoritmos paralelos e distribuídos, pois não há uma sequência pré-estabelecida de passos a serem executados por todos os processos, apenas alguns pontos de coordenação.
No exemplo a seguir, temos 5 processos, com identificadores de 1 a 5, passando por 7 passos até que a eleição se complete.
Observe que os processos não sabem a priori como os eventos aconteceram e apenas reagem aos <strong>eventos</strong> de <strong>recepção de mensagens</strong> e <strong>expiração de temporizadores</strong>.</p>
<ol>
<li>o líder já é o processo 5 (em rosa).</li>
<li>os processos 2 e 3 (amarelo) se "cansaram" de esperar por 5, que falhou (em cinza, e se candidataram a líder, enviando (ELEICAO,2) e (ELEICAO,3), respectivamente, (verde).</li>
<li>4 responde a 2 a 3 com (OK,2) e (OK,3) como resposta a 2 e 3, respectivamente, e 3 envia (OK,2) para 2.</li>
<li>1 se candidata com enviando (ELEICAO,1).</li>
<li>2, 3 e 4 respondem com (OK,1).</li>
<li>4 se candidata enviando (ELEICAO,4) para 5, que não responde, já que está falho.</li>
<li>4 se declara líder e envia (COORD,4) a todos os processos. </li>
</ol>
<p><img alt="Bully algorithm" src="../images/bully.png" /></p>
<p>Como já discutido antes, a escolha do valor temporizador é fundamental para o bom funcionamento do algoritmo.
Se o temporizador usado pelos processos para esperar pelo líder for ajustado de forma agressiva, frequentemente serão iniciadas eleições mesmo que o líder não tenha falhado.
Já se o valor do temporizador for muito grande, o sistema <strong>demorará a eleger um novo líder</strong>.
Da mesma forma, se o tempo esperado por um candidato antes de se declarar líder for muito curto, <strong>mais de um processo pode se declarar líder</strong>, uma situação conhecida como <em>split-brain</em>.</p>
<p>Idealmente, um processo deveria esperar por outro enquanto o outro estiver apto a responder, mas isso requer saber quando o outro processo não está mais apto, isto é, falhou.
Como identificar exatamente quando isso aconteceu é impossível em sistemas distribuídos assíncronos, o algoritmo do brigão não resolve o problema neste ambiente.</p>
<p><img alt="Why you bully?" src="../images/why-you-bully-meme.jpg" />  </p>
<p>Mas se delimitarmos melhor o ambiente, podemos chegar a soluções melhores.</p>
<h3 id="algoritmos-em-aneis">Algoritmos em Anéis</h3>
<p>Consideremos processos organizados em um anel lógico em que processos troquem mensagens apenas com processos à "esquerda" e à "direita".
Considere também que todos os processos são exatamente idênticos, inclusive não possuindo identificadores próprios.
Suponha o seguinte algoritmo de eleição neste anel, em que um processo inicialmente Seguidor se torna Candidato, então se declara Eleito, avisa a seus pares e, finalmente, se declara Empossado.</p>
<div class="admonition example">
<p class="admonition-title">Algoritmo do Anel 1</p>
<ul>
<li>Na iniciação<ul>
<li>Organize os nós em um anel lógico</li>
<li><span class="arithmatex">\(C \gets\)</span> Seguidor</li>
</ul>
</li>
<li>Quando um processo acha que o líder está morto<ul>
<li><span class="arithmatex">\(C \gets\)</span> Candidato</li>
<li>Envia (VoteEmMim) para "a direita" no anel.</li>
</ul>
</li>
<li>Quando um processo recebe (VoteEmMim)<ul>
<li>Se <span class="arithmatex">\(C =\)</span> Seguidor <ul>
<li>envia (VoteEmMim) para a direita</li>
</ul>
</li>
<li>Se <span class="arithmatex">\(C =\)</span> Candidato <ul>
<li><span class="arithmatex">\(C \gets\)</span> Eleito</li>
<li>envia (HabemosLeader) para a direita</li>
</ul>
</li>
</ul>
</li>
<li>Quando um processo recebe (HabemosLeader)<ul>
<li>Se <span class="arithmatex">\(C =\)</span> Seguidor<ul>
<li>envia (HabemosLeader) para a direita</li>
</ul>
</li>
<li>Se <span class="arithmatex">\(C =\)</span> Eleito <ul>
<li><span class="arithmatex">\(C \gets\)</span> Empossado</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>Imagine um cenário com dois processos, como na imagem a seguir. 
Os nomes dos processos são apenas para facilitar o entendimento do fluxo de mensagens e não estão acessíveis aos processos. <br />
<img alt="" src="../drawings/anel1.drawio-0.svg" /> <br />
Executando o algoritmo Anel 1, os processos enviam (<span class="arithmatex">\(\rightarrow\)</span>) e recebem (<span class="arithmatex">\(\leftarrow\)</span>) as seguintes mensagens e ajustam <span class="arithmatex">\(C\)</span> da seguinte forma.</p>
<table>
<thead>
<tr>
<th>1</th>
<th>2</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="arithmatex">\(C \gets\)</span> Seguidor</td>
<td><span class="arithmatex">\(C \gets\)</span> Seguidor</td>
</tr>
<tr>
<td><span class="arithmatex">\(C \gets\)</span> Candidato</td>
<td></td>
</tr>
<tr>
<td>(VoteEmMim) <span class="arithmatex">\(\rightarrow\)</span></td>
<td></td>
</tr>
<tr>
<td></td>
<td>(VoteEmMim) <span class="arithmatex">\(\leftarrow\)</span></td>
</tr>
<tr>
<td></td>
<td>(VoteEmMim) <span class="arithmatex">\(\rightarrow\)</span></td>
</tr>
<tr>
<td>(VoteEmMim) <span class="arithmatex">\(\leftarrow\)</span></td>
<td></td>
</tr>
<tr>
<td><span class="arithmatex">\(C \gets\)</span> Eleito</td>
<td></td>
</tr>
<tr>
<td>(HabemosLider) <span class="arithmatex">\(\rightarrow\)</span></td>
<td></td>
</tr>
<tr>
<td></td>
<td>(HabemosLider) <span class="arithmatex">\(\leftarrow\)</span></td>
</tr>
<tr>
<td></td>
<td>(HabemosLider) <span class="arithmatex">\(\rightarrow\)</span></td>
</tr>
<tr>
<td>(HabemosLider) <span class="arithmatex">\(\leftarrow\)</span></td>
<td></td>
</tr>
<tr>
<td><span class="arithmatex">\(C \gets\)</span> Empossado</td>
<td></td>
</tr>
</tbody>
</table>
<p>Agora imagine que por um acaso, tanto processo 1 quanto o 2 se candidatassem ao mesmo tempo.</p>
<table>
<thead>
<tr>
<th>1</th>
<th>2</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="arithmatex">\(C \gets\)</span> Seguidor</td>
<td><span class="arithmatex">\(C \gets\)</span> Seguidor</td>
</tr>
<tr>
<td><span class="arithmatex">\(C \gets\)</span> Candidato</td>
<td><span class="arithmatex">\(C \gets\)</span> Candidato</td>
</tr>
<tr>
<td>(VoteEmMim) <span class="arithmatex">\(\rightarrow\)</span></td>
<td>(VoteEmMim) <span class="arithmatex">\(\rightarrow\)</span></td>
</tr>
<tr>
<td>(VoteEmMim) <span class="arithmatex">\(\leftarrow\)</span></td>
<td>(VoteEmMim) <span class="arithmatex">\(\leftarrow\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(C \gets\)</span> Eleito</td>
<td><span class="arithmatex">\(C \gets\)</span> Eleito</td>
</tr>
<tr>
<td>(HabemosLider) <span class="arithmatex">\(\rightarrow\)</span></td>
<td>(HabemosLider) <span class="arithmatex">\(\rightarrow\)</span></td>
</tr>
<tr>
<td>(HabemosLider) <span class="arithmatex">\(\leftarrow\)</span></td>
<td>(HabemosLider) <span class="arithmatex">\(\leftarrow\)</span></td>
</tr>
<tr>
<td><span class="arithmatex">\(C \gets\)</span> Empossado</td>
<td><span class="arithmatex">\(C \gets\)</span> Empossado</td>
</tr>
</tbody>
</table>
<p>Como não há nada que diferencie os processos entre si, este cenário é perfeitamente válido, e se no primeiro cenário o algoritmo estava correto ao eleger o processo 1, então no segundo cenário o 1 também deve ser eleito, já que a sequência de evento observadas é exatamente a mesma.
Mas o processo 2 também vê a mesma sequência, então também deve ser eleito.
Assim, violamos a propriedade da Unicidade.</p>
<p>Para quebrar essa simetria entre os processo, podemos permitir que saibam seus identificadores.
No algoritmo seguinte, permitimos que os processos conheçam seus identificadores e um processo que suspeite do líder atual, envia uma mensagem no anel para coletar os identificadores de todos os processos.</p>
<div class="admonition example">
<p class="admonition-title">Algoritmo do Anel 2</p>
<ul>
<li>Organize os nós em um anel lógico</li>
<li>Quando <span class="arithmatex">\(p\)</span> acha que o líder está morto:<ul>
<li>Envia mensagem [<span class="arithmatex">\(p\)</span>] "à direita".</li>
</ul>
</li>
<li>Quando <span class="arithmatex">\(p\)</span> recebe <span class="arithmatex">\(l\)</span><ul>
<li>Se <span class="arithmatex">\(p \not \in l\)</span><ul>
<li>Envia  <span class="arithmatex">\([p:l]\)</span> para a direita.</li>
</ul>
</li>
<li>Se <span class="arithmatex">\(p \in l\)</span><ul>
<li>Escolhe menor id em <span class="arithmatex">\(l\)</span> como líder.</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>Este algoritmo envia até <span class="arithmatex">\(n^2\)</span> mensagens, se todos iniciarem a eleição ao mesmo tempo, e as mensagens crescem até o tamanho <span class="arithmatex">\(n\)</span>.
O algoritmo de Chang e Robert<sup id="fnref:changrobert"><a class="footnote-ref" href="#fn:changrobert">6</a></sup> limita o tamanho das mensagens ao pré-selecionar candidatos viáveis.</p>
<div class="admonition note">
<p class="admonition-title">Algoritmo de Chang e Robert<ul>
<li>Organize os nós em um anel lógico</li>
<li>Quando <span class="arithmatex">\(p\)</span> acha que o líder está morto:<ul>
<li>Envia mensagem <span class="arithmatex">\((p)\)</span> à direita</li>
</ul>
</li>
<li>Quando <span class="arithmatex">\(p\)</span> recebe <span class="arithmatex">\((q)\)</span><ul>
<li>Se <span class="arithmatex">\(p = q\)</span><ul>
<li><span class="arithmatex">\(p\)</span> se declara líder</li>
</ul>
</li>
<li>Senão e se <span class="arithmatex">\(q &gt; p\)</span><ul>
<li>Envia <span class="arithmatex">\((q)\)</span> para a direita.</li>
</ul>
</li>
</ul>
</li>
</ul>
</p>
</div>
<p>Neste algoritmo, todas as mensagens tem tamanho <span class="arithmatex">\(O(1)\)</span> e somente uma mensagem dá uma volta completa do anel; todas as outras são descartadas no meio do caminho.
Apesar disso, pode-se demonstrar que o pior caso em termos de número de mensagens do algoritmo até que alguém se declare líder é <span class="arithmatex">\(O(n^2)\)</span>.</p>
<div class="admonition exercise">
<p class="admonition-title">Exercício: Quantidade de mensagens</p>
<ul>
<li>O pior caso em termos de número de mensagens até que alguém seja eleito é <span class="arithmatex">\(O(n^2)\)</span>. Descreva como os nós devem estar organizados para que esta situação ocorra.</li>
<li>Observe que no algoritmo um processo apenas se "declara líder", mas os outros não necessariamente ficam sabendo disso. Como você o corrigiria para que terminasse?</li>
</ul>
</div>
<p>Diversos outros algoritmos existem para a topologia em anel. O algoritmo de Franklin é um dos que propõe melhorias para reduzir quantidade de mensagens usadas na eleição.
Ele faz isso em rodadas, comparando identificadores com outros processos ativos tanto à esquerda quanto à direita e desativando os processos não viáveis.</p>
<div class="admonition note">
<p class="admonition-title">Algoritmo de Franklin</p>
<ul>
<li>Organize os nós em um anel lógico</li>
<li>Ativo <span class="arithmatex">\(\gets 1\)</span></li>
<li>Quando <span class="arithmatex">\(p\)</span> acha que o líder está morto e se Ativo $ = 1$ :<ul>
<li>Envia mensagem <span class="arithmatex">\((p)\)</span> à direita e à esquerda</li>
</ul>
</li>
<li>Quando <span class="arithmatex">\(p\)</span> recebe <span class="arithmatex">\(e\)</span> e <span class="arithmatex">\(d\)</span>, da esquerda e da direita, respectivamente:<ul>
<li>Se Ativo <span class="arithmatex">\(=1\)</span><ul>
<li>Se <span class="arithmatex">\(max(e,d) &lt; p\)</span><ul>
<li>Envia mensagem <span class="arithmatex">\((p)\)</span> à direita e à esquerda</li>
</ul>
</li>
<li>Se <span class="arithmatex">\(max(e,d) &gt; p\)</span><ul>
<li>Ativo <span class="arithmatex">\(\gets 0\)</span></li>
<li>Envia mensagem <span class="arithmatex">\(-p\)</span> à direita e à esquerda</li>
</ul>
</li>
<li>Se <span class="arithmatex">\(max(e,d) = p\)</span><ul>
<li><span class="arithmatex">\(p\)</span> se declara líder.</li>
</ul>
</li>
</ul>
</li>
<li>Se Ativo <span class="arithmatex">\(=0\)</span><ul>
<li>Repassa cada mensagem para o outro lado.</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>No exemplo na figura, os nós brancos são ativos e os amarelos inativos. 
Observe o papel do nó no centro, supondo que tem o maior identificador entre todos os processos. 
Inicialmente ele envia as mensagens em verde para os lados, que levam seus vizinhos imediatos a se inativarem.
Na segunda rodada, as mensagens são repassadas para os vizinhos dos vizinhos, que também se inativam.</p>
<p><img alt="Algoritmo de Franklin" src="../drawings/leaderelection.drawio-0.svg" /></p>
<p>Observe o seguinte:</p>
<ul>
<li>Em cada fase, para qualquer par de vizinhos ativos, pelos um dos dois é inativado e, portanto, o número de ativos cai pela metade; logo há no máximo <span class="arithmatex">\(O(log n)\)</span> fases.</li>
<li>Na primeira fase, cada processo ativo leva a <span class="arithmatex">\(4\)</span> mensagens serem enviadas na rede (sem nenhuma otimização). Dado que são <span class="arithmatex">\(n\)</span> processos, temos <span class="arithmatex">\(4n\)</span> mensagens, <span class="arithmatex">\(O(n)\)</span></li>
<li>Na segunda fase, cada processo ativo leva a 8 mensagens. Contudo, metade dos processos, pelo menos, foram inativados na primeira fase. Logo, temos <span class="arithmatex">\(8n \times n/2, O(n)\)</span></li>
<li>Assim, no máximo <span class="arithmatex">\(O(n log n)\)</span> mensagens são enviadas em uma execução do algoritmo.</li>
</ul>
<h3 id="algoritmo-do-yoyo">Algoritmo do YoYo</h3>
<p>Saindo da topologia em anel, vejamos o algoritmo do Yoyo, que funciona em qualquer topologia conexa, mesmo se processos não puderem se falar diretamente.
Inicialmente as arestas do formado pelos processos e seus canais de comunicação são não direcionadas, mas na medida em que o protocolo é executado,  as arestas são marcadas como tendo um ou outro sentido.
Esta marcação é apenas lógica e mensagens fluem em ambos os sentidos.
De acordo com o tipo de arestas que um processo tem, ele é classificado como um de três tipos: </p>
<ul>
<li>Fonte (source) - processo que só tem arestas de saída</li>
<li>Vertedouro (sink) - processo que só tem arestas de chegada</li>
<li>Interno - processo que tem arestas de chegada e de saída</li>
</ul>
<p>O algoritmo executa em duas fases. Na primeira, cada processo marca sua arestas como apontando para o maior dentre si próprio e seus vizinhos.
Na segunda fase, mensagens "vão e voltam", o que dá o nome ao algoritmo.
Na "ida", as mensagens vão das fontes para os vertedouros, que identificam quais fontes tem os menores identificadores e sinalizam para que continuem fontes na próxima etapa com mensagens de volta.
As mensagens de volta reordenam as arestas para garantir este comportamento.
Vejamos o algoritmo em mais detalhes.</p>
<div class="admonition note">
<p class="admonition-title">Algoritmo do YoYo</p>
<ul>
<li>
<p>Fase 1</p>
<ul>
<li><span class="arithmatex">\(p\)</span> envia seu identificador para seus vizinhos.<ul>
<li>Quando <span class="arithmatex">\(p\)</span> recebe <span class="arithmatex">\(q\)</span><ul>
<li>Se <span class="arithmatex">\(p&gt;q\)</span><ul>
<li>Marca a aresta em que recebeu <span class="arithmatex">\(q\)</span> como sendo de chegada (<span class="arithmatex">\(p\leftarrow q\)</span>)</li>
</ul>
</li>
<li>Senão<ul>
<li>Marca a aresta em que recebeu <span class="arithmatex">\(q\)</span> como sendo de saída (<span class="arithmatex">\(q\leftarrow p\)</span>)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Fase 2</p>
<ul>
<li>
<p>Se <span class="arithmatex">\(p\)</span> é uma <strong>fonte</strong></p>
<ul>
<li><span class="arithmatex">\(p\)</span> envia seu identificador em todas as suas arestas de saída.</li>
<li>Quando <span class="arithmatex">\(p\)</span> receber <span class="arithmatex">\(S\)</span> ou <span class="arithmatex">\(N\)</span> em todas as suas arestas de saída<ul>
<li>Se recebeu apenas <span class="arithmatex">\(S\)</span><ul>
<li>Executa fase 2 novamente </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Se <span class="arithmatex">\(p\)</span> é um <strong>nó interno</strong></p>
<ul>
<li>
<p>Quando <span class="arithmatex">\(p\)</span> receber identificadores em todas as suas arestas de entrada</p>
<ul>
<li>
<p>escolhe o menor id recebido <span class="arithmatex">\(m\)</span></p>
</li>
<li>
<p>envia <span class="arithmatex">\(m\)</span> em todas as suas arestas de saída</p>
</li>
</ul>
</li>
<li>
<p>Quando <span class="arithmatex">\(p\)</span> recebeu <span class="arithmatex">\(S\)</span> ou <span class="arithmatex">\(N\)</span> em todas as suas arestas de saída</p>
<ul>
<li>
<p>Se recebeu algum <span class="arithmatex">\(S\)</span></p>
<ul>
<li>
<p>envia <span class="arithmatex">\(S\)</span> para vizinhos de onde recebeu <span class="arithmatex">\(m\)</span></p>
</li>
<li>
<p>envia <span class="arithmatex">\(N\)</span> para vizinhos de onde recebeu <span class="arithmatex">\(m' \neq m\)</span></p>
</li>
</ul>
</li>
<li>
<p>Se não recebeu <span class="arithmatex">\(S\)</span></p>
<ul>
<li>envia <span class="arithmatex">\(N\)</span> para vizinhos de onde recebeu algum id.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Se <span class="arithmatex">\(p\)</span> é um <strong>vertedouro</strong></p>
<ul>
<li>
<p>Quando <span class="arithmatex">\(p\)</span> receber identificadores em todas as suas arestas de entrada</p>
<ul>
<li>
<p>escolhe o menor id recebido <span class="arithmatex">\(m\)</span></p>
</li>
<li>
<p>envia <span class="arithmatex">\(S\)</span> para vizinhos de onde recebeu <span class="arithmatex">\(m\)</span></p>
</li>
<li>
<p>envia <span class="arithmatex">\(N\)</span> para vizinhos de onde recebeu <span class="arithmatex">\(m' \neq m\)</span></p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>N inverte a direção das arestas em que trafega.</p>
</li>
</ul>
</li>
</ul>
</div>
<p><a href="https://en.wikipedia.org/wiki/Leader_election">Fonte</a></p>
<p>Veja um exemplo com 3 processos em destaque, uma fonte, um interno e um vertedouro.</p>
<p><img alt="Algoritmo do YoYo" src="../drawings/leaderelection.drawio-1.svg" /></p>
<p>Veja o seguinte exemplo, em que cada figura mostra um estágio da resolução do problema de eleição de líderes.</p>
<ul>
<li>a) A rede em seu estado inicial.</li>
<li>b) Rede orientada pela primera fase</li>
<li>c) Propagação de Fontes</li>
<li>d) Propagação de Vertedouros</li>
<li>e) Inativação dos vertedouros</li>
</ul>
<p>Exemplo: 
<img alt="Fonte: Hemis62 - Own work, CC BY-SA 4.0" src="../images/yoyo.png" /></p>
<p>Embora interessante, este algoritmo também tem problemas, sendo um dos mais críticos a forma de lidar com falhas, mesmo sem considerar falhas de processos.
Suponha que o canal de comunicação entre os processos 2 e 10 pare de funcionar. O que acontecerá?
Esta é uma situação que denominamos <strong>particionamento</strong> da rede e que neste caso levará a duas eleições concorrentes acontecerem e, consequentemente, a dois líderes sendo eleitos, o que é conhecido na área como <strong><em>split-brain</em></strong>.
Vejamos esta e outras situações problemáticas em eleição de líderes.</p>
<h3 id="questoes-importantes">Questões importantes</h3>
<h4 id="split-brain"><em>Split-brain</em></h4>
<p>Se o algoritmo viola a propriedade de unicidade, então fica com <em>split-brain</em>, em que parte da rede vê um processo como líder e parte vê outro.
Se o líder é o responsável por coordenar o acesso a uma região crítica, como visto no algoritmo coordenado de exclusão mútua, então ter dois líderes poderá levar a dois processos na região crítica e portanto violação da exclusão mútua. </p>
<p>Uma das formas de evitar <em>split-brain</em> é atribuir um <strong>"peso"</strong> para cada processo e só aceitar que um líder seja declarado se o mesmo seus votos carregarem mais da metade do peso do sistema.
Ainda assim, temos problemas, pois é necessário que rodadas sucessivas do algoritmo invalidem as eleições anteriores.
O algoritmo Raft de difusão atômica, que estudaremos adiante, define mandatos e garante, com pesos, que somente um líder existe em cada mandato. Devido à natureza assíncrona do sistema, processos podem se achar em mandatos distintos e, por isso, o mandato é associado a todas as comunicações; mensagens recebidas de mandatos anteriores são sumariamente descartadas.</p>
<p>Mas por quê precisamos de mandatos sucessivos? Para substituir um líder que tenha falhado. O que nos leva a outros dois problemas, o da detecção de falhas e o da estabilidade do líder.</p>
<h4 id="estabilidade">Estabilidade</h4>
<p>Dizemos que um algoritmo de eleição de líderes é estável se uma vez que um líder é eleito, uma nova eleição só acontece se o líder falha.
Considere o algoritmo do brigão. Imagine, no exemplo apresentado, que o processo 5 teve problemas de comunicação e foi percebido como falho pelos demais.  Neste caso, o 4 seria eleito líder.
Mas se o problema que aflige 5 é temporário, 5 voltará e executará nova eleição, tornando-se líder novamente. Se este cenário se repente indefinidamente, o sistema poderá ser seriamente comprometido em seu desempenho.</p>
<p>Uma versão estável do algoritmo tentaria, por exemplo, associar ao peso do processo o tempo de execução ininterrupta do mesmo. Assim, quanto mais tempo um processo execute, maior será seu peso e sua capacidade de manter a liderança. 
Se o mesmo falhar, então seu peso será drasticamente reduzido e suas chances de ser eleito líder reduzidas temporariamente.</p>
<p>Observe que os problemas enfrentados são ligados à detecção e contorno de falhas.</p>
<h4 id="deteccao-de-falhas">Detecção de falhas</h4>
<p>Como já mencionado antes, detecção de falhas é o mecanismo pelo qual um processo monitora e percebe se outro falhou.
Pensemos em como um processo monitora o outro em um sistema distribuído. Claramente, por meio de troca de mensagens e temporizadores.
Mas se estamos falando de sistemas distribuídos assíncronos, então mensagens podem ser atrasadas indefinidamente ou relógios podem ser atrasados, então não se pode confiar na falta de recepção de uma mensagem como garantia de que um processo parou de funcionar.
Aprofundemo-nos nos próximos capítulo nos conceitos de tempo e tolerância a falhas, mas enquanto isso, fiquemos com o seguinte resultado.</p>
<div class="admonition note">
<p class="admonition-title">Detecção de falhas</p>
<ul>
<li>Detecção de falhas perfeita é impossível...</li>
<li>em sistemas distribuídos assíncronos (Internet)</li>
<li>sujeitos à partições (Internet)</li>
<li>com requisitos de disponibilidade total.</li>
</ul>
</div>
<div class="footnote">
<hr />
<ol>
<li id="fn:asyncio">
<p>Um bom ponto de partida para o tópico é a sua entrada na <a href="https://en.wikipedia.org/wiki/Asynchronous_I/O">wikipedia</a>.&#160;<a class="footnote-backref" href="#fnref:asyncio" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:seda">
<p>O artigo <a href="http://www.sosp.org/2001/papers/welsh.pdf">SEDA: An Architecture for Well-Conditioned, Scalable Internet Services</a> descreve em detalhes a arquitetura SEDA.&#160;<a class="footnote-backref" href="#fnref:seda" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:ioasync">
<p>Pode-se argumentar que E/S assíncrona resolveria o problema aqui, mas isso não vem ao caso.&#160;<a class="footnote-backref" href="#fnref:ioasync" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:id">
<p>para evitar que mensagens de requisições distintas do mesmo processo se confundam, é útil identificar cada requisição, por exemplo, com um contador de requisições.&#160;<a class="footnote-backref" href="#fnref:id" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:guptaetal">
<p><a href="https://www.cs.cornell.edu/home/rvr/papers/ProbLeaderElection.pdf">A Probabilistically Correct Leader Election Protocol for Large Groups</a>&#160;<a class="footnote-backref" href="#fnref:guptaetal" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:changrobert">
<p><a href="https://dl.acm.org/doi/10.1145/359104.359108">An improved algorithm for decentralized extrema-finding in circular configurations of processes</a>.&#160;<a class="footnote-backref" href="#fnref:changrobert" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
</ol>
</div>

  <!-- Last update of source file -->


              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../microservices/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              Microsserviços
            </div>
          </div>
        </a>
      
      
        <a href="../time/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Próximo
              </span>
              Tempo
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copiar para \u00e1rea de transfer\u00eancia", "clipboard.copied": "Copiado para \u00e1rea de transfer\u00eancia", "search.config.lang": "pt", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Buscar", "search.result.placeholder": "Digite para iniciar a busca", "search.result.none": "Nenhum resultado encontrado", "search.result.one": "1 resultado encontrado", "search.result.other": "# resultados encontrados", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../javascripts/mathjaxhelper.js"></script>
      
    
  </body>
</html>