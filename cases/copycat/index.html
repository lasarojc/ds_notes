
<!doctype html>
<html lang="pt" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Notas de aula do curso de Sistemas Distribuídos da FACOM/UFU">
      
      
      
      
        <link rel="canonical" href="https://lasarojc.github.io/ds_notes/cases/copycat/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.5">
    
    
      
        <title>Copycat - Notas de Aula em Sistemas Distribuídos</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.be71726b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    
      

  


  

  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-65TK61CS8M"),document.addEventListener("DOMContentLoaded",function(){"undefined"!=typeof location$&&location$.subscribe(function(t){gtag("config","G-65TK61CS8M",{page_path:t.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-65TK61CS8M"></script>


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#coordenacao-copycat" class="md-skip">
          Ir para o conteúdo
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabeçalho">
    <a href="../.." title="Notas de Aula em Sistemas Distribuídos" class="md-header__button md-logo" aria-label="Notas de Aula em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Notas de Aula em Sistemas Distribuídos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Copycat
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10a2 2 0 0 1 2 2 2 2 0 0 1-2 2 2 2 0 0 1-2-2 2 2 0 0 1 2-2m10-3a5 5 0 0 1 5 5 5 5 0 0 1-5 5H7a5 5 0 0 1-5-5 5 5 0 0 1 5-5h10M7 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3h10a3 3 0 0 0 3-3 3 3 0 0 0-3-3H7z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Buscar" placeholder="Buscar" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Pesquisar">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Limpar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando a pesquisa
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegação" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Notas de Aula em Sistemas Distribuídos" class="md-nav__button md-logo" aria-label="Notas de Aula em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Notas de Aula em Sistemas Distribuídos
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../preface/" class="md-nav__link">
        Prefácio
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../intro/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Comunicação
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Comunicação" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Comunicação
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../comm/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../comm/redes/" class="md-nav__link">
        Redes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../comm/internet/" class="md-nav__link">
        Internet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../comm/sockets/" class="md-nav__link">
        Sockets
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../comm/datarep/" class="md-nav__link">
        Representação
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../comm/middleware/" class="md-nav__link">
        Middlewares
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../comm/rpc/" class="md-nav__link">
        RPC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../comm/mom/" class="md-nav__link">
        MOM
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../comm/epidemics/" class="md-nav__link">
        Epidêmicos
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../comm/refs/" class="md-nav__link">
        Referências
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        Arquiteturas
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Arquiteturas" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Arquiteturas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/arch/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/p2p/" class="md-nav__link">
        P2P
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../arch/microservices/" class="md-nav__link">
        Microsserviços
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Modelos
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Modelos" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Modelos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../models/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../models/models/" class="md-nav__link">
        Tipos
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../models/processor/" class="md-nav__link">
        Processador
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Coordenação
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Coordenação" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Coordenação
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../coord/concurrency/" class="md-nav__link">
        Concorrência
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../coord/coord/" class="md-nav__link">
        Coordenação
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        Tempo
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tempo" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Tempo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../time/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../time/physical/" class="md-nav__link">
        Tempo Físico
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../time/logical/" class="md-nav__link">
        Tempo Lógico
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      <label class="md-nav__link" for="__nav_8">
        Tolerância a Faltas
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tolerância a Faltas" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Tolerância a Faltas
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../fault/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../fault/failures/" class="md-nav__link">
        Falta/Erros/Falhas
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../fault/replication/" class="md-nav__link">
        Replicação
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../fault/failuredetector/" class="md-nav__link">
        Detectores de Falhas
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../fault/agreement/" class="md-nav__link">
        Acordo
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../fault/reconfiguration/" class="md-nav__link">
        Reconfiguração
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../fault/bizantine/" class="md-nav__link">
        Falhas bizantinas
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../fault/dependability/" class="md-nav__link">
        Dependabilidade
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../consistency/consistency/" class="md-nav__link">
        Consistência
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../db/disdb/" class="md-nav__link">
        Bancos de Dados
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../filesystem/disfs/" class="md-nav__link">
        Sistemas de Arquivos
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12" type="checkbox" id="__nav_12" checked>
      
      <label class="md-nav__link" for="__nav_12">
        Estudos de Caso
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Estudos de Caso" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          Estudos de Caso
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Introdução
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../cassandra/" class="md-nav__link">
        Cassandra
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../chord/" class="md-nav__link">
        Chord
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../dynamo/" class="md-nav__link">
        Dynamo
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../grpc/" class="md-nav__link">
        gRPC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../mosquito/" class="md-nav__link">
        Mosquito
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../rmi/" class="md-nav__link">
        RMI
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../thrift/" class="md-nav__link">
        Thrift
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/" class="md-nav__link">
        Kafka
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../swim/" class="md-nav__link">
        Swim
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Copycat
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Copycat
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#estudo-de-caso-ratis" class="md-nav__link">
    Estudo de caso: Ratis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estudo-de-caso-zookeeper" class="md-nav__link">
    Estudo de caso: Zookeeper
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estudo-de-caso-etcd" class="md-nav__link">
    Estudo de caso: Etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estudo-de-caso-kafka" class="md-nav__link">
    Estudo de caso: Kafka
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estudo-de-caso-bft-smart" class="md-nav__link">
    Estudo de caso BFT-Smart
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ratis/" class="md-nav__link">
        Ratis
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../bftsmart/" class="md-nav__link">
        BFT-Smart
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../etcd/" class="md-nav__link">
        Etcd
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../zookeeper/" class="md-nav__link">
        Zookeeper
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../refs/" class="md-nav__link">
        Referências
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../tech/" class="md-nav__link">
        Tecnologias
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../projeto/" class="md-nav__link">
        Projeto
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#estudo-de-caso-ratis" class="md-nav__link">
    Estudo de caso: Ratis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estudo-de-caso-zookeeper" class="md-nav__link">
    Estudo de caso: Zookeeper
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estudo-de-caso-etcd" class="md-nav__link">
    Estudo de caso: Etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estudo-de-caso-kafka" class="md-nav__link">
    Estudo de caso: Kafka
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estudo-de-caso-bft-smart" class="md-nav__link">
    Estudo de caso BFT-Smart
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              

<!-- Edit button -->


  <!--
       Hack: check whether the content contains a h1 headline. If it
       doesn't, the page title (or respectively site name) is used
       as the main headline.
    -->


  <!-- Content -->
  <h1 id="coordenacao-copycat">Coordenação: Copycat</h1>
<p><a href="http://atomix.io/copycat/">Copycat</a> é um arcabouço de replicação de máquinas de estados implementada pela <a href="http://atomix.io/">Atomix</a>.
Na base do Copycat está uma implementação do Raft.
Sobre o Raft, uma API simples mas moderna permite a criação de máquinas de estados usando <strong>lambdas</strong>, <strong>futures</strong>, e o estilo <strong>fluent</strong> de encadeamento de invocações.</p>
<div class="admonition note">
<div class="tabbed-set" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">Lambda</label><div class="tabbed-content">
<ul>
<li>Classe com um único método.</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">Tarefa</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bem vindo a um loop infinito&quot;</span><span class="p">);</span>
    <span class="p">}</span>   
<span class="p">}</span>

<span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Tarefa</span><span class="p">()).</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Classe anônima - uso único</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">new</span> <span class="n">Thread</span><span class="p">(</span> <span class="k">new</span> <span class="n">Runnable</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bem vindo a um loop infinito&quot;</span><span class="p">);</span>
  <span class="p">}</span>   
<span class="p">}).</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Lambda</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">new</span> <span class="n">Thread</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span>
                <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
                  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Bem vindo a um loop infinito&quot;</span><span class="p">);</span>
              <span class="p">}).</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">Fluent</label><div class="tabbed-content">
<ul>
<li>Encadeamento</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Pessoa</span><span class="o">&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="p">...;</span>
    <span class="n">c</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
      <span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="p">.</span><span class="na">idade</span> <span class="o">&gt;</span> <span class="mi">33</span><span class="p">)</span>
      <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Pessoa</span><span class="p">::</span><span class="n">sobrenomeNome</span><span class="p">)</span><span class="c1">//.map(p -&gt; p.sobrenomeNome())</span>
      <span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><label for="__tabbed_1_3">Future</label><div class="tabbed-content">
<ul>
<li>Promessa de computação e resultado.</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="p">.</span><span class="na">newSingleThreadExecutor</span><span class="p">();</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">futFib</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Fibonacci</span><span class="p">(</span><span class="mi">217</span><span class="p">)};</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Quando será executado?  Em algum momento.    </li>
<li>Como pegar o resultado? </li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">futFib</span><span class="p">.</span><span class="na">isDone</span><span class="p">())</span>
  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;tah calculando...&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">fib217</span> <span class="o">=</span> <span class="n">futFib</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Em qual thread?  Em algum thread. Depende do Executor Service usado.  </li>
</ul>
</div>
</div>
</div>
<p>Há várias versões do Copycat disponíveis, com vantagens e desvantagens.</p>
<div class="admonition note">
<p class="admonition-title">Versões</p>
<div class="tabbed-set" data-tabs="2:3"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">Versão 1.1.4</label><div class="tabbed-content">
<ul>
<li>Baseado em <a href="http://atomix.io/copycat/docs/getting-started/">http://atomix.io/copycat/docs/getting-started/</a> e <a href="https://www.baeldung.com/atomix">https://www.baeldung.com/atomix</a></li>
<li>Código funcional em <a href="https://github.com/pluxos/atomix_labs">https://github.com/pluxos/atomix_labs</a></li>
<li>Documentação oficial removida</li>
</ul>
</div>
<input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><label for="__tabbed_2_2">Versão &gt;= 2</label><div class="tabbed-content">
<ul>
<li>Melhor desempenho</li>
<li>Documentação ruim ou inexistente</li>
<li><a href="https://github.com/atomix/atomix">https://github.com/atomix/atomix</a></li>
</ul>
</div>
<input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><label for="__tabbed_2_3">Versão 3</label><div class="tabbed-content">
<ul>
<li>em Go</li>
<li>evolução rápida</li>
<li>o código é a documentação</li>
</ul>
</div>
</div>
</div>
<p>Aqui usaremos a versão 1.1.4, que apesar de antiga, é a melhor documentada atualmente, pelo tutorial referenciado acima.</p>
<ul>
<li>Clone e compile o projeto<ul>
<li>Instale dependências:</li>
<li>git</li>
<li>maven </li>
<li>JDK &gt;= 1.8</li>
<li><code>git clone https://github.com/pluxos/atomix_labs</code></li>
<li><code>cd atomix_labs</code></li>
<li><code>cd replication</code></li>
<li><code>mvn compile</code></li>
<li><code>mvn test</code></li>
</ul>
</li>
</ul>
<p>Você deve ver uma saída semelhante à seguinte, o que quer dizer que seu código está compilando perfeitamente.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Tests run: <span class="m">1</span>, Failures: <span class="m">0</span>, Errors: <span class="m">0</span>, Skipped: <span class="m">0</span>

<span class="o">[</span>INFO<span class="o">]</span> ---------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> BUILD SUCCESS
<span class="o">[</span>INFO<span class="o">]</span> ---------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> Total time: <span class="m">6</span>.898 s
<span class="o">[</span>INFO<span class="o">]</span> Finished at: <span class="m">2017</span>-10-25T08:38:08-02:00
<span class="o">[</span>INFO<span class="o">]</span> Final Memory: 15M/159M
<span class="o">[</span>INFO<span class="o">]</span> ---------------------------------------
</code></pre></div>
</td></tr></table>
<p>Antes de começar a escrever suas prórpia máquinas de estado, familiarize-se com a estrutura do projeto em <a href="https://github.com/pluxos/atomix_labs/tree/master/replication/src/main/java/atomix_lab/state_machine">https://github.com/pluxos/atomix_labs/tree/master/replication/src/main/java/atomix_lab/state_machine</a></p>
<p>Observe que há três pastas: </p>
<ul>
<li><code>type</code> - tipos dos dados mantidos pela replica (Edge e Vertex)<br />
   Os tipos são serializable para que o Java saiba como transformá-los em bytes.</li>
<li><code>command</code> - estruturas que contêm informações para modificar os tipos<br />
    Os comandos serão enviadas do cliente para o cluster e são naturalmente serializable.</li>
<li><code>client</code> - cria comandos e os envia para serem executados no cluster<br />
    Respostas podem ser esperadas síncrona ou assincronamente.</li>
<li><code>server</code> - recebe os comandos na ordem definida pelo Raft e os executa</li>
</ul>
<p>O projeto foi construído seguindo as instruções no tutorial mencionado antes, saltando-se a parte dos snapshots, isto é:</p>
<ul>
<li>crie um projeto maven<br />
    eclipse tem template para isso</li>
<li>adicione dependências no <code>pom.xml</code><br />
    como so criei um projeto, coloquei as dependências tanto do cliente quando do servidor</li>
<li>defina <code>Command</code> que modifiquem o estado das réplicas</li>
<li>defina <code>Queries</code> que consultem o estado das réplicas</li>
<li>implemente a réplica para lidar com os comandos</li>
<li>implemente o cliente para emitir comandos</li>
</ul>
<p>Para executar um servidor, você precisa passar diversos parâmetros</p>
<ul>
<li>identificador do processo (inteiro)</li>
<li>IP do processo com identificador 0</li>
<li>porta do processo com identificar 0</li>
<li>IP do processo com identificador 1</li>
<li>porta do processo com identificar 1</li>
<li>...</li>
</ul>
<p>Sabendo seu identificador, o servidor sabe em qual porta escutar e em quais IP/porta se conectar para se comunicar com os outros servidores.</p>
<p>Para testar o projeto, execute três servidores, em três terminais distintos. 
Usando o maven, da linha de comando, basta executar os seguintes comandos[^\]:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.server.GraphStateMachine&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;0 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>

mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.server.GraphStateMachine&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;1 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>

mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.server.GraphStateMachine&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;2 127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>
</code></pre></div>
</td></tr></table>
<p>O cliente não precisa de um identificador, apenas dos pares IP/porta dos servidores.
Por exemplo, use o comando:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>mvn exec:java <span class="se">\\</span>
  -Dexec.mainClass<span class="o">=</span><span class="s2">&quot;atomix_lab.state_machine.client.GraphClient&quot;</span> <span class="se">\\</span>
  -Dexec.args<span class="o">=</span><span class="s2">&quot;127.0.0.1 5000 127.0.0.1 5001 127.0.0.1 5002&quot;</span>
</code></pre></div>
</td></tr></table>
<div class="admonition exercise">
<p class="admonition-title">Exercício</p>
<p>Uma vez executado o projeto, modifique-o para incluir uma nova operação (<code>Command</code>) e nova consulta (<code>Query</code>), de sua escolha.</p>
</div>
<h4 id="estudo-de-caso-ratis">Estudo de caso: Ratis</h4>
<p><a href="http://ratis.apache.org/">Ratis</a> é um arcabouço de coordenação recentemente emancipado como um projeto no <a href="https://apache.org">Apache</a>.
Embora mal documentado, o projeto tem alguns exemplos que demonstram como usar abstrações já implementadas. 
A seguir veremos um passo-a-passo, baseado nestes exemplos, de como usar o Ratis para implementar uma máquina de estados replicada.</p>
<p>Crie um novo projeto Maven com o nome <code>ChaveValor</code> (eu estou usando IntelliJ, mas as instruções devem ser semelhantes para Eclipse).</p>
<p><img alt="Novo Projeto Maven" src="../../images/newmaven.png" /></p>
<p>Abra o arquivo <code>pom.xml</code> do seu projeto e adicione o seguinte trecho, com as dependências do projeto, incluindo o próprio Ratis.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">&lt;dependencies&gt;</span>
    <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.ratis/ratis-server --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.ratis<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>ratis-server<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.0.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

    <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.ratis/ratis-netty --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.ratis<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>ratis-netty<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.0.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.ratis<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>ratis-grpc<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.0.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.beust<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jcommander<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.78<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>slf4j-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.7.25<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-slf4j-impl --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-slf4j-impl<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.14.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.14.1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.logging.log4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>log4j-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.14.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div>
</td></tr></table>
<p>Adicione também o plugin Maven e o plugin para gerar um <code>.jar</code> com todas as dependências. Observe que estou usando Java 14, mas você pode mudar para a sua versão.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
        <span class="nt">&lt;plugin&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${maven.compiler.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
                <span class="nt">&lt;source&gt;</span>14<span class="nt">&lt;/source&gt;</span>
                <span class="nt">&lt;target&gt;</span>14<span class="nt">&lt;/target&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;plugin&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>maven-assembly-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;executions&gt;</span>
                <span class="nt">&lt;execution&gt;</span>
                    <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
                    <span class="nt">&lt;goals&gt;</span>
                        <span class="nt">&lt;goal&gt;</span>single<span class="nt">&lt;/goal&gt;</span>
                    <span class="nt">&lt;/goals&gt;</span>
                <span class="nt">&lt;/execution&gt;</span>
            <span class="nt">&lt;/executions&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
                <span class="nt">&lt;descriptorRefs&gt;</span>
                    <span class="nt">&lt;descriptorRef&gt;</span>jar-with-dependencies<span class="nt">&lt;/descriptorRef&gt;</span>
                <span class="nt">&lt;/descriptorRefs&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</code></pre></div>
</td></tr></table>
<p>Crie uma nova classe denominada <code>Cliente</code> no arquivo <code>Cliente.java</code>.
Nesta classe, iremos criar um objeto <code>RaftClient</code> que será usado para enviar operações para os servidores. 
Esta classe é importada juntamente com outras várias dependências, adicionadas no <code>pom.xml</code>, que devemos instanciar antes do <code>RaftClient</code>.</p>
<p>Neste exemplo eu coloco praticamente todos os parâmetros de configuração do Ratis <em>hardcoded</em> para simplificar o código.
Obviamente que voce deveria ser estes parâmetros como argumentos para o programa ou de um arquivo de configuração.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.apache.ratis.client.RaftClient</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.conf.Parameters</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.conf.RaftProperties</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.grpc.GrpcFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.protocol.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.thirdparty.com.google.protobuf.ByteString</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cliente</span>
<span class="p">{</span>
</code></pre></div>
</td></tr></table>
<p>O campo <code>raftGroupId</code> identifica um cluster Ratis; isso quer dizer que um mesmo processo pode participar de vários <em>clusters</em>, mas aqui nos focaremos em apenas um. O valor do campo deve ter exatamente caracteres, o que soma 32 bytes em java, e será interpretado como um <a href="https://pt.wikipedia.org/wiki/Identificador_%C3%BAnico_universal">UUID</a>.</p>
<p><code>id2addr</code> é um mapa do identificador de cada processo no cluster para seu endereço IP + Porta.
Aqui usei várias portas distintas porquê todos os processos estão rodando na mesma máquina, mas se estivesse executando em máquinas distintas, com IP distintos, poderia usar a mesma porta em todos.</p>
<p><code>addresses</code> é uma lista de <code>RaftPeer</code> construída a parti de <code>id2addr</code>.</p>
<p>O campo <code>raftGroup</code> é uma referência a todos os servidores, associados ao identificador do grupo, <code>raftGroupId</code>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="p">{</span>
        <span class="n">String</span> <span class="n">raftGroupId</span> <span class="o">=</span> <span class="s">&quot;raft_group____um&quot;</span><span class="p">;</span> <span class="c1">// 16 caracteres.</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">InetSocketAddress</span><span class="o">&gt;</span> <span class="n">id2addr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p1&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p2&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">3500</span><span class="p">));</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p3&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">));</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">RaftPeer</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">id2addr</span><span class="p">.</span><span class="na">entrySet</span><span class="p">()</span>
                <span class="p">.</span><span class="na">stream</span><span class="p">()</span>
                <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">RaftPeer</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setId</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getKey</span><span class="p">()).</span><span class="na">setAddress</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getValue</span><span class="p">()).</span><span class="na">build</span><span class="p">())</span>
                <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>

        <span class="kd">final</span> <span class="n">RaftGroup</span> <span class="n">raftGroup</span> <span class="o">=</span> <span class="n">RaftGroup</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">RaftGroupId</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">ByteString</span><span class="p">.</span><span class="na">copyFromUtf8</span><span class="p">(</span><span class="n">raftGroupId</span><span class="p">)),</span> <span class="n">addresses</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>Uma vez criado o grupo, criamos o cliente usando a fábrica retornada por <code>RaftClient.newBuilder()</code>.
A fábrica deve ser configurada com os dados do grupo e o tipo de transporte, neste caso gRPC.
Também é necessário o identificador do processo que está se conectando ao grupo; neste caso, usamos um identificador aleatório qualquer, diferente do que faremos com os servidores.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="n">RaftProperties</span> <span class="n">raftProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RaftProperties</span><span class="p">();</span>

        <span class="n">RaftClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">RaftClient</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
                                      <span class="p">.</span><span class="na">setProperties</span><span class="p">(</span><span class="n">raftProperties</span><span class="p">)</span>
                                      <span class="p">.</span><span class="na">setRaftGroup</span><span class="p">(</span><span class="n">raftGroup</span><span class="p">)</span>
                                      <span class="p">.</span><span class="na">setClientRpc</span><span class="p">(</span><span class="k">new</span> <span class="n">GrpcFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">Parameters</span><span class="p">())</span>
                                      <span class="p">.</span><span class="na">newRaftClientRpc</span><span class="p">(</span><span class="n">ClientId</span><span class="p">.</span><span class="na">randomId</span><span class="p">(),</span> <span class="n">raftProperties</span><span class="p">))</span>
                                      <span class="p">.</span><span class="na">build</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>Uma vez criado o cliente, podemos fazer invocações de operações nos servidores. Cada operação será invocada em todos os servidores, na mesma ordem.
Este protótipo suporta duas operações, <code>add</code> e <code>get</code>, incluindo algumas variações, que ignoraremos por enquanto.
A operação <code>add</code> é codificada como uma <code>String</code>, <code>add:k:v</code>, onde <code>k</code> e <code>v</code> são do tipo <code>String</code>. <code>add:k:v</code> adiciona uma entrada em um mapa implementado pelo nosso servidor com chave <code>k</code> e valor <code>v</code>.
Já a operação <code>get:k</code> recupera o valor <code>v</code> associado à chave <code>k</code>, se presente no mapa.</p>
<p>O método <code>RaftClient.io().send</code> é usado para enviar modificações para as réplicas e deve, necessariamente, passar pelo protocolo Raft.
Já o método <code>RaftClient.io().sendReadOnly</code> é usado para enviar consultas a qualquer das réplicas.
Ambos os métodos codificam o comando sendo enviado (<code>add:k:v</code> ou <code>get:k</code>) no formato interno do Ratis para as réplicas e retorna um objeto <code>RaftClientReply</code>, que pode ser usado para pegar a resposta da operação. 
O código é auto explicativo.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="n">RaftClientReply</span> <span class="n">getValue</span><span class="p">;</span>
        <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">RaftClientReply</span><span class="o">&gt;</span> <span class="n">compGetValue</span><span class="p">;</span>
        <span class="n">String</span> <span class="n">response</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">){</span>
            <span class="k">case</span> <span class="s">&quot;add&quot;</span><span class="p">:</span>
                <span class="n">getValue</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">io</span><span class="p">().</span><span class="na">send</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="s">&quot;add:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">));</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getContent</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">());</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Resposta:&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s">&quot;get&quot;</span><span class="p">:</span>
                <span class="n">getValue</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">io</span><span class="p">().</span><span class="na">sendReadOnly</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="s">&quot;get:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">));</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getContent</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">());</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Resposta:&quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s">&quot;add_async&quot;</span><span class="p">:</span>
                <span class="n">compGetValue</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">async</span><span class="p">().</span><span class="na">send</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="s">&quot;add:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">));</span>
                <span class="n">getValue</span> <span class="o">=</span> <span class="n">compGetValue</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getContent</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">());</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Resposta: &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s">&quot;get_stale&quot;</span><span class="p">:</span>
                <span class="n">getValue</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">io</span><span class="p">().</span><span class="na">sendStaleRead</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="s">&quot;get:&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RaftPeerId</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">));</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">getValue</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getContent</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">());</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Resposta: &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;comando inválido&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">client</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Um vez criado o cliente, crie a classe <code>Servidor</code>, no arquivo <code>Servidor.java</code>; a parte inicial do código é semelhante à do cliente.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.apache.ratis.conf.RaftProperties</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.grpc.GrpcConfigKeys</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.protocol.RaftGroup</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.protocol.RaftGroupId</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.protocol.RaftPeer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.protocol.RaftPeerId</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.server.RaftServer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.server.RaftServerConfigKeys</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.thirdparty.com.google.protobuf.ByteString</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ratis.util.LifeCycle</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Servidor</span>
<span class="p">{</span>

    <span class="c1">//Parametros: myId</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[]</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">InterruptedException</span>
    <span class="p">{</span>
        <span class="n">String</span> <span class="n">raftGroupId</span> <span class="o">=</span> <span class="s">&quot;raft_group____um&quot;</span><span class="p">;</span> <span class="c1">// 16 caracteres.</span>

        <span class="c1">//Setup for node all nodes.</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">InetSocketAddress</span><span class="o">&gt;</span> <span class="n">id2addr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p1&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p2&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">3500</span><span class="p">));</span>
        <span class="n">id2addr</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;p3&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">));</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">RaftPeer</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">id2addr</span><span class="p">.</span><span class="na">entrySet</span><span class="p">()</span>
                                          <span class="p">.</span><span class="na">stream</span><span class="p">()</span>
                                          <span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">RaftPeer</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setId</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getKey</span><span class="p">()).</span><span class="na">setAddress</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">getValue</span><span class="p">()).</span><span class="na">build</span><span class="p">())</span>
                                          <span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
</code></pre></div>
</td></tr></table>
<p>A primeira diferença vem na necessidade de identificar o servidor dentro do conjunto de servidores, o que é feito com um <code>RaftPeerId</code>.
Como cada servidor deve usar um identificador único, do conjunto pré-determinado em <code>id2addr</code>, o identificador é passado como argumento para o programa, obrigatoriamente.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="c1">//Setup for this node.</span>
        <span class="n">RaftPeerId</span> <span class="n">myId</span> <span class="o">=</span> <span class="n">RaftPeerId</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">addresses</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">noneMatch</span><span class="p">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">myId</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Identificador &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="s">&quot; é inválido.&quot;</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Encare a seção seguinte como uma receita, mas observe que o método <code>RaftServerConfigKeys.setStorageDir</code> recebe o nome de uma pasta como argumento, que será usada para armazenar o estado da máquina de estados.
Se você executar o servidor múltiplas vezes, a cada nova execução o estado anterior do sistema será recuperado desta pasta.
Para <strong>limpar</strong> o estado, apague as pastas de cada servidor.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="n">RaftProperties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RaftProperties</span><span class="p">();</span>
        <span class="n">properties</span><span class="p">.</span><span class="na">setInt</span><span class="p">(</span><span class="n">GrpcConfigKeys</span><span class="p">.</span><span class="na">OutputStream</span><span class="p">.</span><span class="na">RETRY_TIMES_KEY</span><span class="p">,</span> <span class="n">Integer</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">);</span>
        <span class="n">GrpcConfigKeys</span><span class="p">.</span><span class="na">Server</span><span class="p">.</span><span class="na">setPort</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
        <span class="n">RaftServerConfigKeys</span><span class="p">.</span><span class="na">setStorageDir</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">Collections</span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="s">&quot;/tmp/&quot;</span> <span class="o">+</span> <span class="n">myId</span><span class="p">)));</span>
</code></pre></div>
</td></tr></table>
<p>A máquina de estados em si é especificada no próximo excerto, em <code>setStateMachine</code>, que veremos a seguir.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="c1">//Join the group of processes.</span>
        <span class="kd">final</span> <span class="n">RaftGroup</span> <span class="n">raftGroup</span> <span class="o">=</span> <span class="n">RaftGroup</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">RaftGroupId</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">ByteString</span><span class="p">.</span><span class="na">copyFromUtf8</span><span class="p">(</span><span class="n">raftGroupId</span><span class="p">)),</span> <span class="n">id2addr</span><span class="p">);</span>
        <span class="n">RaftServer</span> <span class="n">raftServer</span> <span class="o">=</span> <span class="n">RaftServer</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
                <span class="p">.</span><span class="na">setServerId</span><span class="p">(</span><span class="n">myId</span><span class="p">)</span>
                <span class="p">.</span><span class="na">setStateMachine</span><span class="p">(</span><span class="k">new</span> <span class="n">MaquinaDeEstados</span><span class="p">())</span>
                <span class="p">.</span><span class="na">setProperties</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
                <span class="p">.</span><span class="na">setGroup</span><span class="p">(</span><span class="n">raftGroup</span><span class="p">)</span>
                <span class="p">.</span><span class="na">build</span><span class="p">();</span>
        <span class="n">raftServer</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>Uma vez iniciado o servidor, basta esperar que ele termine antes de sair do programa.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>        <span class="k">while</span><span class="p">(</span><span class="n">raftServer</span><span class="p">.</span><span class="na">getLifeCycleState</span><span class="p">()</span> <span class="o">!=</span> <span class="n">LifeCycle</span><span class="p">.</span><span class="na">State</span><span class="p">.</span><span class="na">CLOSED</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Vamos agora para a definição da classe <code>MaquinaDeEstados</code>, no arquivo <code>MaquinaDeEstados.java</code>.
Esta classe deve implementar a interface <code>org.apache.ratis.statemachine.StateMachine</code> e seus vários métodos ou, mais simples, estende <code>org.apache.ratis.statemachine.impl.BaseStateMachine</code>, a abordagem que usaremos aqui.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MaquinaDeEstados</span> <span class="kd">extends</span> <span class="n">BaseStateMachine</span>
<span class="p">{</span>
</code></pre></div>
</td></tr></table>
<p>Por enquanto, ignoraremos o armazenamento do estado em disco, mantendo-o simplesmente em memória no campo <code>key2values</code>, e simplesmente implementaremos o processamento de comandos, começando pela implementação do método <code>query</code>.</p>
<p>Este método é reponsável por implementar operações que não alteram o estado da máquina de estados, enviadas com o método <code>RaftClient::sendReadOnly</code>. A única <code>query</code> no nosso sistema é o <code>get</code>.
No código, o conteúdo da requisição enviada pelo cliente deve ser recuperado em quebrado em operação (<code>get</code>) e chave , usando <code>:</code> como delimitador.
Recuperado o valor associado à chave, o mesmo é colocado em um <code>CompletableFuture</code> e retornado.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">key2values</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="nf">query</span><span class="p">(</span><span class="n">Message</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">opKey</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="na">getContent</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">()).</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">);</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">opKey</span><span class="o">[</span><span class="mi">0</span><span class="o">]+</span> <span class="s">&quot;:&quot;</span><span class="o">+</span> <span class="n">key2values</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">opKey</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">);</span>

        <span class="n">LOG</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;{}: {} = {}&quot;</span><span class="p">,</span> <span class="n">opKey</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">opKey</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>O método <code>applyTransaction</code> implementa operações que alteram o estado, como <code>add</code>, enviadas com o método <code>RaftClient::send</code>. 
Da mesma forma que em <code>get</code>, a operação deve ser recuperada em quebrada em operação (<code>add</code>), chave e valor, usando <code>:</code> como delimitador.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="nf">applyTransaction</span><span class="p">(</span><span class="n">TransactionContext</span> <span class="n">trx</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">final</span> <span class="n">RaftProtos</span><span class="p">.</span><span class="na">LogEntryProto</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">trx</span><span class="p">.</span><span class="na">getLogEntry</span><span class="p">();</span>
        <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">opKeyValue</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="na">getStateMachineLogEntry</span><span class="p">().</span><span class="na">getLogData</span><span class="p">().</span><span class="na">toString</span><span class="p">(</span><span class="n">Charset</span><span class="p">.</span><span class="na">defaultCharset</span><span class="p">()).</span><span class="na">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">);</span>

        <span class="kd">final</span> <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">opKeyValue</span><span class="o">[</span><span class="mi">0</span><span class="o">]+</span> <span class="s">&quot;:&quot;</span><span class="o">+</span> <span class="n">key2values</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">opKeyValue</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">opKeyValue</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">);</span>

        <span class="kd">final</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>

        <span class="kd">final</span> <span class="n">RaftProtos</span><span class="p">.</span><span class="na">RaftPeerRole</span> <span class="n">role</span> <span class="o">=</span> <span class="n">trx</span><span class="p">.</span><span class="na">getServerRole</span><span class="p">();</span>
        <span class="n">LOG</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;{}:{} {} {}={}&quot;</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">getId</span><span class="p">(),</span> <span class="n">opKeyValue</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">opKeyValue</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">opKeyValue</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Pronto, você já tem uma máquina de estados replicada, bastando agora apenas compilá-la e executá-la.
Para compilar, de raiz do projeto execute o comando <code>mvn package</code>. 
A primeira vez que faz isso pode demorar um pouco pois várias dependências são baixadas da Internet.
Ao final da execução do comando você deveria ver algo semelhante ao seguinte</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>...
INFO<span class="o">]</span> ------------------------------------------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> BUILD SUCCESS
<span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
<span class="o">[</span>INFO<span class="o">]</span> Total time:  <span class="m">4</span>.793 s
<span class="o">[</span>INFO<span class="o">]</span> Finished at: <span class="m">2020</span>-12-06T23:06:32-03:00
<span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
</code></pre></div>
</td></tr></table>
<p>Então, em três terminais diferentes, execute os seguintes comandos:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Servidor p1
java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Servidor p2
java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Servidor p3
</code></pre></div>
</td></tr></table>
<p>Para executar o cliente, em um outro terminal, faça, por exemplo,</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Cliente add k1 testek1
java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Cliente get k1

java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Cliente add k2 testek2
</code></pre></div>
</td></tr></table>
<p>Todo o código está disponível no <a href="https://github.com/lasarojc/ds_notes/tree/master/docs/fault/code/ChaveValor">Github</a></p>
<details class="todo"><summary>Exercício</summary><ul>
<li>Adicionar operações <ul>
<li><code>del</code></li>
<li><code>clear</code></li>
</ul>
</li>
</ul>
</details>
<h6>Operações assíncronas</h6>
<details class="todo"><summary>TODO</summary><ul>
<li>Operações assíncronas usando <code>async()</code> em vez de <code>io()</code>.</li>
<li><code>CompletableFuture</code></li>
</ul>
</details>
<h6>Leituras "velhas"</h6>
<details class="todo"><summary>TODO</summary><ul>
<li><em>stale reads</em> usando <code>sendStaleRead</code> em vez de <code>sendRead</code>.</li>
<li>índice inicial</li>
<li>nó</li>
<li><code>java -cp target/ChaveValor-1.0-SNAPSHOT-jar-with-dependencies.jar Cliente get_stale  k1 p1</code></li>
</ul>
</details>
<h4 id="estudo-de-caso-zookeeper">Estudo de caso: Zookeeper</h4>
<p>O <a href="http://zookeeper.apache.org/">Zookeeper</a> foi criado para coordenar as ações dos componentes de sistemas distribuídos, porquê sistemas distribuídos são como zoológicos, com animais de diversas espécies, sendo obrigados a conviver de forma anti-natural.</p>
<p><img alt="http://zookeeper.apache.org/" src="../../images/zklogo.jpeg" /></p>
<h6>Visão Geral</h6>
<div class="admonition quote">
<p class="admonition-title">O quê?</p>
<p>ZooKeeper is a <strong>centralized</strong> service for maintaining <strong>configuration</strong> information, <strong>naming</strong>, providing distributed <strong>synchronization</strong>, and providing <strong>group services</strong>. All of these kinds of services are used in some form or another by <strong>distributed applications</strong>. Each time they are implemented there is a lot of work that goes into fixing the bugs and race conditions that are inevitable. Because of the difficulty of implementing these kinds of services, applications initially usually skimp on them, which make them brittle in the presence of change and difficult to manage. Even when done correctly, different implementations of these services lead to management <strong>complexity</strong> when the applications are deployed.</p>
</div>
<p>O arcabouço foi criado pelo <a href="http://www.yahoo.com">Yahoo!</a> para servir como peça na construção de sistemas distribuídos dentro da empresa.</p>
<div class="admonition quote">
<p class="admonition-title">Por quê?</p>
<p>Coordination services are notoriously hard to get right. They are especially prone to errors such as race conditions and deadlock. The motivation behind ZooKeeper is to relieve distributed applications the responsibility of implementing coordination services from scratch.</p>
</div>
<p>Mais tarde o sistema tornou-se <em>Open Source</em> e parte de diversos projetos, tanto abertos quanto proprietários.
A razão de seu sucesso, arrisco dizer, é a simplicidade de sua API, semelhante a um sistema de arquivos.</p>
<div class="admonition quote">
<p class="admonition-title">Como?</p>
<p>[ZooKeeper] exposes a <strong>simple set of primitives</strong> that distributed applications can build upon to implement higher level services for synchronization, configuration maintenance, and groups and naming. It is designed to be easy to program to, and uses a data model styled after the familiar <strong>directory tree structure of file systems</strong>. It runs in Java and has bindings for both <strong>Java</strong> and <strong>C</strong>.</p>
<p>ZooKeeper allows distributed processes to coordinate with each other through a <strong>shared hierarchal namespace which is organized similarly to a standard file system</strong>. ... Unlike a typical file system, which is designed for storage, ZooKeeper data is kept <strong>in-memory</strong>, which means ZooKeeper can achieve <strong>high throughput and low latency</strong> numbers.</p>
</div>
<p>O sistema de arquivos do Zookeeper tem nós denominados <strong>znodes</strong>, em referência aos i-nodes do mundo Unix.
O znode raiz é denominado <code>/</code> e um filho da raiz nomeado <code>teste</code> é referido como <code>/teste</code>.
Cada znode pode ser visto como <strong>arquivo</strong> e <strong>diretório</strong> ao mesmo tempo.</p>
<p><img alt="" src="../../images/zknamespace.jpg" /></p>
<p>Znodes são manipulados, essencialmente, por 4 operações, implementando CRUD, e uma quinta operação que lista os znodes filhos de um dado znode.</p>
<ul>
<li>C: create</li>
<li>R: get</li>
<li>U: set</li>
<li>D: delete</li>
<li>ls *: get children</li>
</ul>
<p>Znodes são lidos e escritos sempre integralmente. Isto é, não se pode escrever apenas parte do conteúdo do "arquivo". Por isso, recomenda-se que os arquivos sejam sempre pequenos, onde pequeno é relativo.</p>
<p>O sistema de arquivos do Zookeeper é replicado em vários nós, usando a técnica de replicação de máquinas de estados estudada. 
A difusão ordenada de comandos é implementadas O protocolo utilizado é pelo protocolo de difusão atômica próprio do Zookeeper, ZAB (<a href="https://zookeeper.apache.org/doc/r3.7.0/zookeeperInternals.html#sc_atomicBroadcast"><em>Zookeeper Atomic Broadcast</em></a>).</p>
<p>Comandos de modificação do sistema de arquivos, como <strong>create</strong> e <strong>delete</strong>, podem ser enviados para qualquer das réplicas, mas serão internamente encaminhados para um processos líder e de lá replicados.</p>
<p><img alt="" src="../../images/zkservice.jpg" /></p>
<p>Já comandos de leitura são executados direto na réplica que os recebe, sendo respondidos mais rapidamente mas que, devido à assincronia do sistema, podem ser respondidos com dados antigos. Por este motivo, clientes sempre conversam com o mesmo servidor, a não ser que sejam forçados a estabelecer nova conexão, e só emitem novos comandos depois que o anterior tiver sido respondido. Este comportamento resulta em garantias de consistência específicas, denominadas <a href="https://zookeeper.apache.org/doc/r3.7.0/zookeeperInternals.html#sc_consistency">consistência sequencial ordenada</a>.</p>
<p><img alt="" src="../../images/zkcomponents.jpg" /></p>
<p>Por causa do custo em termos de mensagens trocadas entre os processos para mensagens de atualização e pelo baixo custo das mensagens de leitura, o zookeeper é recomendado para cargas de trabalho com poucas escritas.</p>
<div class="admonition quote">
<p class="admonition-title">Desempenho</p>
<p>ZooKeeper is fast [...] and it performs best where reads are more common than writes, at ratios of around 10:1.</p>
</div>
<p>O gráfico seguinte mostra como o desempenho do sistema varia com o número de processos.
No eixo Y, a quantidade de requisições processadas por segundo, ou seja, a vazão.
No eixo X, a percentagem das requisições do teste que são leituras e, portanto, repondidas na réplica em que são recebidas.
As diferentes curvas mostram diferentes configurações do sistema, indo de 3 a 12 réplicas.</p>
<p><img alt="" src="../../images/zkperfRW_3_2.jpg" /></p>
<p>Em geral, todas as configurações apresentam melhor desempenho quando há uma percentagem maior de leituras.
Mas observe como as curvas se invertem, se focando primeiro na curva para 3 servidores: quando todas as operações são de escrita, e portanto precisam passar pelo protocolo de difusão atômica, esta curva apresenta os melhores resultados. Isto ocorre porquê o <em>overhead</em> de executar o protocolo é mais baixo entre 3 servidores que entre 13. Em compensação, quando temos mais leituras, que não precisam de sincronização, então ter mais servidores é mais vantajoso pois sobre menos carga de trabalho para cada servidor.</p>
<h6>Laboratório</h6>
<p>Instale o Zookeeper em sua máquina seguindo estas instruções.</p>
<ul>
<li>Baixe: <code>wget www-eu.apache.org/dist/zookeeper/zookeeper-3.6.2</code></li>
<li>Descomprima: <code>tar xvzf zookeeper*.tgz</code></li>
<li>Entre na pasta criada.</li>
<li>Configure: copie o arquivo <code>conf/zoo_sample.cfg</code> para <code>conf/zoo.cfg</code></li>
<li>Execute<ul>
<li><code>./bin/zkServer.sh start-foreground</code> em um terminal</li>
<li><code>./bin/zkCli.sh -server 127.0.0.1:2181</code> em outro terminal</li>
</ul>
</li>
</ul>
<p>Do shell do programa cliente (executado por último), digite <code>help</code> e enter para ver uma lista de todos os comandos disponíveis.
Vejamos alguns exemplos básicos.</p>
<ul>
<li><code>ls /</code> - lista os nós filhos da raiz.</li>
<li><code>create /teste lala</code> - cria o nó <code>/teste</code> com conteúdo <code>lala</code></li>
<li><code>get /teste</code> - pega o conteúdo do arquivo</li>
<li><code>set /teste lele</code> - atualiza o conteúdo do arquivo</li>
<li><code>delete /teste</code> - apaga o arquivo</li>
</ul>
<p>Outros comandos interessantes são:</p>
<ul>
<li><code>stat /teste</code> - mostra medatados do arquivo, por exemplo versão, e <em>timestamps</em></li>
<li><code>set -v V /teste lili</code> - faz um update condiciona, isto é, atualiza o conteúdo do arquivo se a versão do mesmo, como mostrada pelo comando <code>stat</code>, for igual a <code>V</code></li>
</ul>
<h6>Nós Efêmeros e Watches</h6>
<p>O Zookeeper tem muitas funcionalidades interessantes, mas chamarei a atenção a duas que são particularmente úteis:</p>
<p>Nós <strong>efêmeros</strong>, criados com a flag <code>-e</code>, p.e., <code>create -ef /teste/noefemero efemero</code>, são automaticamente destruídos quando o cliente que os criou se desconecta do servidor. E <strong>watches</strong> avisam ao cliente quando uma operação em um certo znode ou em seus filhos acontece. Para ser avisado quando os dados de um nó forem alterados, use a opção <code>-w</code> do get, por exemplo, <code>get -w /teste</code>. Para monitorar alterações no conjunto de filhos de um nó, use <code>-w</code> no <code>ls</code>, por exemplo, <code>ls -w /teste</code>.</p>
<div class="admonition exercise">
<p class="admonition-title">Nós Efêmeros e Watches</p>
<ul>
<li>Crie um zNode /teste</li>
<li>
<p>Debaixo de /teste, crie três outros, sequenciais</p>
</li>
<li>
<p>Crie um zNode /teste2</p>
</li>
<li>Crie um zNode efêmero</li>
<li>Conecte-se com outro cliente</li>
<li>Coloque um watch em /teste2</li>
<li>Desconecte o primeiro cliente</li>
<li>Observe o evento gerado no segundo cliente</li>
<li>Reconecte o primeiro cliente</li>
</ul>
</div>
<h6>Cluster tolerante a falhas</h6>
<p>Observe que você está executando o Zookeeper em apenas um nó, ou seja, não há tolerância a falhas alguma aqui.
Para tolerar falhas, você precisa de um cluster multi-nós, mesmo que seja em uma única máquina. 
Neste caso, crie três arquivos de configuração, <code>zoo1.cfg</code>, <code>zoo2.cfg</code> e <code>zoo3.cfg</code>. O arquivo <code>zooX.cfg</code>, onde <code>1 &lt;= X &lt;= 3</code>, fica assim:</p>
<ul>
<li><code>dataDir=/tmp/lasaro/zooX #Substitua o X pelo valor correto</code></li>
<li><code>server.1=zoo1:2888:3888</code></li>
<li><code>server.2=zoo2:2889:3889</code></li>
<li><code>server.3=zoo3:2890:3890</code></li>
<li><code>clientPort=218X #Substitua o X pelo valor correto</code></li>
</ul>
<p>Crie diretórios e arquivos de identificação.</p>
<ul>
<li><code>mkdir /tmp/lasaro/zooX</code></li>
<li><code>echo X &gt; /tmp/lasaro/zooX/myid</code></li>
</ul>
<p>Execute servidores.</p>
<ul>
<li><code>./bin/zkServer.sh start conf/zooX.cfg</code></li>
</ul>
<p>Ainda que tenha três servidores executando em uma mesma máquina, seu cluster parará de funcionar se a máquina parar de funcionar. O ideal é que cada servidor execute em uma máquina distinta.</p>
<h6>Receitas</h6>
<p>É possível resolver diversos problemas encontrados em sistemas distribuídos usando-se o ZooKeeper, por exemplo, o problema de descoberta de processos.</p>
<div class="admonition example">
<p class="admonition-title">Rendezvous</p>
<p>Ponto de encontro de processos. </p>
<ul>
<li>Defina um zNode raiz a ser usado: /rendezvous/app1/ </li>
<li>Cada filho de /rendezvous/app1 corresponde a um processo:<ul>
<li>IP</li>
<li>Porta</li>
<li>Número de processadores</li>
<li>...</li>
</ul>
</li>
<li>Processo p ao ser iniciado:<ul>
<li>procura /rendezvous/app1/p</li>
<li>se achar, continua</li>
<li>se não achar, cria /rendezvous/app1/p</li>
</ul>
</li>
<li>lista os filhos de /rendezvous/app1</li>
</ul>
</div>
<p>Como lidar com saída de processos?
Faça todos os zNodes são efêmeros.
Quando um nó é desconectado, o zNode correspondente será destruído.</p>
<p>Como detectar mudanças no grupo de processos?</p>
<p>Monitore os filhos de /rendezvous/app1<br />
Sempre que receber notificações, refaça o cálculo do <strong><em>membership</em></strong>.</p>
<p>Eleição de Líderes
Rendezvous.
Faça os zNodes sequenciais.
Ordene os zNodes e escolha o primeiro.
Monitore o zNode. Se ele sumir, eleja outro líder.</p>
<div class="admonition exaple">
<p class="admonition-title">Exclusão Mútua</p>
<p>Construa uma fila usando nós efêmeros e sequenciais. O processo na cabeça da fila tem direito de acesso. Em caso de falhas, o processo é removido da cabeça da fila.</p>
</div>
<p>Várias outras receitas podem ser facilmente encontradas no <a href="http://zookeeper.apache.org/doc/trunk/recipes.html">sítio do projeto</a>:</p>
<ul>
<li>Lock distribuído</li>
<li>Filas, e.g. de prioridades</li>
<li>Barreira</li>
<li>Serviço de nomes</li>
<li>Terminação em duas fases</li>
<li>Contador atômico</li>
</ul>
<p>Além destas, outro projeto, o <a href="http://curator.apache.org">Curator</a> se dedica apenas a colecionar implementações corretas de receitas para o Zookeeper.</p>
<h4 id="estudo-de-caso-etcd">Estudo de caso: Etcd</h4>
<details class="todo"><summary>Todo</summary><p><a href="https://etcd.io/">etcd</a></p>
</details>
<h4 id="estudo-de-caso-kafka">Estudo de caso: Kafka</h4>
<details class="todo"><summary>Todo</summary><p><a href="https://kafka.apache.org/">Kafka</a></p>
</details>
<h4 id="estudo-de-caso-bft-smart">Estudo de caso BFT-Smart</h4>
<details class="todo"><summary>Todo</summary><p><a href="https://github.com/bft-smart/library">BFT-Smart</a></p>
</details>
<!--
O quê?
* Manter dados/serviços disponíveis a despeito de falhas.

Replicação
* No Kafka, o \alert{Replication Factor} determina quantas cópias de cada tópico (todas as partições no tópico).

Líder e Seguidor
*  Produtor conversa com líder. Líder grava localmente e envia ack ao produtor.
*  Consumidor conversa com líder. Líder envia dados ao consumidor.
*  Líder replica dados para seguidores.

Replicar
* Passo 6  ensina a criar um sistema com múltiplos brokers.

*  Identificador
*  Porta (mesmo servidor)
*  \alert{Log directory}

Replicar
*  Crie um novo tópico, com RF = 3 e duas partições
*  \lstinline|bin/kafka-topics.sh --list --zookeeper localhost:2181 --describe --topic <topico>|
*  Lista de réplicas
*  Lista de réplicas sincronizadas: \emph{list of \alert{i}n \alert{s}ync \alert{r}eplicas}


Zookeeper
*  Permite que nós do cluster se descubram
*  Elege líder

Armazenamento
*  Dado deve ser removido depois de um tempo de ``retenção''
*  Pode definir retenção por tamanho (por partição, não tópico)


Produtor

*  Produtor envia mensagens para os brokers
*  Producer API
*  [Learning Journal](https://github.com/LearningJournal/ApacheKafkaTutorials)

SimpleProducer.java

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.apache.kafka.clients.producer.KafkaProducer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.kafka.clients.producer.Producer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.apache.kafka.clients.producer.ProducerRecord</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleProducer</span> <span class="p">{</span>
 <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">String</span> <span class="n">topicName</span> <span class="o">=</span> <span class="s">&quot;SimpleProducerTopic&quot;</span><span class="p">;</span>
  <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;Chave&quot;</span><span class="p">;</span>
  <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;Valor&quot;</span><span class="p">;</span>
  <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="p">();</span>
  <span class="n">props</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;bootstrap.servers&quot;</span><span class="p">,</span> <span class="s">&quot;localhost:9092, localhost:9093&quot;</span><span class="p">);</span>
  <span class="n">props</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;key.serializer&quot;</span><span class="p">,</span> <span class="s">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="p">);</span>
  <span class="n">props</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;value.serializer&quot;</span><span class="p">,</span> <span class="s">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="p">);</span>

  <span class="n">Producer</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">producer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KafkaProducer</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">props</span><span class="p">);</span>

  <span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">record</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">topicName</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

  <span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
  <span class="n">producer</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>

  <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;SimpleProducer Completed.&quot;</span><span class="p">);</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>

Workflow
![]()images/kafka6.png)

*  Particionador default
    *  Partition
    *  Hash da ``chave''
    *  Round robin
*  Retry automático


Fire and Forget
* Envia a mensagem e não se importa com o resultado.

Synchronous Call
* Envia a mensagem e espera para saber se foi entregue ou não.

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">{</span>
 <span class="n">RecordMetadata</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">record</span><span class="p">).</span><span class="na">get</span><span class="p">();</span>
 <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Message is sent to Partition no &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">.</span><span class="na">partition</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; and offset &quot;</span> <span class="o">+</span> <span class="n">metadata</span><span class="p">.</span><span class="na">offset</span><span class="p">());</span>
 <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;SynchronousProducer Completed with success.&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
 <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
 <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;SynchronousProducer failed with an exception&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="k">finally</span><span class="p">{</span>
 <span class="n">producer</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>

*  Future

Callback
Envia a mensagem e é invocado depois de receber um ACK

<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>producer.send(record, new MyProducerCallback());

...

class MyProducerCallback implements Callback{
 @Override
 public  void onCompletion(RecordMetadata recordMetadata, Exception e) {
  if (e != null)
   System.out.println(&quot;AsynchronousProducer failed with an exception&quot;);
  else
   System.out.println(&quot;AsynchronousProducer call Success:&quot;);
 }
}
</code></pre></div>
</td></tr></table>

*  max.in.flight.requests.per.connection


Default Partitioner
![](../images/kafka6.png)

*  Partition
*  Hash da ``chave'' \% \#partition
*  Round robin

\href{https://github.com/LearningJournal/ApacheKafkaTutorials/blob/master/ProducerExamples/SensorPartitioner.java}{Exemplo de Custom Partitioner}
\end{frame}

\subsection{Consumidor}

\begin{frame}{Consumer Groups}
\begin{itemize}
*  Múltiplos consumidores processam dados em paralelo
*  Grupo de consumidores de tópicos
*  Grupo pertence à mesma aplicação
    \includegraphics[width=.6\textwidth]{images/kafka7}
*  Duplicate reads? Consumidores não compartilham partições
*  Group coordinator (broker eleito): lista de consumidores
*  Group líder: rebalanceamento
\end{itemize}
\end{frame}

\begin{frame}[fragile, allowframebreaks]{Consumer}
\begin{lstlisting}[language=Java]
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;

import java.io.IOException;
import java.util.Arrays;
import java.util.Properties;

public class SimpleConsumer {
 public static void main(String[] args) throws IOException {
  String topicName = "SimpleProducerTopic";
  String groupName = "SupplierTopicGroup";

  Properties props = new Properties();
  props.put("bootstrap.servers", "localhost:9092,localhost:9093");
  props.put("group.id", groupName);
  props.put("key.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
  props.put("value.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");

  KafkaConsumer<String, String> consumer = null;

  try {
   consumer = new KafkaConsumer<String, String>(props);
   consumer.subscribe(Arrays.asList(topicName));

   while (true) {
    ConsumerRecords<String,String> records = consumer.poll(100);

    for (ConsumerRecord<String, String> record: records)
     System.out.println("Key = " + record.key() + " Value = " + record.value());
   }
  } catch (Exception ex) {
   ex.printStackTrace();
  } finally {
   consumer.close();
  }
 }
}
\end{lstlisting}

\begin{itemize}
*  Se não definir grupo, será novo grupo, e lerá todas as mensagens disponíveis
\end{itemize}
\end{frame}


\begin{frame}{Poll}
\begin{itemize}
*  poll também envia hearbeat
*  executar a cada 3s, no mínimo    
*  Current offset: a cada poll, broker incrementa current offset
*  Commited offset: o consumidor informa quais índices foram processados
    \begin{itemize}
    *  Auto Commit
        \begin{itemize}
        *  enable.auto.commit
        *  auto.commit.interval.ms
        *  Pode causar reprocessamento de mensagens
        \end{itemize}
    *  Manual Commit
        \begin{itemize}
        *  CommitSync
        *  CommitAsync
        \end{itemize}
    \end{itemize}
\end{itemize}
\end{frame}


\subsection{Arquitetura}
%\begin{frame}{Líder}

%\end{frame}

%mensagens são ack depois de copiadas para todas as réplicas
%replicas lentas são removidas se lentas ou falhas
%at least once, at most once, exactly one (nao suportado)
%rolling upgrade
%tls security
%rest
%CRUD












### Falhas Bizantinas 

Uma história de três exércitos -- Versão 2}
Exércitos estão às portas de Bizâncio, aka Constantinopla, aka Istambul.

Todos os exércitos tem que atacar em conjunto ou se retirar em conjunto.

Cada exército é comandado por um General. Alguns destes preferem atacar, enquanto outros preferem se retirar.

Alguns generais podem ter sido comprados, e mandar mensagens discrepantes para os outros, ou simplesmente não mandar mensagens.

Fonte: \href{http://research.microsoft.com/en-us/um/people/lamport/pubs/byz.pdf}{Lamport, L.; Shostak, R.; Pease, M. (1982). "The Byzantine Generals Problem" (PDF). ACM Transactions on Programming Languages and Systems. 4 (3): 382–401. doi:10.1145/357172.357176.}


Generais e Tenentes
Problema pode ser mudado para:

    * Comandante envia ordem.
    * Todos os tenentes leais executam ordem recebida.
    * Comandante pode ser traidor.




Generais e Tenentes
Suponha 3 exércitos. \\
Comandante (traidor) diz "Ataque!" Tenente A e "Retirada!" tenente B.\\
Ou \\
Comandante diz "Ataque!" a ambos. Tenente A segue a ordem mas B se retira.

 E se os tenentes trocarem informações?

 Como diferenciar casos em que Comandante ou Tenente é traidor?





Generais e Tenentes
Só há solução se mais de $\frac{2}{3}$ dos Generais/Tenentes são leais.


%http://www.drdobbs.com/cpp/the-byzantine-generals-problem/206904396?pgno=5

Comunicação}

    * Toda mensagem enviada é entregue corretamente.
    * A ausência de mensagem pode ser detectada (mensagem Null é entregue no lugar) (Sistema síncrono)




4/0}
General manda ordens.

Ausência de ordem = Retirada

Tenente repassa ordens

Maioria de comandos é comando a ser seguido



4/0}
General manda ordens.

Ausência de ordem = Retirada

Tenente repassa ordens

Maioria de comandos é comando a ser seguido



Comunicação}

    * Toda mensagem enviada é entregue corretamente.
    * Toda mensagem é assinada.
    * A ausência de mensagem pode ser detectada (mensagem Null é entregue no lugar) (Sistema síncrono)


 É possível detectar inconsistências e processos bizantinos.



%http://cs.brown.edu/courses/cs138/s16/lectures/19consen-notes.pdf
\section{Outros tópicos}

%TODO \subsection{Detectores de Falhas}




\subsection{Reconfiguração}

Reconfiguração da Aplicação}
Na segunda entrega do projeto, você distribuiu a carga do seu banco de dados entre vários nós. Caso um nó falhe, parte dos seus dados será perdida.

Para corrigir esta deficiência, na terceira entrega, cada nó será replicado em três vias e, assim, caso um nó falhe, outros dois continuarão a manter o dado.



Reconfiguração da Aplicação}
Ainda assim, há problemas. E se mais de um, de um mesmo conjunto de réplicas, falhar? 

 Embora seja pequena a probabilidade de dois nós de um mesmo grupo falharem em instantes próximos, dado tempo suficiente, qualquer evento com probabilidade diferente de 0 acontecerá.

 Precisamos de uma forma de trocar nós da aplicação que falharam por novos nós. 

Este é problema denominado Pertinência de Grupo ou \emph{Group Membership}



Group Membership}
Para não correr o risco, retire o processo falhos do grupo e coloque outro no lugar!

I.e., mude a visão que o sistema de quem é o grupo.




Visões}
\includegraphics[width=.7\textwidth]{images/vc}

Fonte: \href{https://www.cs.rutgers.edu/~pxk/417/notes/virtual_synchrony.html}{Paul Krzyzanowski}

$G$ é o grupo de processos participando do sistema, é a Visão do Sistema.


Inicialmente, $G$ consiste de apenas o processo $p$, como o processo que cria o cluster no Atomix. Na sequência, outros processo vão se unindo ao grupo através de View Changes. Uma vez que $p$ e $q$ estão no grupo, inicia-se a comunicação entre eles. Quando $r, s$ e $t$ aparecem, também entram no grupo por meio de uma nova visão.

Finalmente, quando ambos $p$ e $q$ falham, os outros processo os excluem da visão, e continuam funcionando normalmente.


Impossibilidade de Detecção de Falhas}
Em um sistema distribuído assíncrono, é impossível distinguir com toda certeza um processo falho (parou de funcionar) de um que está lento.

 Como decidir se mudar ou não de visão?


Ou aceita a imprecisão e muda quando suspeitar de uma falha, ou corre o risco de ficar esperando \emph{ad eternum} e não mudar, mesmo quando uma falha aconteceu.

Uma ``solução''!}
Quando suspeitar de falha, reporte suspeita a outros processos, que também passarão a suspeitar.

Tome decisão baseado na suspeita, isto é, troque de visão quando houver suspeita.

Pague o preço de uma suspeita errada, isto é, quando um processo for removido da visão indevidamente, adicione-o novamente.



Sincronismos Virtual}
Gerenciamento de Grupo/Group Membership e Comunicação em Grupo

    * Processos se unem ao grupo
    * Processos saem do grupo
    * Processos enviam mensagens para o grupo
    * Diferentes ordenações

            * Atomic Multicast




Visão de Grupo}

    * Visão: conjunto de processos no sistema.
    * Multicast feito para processos na visão.
    * Visão é consistente entre os processos.
    * Entrada e saída de processos muda a visão.



Eventos}

    * Mensagem
    * Mudança de Visão
    * Checkpoint



Visões}
\includegraphics[width=.7\textwidth]{images/vc}

Fonte: \href{https://www.cs.rutgers.edu/~pxk/417/notes/virtual_synchrony.html}{Paul Krzyzanowski}


Sincronismo Virtual}
Deve satisfazer

    * Se uma mensagem é enviada em uma visão, ela só pode ser entregue naquela visão.
    * Se uma mensagem é entregue a um processo correto em uma visão, então é entregue a todos os processos corretos naquela visão.
    * Se um processo não recebe a mensagem, ele não estará na próxima visão.
    * Ao entrar em uma visão, o processo recebe o estado dos outros processos e seu estado se torna equivalente ao de um processo que recebeu todas as mensagens já entregues.


A troca de Visão é uma barreira.


ISIS Toolkit}
    Sistema de Sincronismo Virtual tolerante a falhas desenvolvido por Ken Birman, Cornell University (\url{http://www.cs.cornell.edu/Info/Projects/Isis/})\\
    ISIS: An Environment for Constructing Fault-Tolerant Distributed Systems. Kenneth Birman, D. Skeen, A. El Abbadi, W. C. Dietrich and T. Raeuchle. May 1983.


    * 100.000's/s
    * Em uso até 2009
    * NY Stock Exchange
    * Swiss Exchange
    * US Navy
    * Precursos de sistemas como Zookeeker
    * Totem, ISIS, Horus, Transis (Partições), \alert{Spread}, \alert{Ensamble}, \alert{JGroups}, Appia, QuickSilver, vSynch (née ISIS 2)



Difusão Totalmente Ordenada}

    * Corretude: Se um processo $p$ envia uma mensagem $m$ para processos no grupo $G$, então se $p$ não falha, todos os processos corretos em $G$ recebem a mensagem.

    * Acordo: Se um processo correto em $G$ recebe uma mensagem $m$, então todo processo correto em $G$ recebe $m$

    * Ordenação: Se um processo recebe mensagem $m$ e depois $n$, então qualquer processo que receba a mensagem $n$ deve primeiro receber $m$

    * Validade: Somente mensagens difundidas são entregues.


E se mandarmos mensagens do tipo ``A partir da entrega desta mensagem, o grupo de processos é $G$.''


Sincronismo Virtual}
Deve satisfazer

    * Se uma mensagem é enviada em uma visão, ela só pode ser entregue naquela visão.\\
    Mensagens de troca de visão podem incrementar um contador\\
    Mensagens normais carregam o valor atual do contador\\
    Mensagem descartada se valor na mensagem é maior contador no destinatário

    * Se uma mensagem é entregue a um processo correto em uma visão, então é entregue a todos os processos corretos naquela visão.\\
    Pela difusão, se a mensagem de troca for entregue para um processo, será entregue para todos os corretos, na mesma ordem
    Se mensagem comum for entregue antes para algum, será entregue ante para todos.

    * Se um processo não recebe a mensagem, ele não estará na próxima visão.\\
    Se um processo não recebe uma mensagem comum que foi entregue pelos outros, então ele não troca de visão.

    * Ao entrar em uma visão, o processo recebe o estado dos outros processos e seu estado se torna equivalente ao de um processo que recebeu todas as mensagens já entregues.\\
    Caso contrário, não haveria porquê trocar os processos



State Transfer}
\includegraphics[width=.7\textwidth]{images/state_transfer}


\href{http://www.gsd.inesc-id.pt/~ler/docencia/tfd0405/bib/BSRNA.pdf}{Building Secure and Reliable Network Applications}



Difusão Atômica $\equiv$ Sincronismo Virtual?}
Seria uma boa aproximação, mas que poderia ser relaxada. 

Em certas aplicações, FIFO ou Causal seriam suficientes dentro da visão, desde que a mensagem de mudança da visão seja totalmente ordenada com as comuns.



Particionamento}
E se dois subconjuntos mutuamente exclusivos se formarem e criarem visões independentes?

 \emph{Primary Partition Model} -- Somente a partição primária pode mudar de visão.

 Lembram-se que no Raft somente uma partição com uma maioria de processo pode decidir? É exatamente a mesma situação, pois os processos estão chegando a um Consenso sobre quem é a nova visão.



Extended Virtual Synchrony}
\emph{Primary Partition Model} -- Não é adequado a uma rede geograficamente distribuída (Internet scale).

 Lembram-se que no Raft somente uma partição com uma maioria de processo pode decidir? É exatamente a mesma situação, pois os processos estão chegando a um Consenso sobre quem é a nova visão.


É possível que no trabalho dois, alguns de vocês tenham tentado gerar locks do sistema para manipular objetos distribuídos no sistema. Esse locks são perigosos por quê processos pode travar/quebrar/falhar e nunca liberarem os locks. O uso de um algoritmo VS poderia ser usado para resolver o problema.\right 




[Swim](https://asafdav2.github.io/2017/swim-protocol/)




http://courses.cs.vt.edu/cs5204/fall05-gback/lectures/Lecture8.pdf



-->

<div class="footnote">
<hr />
<ol>
<li id="fn:\\">
<p>O <code>\\</code> no final da linha é só para mostrar que o comando continua na próxima e facilitar a visualização. 
Na hora de executar, use apenas uma linha, sem o <code>\\</code>.&#160;<a class="footnote-backref" href="#fnref:\\" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>

  <!-- Last update of source file -->


              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Rodapé">
      
        
        <a href="../swim/" class="md-footer__link md-footer__link--prev" aria-label="Anterior: Swim" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              Swim
            </div>
          </div>
        </a>
      
      
        
        <a href="../ratis/" class="md-footer__link md-footer__link--next" aria-label="Próximo: Ratis" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Próximo
              </span>
              Ratis
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright © 2021 Lásaro Camargos
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
      <a href="https://github.com/lasarojc/ds_notes" target="_blank" rel="noopener" title="These notes on Github" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "navigation.indexes"], "translations": {"clipboard.copy": "Copiar para \u00e1rea de transfer\u00eancia", "clipboard.copied": "Copiado para \u00e1rea de transfer\u00eancia", "search.config.lang": "pt", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Buscar", "search.result.placeholder": "Digite para iniciar a busca", "search.result.none": "Nenhum resultado encontrado", "search.result.one": "1 resultado encontrado", "search.result.other": "# resultados encontrados", "search.result.more.one": "Mais 1 nesta p\u00e1gina", "search.result.more.other": "Mais # nesta p\u00e1gina", "search.result.term.missing": "Ausente", "select.version.title": "Selecione a vers\u00e3o"}, "search": "../../assets/javascripts/workers/search.409db549.min.js", "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.56a63758.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../javascripts/mathjaxhelper.js"></script>
      
    
  </body>
</html>