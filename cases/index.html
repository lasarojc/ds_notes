
<!doctype html>
<html lang="pt" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Estudos de Caso - Notas em Sistemas Distribuídos</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
          
          
          <meta name="theme-color" content="#546d78">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-PJX835H7DP","lasarojc.github.org/dsnotes"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#sistema-p2p-chord" class="md-skip">
          Ir para o conteúdo
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-header__button md-logo" aria-label="Notas em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Notas em Sistemas Distribuídos
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Estudos de Caso
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Buscar" placeholder="Buscar" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Notas em Sistemas Distribuídos" class="md-nav__button md-logo" aria-label="Notas em Sistemas Distribuídos" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Notas em Sistemas Distribuídos
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/lasarojc/ds_notes" title="Ir ao repositório" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../preface/" class="md-nav__link">
        Prefácio
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        Introdução
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../arch/" class="md-nav__link">
        Arquiteturas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/" class="md-nav__link">
        Modelos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../comm/" class="md-nav__link">
        Comunicação
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../p2p/" class="md-nav__link">
        P2P
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../microservices/" class="md-nav__link">
        Microsserviços
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../coord/" class="md-nav__link">
        Coordenação
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../time/" class="md-nav__link">
        Tempo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../fault/" class="md-nav__link">
        Tolerância a Falhas
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../consistency/" class="md-nav__link">
        Consistência
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../disdb/" class="md-nav__link">
        Bancos de Dados
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../disfs/" class="md-nav__link">
        Sistemas de Arquivos
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Estudos de Caso
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Estudos de Caso
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sistema-p2p-chord" class="md-nav__link">
    Sistema P2P: Chord
  </a>
  
    <nav class="md-nav" aria-label="Sistema P2P: Chord">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identificacao" class="md-nav__link">
    Identificação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#divisao-de-carga" class="md-nav__link">
    Divisão de carga
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roteamento" class="md-nav__link">
    Roteamento
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#churn" class="md-nav__link">
    Churn
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sistema-p2p-dynamodb" class="md-nav__link">
    Sistema P2P: DynamoDB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sistema-p2p-cassandra" class="md-nav__link">
    Sistema P2P: Cassandra
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estudos-de-caso" class="md-nav__link">
    Estudos de Caso
  </a>
  
    <nav class="md-nav" aria-label="Estudos de Caso">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rpc-grpc" class="md-nav__link">
    RPC: gRPC
  </a>
  
    <nav class="md-nav" aria-label="RPC: gRPC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instalacao" class="md-nav__link">
    Instalação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exemplo-java" class="md-nav__link">
    Exemplo Java
  </a>
  
    <nav class="md-nav" aria-label="Exemplo Java">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pegando-o-codigo" class="md-nav__link">
    Pegando o código
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compilando-e-executando" class="md-nav__link">
    Compilando e executando
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#o-servico" class="md-nav__link">
    O serviço
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementando-um-servico" class="md-nav__link">
    Implementando um serviço
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpc-thrift" class="md-nav__link">
    RPC: Thrift
  </a>
  
    <nav class="md-nav" aria-label="RPC: Thrift">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instalacao_1" class="md-nav__link">
    Instalação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idl-thrift" class="md-nav__link">
    IDL Thrift
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arquitetura" class="md-nav__link">
    Arquitetura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#classpath" class="md-nav__link">
    Classpath
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpc-remote-method-invocation" class="md-nav__link">
    RPC: Remote Method Invocation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pubsub-mosquitto" class="md-nav__link">
    Pub/Sub: MosQuiTTo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tech/" class="md-nav__link">
        Tecnologias
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Índice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Índice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sistema-p2p-chord" class="md-nav__link">
    Sistema P2P: Chord
  </a>
  
    <nav class="md-nav" aria-label="Sistema P2P: Chord">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#identificacao" class="md-nav__link">
    Identificação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#divisao-de-carga" class="md-nav__link">
    Divisão de carga
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roteamento" class="md-nav__link">
    Roteamento
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#churn" class="md-nav__link">
    Churn
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sistema-p2p-dynamodb" class="md-nav__link">
    Sistema P2P: DynamoDB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sistema-p2p-cassandra" class="md-nav__link">
    Sistema P2P: Cassandra
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#estudos-de-caso" class="md-nav__link">
    Estudos de Caso
  </a>
  
    <nav class="md-nav" aria-label="Estudos de Caso">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rpc-grpc" class="md-nav__link">
    RPC: gRPC
  </a>
  
    <nav class="md-nav" aria-label="RPC: gRPC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instalacao" class="md-nav__link">
    Instalação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exemplo-java" class="md-nav__link">
    Exemplo Java
  </a>
  
    <nav class="md-nav" aria-label="Exemplo Java">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pegando-o-codigo" class="md-nav__link">
    Pegando o código
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compilando-e-executando" class="md-nav__link">
    Compilando e executando
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#o-servico" class="md-nav__link">
    O serviço
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementando-um-servico" class="md-nav__link">
    Implementando um serviço
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpc-thrift" class="md-nav__link">
    RPC: Thrift
  </a>
  
    <nav class="md-nav" aria-label="RPC: Thrift">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instalacao_1" class="md-nav__link">
    Instalação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idl-thrift" class="md-nav__link">
    IDL Thrift
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arquitetura" class="md-nav__link">
    Arquitetura
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#classpath" class="md-nav__link">
    Classpath
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpc-remote-method-invocation" class="md-nav__link">
    RPC: Remote Method Invocation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pubsub-mosquitto" class="md-nav__link">
    Pub/Sub: MosQuiTTo
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#referencias" class="md-nav__link">
    Referências
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              

<!-- Edit button -->


  <!--
       Hack: check whether the content contains a h1 headline. If it
       doesn't, the page title (or respectively site name) is used
       as the main headline.
    -->

  <h1>Estudos de Caso</h1>


  <!-- Content -->
  <h2 id="sistema-p2p-chord">Sistema P2P: Chord</h2>
<p>Chord é uma sistema P2P de múltiplas aplicações desenvolvido pelos membros do <a href="https://www.csail.mit.edu/">CSAIL</a>, do MIT, e publicado em 2001. 
Desde então, inspirou diversos outros sistemas, tornando-se sinônimo com P2P.
Neste sistema, nós organizam-se em um anel lógico e cada um torna-se responsável por um dos segmentos do anel adjacente a onde se encontra no mesmo.
Requisições para correspondentes a um segmento são roteados para o nó responsável usando uma tabela de rotas conhecida como <em>finger table</em>.
Se traçarmos os caminhos apontados por esta tabela sobre o anel, desenharemos <strong>cordas</strong> sobre o mesmo, o que explica o nome do sistema.</p>
<p><img alt="Chord" src="../images/chord.png" /></p>
<h3 id="identificacao">Identificação</h3>
<p>No Chord o problema da identificação dos dados é resolvido usando-se chaves de <strong><span class="arithmatex">\(m\)</span> bits</strong>, geradas por meio de uma função hash criptográfica a partir de chaves que faça sentido para a aplicação, por exemplo nome, telefone, ou CPF.
Como a função hash é criptográfica, uma pequena variação na entrada implica em grande variação na saída e, para quem observa apenas a saída da função, uma sequência de chaves é indistinguível de uma sequência aleatória.</p>
<h3 id="divisao-de-carga">Divisão de carga</h3>
<p>A cada nó é atribuído um identificador único de <strong><span class="arithmatex">\(m\)</span> bits</strong>, gerado aleatoriamente. 
Como <span class="arithmatex">\(m\)</span> normalmente é grande, com mais de uma centena de bits, a probabilidade de dois nós terem o mesmo identificar é desprezível.
Além disso, os nós se organizam em uma rede sobreposta estruturada na forma de um <strong>anel lógico</strong>, em que os nós aparecem ordenadamente de acordo com seus identificadores.
A figura a seguir mostra um anel em cujo os nós tem identificadores de 8 bits (0 a 255), com cinco nós.<sup id="fnref:chord_dist"><a class="footnote-ref" href="#fn:chord_dist">1</a></sup>
Assumamos inicialmente que os nós só estão cientes dos seus vizinhos imediatos no anel.</p>
<p><img alt="Anel Chord" src="../drawings/chord.drawio-0.svg" /></p>
<p>Cada chave é associada a um nó, responsável por atender requisições de criação, consulta, modificação e remoção dos dados relacionados àquela chave.
A pseudo aleatoriedade na geração da chave e a aleatoriedade na geração dos identificadores de nós faz com que a distribuição de carga entre os nós seja uniforme.
O dado com chave <span class="arithmatex">\(k\)</span> é responsabilidade do nó com menor identificador <span class="arithmatex">\(i \geq k\)</span>, aka, <strong>sucessor de <span class="arithmatex">\(k\)</span></strong> (<span class="arithmatex">\(i = suc(k)\)</span>), no anel.
Na figura a seguir, é apresentado junto a cada nó as chaves pelas quais o nó é responsável.</p>
<p><img alt="Anel com Chaves no Chord" src="../drawings/chord.drawio-1.svg" /></p>
<h3 id="roteamento">Roteamento</h3>
<p>Suponha que um cliente solicite ao Chord do exemplo anterior que armazene o valor <span class="arithmatex">\(v\)</span> associado à chave <span class="arithmatex">\(k\)</span>.
A solicitação é feita pelo contato a um dos nós no sistema, que pode ou não ser o responsável por <span class="arithmatex">\(k\)</span>.
Caso seja o responsável, a solicitação é executada localmente e uma resposta devolvida ao cliente.
Caso contrário, a requisição deve repassada ou <strong>roteada</strong> para o nó correto.</p>
<p>Na rede estruturada definida até agora, uma opção óbvia é repassar a requisição para um dos vizinhos e assim sucessivamente até que alcance o nó correto. 
Esta solução, correta, tem custo da ordem do número de nós no sistema, <span class="arithmatex">\(O(n)\)</span>.
Em uma instância com milhares de nós, <span class="arithmatex">\(O(n)\)</span> é um custo muito alto, ainda mais se considerarmos que cada salto na rede sobreposta potencialmente cruza toda a Internet, uma vez que, reforçando, a proximidade na rede sobreposta não implica em proximidade na rede física abaixo.
Observe que o custo em termos de espaço para se implementar esta solução é <span class="arithmatex">\(O(1)\)</span> para cada nó do sistema.
Em outras palavras, cada nó mantem uma <strong>tabela de rotas</strong> com uma ou duas entradas, apontando para seus vizinhos.</p>
<p>Com uma rede com milhares de nós, uma solução <span class="arithmatex">\(O(n)\)</span> saltos, onde cada pode levar <strong>ao outro lado do planeta</strong>, operações teriam uma latência muito alta.
Para amenizar o custo, Chord propõe a criação de uma tabela de rotas, também conhecida como <em>finger-table</em>, que aponta para nós no anel com distâncias que se dobram a cada entrada.</p>
<p><img alt="Anel com Chaves no Chord" src="../drawings/chord.drawio-2.svg" /></p>
<p>A <em>finger-table</em> é construída da seguinte forma, onde <span class="arithmatex">\(m\)</span> é a quantidade de bits usados para identificar nós no sistema:</p>
<ul>
<li>seja <span class="arithmatex">\(F_p\)</span> a <em>finger-table</em> do processo <span class="arithmatex">\(p\)</span>;</li>
<li>seja <span class="arithmatex">\(F_p[i]\)</span> a <span class="arithmatex">\(i\)</span>-ésima da tabela; e,</li>
<li><span class="arithmatex">\(F_p[i] = suc(p+2^{i-1})\)</span>.</li>
</ul>
<p>Observe que nesta tabela, a <span class="arithmatex">\(i\)</span>-ésima entrada aponta para o processo que no que sucede <span class="arithmatex">\(p\)</span> pelo menos <span class="arithmatex">\(2^{i-1}\)</span>, e que esta distância de sucessão aumenta exponencialmente. 
Observe também que a maior distância é proporcional a metade do tamanho do anel.
Isto quer dizer que o último <em>finger</em> da tabela proporciona um salto de <span class="arithmatex">\(1/2\)</span> anel, o penúltimo <span class="arithmatex">\(1/4\)</span> do anel, o ante-penúltimo <span class="arithmatex">\(1/8\)</span>, e assim sucessivamente.
Outra forma de se ver esta tabela é como proporcionando um salto de pelo menos metade da distância restante para o nó responsável pela chave, resultando em um roteamento com custo <span class="arithmatex">\(O(log n)\)</span>.</p>
<p>Mas como este potencial é explorado? Usando-se o seguinte algoritmo de busca pela entrada correta na tabela de roteamento, do ponto de vista do processo <span class="arithmatex">\(p\)</span>:</p>
<ul>
<li>seja <span class="arithmatex">\(k\)</span> a chave para qual estamos procurando o sucessor;</li>
<li>itere pela tabela até achar a primeira entrada cujo valor, i.e., o identificador de um nó, é maior que <span class="arithmatex">\(k\)</span>;</li>
<li>se a entrada é a primeira da tabela, então encaminhe a requisição para o nó apontado, pois ele é o sucessor de <span class="arithmatex">\(k\)</span>, até onde <span class="arithmatex">\(p\)</span> consegue determinar;</li>
<li>senão, encaminhe a requisição para a entrada anterior, pois o nó referenciado está mais próximo do sucessor para determiná-lo com segurança.</li>
</ul>
<p>Considere no exemplo a seguir a busca pelo sucessor de 26, iniciada pelo nó 1.</p>
<p><img alt="" src="../images/05-04.png" /></p>
<p>Duas observações são importantes aqui. A primeira, é que as comparações para se encontrar a entrada correta, deve respeitar o anel, por exemplo, em um anel com 32 posições, por exemplo, <span class="arithmatex">\(31 &lt; 0\)</span>. No seguinte exemplo, considere por exemplo a busca que o nó 21 faz pelo sucessor de 31; qual deve ser a entrada selecionada?</p>
<p><img alt="" src="../images/05-04.png" /></p>
<p>A segunda observação é que não se pode encaminhar a requisição diretamente para o nó apontado na entrada encontrada, pois a visão de <span class="arithmatex">\(p\)</span> pode ser incompleta para partes distantes do anel.
Tente identificar exemplos no anel a seguir onde este comportamento seria errado.</p>
<p>A organização dos nós em um anel virtual e a distribuição da responsabilidade dos dados pelo particionamento do espaço das chaves de forma correspondente às faixas no anel lógico é a técnica conhecida como <strong>espalhamento consistente</strong>, do inglês, <em>consistent hashing</em>.</p>
<h3 id="churn">Churn</h3>
<p>Apesar do espalhamento consistente ser uma técnica muito útil, ela não resolve todos os problemas. Aliás, vários outros problemas precisam ser resolvidos, sendo o primeiro deles lidar com a entrada e saída de nós, principalmente por falhas de nós e comunicação.</p>
<p>Quando um novo nó entra do sistema, ele precisa seguir os seguintes passos:</p>
<ul>
<li>Escolher um novo Identificador <span class="arithmatex">\(I\)</span></li>
<li>Identificar o sucessor <span class="arithmatex">\(S\)</span> de <span class="arithmatex">\(I\)</span></li>
<li>Identificar o antecessor <span class="arithmatex">\(A\)</span> de <span class="arithmatex">\(I\)</span></li>
<li>Informar <span class="arithmatex">\(A\)</span> e <span class="arithmatex">\(S\)</span> de sua entrada, para que ajustem suas tabelas de rota.</li>
<li><span class="arithmatex">\(A\)</span> e <span class="arithmatex">\(S\)</span> propagam a informação da entrada de <span class="arithmatex">\(I\)</span> para seus vizinhos, permitindo que ajustem suas tabelas de rota.</li>
</ul>
<p>Além disto, a reorganização dos nós exige movimentação de dados, pois parte dos dados armazenados em <span class="arithmatex">\(S\)</span>, com chaves menores que <span class="arithmatex">\(I\)</span>, precisam ser copiadas para <span class="arithmatex">\(I\)</span>, o novo responsável.
As principais questões a serem respondidas durante a movimentação dos dados são</p>
<ul>
<li>como manter os dados disponíveis para inserção e consulta durante todo o processo, e</li>
<li>como minimizar o impacto da reorganização nos nós vizinhos ao novo nó</li>
</ul>
<p>Quanto à primeira questão, pode-se rotear as requisições para os dois nós responsáveis, o atual e o novo, e combinar as respostas, mantendo os dados mais recentes.
Quanto à segunda, uma opção é fazer com que cada novo nó assuma diversas posições no anel, com identificadores distintos, passando a "incomodar" múltiplos processos, mas de forma mais suave.</p>
<p>Embora se possa "facilmente" resolver os problemas da entrada de nós, os da saída são mais complexos, principalmente porquê a saída acontece geralmente bruscamente, por exemplo por falhas no sistema.
Quanto à reorganização das tabelas de rota, cada nó precisa monitorar os nós que figuram em sua tabela e, caso pareçam indisponíveis, ajustar par apontar para outro nó.
Contudo, caso a suspeita seja indevida, isto pode levar a dados serem consultados e armazenados nos nós errados.
Também com relação aos dados, há o problema de não perdê-los quando o nó responsável se torna indisponível.
O tratamento destes problemas está relacionado e é feito pelo replicação dos dados em múltiplos nós. Isto é feito no Chord, por exemplo, da seguinte forma:</p>
<ul>
<li>para cada dado, com chave <span class="arithmatex">\(k\)</span>, há <span class="arithmatex">\(r\)</span> cópias;</li>
<li>a primeira cópia é mantida no sucessor de <span class="arithmatex">\(k\)</span>;</li>
<li>a segunda cópia, no sucessor do sucessor de <span class="arithmatex">\(k\)</span>, e assim por diante;</li>
<li>cada escrita é feita na primeira cópia, respondida, e replicada para as demais cópias;</li>
<li>cada leitura é feita na cópia com menor identificador.</li>
</ul>
<p>No caso de falha de uma cópia, há <span class="arithmatex">\(r-1\)</span> cópias ainda disponíveis para responder à requisição, mantendo o sistema disponível a despeito de (<span class="arithmatex">\(r-1\)</span>) falhas, no que se chama de <strong>degradação graciosa</strong>.
Há contudo, um problema introduzido por esta abordagem. Assuma a seguinte sequência de passos, em um sistema com <span class="arithmatex">\(r=2\)</span>.</p>
<ul>
<li>escrita na cópia 1;</li>
<li>resposta ao cliente;</li>
<li>replicação para cópia 2;</li>
<li>escrita na cópia 1;</li>
<li>resposta ao cliente;</li>
<li>falha da cópia 1;</li>
<li>leitura na cópia 2.</li>
</ul>
<p>O cliente, ao ler o dado, lê uma versão antiga do mesmo, inconsistente com a visão que tinha do sistema.
De fato, este tipo de sistema é chamado de eventualmente consistente pois somente na <strong>ausência de falhas e de escritas</strong> as diversas réplicas serão consistentes umas com as outras.
Continuemos a sequência:</p>
<ul>
<li>escrita na cópia 2;</li>
<li>cópia 1 volta a funcionar;</li>
<li>leitura na cópia 1.</li>
</ul>
<p>Neste caso, a cópia "secundária" 2 tem um dado mais atual, que precisa ser repassado para a cópia 1; este movimento de convergência de dados é conhecido como anti-entropia.
Finalmente, continuemos a sequência:</p>
<ul>
<li>escrita na cópia 1, por outro cliente.</li>
</ul>
<p>Assim, ambas as cópias, 1 e 2, tem dados derivados da primeira escrita, mas feitos "concorrentemente", um <strong>conflito</strong>.
Qual dos dois é o correto neste contexto? É impossível apresentar uma estratégia genérica para resolver esta situação, mas alguns sistemas usarão uma estratégia do tipo "a última escrita vence", onde a última escrita pode ser determinada em por relógios lógicos, vetoriais, tempo, e uma pitada de "arranjo técnico" para quebrar empates.
O Dynamo, que veremos a seguir, é um destes sistemas.</p>
<div class="admonition note">
<p class="admonition-title">Espalhamento Consistente</p>
<ul>
<li>Carga uniforme entre nós.</li>
<li>Todos os nós sabem como rotear requisições</li>
<li>Número de saltos médio é conhecido.</li>
<li>O sistema se adapta a entrada e saída de nós, por falhas ou não.</li>
</ul>
</div>
<h2 id="sistema-p2p-dynamodb">Sistema P2P: DynamoDB</h2>
<p>DynamoDB é o marco fundamental dos bancos de dados NoSQL. 
No vídeo a seguir um de seus evangelizadores, descreve rapidamente o banco, os cenários em que deveria ser usado e diversos padrões de projeto para modelagem de dados.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/HaEPXoXVf2k" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>Enquanto o assiste, alguns pontos devem ser ressaltados sobre o Dynamo de forma específica e os NoSQL de forma geral:     </p>
<ul>
<li>surgiram da necessidade de escalabilidade dos bancos de dados, isto é, da necessidade de lidar com milhões e milhões de entradas de dados, gerados e processados com baixa latência e alta vazão, a despeito de falhas;</li>
<li>maior escalabilidade implica em maior exposição a particionamentos da rede em que o sistema roda, que associado à necessidade de manutenção de alta disponibilidade, implica em perda de garantias de consistência (veremos o <a href="https://en.wikipedia.org/wiki/CAP_theorem">Teorema CAP</a> adiante);</li>
<li><em>Partition keys</em> são as chaves usadas para roteamento dos dados, ou seja, as chaves discutidas anteriormente neste capítulo sobre sistema P2P;</li>
<li><em>Sort keys</em> são chaves usadas dentro de cada nó para ordenar os dados na hora de gerar as SSTables (<em>String Sorted Tables</em>), e se usadas em agregados de valores, são equivalentes ao <em>GROUP BY</em> do SQL;</li>
<li><em>Lambda functions</em>  são funções para processamento de dados executadas em entradas definidas por um pipeline de processamento sem a definição explícita de sockets e portas, em um modelo conhecido como <a href="https://en.wikipedia.org/wiki/Serverless_computing">Serverless</a>.</li>
</ul>
<p>Este modelo é adequado a algumas aplicações, como o carrinho de compras da Amazon.com, aplicação para a qual o Dynamodb foi inicialmente desenvolvido.
Nesta aplicação, cada usuário tem um <strong>identificador único</strong>, recuperado no momento em que se loga ao sistema da Amazon.
Este identificador único é a <strong>chave de particionamento</strong> e os dados são o conteúdo do carrinho de compras.</p>
<p>Para lidar com falhas, o conteúdo do carrinho é replicado nos nós sucessivos ao responsável pela dupla chave valor.
O carrinho é <strong>modificado atomicamente</strong>, isto é, sobrescrito por inteiro. A replicação, associada às modificações atômicas, potencializa conflitos, que são identificados comparando-se os vetores de versão (relógios vetoriais) associados a cada valor escrito.
No caso de conflitos, as múltiplas cópias concorrentes são apresentadas ao usuário na forma de um carrinho de compras com a união dos itens nos respectivos carrinhos, de forma que o usuário possa corrigí-lo. Na pior das hipóteses, uma compra com erros será feita, e necessitará de uma atividade compensatória para o usuário, como um brinde.</p>
<p>Na prática, muitos sistemas mantém os papéis de clientes, que requisitam a execução de serviços, e servidores, que executam as requisições, mas distribuem as tarefas dos servidores entre pares para aquela função, sendo efetivamente sistemas híbridos. 
Este é o caso dos bancos de dados NOSQL, como o Dynamo, que acabamos de estudar, e também do Cassandra, que veremos a seguir.</p>
<p><img alt="CassandraDB" src="../drawings/cassandra_hibrido.drawio-0.svg" /></p>
<h2 id="sistema-p2p-cassandra">Sistema P2P: Cassandra</h2>
<p>Outra alternativa é fazer com que cada nó do sistema conheça todos os outros. Assim, cada requisição pode ser diretamente encaminhada ao nó responsável por tratá-la. 
O custo do roteamento, neste caso, é <span class="arithmatex">\(O(1)\)</span>, muito mais rápido que na abordagem anterior. O custo de armazenamento da <em>tabela de rotas</em> é, contudo, <span class="arithmatex">\(O(n)\)</span>, o que pode ser proibitivo em uma rede com milhares de nós, apesar de ser uma solução viável em redes menores. Este é o caso do CassandraDB, uma banco de dados distribuído baseado no Chord, que estudaremos melhor mais adiante, considerado uma DHT de salto único (<em>single-hop</em> DHT).</p>
<p>O CassandraDB foi, sem sombra de dúvida, influenciado pelo projeto do DynamoDB, o que é facilmente explicável já que um dos criadores do Dynamo foi o arquiteto do Cassandra.
Mas em vez de uma cópia, o Cassandra largamente expande a funcionalidade do Dynamo ao se inspirar no banco de dados <a href="https://en.wikipedia.org/wiki/Bigtable">BigTable</a>, do Google.
Com isso, o Cassandra se aproxima do modelo relacional, facilitando o desenvolvimento de certas aplicações, sem perder as características desejáveis das DHT.<br />
A principal característica neste sentido é o modelo híbrido chave-valor/relacional, em que os valores associados a uma chave são divididos em colunas.
A combinação chave-colunas são denominadas <strong>column-families</strong> e seu conjunto <strong>keyspace</strong>. Estas duas estruturas são equivalente às tabelas/relações e aos bancos de dados, dos bancos de dados  relacionais. </p>
<p><img alt="keyspace" src="../images/cass_keyspace.jpg" /></p>
<p>Uma diferença fundamental entre column-families e relações é que as últimas precisam de um esquema pré-definido, enquanto que as primeiras não tem um esquema. Isto quer dizer que novas colunas podem ser adicionadas dinamicamente e que nem todas precisam estar presentes para cada chave. De fato, múltiplos registros com a mesma chave, ou linhas, podem ter conjuntos de colunas diferentes.</p>
<p><img alt="Column-family" src="../images/cass_column_family.jpg" /></p>
<p>Para que o correto conjunto de colunas associado a uma chave possa ser apurado, após múltiplas escritas com a mesma chave tenham ocorrido, a cada tupla (chave,coluna,valor) é associado também um <em>timestamp</em>.<br />
<img alt="timestamps" src="../images/cass_column.jpg" />.<br />
Assim, dados uma mesma chave e coluna, o valor válido é o com o maior timestamp.
Devido a possibilidade de valores serem escritos para diferentes colunas independentemente, valores válidos e inválidos podem ter o mesmo <em>timestamp</em>.
Por exemplo, considere os seguintes dados escritos no banco:</p>
<table>
<thead>
<tr>
<th>Chave</th>
<th>Coluna<span class="arithmatex">\(\rightarrow\)</span>Valor</th>
<th>Timestamp</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>Nome<span class="arithmatex">\(\rightarrow\)</span>José, Idade<span class="arithmatex">\(\rightarrow\)</span>30</td>
<td>02:02:2020,13:45:00</td>
</tr>
<tr>
<td>3</td>
<td>Idade<span class="arithmatex">\(\rightarrow\)</span>33</td>
<td>02:02:2020,13:50:00</td>
</tr>
<tr>
<td>3</td>
<td>Telefone<span class="arithmatex">\(\rightarrow\)</span>333444554433</td>
<td>02:02:2020,13:55:00</td>
</tr>
</tbody>
</table>
<p>Uma busca pelos dados associados à chave 3 retornará o seguinte resultado:  Nome<span class="arithmatex">\(\rightarrow\)</span>José, Idade<span class="arithmatex">\(\rightarrow\)</span>33, Telefone<span class="arithmatex">\(\rightarrow\)</span>333444554433.
Para facilitar mais ainda o desenvolvimento, o Cassandra conta com uma linguagem de consulta similar ao SQL (Structured Query Language), a CQL (Cassandra Query Language).
Assim, a consulta a estes dados seria mais ou menos como <code class="highlight"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">dados</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">==</span> <span class="mi">3</span></code>.<sup id="fnref:cql_sintax"><a class="footnote-ref" href="#fn:cql_sintax">2</a></sup></p>
<p>Há muitos recursos <em>online</em>  para se aprender mais se aprender mais sobre como usar o Cassandra, por exemplo, <a href="http://wiki.apache.org/cassandra/GettingStarted">aqui</a>.
Há também diversos projetos de código livre que o usam e podem ser estudados, por exemplo, o clone de Twiter <a href="https://github.com/twissandra/twissandra">Twissandra</a>.
Mas embora o uso de sistemas gerenciadores de bancos de dados em sistemas distribuídos seja interessante, aqui nos focaremos em alguns dos aspectos de como estes SGBD são construídos.</p>
<div class="admonition note">
<p class="admonition-title">Detalhes de Implementação</p>
<p>A seção de <a href="../tech/#estruturas-de-dados-para-sd">tecnologias</a> descreve várias estruturas de dados recorrentemente usadas em implementação de bancos de dados como o Cassandra.</p>
</div>
<h2 id="estudos-de-caso">Estudos de Caso</h2>
<h3 id="rpc-grpc">RPC: gRPC</h3>
<p>gRPC é um framework para invocação remota de procedimentos multi-linguagem e sistema operacional, usando internamente pelo Google há vários anos para implementar sua arquitetura de micro-serviços.
Inicialmente desenvolvido pelo Google, o gRPC é hoje de código livre encubado pela Cloud Native Computing Foundation.</p>
<p>O sítio <a href="https://grpc.io">gRPC.io</a> documenta muito bem o gRPC, inclusive os <a href="https://grpc.io/blog/principles/">princípios</a> que nortearam seu projeto.</p>
<p>O seu uso segue, em linhas gerais, o modelo discutido nas seções anteriores, isto é, inicia-se pela definição de estruturas de dados e serviços, "compila-se" a definição para gerar stubs na linguagem desejada, e compila-se os stubs juntamente com os códigos cliente e servidor para gerar os binários correspondentes.
Vejamos a seguir um tutorial passo a passo, em Java, baseado no <a href="https://grpc.io/docs/quickstart/java.html">quickstart guide</a>.</p>
<h4 id="instalacao">Instalação</h4>
<p>Os procedimentos de instalação dependem da linguagem em que pretende usar o gRPC, tanto para cliente quanto para servidor.
No caso do <strong>Java</strong>, <strong>não há instalação propriamente dita</strong>.</p>
<h4 id="exemplo-java">Exemplo Java</h4>
<p>Observe que o repositório base apontado no tutorial serve de exemplo para diversas linguagens e diversos serviços, então sua estrutura é meio complicada. Nós nos focaremos aqui no exemplo mais simples, uma espécie de "hello word" do RPC.</p>
<h5 id="pegando-o-codigo">Pegando o código</h5>
<p>Para usar os exemplos, você precisa clonar o repositório com o tutorial, usando o comando a seguir.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>git clone -b v1.33.0 https://github.com/grpc/grpc-java
</code></pre></div>
</td></tr></table>
<p>Uma vez clonado, entre na pasta de exemplo do Java e certifique-se que está na versão 1.33, usada neste tutorial.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nb">cd</span> grpc-java/examples
git checkout v1.36.0
</code></pre></div>
</td></tr></table>
<h5 id="compilando-e-executando">Compilando e executando</h5>
<p>O projeto usa <a href="https://gradle.org/">gradle</a> para gerenciar as dependências. Para, use o <em>wrapper</em> do gradle como se segue.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nb">cd</span> grpc-java/examples
./gradlew installDist -PskipAndroid<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
</td></tr></table>
<p>Caso esteja na UFU, coloque também informação sobre o proxy no comando.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./gradlew -Dhttp.proxyHost<span class="o">=</span>proxy.ufu.br -Dhttp.proxyPort<span class="o">=</span><span class="m">3128</span> -Dhttps.proxyHost<span class="o">=</span>proxy.ufu.br -Dhttps.proxyPort<span class="o">=</span><span class="m">3128</span> installDist
</code></pre></div>
</td></tr></table>
<p>Como quando usamos sockets diretamente, para usar o serviço definido neste exemplo, primeiros temos que executar o servidor.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./build/install/examples/bin/hello-world-server
</code></pre></div>
</td></tr></table>
<p>Agora, em <strong>um terminal distinto</strong> e a partir da mesma localização, execute o cliente, quantas vezes quiser.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./build/install/examples/bin/hello-world-client
</code></pre></div>
</td></tr></table>
<h5 id="o-servico">O serviço</h5>
<p>O exemplo não é muito excitante, pois tudo o que o serviço faz é enviar uma saudação aos clientes.
O serviço é definido no seguinte arquivo <code>.proto</code>, localizado em <code>./src/main/proto/helloworld.proto</code>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">message</span> <span class="nc">HelloRequest</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">HelloReply</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="kd">message</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// The greeting service definition.</span>
<span class="kd">service</span> <span class="n">Greeter</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">SayHello</span> <span class="p">(</span><span class="n">HelloRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloReply</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>No arquivo, inicialmente são definidas duas mensagens, usadas como requisição (cliente para servidor) e outra como resposta (servidor para cliente) do serviço definido em seguida.</p>
<p>A mensagem <code>HelloRequest</code> tem apenas um campo denominado <code>name</code>, do tipo <code>string</code>. Esta mensagem conterá o nome do cliente, usado na resposta gerada pelo servidor.</p>
<p>A mensagem <code>HelloReply</code> também tem um campo do tipo <code>string</code>, denominado <code>message</code>, que conterá a resposta do servidor.</p>
<p>O serviço disponível é definido pela palavra chave <code>service</code>e de nome <code>Greeter</code>; é importante entender que este nome será usado em todo o código gerado pelo compilador gRPC e que se for mudado, todas as referências ao código gerado devem ser atualizadas.</p>
<p>O serviço possui apenas uma operação, <code>SayHello</code>, que recebe como entrada uma mensagem <code>HelloRequest</code> e gera como resposta uma mensagem <code>HelloReply</code>.
Caso a operação precisasse de mais do que o conteúdo de <code>name</code> para executar, a mensagem <code>HelloRequest</code> deveria ser estendida, pois não há passar mais de uma mensagem para a operação.
Por outro lado, embora seja possível passar zero mensagens, esta não é uma prática recomendada.
Isto porquê caso o serviço precisasse ser modificado no futuro, embora seja possível estender uma mensagem, não é possível modificar a assinatura do serviço. 
Assim, caso não haja a necessidade de se passar qualquer informação para a operação, recomenda-se que seja usada uma mensagem de entrada vazia, que poderia ser estendida no futuro.
O mesmo se aplica ao resultado da operação.</p>
<p>Observe também que embora o serviço de exemplo tenha apenas uma operação, poderia ter múltiplas.
Por exemplo, para definir uma versão em português da operação <code>SayHello</code>, podemos fazer da seguinte forma.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">message</span> <span class="nc">HelloRequest</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">HelloReply</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="kd">message</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">OlaRequest</span> <span class="p">{</span>     <span class="c1">// &lt;&lt;&lt;&lt;&lt;====</span>
  <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">OlaReply</span> <span class="p">{</span>       <span class="c1">// &lt;&lt;&lt;&lt;&lt;====</span>
  <span class="kt">string</span> <span class="kd">message</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">service</span> <span class="n">Greeter</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">SayHello</span> <span class="p">(</span><span class="n">HelloRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloReply</span><span class="p">)</span> <span class="p">{}</span>
  <span class="k">rpc</span> <span class="n">DigaOla</span> <span class="p">(</span><span class="n">OlaRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">OlaReply</span><span class="p">)</span> <span class="p">{}</span><span class="c1">// &lt;&lt;&lt;&lt;&lt;====</span>
<span class="p">}</span>
<span class="o">...</span>
</code></pre></div>
</td></tr></table>
<p>Observe que a nova operação recebe como entrada  mensagens <code>OlaRequest</code> e <code>OlaReply</code>, que tem definições exatamente iguais a <code>HellorRequest</code> e <code>HelloReply</code>.
Logo, em vez de definir novas mensagens, poderíamos ter usado as já definidas. Novamente, esta não é uma boa prática, pois caso fosse necessário evoluir uma das operações para atender a novos requisitos e estender suas mensagens, não será necessário tocar o restante do serviço.
Apenas reforçando, é boa prática definir <em>requests</em> e <em>responses</em> para cada método, a não ser que não haja dúvida de que serão para sempre iguais.</p>
<h5 id="implementando-um-servico">Implementando um serviço</h5>
<p>Agora modifique o arquivo <code>.proto</code> como acima, para incluir a operação <code>DigaOla</code>, recompile e reexecute o serviço.
Não dá certo, não é mesmo? Isto porquê você adicionou a definição de uma nova operação, mas não incluiu o código para implementá-la.
Façamos então a modificação do código, começando por <code>./src/main/java/io/grpc/examples/helloworld/HelloWorldServer.java</code>.
Este arquivo define a classe que <strong>implementa</strong> o serviço <code>Greeter</code>, <code>GreeterImpl</code>, com um método para cada uma das operações definidas. 
Para confirmar, procure por <code>sayHello</code>para encontrar a implementação de <code>SayHello</code>; observe que a diferença do <code>casing</code> vem das boas práticas de Java, de definir métodos e variáveis em <em>Camel casing</em>.</p>
<p>Para que sua versão estendida do serviço <code>Greeter</code> funcione, defina um método correspondendo à <code>DigaOla</code>, sem consultar o código exemplo abaixo, mas usando o código de <code>sayHello</code> como base; não se importe por enquanto com os métodos sendo invocados.
Note que os <code>...</code> indicam que parte do código, que não sofreu modificações, foi omitido.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">...</span>
<span class="kd">private</span> <span class="kd">class</span> <span class="nc">GreeterImpl</span> <span class="kd">extends</span> <span class="n">GreeterGrpc</span><span class="p">.</span><span class="na">GreeterImplBase</span> <span class="p">{</span>
<span class="p">...</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello</span><span class="p">(</span><span class="n">HelloRequest</span> <span class="n">req</span><span class="p">,</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">HelloReply</span><span class="o">&gt;</span> <span class="n">responseObserver</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">...</span>
  <span class="p">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">digaOla</span><span class="p">(</span><span class="n">OlaRequest</span> <span class="n">req</span><span class="p">,</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">OlaReply</span><span class="o">&gt;</span> <span class="n">responseObserver</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">OlaReply</span> <span class="n">reply</span> <span class="o">=</span> 
      <span class="n">OlaReply</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setMessage</span><span class="p">(</span><span class="s">&quot;Ola &quot;</span> <span class="o">+</span> <span class="n">req</span><span class="p">.</span><span class="na">getName</span><span class="p">()).</span><span class="na">build</span><span class="p">();</span>
    <span class="n">responseObserver</span><span class="p">.</span><span class="na">onNext</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
    <span class="n">responseObserver</span><span class="p">.</span><span class="na">onCompleted</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Se você recompilar e reexecutar o código, não perceberá qualquer mudança na saída do programa. Isto porquê embora tenha definido um novo serviço, você não o utilizou. Para tanto, agora modifique o cliente, em <code>src/main/java/io/grpc/examples/helloworld/HelloWorldClient.java</code>, novamente se baseando no código existente e não se preocupando com "detalhes".</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">greet</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Will try to greet &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot; ...&quot;</span><span class="p">);</span>
<span class="p">...</span>
  <span class="n">OlaRequest</span> <span class="n">request2</span> <span class="o">=</span> <span class="n">OlaRequest</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setName</span><span class="p">(</span><span class="n">name</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
  <span class="n">OlaReply</span> <span class="n">response2</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="n">response2</span> <span class="o">=</span> <span class="n">blockingStub</span><span class="p">.</span><span class="na">digaOla</span><span class="p">(</span><span class="n">request2</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">StatusRuntimeException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">logger</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">Level</span><span class="p">.</span><span class="na">WARNING</span><span class="p">,</span> <span class="s">&quot;RPC failed: {0}&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span>
   <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Greeting: &quot;</span> <span class="o">+</span> <span class="n">response2</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Agora sim, você pode reexecutar cliente e servidor.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>./gradlew installDist
./build/install/examples/bin/hello-world-server <span class="p">&amp;</span>
./build/install/examples/bin/hello-world-client
</code></pre></div>
</td></tr></table>
<p>Percebeu como foi fácil adicionar uma operação ao serviço? Agora nos foquemos nos detalhes, começando sobre como um servidor gRPC é criado.
Observe que um objeto <code>Server</code> é criado por uma fábrica que recebe como parâmetros a porta em que o serviço deverá escutar e o objeto que efetivamente implementa as operações definidas no arquivo <code>.proto</code>. O <code>start()</code> também é invocado na sequência e, estudando o código, você entenderá como o fim da execução é tratada.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">io.grpc.Server</span><span class="p">;</span>
<span class="p">...</span>
<span class="kd">private</span> <span class="n">Server</span> <span class="n">server</span><span class="p">;</span>
<span class="p">...</span>
 <span class="n">server</span> <span class="o">=</span> <span class="n">ServerBuilder</span><span class="p">.</span><span class="na">forPort</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
                       <span class="p">.</span><span class="na">addService</span><span class="p">(</span><span class="k">new</span> <span class="n">GreeterImpl</span><span class="p">())</span>
                       <span class="p">.</span><span class="na">build</span><span class="p">()</span>
                       <span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="p">...</span>
</code></pre></div>
</td></tr></table>
<p>Do lado do cliente, é criado um <code>ManagedChannel</code> e com este um <code>GreeterBlockingStub</code>, um <em>stub</em> em cujas chamadas são bloqueantes.
Finalmente, no <em>stub</em> são invocados os serviços definidos na IDL.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">io.grpc.Channel</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">io.grpc.ManagedChannel</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">io.grpc.ManagedChannelBuilder</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">ManagedChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ManagedChannelBuilder</span><span class="p">.</span><span class="na">forTarget</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                                              <span class="p">.</span><span class="na">usePlaintext</span><span class="p">()</span>
                                              <span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">...</span>                                              
<span class="kd">private</span> <span class="kd">final</span> <span class="n">GreeterGrpc</span><span class="p">.</span><span class="na">GreeterBlockingStub</span> <span class="n">blockingStub</span> <span class="o">=</span> <span class="n">GreeterGrpc</span><span class="p">.</span><span class="na">newBlockingStub</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">HelloRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">HelloRequest</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
                                   <span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                   <span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="n">HelloReply</span> <span class="n">response</span><span class="p">;</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">blockingStub</span><span class="p">.</span><span class="na">sayHello</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">StatusRuntimeException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">logger</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">Level</span><span class="p">.</span><span class="na">WARNING</span><span class="p">,</span> <span class="s">&quot;RPC failed: {0}&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Greeting: &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
</code></pre></div>
</td></tr></table>
<div class="admonition exercise">
<p class="admonition-title">Diga Olás!</p>
<p>Para fixar o conteúdo é preciso colocar a mão na massa. Estenda a definição do serviço com uma operação <code>DigaOlas</code> em que uma <strong>lista</strong> de nomes é enviada ao servidor e tal que o servidor responda com **uma longa string**cumprimentando todos os nomes, um após o outro.</p>
<details class="tip"><summary>Só abra depois de pensar em como resolver o problema</summary><p>Você pode usar <code>repeated</code> no campo <code>message</code> do tipo <code>HelloRequest</code>.</p>
</details>
</div>
<div class="admonition exercise">
<p class="admonition-title">Stream</p>
<p>Para terminar este estudo de caso, modifique a função definida no exercício anterior para gerar múltiplas respostas, uma para cada nome passado, em vez de uma única, longa, resposta.</p>
<details class="tip"><summary>Só abra depois de pensar em como resolver o problema</summary><p>Você deverá usar <em>streams</em>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">rpc</span> <span class="n">DigaOlas</span> <span class="p">(</span><span class="n">OlaRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">stream</span> <span class="n">OlaReply</span><span class="p">)</span> <span class="p">{}</span>
</code></pre></div>
</td></tr></table>
<ul>
<li>Do lado do servidor <br />
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">listOfHi</span> <span class="o">=</span> <span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="s">&quot;e aih&quot;</span><span class="p">,</span> <span class="s">&quot;ola&quot;</span><span class="p">,</span> <span class="s">&quot;ciao&quot;</span><span class="p">,</span> <span class="s">&quot;bao&quot;</span><span class="p">,</span> <span class="s">&quot;howdy&quot;</span><span class="p">,</span> <span class="s">&quot;s&#39;up&quot;</span><span class="p">);</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">digaOlas</span><span class="p">(</span><span class="n">OlaRequest</span> <span class="n">req</span><span class="p">,</span> <span class="n">StreamObserver</span><span class="o">&lt;</span><span class="n">OlaReply</span><span class="o">&gt;</span> <span class="n">responseObserver</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">hi</span><span class="p">:</span> <span class="n">listOfHi</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">OlaReply</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">OlaReply</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setMessage</span><span class="p">(</span><span class="n">hi</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="n">req</span><span class="p">.</span><span class="na">getName</span><span class="p">()).</span><span class="na">build</span><span class="p">();</span>
      <span class="n">responseObserver</span><span class="p">.</span><span class="na">onNext</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">responseObserver</span><span class="p">.</span><span class="na">onCompleted</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table></li>
<li>Do lado do cliente <br />
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">OlaRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">OlaRequest</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">().</span><span class="na">setName</span><span class="p">(</span><span class="n">name</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">OlaReply</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">blockingStub</span><span class="p">.</span><span class="na">digaOlas</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="na">hasNext</span><span class="p">()){</span>
       <span class="n">OlaReply</span> <span class="n">response</span> <span class="o">=</span> <span class="n">it</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
       <span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Greeting: &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">StatusRuntimeException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">logger</span><span class="p">.</span><span class="na">log</span><span class="p">(</span><span class="n">Level</span><span class="p">.</span><span class="na">WARNING</span><span class="p">,</span> <span class="s">&quot;RPC failed: {0}&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="na">getStatus</span><span class="p">());</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table></li>
</ul>
</details>
</div>
<div class="admonition exercise">
<p class="admonition-title">Desafio de Interoperabilidade</p>
<p>Siga o tutorial abaixo e execute use o gRPC em Python. Uma vez executados cliente e servidor, tente fazer com que interaja com a implementação em java.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>apt-get install python3
apt-get install python3-pip
python3 -m pip install --upgrade pip
python3 -m pip install grpcio
python3 -m pip install grpcio-tools

git clone -b v1..x https://github.com/grpc/grpc
<span class="nb">cd</span> grpc/examples/python/helloworld
python3 greeter<span class="se">\_</span>server.py
python3 greeter<span class="se">\_</span>client.py
</code></pre></div>
</td></tr></table>
<p>Para recompilar os <em>stubs</em>, faça</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>python3 -m grpc_tools.protoc -I../../protos --python_out<span class="o">=</span>. --grpc_python_out<span class="o">=</span>. ../../protos/helloworld.proto
</code></pre></div>
</td></tr></table>
<p>Modifique o servidor</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">DigaOla</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">helloworld_pb2</span><span class="o">.</span><span class="n">OlaReply</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Ola, </span><span class="si">%s</span><span class="s1">!&#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>Modifique o cliente</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">response</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">DigaOla</span><span class="p">(</span><span class="n">helloworld_pb2</span><span class="o">.</span><span class="n">OlaRequest</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;zelelele&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Greeter client received: &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
</div>
<h3 id="rpc-thrift">RPC: Thrift</h3>
<p><a href="https://thrift.apache.org/">Thrift</a></p>
<h4 id="instalacao_1">Instalação</h4>
<ul>
<li><a href="http://www.apache.org/dyn/closer.cgi?path=/thrift/0.13.0/thrift-0.13.0.tar.gz">Baixe</a> e compile o thrift</li>
<li>ou instale-o usando apt-get, por exemplo. <code>apt-get install thrift-compiler</code></li>
<li>execute "thrift" na linha de comando.</li>
<li>Para thrift com Java, também precisarão dos seguintes arquivos</li>
<li><a href="http://mvnrepository.com/artifact/org.slf4j/slf4j-api/1.7.21">slf4j</a></li>
<li><a href="https://mvnrepository.com/artifact/org.apache.thrift/libthrift/0.13.0">libthrift0.13.0.jar</a></li>
<li>coloque-os na pasta <code>jars</code></li>
</ul>
<h4 id="idl-thrift">IDL Thrift</h4>
<ul>
<li>Serviços
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">service</span><span class="w"> </span><span class="nc">ChaveValor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">set</span><span class="o">(</span><span class="mi">1</span><span class="p">:</span><span class="kt">i32</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="kt">string</span><span class="w"> </span><span class="n">value</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nf">get</span><span class="o">(</span><span class="mi">1</span><span class="p">:</span><span class="kt">i32</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="k">throws</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">KeyNotFound</span><span class="w"> </span><span class="n">knf</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">delete</span><span class="o">(</span><span class="mi">1</span><span class="p">:</span><span class="kt">i32</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table></li>
<li><strong>Não se pode retornar NULL!!!</strong></li>
<li>Exceções
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">exception</span><span class="w"> </span><span class="nc">KeyNotFound</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="kt">i64</span><span class="w"> </span><span class="n">hora</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="mi">2</span><span class="p">:</span><span class="kt">string</span><span class="w"> </span><span class="n">chaveProcurada</span><span class="o">=</span><span class="s2">&quot;thrifty&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
</td></tr></table></li>
</ul>
<p>Exemplo: chavevalor.thrift</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">namespace</span><span class="w"> </span><span class="nn">java</span><span class="w"> </span><span class="n">chavevalor</span><span class="w"></span>
<span class="kn">namespace</span><span class="w"> </span><span class="nn">py</span><span class="w"> </span><span class="n">chavevalor</span><span class="w"></span>


<span class="kd">exception</span><span class="w"> </span><span class="nc">KeyNotFound</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="kd">service</span><span class="w"> </span><span class="nc">ChaveValor</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="nf">getKV</span><span class="o">(</span><span class="mi">1</span><span class="p">:</span><span class="kt">i32</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="k">throws</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">KeyNotFound</span><span class="w"> </span><span class="n">knf</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">setKV</span><span class="o">(</span><span class="mi">1</span><span class="p">:</span><span class="kt">i32</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="kt">string</span><span class="w"> </span><span class="n">value</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">delKV</span><span class="o">(</span><span class="mi">1</span><span class="p">:</span><span class="kt">i32</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w">  </span>
</code></pre></div>
</td></tr></table>
<p>Compilação</p>
<p><code>thrift --gen java chavevalor.thrift</code></p>
<p><code>thrift --gen py chavevalor.thrift</code></p>
<p>ChaveValorHandler.java
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">namespace</span> <span class="n">java</span> <span class="n">chavevalor</span>
<span class="n">namespace</span> <span class="n">py</span> <span class="n">chavevalor</span>


<span class="n">exception</span> <span class="n">KeyNotFound</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="n">service</span> <span class="n">ChaveValor</span>
<span class="p">{</span>
    <span class="n">string</span> <span class="nf">getKV</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">i32</span> <span class="n">key</span><span class="p">)</span> <span class="kd">throws</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">KeyNotFound</span> <span class="n">knf</span><span class="p">),</span>
    <span class="n">bool</span> <span class="nf">setKV</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">i32</span> <span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">string</span> <span class="n">value</span><span class="p">),</span>
    <span class="kt">void</span> <span class="nf">delKV</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">i32</span> <span class="n">key</span><span class="p">)</span>
<span class="p">}</span>  

<span class="kn">package</span> <span class="nn">chavevalor</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.apache.thrift.TException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">chavevalor.*</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChaveValorHandler</span> <span class="kd">implements</span> <span class="n">ChaveValor</span><span class="p">.</span><span class="na">Iface</span> <span class="p">{</span>
   <span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">kv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="n">String</span> <span class="nf">getKV</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">TException</span> <span class="p">{</span>
       <span class="k">if</span><span class="p">(</span><span class="n">kv</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
          <span class="k">return</span> <span class="n">kv</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
       <span class="k">else</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">KeyNotFound</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">setKV</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="n">String</span> <span class="n">valor</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">TException</span> <span class="p">{</span>
       <span class="n">kv</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">valor</span><span class="p">);</span>
       <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delKV</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">TException</span> <span class="p">{</span>
       <span class="n">kv</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
   <span class="p">}</span>    
<span class="p">}</span>
</code></pre></div>
</td></tr></table></p>
<h4 id="arquitetura">Arquitetura</h4>
<ul>
<li>Runtime library -- componentes podem ser selecionados em tempo de execução e implementações podem ser trocadas</li>
<li>Protocol -- responsável pela serializaçãoo dos dados<ul>
<li>TBinaryProtocol</li>
<li>TJSONProtocol</li>
<li>TDebugProtocol</li>
<li>...</li>
</ul>
</li>
<li>Transport -- I/O no ``fio''<ul>
<li>TSocket</li>
<li>TFramedTransport (non-blocking server)</li>
<li>TFileTransport</li>
<li>TMemoryTransport</li>
</ul>
</li>
<li>
<p>Processor -- Conecta protocolos de entrada e saída com o \emph{handler}</p>
</li>
<li>
<p>Handler -- Implementação das operações oferecidas</p>
</li>
<li>Server -- Escuta portas e repassa dados (protocolo) para o processors<ul>
<li>TSimpleServer</li>
<li>TThreadPool</li>
<li>TNonBlockingChannel</li>
</ul>
</li>
</ul>
<h4 id="classpath">Classpath</h4>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>javac  -cp jars/libthrift0.9.3.jar:jars/slf4japi1.7.21.jar:gen-java  -d . *.java 
java -cp jars/libthrift0.9.3.jar:jars/slf4japi1.7.21.jar:gen-java:. chavevalor.ChaveValorServer
java -cp jars/libthrift0.9.3.jar:jars/slf4japi1.7.21.jar:gen-java:. chavevalor.ChaveValorClient 
</code></pre></div>
</td></tr></table>
<h3 id="rpc-remote-method-invocation">RPC: Remote Method Invocation</h3>
<details class="bug"><summary>TODO</summary><p>Como usar RMI.</p>
</details>
<h3 id="pubsub-mosquitto">Pub/Sub: MosQuiTTo</h3>
<blockquote>
<p><a href="https://mosquitto.org">Eclipse Mosquitto</a> is an open source (EPL/EDL licensed) message broker that implements the MQTT protocol versions 5.0, 3.1.1 and 3.1. Mosquitto is lightweight and is suitable for use on all devices from low power single board computers to full servers.</p>
</blockquote>
<p>MQTT é um protocolo de transporte para publish/subscribe do tipo cliente-servidor.
É leve, aberto e fácil de implementar, ideal para comunicação <em>Machine to Machine</em> (M2M) e uso no contexto de Internet das Coisas (<em>Internet of Things - I0T</em>).</p>
<blockquote>
<p>MQTT is a very light weight and binary protocol, and due to its minimal packet overhead, MQTT excels when transferring data over the wire in comparison to protocols like HTTP. Another important aspect of the protocol is that MQTT is extremely easy to implement on the client side. Ease of use was a key concern in the development of MQTT and makes it a perfect fit for constrained devices with limited resources today.</p>
</blockquote>
<p>O padrão é definido pela OASIS, uma organização aberta responsável por padrões como SAML e DocBook. A especificação atual é a de número 5, lançada em março de 2019.</p>
<h6>Instalação</h6>
<ul>
<li>Ubuntu: <code>apt-get install mosquitto</code></li>
<li>MacOS: brew install mosquitto</li>
<li>Windows: baixe <a href="http://mosquitto.org/download">mosquitto-2.0.9a-install-windows-x64.exe</a></li>
</ul>
<h6>Inicializando o serviço</h6>
<p>O arquivo <code>mosquito.conf</code> contém as configurações para o <em>broker</em>. 
As configurações funcionam bem para o nosso caso. O <em>broker</em> aceita requisições na porta 1883 e <em>publishers</em> e <em>subscribers</em> também utilizam essa porta por padrão.
Basta iniciar o <em>broker</em> com a opção <code>-v</code> para ter mais detalhes sobre o que ocorre internamente.</p>
<ul>
<li>Ubuntu: <code>mosquitto -v</code></li>
<li>MacOS: <code>/usr/local/sbin/mosquitto -c /usr/local/etc/mosquitto/mosquitto.conf</code></li>
</ul>
<h6>Publicando</h6>
<p>Para publicar uma mensagem, o <em>publisher</em> deve indicar um host, porta, tópico e mensagem. Caso o host e porta sejam omitidos, assume-se <code>localhost:1883</code>.
No MacOS, adicione <code>/usr/local/opt/mosquitto/bin/mosquitto_sub</code> ao <em>path</em>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># publicando valor de 40 para tópicos &#39;sensor/temperature/1&#39; e &#39;sensor/temperature/2&#39;</span>
mosquitto_pub -t sensor/temperature/1 -m <span class="m">40</span>
mosquitto_pub -t sensor/temperature/2 -m <span class="m">32</span>
</code></pre></div>
</td></tr></table>
<p>Caso o <em>subscriber</em> não esteja em execução, adicione a opção <code>-r</code> para que o broker retenha a mensagem.</p>
<h6>Consumindo</h6>
<p>O consumidor funciona de maneira semelhante, informando o tópico de interesse:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1"># consumindo mensagens de tópico /sensor/temperature/*</span>
mosquito_pub -t sensor/temperature/+
</code></pre></div>
</td></tr></table>
<h6>Programando</h6>
<p>Existem também APIs em diversas linguagem para desenvolvimento de aplicações que utilizem o Mosquitto.
A biblioteca pode ser baixada <a href="https://repo.eclipse.org/content/repositories/paho-snapshots/org/eclipse/paho/org.eclipse.paho.client.mqttv3/1.2.6-SNAPSHOT/org.eclipse.paho.client.mqttv3-1.2.6-20200715.040602-1.jar">aqui</a>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttClient</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttConnectOptions</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttException</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.MqttMessage</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.paho.client.mqttv3.persist.MemoryPersistence</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MqttPublishSample</span> <span class="p">{</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">topic</span>        <span class="o">=</span> <span class="s">&quot;MQTT Examples&quot;</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">content</span>      <span class="o">=</span> <span class="s">&quot;Message from MqttPublishSample&quot;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">qos</span>             <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">broker</span>       <span class="o">=</span> <span class="s">&quot;tcp://mqtt.eclipse.org:1883&quot;</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">clientId</span>     <span class="o">=</span> <span class="s">&quot;JavaSample&quot;</span><span class="p">;</span>
    <span class="n">MemoryPersistence</span> <span class="n">persistence</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemoryPersistence</span><span class="p">();</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="n">MqttClient</span> <span class="n">sampleClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MqttClient</span><span class="p">(</span><span class="n">broker</span><span class="p">,</span> <span class="n">clientId</span><span class="p">,</span> <span class="n">persistence</span><span class="p">);</span>
      <span class="n">MqttConnectOptions</span> <span class="n">connOpts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MqttConnectOptions</span><span class="p">();</span>
      <span class="n">connOpts</span><span class="p">.</span><span class="na">setCleanSession</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Connecting to broker: &quot;</span><span class="o">+</span><span class="n">broker</span><span class="p">);</span>
      <span class="n">sampleClient</span><span class="p">.</span><span class="na">connect</span><span class="p">(</span><span class="n">connOpts</span><span class="p">);</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Connected&quot;</span><span class="p">);</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Publishing message: &quot;</span><span class="o">+</span><span class="n">content</span><span class="p">);</span>
      <span class="n">MqttMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MqttMessage</span><span class="p">(</span><span class="n">content</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
      <span class="n">message</span><span class="p">.</span><span class="na">setQos</span><span class="p">(</span><span class="n">qos</span><span class="p">);</span>
      <span class="n">sampleClient</span><span class="p">.</span><span class="na">publish</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Message published&quot;</span><span class="p">);</span>
      <span class="n">sampleClient</span><span class="p">.</span><span class="na">disconnect</span><span class="p">();</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Disconnected&quot;</span><span class="p">);</span>
      <span class="n">System</span><span class="p">.</span><span class="na">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">MqttException</span> <span class="n">me</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;reason &quot;</span><span class="o">+</span><span class="n">me</span><span class="p">.</span><span class="na">getReasonCode</span><span class="p">());</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;msg &quot;</span><span class="o">+</span><span class="n">me</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;loc &quot;</span><span class="o">+</span><span class="n">me</span><span class="p">.</span><span class="na">getLocalizedMessage</span><span class="p">());</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;cause &quot;</span><span class="o">+</span><span class="n">me</span><span class="p">.</span><span class="na">getCause</span><span class="p">());</span>
      <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;excep &quot;</span><span class="o">+</span><span class="n">me</span><span class="p">);</span>
      <span class="n">me</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<details class="todo"><summary>Hive</summary><ul>
<li><code>/usr/local/opt/mosquitto/bin/mosquitto_sub -h broker.hivemq.com  -p 1883 -t esportes/+/flamengo</code></li>
<li><code>/usr/local/opt/mosquitto/bin/mosquitto_pub -t esportes/nadacao/flamengo -m "perdeu mais uma vez" -r -h broker.hivemq.com</code></li>
</ul>
</details>
<!-- Distinction from message queues
There is a lot of confusion about the name MQTT and whether the protocol is implemented as a message queue or not. We will try to shed some light on the topic and explain the differences. In our last post, we mentioned that MQTT refers to the MQseries product from IBM and has nothing to do with “message queue“. Regardless of where the name comes from, it’s useful to understand the differences between MQTT and a traditional message queue:

A message queue stores message until they are consumed When you use a message queue, each incoming message is stored in the queue until it is picked up by a client (often called a consumer). If no client picks up the message, the message remains stuck in the queue and waits to be consumed. In a message queue, it is not possible for a message not to be processed by any client, as it is in MQTT if nobody subscribes to a topic.

A message is only consumed by one client 
Another big difference is that in a traditional message queue a message can be processed by one consumer only. The load is distributed between all consumers for a queue. In MQTT the behavior is quite the opposite: every subscriber that subscribes to the topic gets the message.

Queues are named and must be created explicitly 
A queue is far more rigid than a topic. Before a queue can be used, the queue must be created explicitly with a separate command. Only after the queue is named and created is it possible to publish or consume messages. In contrast, MQTT topics are extremely flexible and can be created on the fly.

If you can think of any other differences that we overlooked, we would love to hear from you in the comments. -->

<div class="admonition question">
<p class="admonition-title">Exercícios - RPC e Publish/Subscribe</p>
<ul>
<li>Usando <em>thrift</em> e a linguagem Java, estenda o serviço ChaveValor para retornar o valor antigo de uma determinada chave na operação <code>setKV()</code>  caso a chave já exista.</li>
<li>Usando o <em>broker</em> mosquitto instalado localmente, faça em Java um <em>publisher</em> que simula um sensor de temperatura e publica valores aleatórios entre 15 e 45 a cada segundo.</li>
<li>Faça o <em>subscriber</em> que irá consumir esses dados de temperatura.</li>
</ul>
</div>
<h2 id="referencias">Referências</h2>
<ul>
<li><a href="https://grpc.io/docs/what-is-grpc/introduction/">What is gRPC: introduction</a></li>
<li><a href="https://diwakergupta.github.io/thrift-missing-guide/">Thrift: the missing guide</a></li>
<li><a href="https://www.hivemq.com/mqtt-essentials/">MQTT Essentials</a></li>
<li><a href="https://www.baeldung.com/java-mqtt-client">MQTT Client in Java</a></li>
<li><a href="http://thrift-tutorial.readthedocs.org/en/latest/index.html">Thrift Tutorial</a></li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:chord_dist">
<p>Observe que as distâncias entre os nós no anel foram desenhadas de forma proporcional à diferença numérica entre os identificadores.&#160;<a class="footnote-backref" href="#fnref:chord_dist" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:cql_sintax">
<p>Este exemplo é meramente ilustrativo e não segue estritamente a sintaxe do CQL.&#160;<a class="footnote-backref" href="#fnref:cql_sintax" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>

  <!-- Last update of source file -->


              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../disfs/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Anterior
              </span>
              Sistemas de Arquivos
            </div>
          </div>
        </a>
      
      
        <a href="../tech/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Próximo
              </span>
              Tecnologias
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copiar para \u00e1rea de transfer\u00eancia", "clipboard.copied": "Copiado para \u00e1rea de transfer\u00eancia", "search.config.lang": "pt", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Buscar", "search.result.placeholder": "Digite para iniciar a busca", "search.result.none": "Nenhum resultado encontrado", "search.result.one": "1 resultado encontrado", "search.result.other": "# resultados encontrados", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@8.5.1/dist/mermaid.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../javascripts/mathjaxhelper.js"></script>
      
    
  </body>
</html>